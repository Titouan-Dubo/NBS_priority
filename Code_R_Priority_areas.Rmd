---
title: "Code_R_priority_areas"
output: html_document
Authors-generated code of the study: Priority areas for nature-based adaptation to climate change in the Alps
Replace 'Path/to/working/directory' by appropriated folder path
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Libraries

```{r Libraries, warning=FALSE, include=FALSE}


library(sp) # Central package supporting spatial data analysis
library(raster)
library(rgdal)
library(moments) #For Skewness and Kurtosis indices
library(spatialEco) #For zonal statistics between raster and polygons
library(tidyverse) #For spatial geometric relationship
library(sf) #For spatial geometric relationship
library(png)
library(ggplot2)
library(chron)
library(lattice)
library(ncdf4)
library(adehabitatHR)
library(corrplot)
library(factoextra)
library(FactoMineR)
library(Rarity)
library(RColorBrewer)
library(grDevices)
library(ade4)
library(vegan)
library(missMDA)
library(lawstat)
library(png)
library(agricolae) 
library(networkD3)
library(tidyr)
library(patchwork)
library(lme4)
library(spdep)
library(tripack)
library(nlme)
library(TSA)
library(gwrr)
library(rstatix)  
library(multcomp)
library(gamm4)
library(randomForest)
library(randomForestSRC)
library(rgeos)
library(fmsb)
library(remotes)


```

# Functions

```{r Functions}
fx=function(p){
  x11() + print(p)
}

### Standardized_to_1: Procedure that return the raster layer with maximum-standardized data in Bounding Box (from -1 (if values could be negative) to 1 (if values could be positive))
#               Input : raster : name of the raster to standardized
#              Output : the standardized raster layer
Standardized_to_1=function(raster, Bounding_box){
  # raster_data_in_AC=raster::extract(raster, extent(AC))
  if (extent(raster)!=extent(Bounding_box)){raster=crop(raster, Bounding_box)}
  
  # raster_data_std=raster@data@values
  raster@file@nbands=as.integer(1)
  raster_data_std=raster::extract(raster, extent(Bounding_box))
  
  if (cellStats(raster, 'min')<0){raster_data_std[which((raster_data_std<0)==T)]=raster_data_std[which((raster_data_std<0)==T)]/abs(cellStats(raster, 'min'))}
  if (cellStats(raster, 'max')>0){raster_data_std[which((raster_data_std>0)==T)]=raster_data_std[which((raster_data_std>0)==T)]/cellStats(raster, 'max')}
  raster_std=raster
  raster_std=setValues(raster_std, raster_data_std)
  return(raster_std)
}

### Rescaled_values: Procedure that return the raster layer with min-max standardized data in Bounding Box (from -100 (if values could be negative) to 100 (if values could be positive) by taking in account the minimum and maximum of the both side of the 0 value)
#               Input : raster : name of the raster to standardized
#              Output : the standardized raster layer
Rescale_to_100=function(raster, Bounding_box){
  # raster_data_in_AC=raster::extract(raster, extent(AC))
  if (extent(raster)!=extent(Bounding_box)){raster=crop(raster, Bounding_box)}
  
  # raster_data_std=raster@data@values
  raster@file@nbands=as.integer(1)
  raster_data_std=raster::extract(raster, extent(Bounding_box))
  raster_data_std_pos=raster_data_std[raster_data_std>0]
  raster_data_std_neg=raster_data_std[raster_data_std<0]
  
  if (cellStats(raster, 'min')<0){raster_data_std[which((raster_data_std<0)==T)]=
    (raster_data_std[which((raster_data_std<0)==T)]-max(raster_data_std_neg, na.rm=T))/(max(raster_data_std_neg, na.rm=T)-min(raster_data_std_neg, na.rm=T))}
  if (cellStats(raster, 'max')>0){raster_data_std[which((raster_data_std>0)==T)]=
    (raster_data_std[which((raster_data_std>0)==T)]-min(raster_data_std_pos, na.rm=T))/(max(raster_data_std_pos, na.rm=T)-min(raster_data_std_pos, na.rm=T))}
  
  raster_data_std=100*raster_data_std
  
  raster_std=raster
  raster_std=setValues(raster_std, raster_data_std)
  return(raster_std)
}

Rescale_to_100_shp=function(shp, Bounding_box){
  # raster_data_in_AC=raster::extract(raster, extent(AC))

  
  
  # raster_data_std=raster@data@values
  raster@file@nbands=as.integer(1)
  raster_data_std=raster::extract(raster, extent(Bounding_box))
  raster_data_std_pos=raster_data_std[raster_data_std>0]
  raster_data_std_neg=raster_data_std[raster_data_std<0]
  
  if (cellStats(raster, 'min')<0){raster_data_std[which((raster_data_std<0)==T)]=
    (raster_data_std[which((raster_data_std<0)==T)]-max(raster_data_std_neg, na.rm=T))/(max(raster_data_std_neg, na.rm=T)-min(raster_data_std_neg, na.rm=T))}
  if (cellStats(raster, 'max')>0){raster_data_std[which((raster_data_std>0)==T)]=
    (raster_data_std[which((raster_data_std>0)==T)]-min(raster_data_std_pos, na.rm=T))/(max(raster_data_std_pos, na.rm=T)-min(raster_data_std_pos, na.rm=T))}
  
  raster_data_std=100*raster_data_std
  
  raster_std=raster
  raster_std=setValues(raster_std, raster_data_std)
  return(raster_std)
}


#### This function is used to compute the heatmaps, it allows to create the sequence of the quantile even with redundancy among quantile.
# INPUT: matrix: dataframe with data
#        indic : index of the column 
#        Length : length of the sequence
Seq_quantile=function(matrix,indic,Length){
    seq_quantile=c()
    compteur=0
    redondant=c()
    for (i in 0:Length){
      quantile_i=quantile(matrix[,indic], i/10, na.rm=T)
      seq_quantile=c(seq_quantile, quantile_i)
      # print(i)
      # print(seq_quantile)
      if (i>0){
        if (quantile_i==seq_quantile[i]){
          redondant=c(redondant, i)
        }
      }
    }
  return(list(seq_quantile, redondant))
  }

### list files in folder
List_files_nc=function(dossier){
  files=list.files(dossier)
  files=files[-grep(".aux", files)]
  files=files[grep(".nc", files)]
  return(files)
}
  

### plot models and data
box_dot=function(data, var){
  par(mfrow=c(1,2))
boxplot(data@data[,grep(paste("^",var,"$", sep=''), colnames(data@data))]
        ,col='red'
        ,ylab=var)
dotchart(data@data[,grep(paste("^",var,"$", sep=''), colnames(data@data))]
         ,pch=16
         ,col='red'
         , xlab=var)
}

hist_qqplot=function(data, var){
  par(mfrow=c(1,2))
#Histogram
hist(data@data[,grep(paste("^",var,"$", sep=''), colnames(data@data))]
     ,breaks=8
     , col='red'
     , xlab=var
     , ylab='Number')
# Quantile-Quantile Plot
qqnorm(data@data[,grep(paste("^",var,"$", sep=''), colnames(data@data))]
       , col='red'
       , pch=16)
qqline(data@data[,grep(paste("^",var,"$", sep=''), colnames(data@data))])
  
}

hist_qqplot_res=function(model){
  par(mfrow=c(1,2))
#Histogram
hist(residuals(model)
     ,breaks=8
     , col='red'
     , xlab=var
     , ylab='Number')
# Quantile-Quantile Plot
qqnorm(residuals(model)
       , col='red'
       , pch=16)
qqline(residuals(model))
  
}

homogeneity=function(model, data, var){
  par(mfrow=c(1,2))
plot(residuals(model)~fitted(model)
     , col='red'
     , pch=16
     , xlab = "Fitted values",
     ylab = "Residuals", 
     main = "Homogeneity?")
abline(h = 0, v = 0, lty = 2)

plot( residuals(model)~ data@data[,grep(paste("^",var,"$", sep=''), colnames(data@data))]
      , col='red'
      , pch=16
      , ylab = "Residuals"
      , xlab = var
      , main = "")
abline(h = 0, lty = 2)
}

influencial=function(model){
  par(mfrow=c(1,3))
  plot(model,which = c(2),
       pch=16,
       col="red")
  plot(model,which = c(1),
       pch=16,
       col="red")
  plot(model,which = c(4),
       pch=16,
       col="red")
}

fitted_drought=function(model, data, x, y,Drought_seq, log){
  fitted_values=summary(model)$coefficients[1,1] + summary(model)$coefficients[2,1]*Drought_seq
  
  if(log==F){
  plot(x = data@data[,grep(paste("^",x,"$", sep=''), colnames(data@data))],
     y = data@data[,grep(paste("^",y,"$", sep=''), colnames(data@data))],
     xlab = x,
     ylab = y,
     pch = 16)}

  if(log==T){
    plot(x = data@data[,grep(paste("^",x,"$", sep=''), colnames(data@data))],
     y = log(data@data[,grep(paste("^",y,"$", sep=''), colnames(data@data))]),
     xlab = x,
     ylab = y,
     pch = 16)
    }
lines(x = Drought_seq,
      y = fitted_values,
      col='red')
  
}

### Plot the models results and save the png in the folder 
plot_models=function(data, x, y, model, dossier, log){
  # Plot x data
  png(file= paste(dossier, "/boxplot_dotchart_", x, ".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  box_dot(data, x)
  dev.off()
  display(readPNG(paste(dossier, "/boxplot_dotchart_", x, ".png", sep='')))

  png(file= paste(dossier, "/hist_qqplot_", x,".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  hist_qqplot(data, x)
  dev.off()
  display(readPNG(paste(dossier, "/hist_qqplot_", x,".png", sep='')))
 
  # Plot y data
   png(file= paste(dossier, "/boxplot_dotchart_", y, ".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  box_dot(data, y)
  dev.off()
  display(readPNG(paste(dossier, "/boxplot_dotchart_", y, ".png", sep='')))

   png(file= paste(dossier, "/hist_qqplot_", y, ".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  hist_qqplot(data, y)
  dev.off()
  display(readPNG(paste(dossier, "/hist_qqplot_", y, ".png", sep='')))  
   
  
  png(file= paste(dossier, "/normality_residuals_model_",x,"_", y, ".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  hist_qqplot_res((model))
  dev.off()
  display(readPNG(paste(dossier, "/normality_residuals_model_",x,"_", y, ".png", sep='')))
  
  png(file= paste(dossier, "/homogenity_residuals_model_",x,"_", y, ".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  homogeneity(model, data, x)
  dev.off()
  display(readPNG(paste(dossier, "/homogenity_residuals_model_",x,"_", y, ".png", sep='')))
  
   png(file= paste(dossier, "/influencial_model_",x,"_", y, ".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  influencial(model)
  dev.off()
  display(readPNG(paste(dossier, "/influencial_model_",x,"_", y, ".png", sep='')))
 
  

  Seq_x <- seq(from   = min(data@data[,grep(paste("^",x,"$", sep=''),
                                            colnames(data@data))], na.rm=T)-10, 
            to     =  max(data@data[,grep(paste("^",x,"$", sep=''),
                                          colnames(data@data))], na.rm=T),
            length = 10)

  png(file= paste(dossier, "/fitted_vs_observed_",x,"_", y, ".png", sep=''),width = 1024*(3/4), height = 768*(3/4))
  fitted_drought(model, data, x, y, Seq_x, log=log)
  dev.off()
  display(readPNG(paste(dossier, "/fitted_vs_observed_",x,"_", y, ".png", sep='')))
    
}


Cumul_rank=function(Matrix_rank, Polygons, Variable, Rank){
  sp_data=Polygons@data
  Cumul_var=c()
  value=0
  for (i in 1:nrow(sp_data)){
    if (i %in% sp_data[,grep(Rank, colnames(sp_data))]){
    
    value=value+sp_data[which(sp_data[,grep(Rank, colnames(sp_data))[1]]==i),grep(Variable, colnames(sp_data))[1]]
    Cumul_var=c(Cumul_var, value)
    }
   else{Cumul_var=c(Cumul_var, NA)}
  }
 
  
  Cumul_var_prop=100*Cumul_var/sum(sp_data[,grep(Variable, colnames(sp_data))], na.rm=T)
  
  Matrix_rank=cbind(Matrix_rank, Cumul_var_prop)
  colnames(Matrix_rank)=c(colnames(Matrix_rank)[-ncol(Matrix_rank)], Rank)
  
  return(Matrix_rank)
  
}



```

# Data

## AC and BB import

```{r AC and BB import}
Bounding_box=shapefile("Path/to/working/directory/QGIS/Bounding_Box_Dubo.shp")
crs(Bounding_box, asText=T)
Bounding_box_ETRS=spTransform(Bounding_box, crs(BB_Large_ETRS89)@projargs)
crs(Bounding_box_ETRS)

BB_Large_ETRS89=shapefile("Path/to/working/directory/BB_Large_ETRS89.shp")
crs(BB_Large_ETRS89)@projargs
BB_Large_WGS84=spTransform(BB_Large_ETRS89, crs(Bounding_box)@projargs)


AC=shapefile("Path/to/working/directory/QGIS/AC_WFS_WGS84.shp")
crs(AC)@projargs==crs(Bounding_box)@projargs
AC_repair=shapefile("Path/to/working/directory/Shp/AC_WFS_WGS84_repair.shp")
crs(AC_repair)@projargs==crs(Bounding_box)@projargs

Alpine_Space=shapefile("Path/to/working/directory/QGIS/Alpine_space.shp")
crs(Alpine_Space)@projargs==crs(Bounding_box)@projargs
Alpine_Space_WGS84=spTransform(Alpine_Space, crs(Bounding_box)@projargs)
crs(Alpine_Space_WGS84)@projargs==crs(Bounding_box)@projargs

plot(BB_Large_WGS84)
plot(Alpine_Space_WGS84, add=T, col='red')

AS_fusion_ETRS=shapefile("Path/to/working/directory/QGIS/Alpine_space_fusion_ETRS89.shp")
AS_fusion_WGS84=spTransform(AS_fusion_ETRS, crs(Bounding_box)@projargs)
# plot(AS_fusion_ETRS)

### Countries and regions
Countries_ERTS=shapefile("Path/to/working/directory/Eurogeographics/Countries_Alps_ETRS89.shp")
Countries_WGS84=spTransform(Countries_ERTS, crs(Bounding_box)@projargs)
plot(Countries_WGS84)
ICC_Alps=c("AT", "CH", "DE", "FR", "IT", "LI", "SI")
Countries_Alps_WGS84=Countries_WGS84[which(Countries_WGS84$ICC %in% ICC_Alps),]
for (i in 1:length(Countries_Alps_WGS84)){
  x11() +   plot(Countries_Alps_WGS84[i,], main=Countries_Alps_WGS84$OBJECTID[i])
}
DROM=c("18", "19", "31" ,"32", "52", "53")
Countries_Alps_WGS84=Countries_Alps_WGS84[-which(Countries_Alps_WGS84$OBJECTID %in% DROM),]
#### Countries in the Alpine Space borders
# sf::sf_use_s2(FALSE)
Countries_Alps_WGS84_st=sf::st_intersection(as(Countries_Alps_WGS84, "sf"), as(Alpine_Space_WGS84, "sf"))
# sf::sf_use_s2(T)
# Not the same geometries, need to have only polygons
types <- vapply(sf::st_geometry(Countries_Alps_WGS84_st), function(x) {
    class(x)[2]
}, "")

unique(types)
polys <- Countries_Alps_WGS84_st[ grepl("*POLYGON", types), ]
Countries_Alps_WGS84_sp=sf::as_Spatial(polys)

#### Countries in the Bounding_box border
# sf::sf_use_s2(FALSE)
Countries_BB_Large_WGS84_st=sf::st_intersection(as(Countries_Alps_WGS84, "sf"), as(BB_Large_WGS84, "sf"))
# sf::sf_use_s2(T)
# Not the same geometries, need to have only polygons
types <- vapply(sf::st_geometry(Countries_BB_Large_WGS84_st), function(x) {
    class(x)[2]
}, "")

unique(types)
polys <- Countries_BB_Large_WGS84_st[ grepl("*POLYGON", types), ]
Countries_BB_Large_WGS84_sp=sf::as_Spatial(polys)

```


## NCP AlpES

```{r ncp_alpes}
## Import AlpES values
NCP_AlpES_WGS84_ratio_in_AC=shapefile("Path/to/working/directory/AlpES/AlpES_8_ES_WebGIS_WGS84_with_ratio_04.08.21.shp")

## Clusters NCP
NCP_data=NCP_AlpES_WGS84_ratio_in_AC@data
NCP_pca=NCP_data[,-c(1:2,24:40)]

pca.ncp=PCA(NCP_pca, graph=F)

pca.var=pca.ncp$var
pca.ind=pca.ncp$ind

plot(pca.ncp,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))
plot(pca.ncp,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,3))
plot(pca.ncp,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(2,3))

plot(pca.ncp,
     invisible = c("var", "ind"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))

plot(pca.ncp,
     invisible = c("ind"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))



# with cos2
fviz_pca_var(pca.ncp, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,2)
            # invisible=c("quali.sup"),
            )
fviz_pca_var(pca.ncp, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,3)
            # invisible=c("quali.sup"),
            )


eig.val <- pca.ncp$eig
barplot(eig.val[, 2], 
        names.arg = 1:nrow(eig.val), 
        main = "Variances Explained by Dimensions (%)",
        xlab = "Principal Dimensions",
        ylab = "Percentage of variances",
        col ="steelblue")
# Add connected line segments to the plot
lines(x = 1:nrow(eig.val), eig.val[, 2], 
      type = "b", pch = 19, col = "red")



## Clustering
clust.pca=HCPC(PCA(NCP_pca, graph=F), metric="euclidean")
clust.pca=HCPC(PCA(NCP_pca, graph=F), metric="euclidean", nb.clust=5)


fviz_cluster(clust.pca,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = FALSE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             geom = c(""),
             main = "Factor map",
             axes = c(1, 2)
             )

fviz_cluster(clust.pca,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = FALSE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             geom = c(""),
             main = "Factor map",
             axes = c(1, 3)
             )

plot(clust.pca, choice = "3D.map")

#p-value
clust.pca$desc.var$quanti.var

clust.pca$desc.var$category
######################
#######  C1  #########
######################
ncp.clust1=as.data.frame(clust.pca$desc.var$quanti$`1`)
ncp.clust1$Levers=rownames(ncp.clust1)
ncp.clust1$Signif=0
ncp.clust1$Signif[which((ncp.clust1$p.value<0.02) & (ncp.clust1$v.test<0))]=-1
ncp.clust1$Signif[which((ncp.clust1$p.value<0.02) & (ncp.clust1$v.test>0))]=1
ncp.clust1$Signif=as.factor(ncp.clust1$Signif)
ncp.clust1$diff_mean=ncp.clust1$`Mean in category`-ncp.clust1$`Overall mean`
ncp.clust1[,c(1,6:9)]

# B_3, C_3, D_1_2, D_3, (A_3)
#

######################
#######  C2  #########
######################
ncp.clust2=as.data.frame(clust.pca$desc.var$quanti$`2`)
ncp.clust2$Levers=rownames(ncp.clust2)
ncp.clust2$Signif=0
ncp.clust2$Signif[which((ncp.clust2$p.value<0.02) & (ncp.clust2$v.test<0))]=-1
ncp.clust2$Signif[which((ncp.clust2$p.value<0.02) & (ncp.clust2$v.test>0))]=1
ncp.clust2$Signif=as.factor(ncp.clust2$Signif)
ncp.clust2$diff_mean=ncp.clust2$`Mean in category`-ncp.clust2$`Overall mean`
ncp.clust2[,c(1,6:9)]

# A_1, A_2, A_3, C_3, F_3, G_2, G_3

######################
#######  C3  #########
######################
ncp.clust3=as.data.frame(clust.pca$desc.var$quanti$`3`)
ncp.clust3$Levers=rownames(ncp.clust3)
ncp.clust3$Signif=0
ncp.clust3$Signif[which((ncp.clust3$p.value<0.02) & (ncp.clust3$v.test<0))]=-1
ncp.clust3$Signif[which((ncp.clust3$p.value<0.02) & (ncp.clust3$v.test>0))]=1
ncp.clust3$Signif=as.factor(ncp.clust3$Signif)
ncp.clust3$diff_mean=ncp.clust3$`Mean in category`-ncp.clust3$`Overall mean`
ncp.clust3[,c(1,6:9)]

# B_1, B_2, B_3, C_1, C_2, D_1_2, D_3, F_1_2



######################
#######  C4  #########
######################
ncp.clust4=as.data.frame(clust.pca$desc.var$quanti$`4`)
ncp.clust4$Levers=rownames(ncp.clust4)
ncp.clust4$Signif=0
ncp.clust4$Signif[which((ncp.clust4$p.value<0.02) & (ncp.clust4$v.test<0))]=-1
ncp.clust4$Signif[which((ncp.clust4$p.value<0.02) & (ncp.clust4$v.test>0))]=1
ncp.clust4$Signif=as.factor(ncp.clust4$Signif)
ncp.clust4$diff_mean=ncp.clust4$`Mean in category`-ncp.clust4$`Overall mean`
ncp.clust4[,c(1,6:9)]

# C_1, C_2, F_1_2, G_1, G_2



#######  C5  #########
######################
ncp.clust5=as.data.frame(clust.pca$desc.var$quanti$`5`)
ncp.clust5$Levers=rownames(ncp.clust5)
ncp.clust5$Signif=0
ncp.clust5$Signif[which((ncp.clust5$p.value<0.02) & (ncp.clust5$v.test<0))]=-1
ncp.clust5$Signif[which((ncp.clust5$p.value<0.02) & (ncp.clust5$v.test>0))]=1
ncp.clust5$Signif=as.factor(ncp.clust5$Signif)
ncp.clust5$diff_mean=ncp.clust5$`Mean in category`-ncp.clust5$`Overall mean`
ncp.clust5[,c(1,6:9)]

# A_1, E_1, E_2, E_3, G_1, G_2, H_1, H_2


### Export NCP clusters

nrow(clust.pca$data.clust)==nrow(NCP_data)

summary(as.factor(clust.pca$data.clust$clust))/nrow(NCP_data)
#    1    2    3    4    5 
# 3279  473 2156 7928 2949 
# 19%    2%  13%  47% 18%


NCP_data$clust=clust.pca$data.clust$clust
NCP_AlpES_WGS84_ratio_in_AC@data=NCP_data

shapefile(NCP_AlpES_WGS84_ratio_in_AC,
"Path/to/working/directory/AlpES/AlpES_8_ES_WebGIS_WGS84_with_ratio_clust_15.11.23.shp")



### Distrib clusters in priority areas

All_priority_areas=shapefile("Path/to/working/directory/PhD/Maps/R/Export_data/All_priority_areas_AS_NCP_BD_art17_LULC_TOP_cluster_landscapes.shp")

table(All_priority_areas$clust,All_priority_areas$TOP)
table(All_priority_areas$clust,All_priority_areas$TOP,All_priority_areas$LULC)

### Croplands
data_clust_cropland=as.data.frame(table(All_priority_areas$clust[which(All_priority_areas$LULC=="Cropland")],All_priority_areas$TOP[which(All_priority_areas$LULC=="Cropland")]))
colnames(data_clust_cropland)=c("Clust", "TOP", "Nb")

data_clust_cropland$Prop[1:5]=100*data_clust_cropland$Nb[1:5]/sum(data_clust_cropland$Nb[1:5])
data_clust_cropland$Prop[6:10]=100*data_clust_cropland$Nb[6:10]/sum(data_clust_cropland$Nb[6:10])

p=ggplot(data=data_clust_cropland) + geom_bar(aes(x=TOP, y=Prop, fill=Clust), stat="identity")+
  # scale_fill_manual(values=color_values)+
    # geom_text(aes(x="AS", y=label_as, label=as.character(round(data_PA_AS_modif$Prop_modif[c(7,5,4,2,8)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

ggsave(plot=p, filename = paste("Path/to/working/directory/PhD/Maps/R/Export_data/NCP/NCP_clusters_in_priority_Croplands" , ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

### Grasslands
data_clust_grassland=as.data.frame(table(All_priority_areas$clust[which(All_priority_areas$LULC=="Grassland")],All_priority_areas$TOP[which(All_priority_areas$LULC=="Grassland")]))
colnames(data_clust_grassland)=c("Clust", "TOP", "Nb")

data_clust_grassland$Prop[1:5]=100*data_clust_grassland$Nb[1:5]/sum(data_clust_grassland$Nb[1:5])
data_clust_grassland$Prop[6:10]=100*data_clust_grassland$Nb[6:10]/sum(data_clust_grassland$Nb[6:10])

p=ggplot(data=data_clust_grassland) + geom_bar(aes(x=TOP, y=Prop, fill=Clust), stat="identity")+
  # scale_fill_manual(values=color_values)+
    # geom_text(aes(x="AS", y=label_as, label=as.character(round(data_PA_AS_modif$Prop_modif[c(7,5,4,2,8)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

ggsave(plot=p, filename = paste("Path/to/working/directory/PhD/Maps/R/Export_data/NCP/NCP_clusters_in_priority_Grasslands" , ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

### Forests
data_clust_forest=as.data.frame(table(All_priority_areas$clust[which(All_priority_areas$LULC=="Forest")],All_priority_areas$TOP[which(All_priority_areas$LULC=="Forest")]))
colnames(data_clust_forest)=c("Clust", "TOP", "Nb")

data_clust_forest$Prop[1:5]=100*data_clust_forest$Nb[1:5]/sum(data_clust_forest$Nb[1:5])
data_clust_forest$Prop[6:10]=100*data_clust_forest$Nb[6:10]/sum(data_clust_forest$Nb[6:10])

p=ggplot(data=data_clust_forest) + geom_bar(aes(x=TOP, y=Prop, fill=Clust), stat="identity")+
  # scale_fill_manual(values=color_values)+
    # geom_text(aes(x="AS", y=label_as, label=as.character(round(data_PA_AS_modif$Prop_modif[c(7,5,4,2,8)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

ggsave(plot=p, filename = paste("Path/to/working/directory/PhD/Maps/R/Export_data/NCP/NCP_clusters_in_priority_Forests" , ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

### Wetlands
data_clust_wetland=as.data.frame(table(All_priority_areas$clust[which(All_priority_areas$LULC=="Wetland")],All_priority_areas$TOP[which(All_priority_areas$LULC=="Wetland")]))
colnames(data_clust_wetland)=c("Clust", "TOP", "Nb")

data_clust_wetland$Prop[1:4]=100*data_clust_wetland$Nb[1:4]/sum(data_clust_wetland$Nb[1:4])
data_clust_wetland$Prop[5:8]=100*data_clust_wetland$Nb[5:8]/sum(data_clust_wetland$Nb[5:8])

p=ggplot(data=data_clust_wetland) + geom_bar(aes(x=TOP, y=Prop, fill=Clust), stat="identity")+
  # scale_fill_manual(values=color_values)+
    # geom_text(aes(x="AS", y=label_as, label=as.character(round(data_PA_AS_modif$Prop_modif[c(7,5,4,2,8)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

ggsave(plot=p, filename = paste("Path/to/working/directory/PhD/Maps/R/Export_data/NCP/NCP_clusters_in_priority_Wetlands" , ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


```


## Carbon saturation capacity
ESDAC study Lugato_et_al-2014-Global_Change_Biology (a & b)
```{r Carbon_saturation}
Carbon_saturation_ETRS=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ESDAC/Carbon_pool/carbon_pool/SOCp_all_bil7.tif")
plot(Carbon_saturation_ETRS)
crs(Carbon_saturation_ETRS)@projargs==crs(BB_Large_ETRS89)@projargs



hist(Carbon_saturation_ETRS[sample(1:length(values(Carbon_saturation_ETRS)), 10000, replace = F)])
Carbon_saturation_WGS84=projectRaster(Carbon_saturation_ETRS,  crs= crs(BB_Large_WGS84)@projargs)

Carbon_saturation_cut_WGS84=crop(Carbon_saturation_WGS84, BB_Large_WGS84)




```



## Protected area
```{r protected area}
WDPA=shapefile("Path/to/working/directory/PhD/Maps/WDPA2023/WDPA_Jun2023_Alps_WGS84.shp")

WDPA$IUCN_CAT
WDPA$IUCN_cat_modif=NA
WDPA$IUCN_cat_modif[which(WDPA$IUCN_CAT=="Ia" |WDPA$IUCN_CAT=="Ib" )]=1
WDPA$IUCN_cat_modif[which(WDPA$IUCN_CAT=="II" )]=2
WDPA$IUCN_cat_modif[which(WDPA$IUCN_CAT=="III" )]=3
WDPA$IUCN_cat_modif[which(WDPA$IUCN_CAT=="IV" )]=4
WDPA$IUCN_cat_modif[which(WDPA$IUCN_CAT=="V" )]=5
WDPA$IUCN_cat_modif[which(WDPA$IUCN_CAT=="VI" )]=6
WDPA$IUCN_cat_modif[which(WDPA$IUCN_CAT=="Not Applicable" |WDPA$IUCN_CAT=="Not Assigned" | WDPA$IUCN_CAT=="Not Reported")]=NA

WDPA$IUCN_cat_modif=factor(WDPA$IUCN_cat_modif, levels=c("Not Categorised", 0:6))
WDPA$Area_r=raster::area(WDPA)

data_PA_AS <- WDPA@data %>%
  group_by(IUCN_cat_modif) %>%
  summarize(area = sum(Area_r, na.rm=T)) %>% as.data.frame()
data_PA_AS$IUCN_cat_modif[7]="Not Categorised"

### Area outside PA

# Area_all_AS=raster::area(AS_fusion_WGS84)
# Area_not_PA=Area_all_AS-sum(data_PA_AS$area) ## do not work if PA overlap


WDPA_fusion_AS=shapefile("Path/to/working/directory/PhD/Maps/WDPA2023/WDPA_Jun2023_Alpine_space_fusion_WGS84.shp")
Area_PA=raster::area(WDPA_fusion_AS) # 112003 km2
Area_outside_PA=raster::area(AS_fusion_WGS84)-Area_PA # 278239 km2
Area_outside_PA/raster::area(AS_fusion_WGS84) # 71%
Area_PA/raster::area(AS_fusion_WGS84) # 29%
### Be careful in calculating area/prop, PA from different categoriesoverlap

data_PA_AS_modif=data_PA_AS
data_PA_AS_modif$Prop=100*data_PA_AS_modif$area/sum(data_PA_AS_modif$area)
data_PA_AS_modif$Prop_modif=data_PA_AS_modif$Prop*0.71
### Prop to calculate
data_PA_AS_modif=rbind(data_PA_AS_modif, c(factor(0), Area_outside_PA, 100, 29))


data_PA_AS_modif$IUCN_cat_modif[8]=0


### PLOT
color_values=c(rgb(128,128,128, maxColorValue=255))
color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(data_PA_AS$IUCN_cat_modif))))
# color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(data_PA_AS$IUCN_cat_modif))-1))

data_PA_AS_modif$IUCN_cat_modif=factor(data_PA_AS_modif$IUCN_cat_modif, levels=c(0:6, "Not Categorised"))

# Label with prop
label_as=c(data_PA_AS_modif$Prop_modif[7]/2,
           
           data_PA_AS_modif$Prop_modif[7]+data_PA_AS_modif$Prop_modif[6]+data_PA_AS_modif$Prop_modif[5]/2,
           data_PA_AS_modif$Prop_modif[7]+data_PA_AS_modif$Prop_modif[6]+data_PA_AS_modif$Prop_modif[5]+data_PA_AS_modif$Prop_modif[4]/2,
           
           data_PA_AS_modif$Prop_modif[7]+data_PA_AS_modif$Prop_modif[6]+data_PA_AS_modif$Prop_modif[5]+data_PA_AS_modif$Prop_modif[4]+data_PA_AS_modif$Prop_modif[3]+data_PA_AS_modif$Prop_modif[2]/2,
           
           data_PA_AS_modif$Prop_modif[7]+data_PA_AS_modif$Prop_modif[6]+data_PA_AS_modif$Prop_modif[5]+data_PA_AS_modif$Prop_modif[4]+data_PA_AS_modif$Prop_modif[3]+data_PA_AS_modif$Prop_modif[2]+data_PA_AS_modif$Prop_modif[1]+data_PA_AS_modif$Prop_modif[8]/2
           )
# Label with area
label_as=c(data_PA_AS_modif$area[7]/2,
           
           data_PA_AS_modif$area[7]+data_PA_AS_modif$area[6]+data_PA_AS_modif$area[5]/2,
           data_PA_AS_modif$area[7]+data_PA_AS_modif$area[6]+data_PA_AS_modif$area[5]+data_PA_AS_modif$area[4]/2,
           
           data_PA_AS_modif$area[7]+data_PA_AS_modif$area[6]+data_PA_AS_modif$area[5]+data_PA_AS_modif$area[4]+data_PA_AS_modif$area[3]+data_PA_AS_modif$area[2]/2,
           
           data_PA_AS_modif$area[7]+data_PA_AS_modif$area[6]+data_PA_AS_modif$area[5]+data_PA_AS_modif$area[4]+data_PA_AS_modif$area[3]+data_PA_AS_modif$area[2]+data_PA_AS_modif$area[1]+data_PA_AS_modif$area[8]/2
           )



p=ggplot() + geom_bar(data=data_PA_AS_modif, aes(x="AS", y=Prop_modif, fill=IUCN_cat_modif), stat="identity")+scale_fill_manual(values=color_values)+
    geom_text(aes(x="AS", y=label_as, label=as.character(round(data_PA_AS_modif$Prop_modif[c(7,5,4,2,8)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

ggsave(plot=p, filename = paste(dossier_as, "/Figure/PA" ,"/geom_bar_PA_in_AS_modif", ".png", sep=''), width=3*2, height=10*2, limitsize=F, dpi = 300)

### PLOT within PA only

data_PA_only_AS=data_PA_AS
data_PA_only_AS=data_PA_only_AS[-8,]
data_PA_only_AS$Prop=100*data_PA_only_AS$area_km2/sum(data_PA_only_AS$area_km2)
label_as=c(data_PA_only_AS$area[7]/2,
           
           data_PA_only_AS$area[7]+data_PA_only_AS$area[6]+data_PA_only_AS$area[5]/2,
           data_PA_only_AS$area[7]+data_PA_only_AS$area[6]+data_PA_only_AS$area[5]+data_PA_only_AS$area[4]/2,
           
           data_PA_only_AS$area[7]+data_PA_only_AS$area[6]+data_PA_only_AS$area[5]+data_PA_only_AS$area[4]+data_PA_only_AS$area[3]+data_PA_only_AS$area[2]/2
           )

color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(data_PA_AS$IUCN_cat_modif))))

p=ggplot() + geom_bar(data=data_PA_AS[-8,], aes(x="AS", y=area, fill=IUCN_cat_modif), stat="identity")+scale_fill_manual(values=color_values[-1])+
    # geom_text(aes(x="AS", y=label_as[-5], label=as.character(round(data_PA_AS$Prop[c(7,5,4,2)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

# ggsave(plot=p, filename = paste(dossier_as, "/Figure/PA" ,"/geom_bar_PA_only_in_AS", ".png", sep=''), width=3*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_as, "/Figure/PA" ,"/geom_bar_PA_only_in_AS_prop", ".png", sep=''), width=3*2, height=10*2, limitsize=F, dpi = 300)


```

## Elevation

```{r elevation}
Elevation=raster("Path/to/working/directory/CC_variable/CC_variable/CC_test/WorldClim/wc2.1_30s_elev/wc2.1_30s_elev.tif")
crs(Elevation)@projargs==crs(BB_Large_WGS84)@projargs
Elevation_cut_WGS84=crop(Elevation, BB_Large_WGS84)
Elevation_cut_ETRS=projectRaster(Elevation_cut_WGS84, crs=crs(BB_Large_ETRS89)@projargs)


Elev_in_AS=mask(Elevation_cut_WGS84, AS_fusion_WGS84)
length(Elev_in_AS@data@values[-which(is.na(Elev_in_AS@data@values))]) # 658271
Elev_in_AS_rd=data.frame(Elev=sampleRandom(Elev_in_AS, 20000, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_AS_rd)=c("Elev", "TOP")  

p=ggplot() + 
  geom_violin(data=Elev_in_AS_rd, aes(x=TOP, y=Elev, fill=TOP))+
  scale_fill_manual(values=c(
    # rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               # rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=4300 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
    # geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75)) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)


ggsave(plot=p, filename = paste(dossier_as, "/Figure/Elev" ,"/geom_violin_AS_Elev", ".png", sep=''), width=3*2, height=8*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/Elev" ,"/geom_violin_agrof_Elev_groups", ".png", sep=''), width=10*2, height=8*2, limitsize=F, dpi = 300)


```


## Drought RCP8.5
### Duration

```{r drought_duration}
### Soil moisture - Volume of water within the unsaturated zone of the soil profile. From CDS (Hydrological change)
### Drought duration - units = months. Relative change : 
dossier="Path/to/working/directory/CC_variable/CC_variable/CC_test/ClimateCentreDataStore/Soil moisture/dataset-sis-water-hydrological-change-Drought_duration_RCP2.6-8.5-Noah-MP/"
files=List_files_nc(dossier)
SM_Drought_RCP85=brick(paste(dossier, files[2], sep=''))
# Not the same CRS so do not overlap well with the others 


#### Ref period already prepared

# Soil_moisture_Drought_1971_2000=raster("Path/to/working/directory/CC_variable/CC_variable/CC_test/ClimateCentreDataStore/Soil moisture/dataset-sis-water-hydrological-change-Drought_duration_RCP2.6-8.5-Noah-MP/ReprojectedCut/Soil_moisture_drought_duration_1970-2000_Alpes_WGS84.tif")
# crs(Soil_moisture_Drought_1971_2000)@projargs==crs(Bounding_box)@projargs
# 
# Soil_moisture_Drought_1971_2000_cut=crop(Soil_moisture_Drought_1971_2000, Bounding_box)
# names(Soil_moisture_Drought_1971_2000_cut)="Soil_moisture_Drought_1970_2000"
# plot(Soil_moisture_Drought_1971_2000_cut, main='Soil moisture drought duration index 1970-2000')


### Ref period not prepared
Soil_moisture_Drought_1971_2000_EUROPE=raster("Path/to/working/directory/CC_variable/CC_variable/CC_test/ClimateCentreDataStore/Soil moisture/dataset-sis-water-hydrological-change-Drought_duration_RCP2.6-8.5-Noah-MP/ReprojectedCut/Soil_moisture_drought_duration_RCP85_1970-2000_WGS84.tif")
Soil_moisture_Drought_1971_2000_ALPS=crop(Soil_moisture_Drought_1971_2000_EUROPE, BB_Large_WGS84)
names(Soil_moisture_Drought_1971_2000_ALPS)="Soil_moisture_Drought_1971_2000_ALPS"
plot(Soil_moisture_Drought_1971_2000_ALPS, main='Soil moisture drought duration index 1970-2000')



# Soil moisture relative change
### With all the years ###
Soil_moisture_Drought_All_Year_RCP85=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ClimateCentreDataStore/Soil moisture/dataset-sis-water-hydrological-change-Drought_duration_RCP2.6-8.5-Noah-MP/ReprojectedCut/Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.tif")

crs(Soil_moisture_Drought_All_Year_RCP85)
Soil_moisture_Drought_All_Year_RCP85_cut=crop(Soil_moisture_Drought_All_Year_RCP85, BB_Large_WGS84)
extent(Soil_moisture_Drought_All_Year_RCP85_cut)==extent(Soil_moisture_Drought_1971_2000_ALPS)
plot(Soil_moisture_Drought_1971_2000_ALPS)


# Absolute drought value 2050
Soil_moisture_Drought_RCP85_2050_cut=Soil_moisture_Drought_1971_2000_ALPS*(1+Soil_moisture_Drought_All_Year_RCP85_cut$Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.6/100)
x11() + plot(Soil_moisture_Drought_RCP85_2050_cut)

# writeRaster(Soil_moisture_Drought_RCP85_2050_cut, "Path/to/working/directory/CC_variable/CC_variable/CC_test/ClimateCentreDataStore/Soil moisture/dataset-sis-water-hydrological-change-Drought_duration_RCP2.6-8.5-Noah-MP/2023/Soil_moisture_drought_duration_RCP85_abs_val_2050_Alps_WGS84.tif")


# Top Drought 2050
Values_Soil_moisture_Drought_RCP85_2050_in_AS=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, (Alpine_Space_WGS84), cellnumbers=T)[[1]]
nrow(Values_Soil_moisture_Drought_RCP85_2050_in_AS)
length(Soil_moisture_Drought_RCP85_2050_cut@data@values)
# Top 1%
quant1=quantile(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2], 0.99)[1]
Soil_moisture_Drought_RCP85_2050_in_AS_TOP1=Values_Soil_moisture_Drought_RCP85_2050_in_AS[which(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2]>quant1),]

Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1=raster::xyFromCell(Soil_moisture_Drought_RCP85_2050_cut, Soil_moisture_Drought_RCP85_2050_in_AS_TOP1[,1])
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1=as.data.frame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1)
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1$value=Soil_moisture_Drought_RCP85_2050_in_AS_TOP1[,2]

Points_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1=SpatialPointsDataFrame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1[,c(1,2)],data=Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1)
crs(Points_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1)@projargs=crs(BB_Large_WGS84)@projargs
x11() + plot(Soil_moisture_Drought_All_Year_RCP85_cut$Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.6)
plot(Alpine_Space_WGS84, add=T, alpha=0)
plot(Points_Soil_moisture_Drought_RCP85_2050_in_AS_TOP1, add=T, col='red')

# Top 10%
quant10=quantile(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2], 0.9)[1]
Soil_moisture_Drought_RCP85_2050_in_AS_TOP10=Values_Soil_moisture_Drought_RCP85_2050_in_AS[which(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2]>quant10),]

Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10=raster::xyFromCell(Soil_moisture_Drought_RCP85_2050_cut, Soil_moisture_Drought_RCP85_2050_in_AS_TOP10[,1])
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10=as.data.frame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10)
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10$value=Soil_moisture_Drought_RCP85_2050_in_AS_TOP10[,2]

Points_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10=SpatialPointsDataFrame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10[,c(1,2)],data=Coord_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10)
crs(Points_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10)@projargs=crs(BB_Large_WGS84)@projargs
x11() + raster::plot(Soil_moisture_Drought_RCP85_2050_cut)
raster::plot(AS_fusion_WGS84, add=T, alpha=0)
raster::plot(Points_Soil_moisture_Drought_RCP85_2050_in_AS_TOP10, add=T, col='red')

### For lower values
# last 1%
quant_l1=quantile(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2], 0.01)[1]
Soil_moisture_Drought_RCP85_2050_in_AS_LAST1=Values_Soil_moisture_Drought_RCP85_2050_in_AS[which(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2]<quant_l1),]

Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1=raster::xyFromCell(Soil_moisture_Drought_RCP85_2050_cut, Soil_moisture_Drought_RCP85_2050_in_AS_LAST1[,1])
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1=as.data.frame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1)
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1$value=Soil_moisture_Drought_RCP85_2050_in_AS_LAST1[,2]

Points_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1=SpatialPointsDataFrame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1[,c(1,2)],data=Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1)
crs(Points_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1)@projargs=crs(BB_Large_WGS84)@projargs
x11() + plot(Soil_moisture_Drought_RCP85_2050_cut)
plot(AS_fusion_WGS84, add=T, alpha=0)
plot(Points_Soil_moisture_Drought_RCP85_2050_in_AS_LAST1, add=T, col='red')

# last 10%
quant_l10=quantile(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2], 0.01)[1]
Soil_moisture_Drought_RCP85_2050_in_AS_LAST10=Values_Soil_moisture_Drought_RCP85_2050_in_AS[which(Values_Soil_moisture_Drought_RCP85_2050_in_AS[,2]<quant_l10),]

Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10=raster::xyFromCell(Soil_moisture_Drought_RCP85_2050_cut, Soil_moisture_Drought_RCP85_2050_in_AS_LAST10[,1])
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10=as.data.frame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10)
Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10$value=Soil_moisture_Drought_RCP85_2050_in_AS_LAST10[,2]

Points_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10=SpatialPointsDataFrame(Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10[,c(1,2)],data=Coord_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10)
crs(Points_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10)@projargs=crs(BB_Large_WGS84)@projargs
x11() + plot(Soil_moisture_Drought_RCP85_2050_cut)
plot(AS_fusion_WGS84, add=T, alpha=0)
plot(Points_Soil_moisture_Drought_RCP85_2050_in_AS_LAST10, add=T, col='red')

##

# Absolute drought value 2100
Soil_moisture_Drought_RCP85_2100_cut=Soil_moisture_Drought_1971_2000_ALPS*(1+Soil_moisture_Drought_All_Year_RCP85_cut$Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.12/100)
x11() + plot(Soil_moisture_Drought_RCP85_2100_cut)
raster::plot(AS_fusion_WGS84, add=T, alpha=0)

# writeRaster(Soil_moisture_Drought_RCP85_2100_cut, "Path/to/working/directory/CC_variable/CC_variable/CC_test/ClimateCentreDataStore/Soil moisture/dataset-sis-water-hydrological-change-Drought_duration_RCP2.6-8.5-Noah-MP/2023/Soil_moisture_drought_duration_RCP85_abs_val_2100_Alps_WGS84.tif")

# Top Drought 2100
Values_Soil_moisture_Drought_RCP85_2100_in_AS=raster::extract(Soil_moisture_Drought_RCP85_2100_cut, (AS_fusion_WGS84), cellnumbers=T)[[1]]
nrow(Values_Soil_moisture_Drought_RCP85_2100_in_AS)
length(Soil_moisture_Drought_RCP85_2100_cut@data@values)
# Top 1%
quant1=quantile(Values_Soil_moisture_Drought_RCP85_2100_in_AS[,2], 0.99)[1]
Soil_moisture_Drought_RCP85_2100_in_AS_TOP1=Values_Soil_moisture_Drought_RCP85_2100_in_AS[which(Values_Soil_moisture_Drought_RCP85_2100_in_AS[,2]>quant1),]

Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1=raster::xyFromCell(Soil_moisture_Drought_RCP85_2100_cut, Soil_moisture_Drought_RCP85_2100_in_AS_TOP1[,1])
Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1=as.data.frame(Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1)
Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1$value=Soil_moisture_Drought_RCP85_2100_in_AS_TOP1[,2]

Points_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1=SpatialPointsDataFrame(Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1[,c(1,2)],data=Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1)
crs(Points_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1)@projargs=crs(BB_Large_WGS84)@projargs
x11() + plot(Soil_moisture_Drought_RCP85_2100_cut, col=terrain.colors(255))
plot(AS_fusion_WGS84, add=T, alpha=0)
plot(Points_Soil_moisture_Drought_RCP85_2100_in_AS_TOP1, add=T, col='red')

# Top 10%
quant10=quantile(Values_Soil_moisture_Drought_RCP85_2100_in_AS[,2], 0.9)[1]
Soil_moisture_Drought_RCP85_2100_in_AS_TOP10=Values_Soil_moisture_Drought_RCP85_2100_in_AS[which(Values_Soil_moisture_Drought_RCP85_2100_in_AS[,2]>quant10),]

Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10=raster::xyFromCell(Soil_moisture_Drought_RCP85_2100_cut, Soil_moisture_Drought_RCP85_2100_in_AS_TOP10[,1])
Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10=as.data.frame(Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10)
Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10$value=Soil_moisture_Drought_RCP85_2100_in_AS_TOP10[,2]

Points_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10=SpatialPointsDataFrame(Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10[,c(1,2)],data=Coord_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10)
crs(Points_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10)@projargs=crs(BB_Large_WGS84)@projargs
x11() + raster::plot(Soil_moisture_Drought_RCP85_2100_cut)
raster::plot(AS_fusion_WGS84, add=T, alpha=0)
raster::plot(Points_Soil_moisture_Drought_RCP85_2100_in_AS_TOP10, add=T, col='red')


### Zonal stat Drought by watersheds lv12
crs(HydroBasin_l12_cut)@projargs==crs(Soil_moisture_Drought_RCP85_2050_cut)@projargs


Soil_moisture_Drought_RCP85_2050_WS12=zonal.stats(HydroBasin_l12_ALPS_int_sp,Soil_moisture_Drought_RCP85_2050_cut, stats = 'mean')

HydroBasin_l12_ALPS_int_sp$Drought2050=Soil_moisture_Drought_RCP85_2050_WS12$mean.layer


# T %in% is.na(HydroBasin_l12_cut$AWY2100) # FALSE => ok, no na
# x11() + plot(HydroBasin_l12_cut)
# str(HydroBasin_l12_cut$AWY2100)
# summary(HydroBasin_l12_cut$AWY2100)
# hist(HydroBasin_l12_cut$AWY2100)
# class(HydroBasin_l12_cut)
# # x11() + print(spplot(HydroBasin_l12_cut, zcol=c("AWY2100"), col.regions=brewer.pal(9,"Blues")))
# # p=spplot(HydroBasin_l12_cut, zcol=c("AWY2100"), col.regions=(gradient_n_pal(brewer_pal("seq")(5))(seq(0,1, length.out=20))))
# 
# # AWY in Alpine space
# crs(HydroBasin_l12_cut)@projargs==crs(Alpine_Space_WGS84)@projargs
# 
# sf::sf_use_s2(FALSE)
# HydroBasin_l12_ALPS_int=sf::st_intersection(as(HydroBasin_l12_cut, "sf"), as(Alpine_Space_WGS84, "sf"))
# sf::sf_use_s2(T)
# # Not the same geometries, need to have only polygons
# types <- vapply(sf::st_geometry(HydroBasin_l12_ALPS_int), function(x) {
#     class(x)[2]
# }, "")
# 
# unique(types)
# polys <- HydroBasin_l12_ALPS_int[ grepl("*POLYGON", types), ]
# HydroBasin_l12_ALPS_int_sp=sf::as_Spatial(polys)

Soil_moisture_Drought_RCP85_2100_WS12=zonal.stats(HydroBasin_l12_ALPS_int_sp,Soil_moisture_Drought_RCP85_2100_cut, stats = 'mean')

HydroBasin_l12_ALPS_int_sp$Drought2100=Soil_moisture_Drought_RCP85_2100_WS12$mean.layer

### Zonal stat for relative change too
Soil_moisture_Rel_Drought_RCP85_2050_WS12=zonal.stats(HydroBasin_l12_ALPS_int_sp,Soil_moisture_Drought_All_Year_RCP85_cut$Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.6, stats = 'mean')

HydroBasin_l12_ALPS_int_sp$RelDrought2050=Soil_moisture_Rel_Drought_RCP85_2050_WS12$mean.Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.6

Soil_moisture_Rel_Drought_RCP85_2100_WS12=zonal.stats(HydroBasin_l12_ALPS_int_sp,Soil_moisture_Drought_All_Year_RCP85_cut$Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.12, stats = 'mean')

HydroBasin_l12_ALPS_int_sp$RelDrought2100=Soil_moisture_Rel_Drought_RCP85_2100_WS12$mean.Soil_moisture_drought_duration_RCP85_rel_change_all_years_WGS84.12



```

#### Distribution by LULC/elev

```{r drought_distrib_lulc}
### Distribution of drought by elevation range / LULC


raster::crs(Soil_moisture_Drought_RCP85_2050_cut)
plot(Soil_moisture_Drought_RCP85_2050_cut)

LULC_shp_WGS84=spTransform(LULC_shp, crs(BB_Large_WGS84))
crs(LULC_shp_WGS84)@projargs==crs(Soil_moisture_Drought_RCP85_2050_cut)@projargs

LULC_shp_WGS84$LU_modif=NA
for (i in levels(as.factor(LULC_shp_WGS84$DN))){
  LULC_shp_WGS84$LU_modif[which(LULC_shp_WGS84$DN==i)]=legend_LULC$CLC_modif[which(legend_LULC$GRID_CODE==i)]
  
}

AbsDrough2050_Forest_AS=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, LULC_shp_WGS84[which(LULC_shp_WGS84$LU_modif %in% c("FORm", "FORb", "FORc")),])
AbsDrough2050_Forest_AS_df=c()
for (i in 1:length(AbsDrough2050_Forest_AS)){
  AbsDrough2050_Forest_AS_df=c(AbsDrough2050_Forest_AS_df, AbsDrough2050_Forest_AS[[i]])
}

AbsDrough2050_Crop_AS=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, LULC_shp_WGS84[which(LULC_shp_WGS84$LU_modif %in% c("ARAn", "ARAi", "RICE", "VINE", "FRUI", "OLI", "CRO", "COM", "AGR", "AFA")),])

AbsDrough2050_Crop_AS_df=c()
for (i in 1:length(AbsDrough2050_Crop_AS)){
  AbsDrough2050_Crop_AS_df=c(AbsDrough2050_Crop_AS_df, AbsDrough2050_Crop_AS[[i]])
}



AbsDrough2050_Grassland_AS=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, LULC_shp_WGS84[which(LULC_shp_WGS84$LU_modif %in% c("PAS", "GRAS", "TWS", "SCL", "MOO")),])
AbsDrough2050_Grassland_AS_df=c()
for (i in 1:length(AbsDrough2050_Grassland_AS)){
  AbsDrough2050_Grassland_AS_df=c(AbsDrough2050_Grassland_AS_df, AbsDrough2050_Grassland_AS[[i]])
}


AbsDrough2050_Urban_AS=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, LULC_shp_WGS84[which(LULC_shp_WGS84$LU_modif %in% c("URBc", "URBd", "IND", "ROA", "POR", "AIR", "MIN", "DUM", "BAT", "GUI", "SPO" )),])
AbsDrough2050_Urban_AS_df=c()
for (i in 1:length(AbsDrough2050_Urban_AS)){
  AbsDrough2050_Urban_AS_df=c(AbsDrough2050_Urban_AS_df, AbsDrough2050_Urban_AS[[i]])
}

p=ggplot() +
  geom_boxplot(aes(x="Forest", y=AbsDrough2050_Forest_AS_df), stat = "boxplot") +
  geom_boxplot(aes(x="Crop", y=AbsDrough2050_Crop_AS_df), stat="boxplot")+
  geom_boxplot(aes(x="Grasslands", y=AbsDrough2050_Grassland_AS_df), stat="boxplot")+
  geom_boxplot(aes(x="Urban", y=AbsDrough2050_Urban_AS_df), stat="boxplot")


####### Distribution by elevation

Elev_shp_0_500=rasterToPolygons(Elevation_cut_ETRS, function(x){return(x<500)}, na.rm=T, dissolve=T)


AbsDrough2050_elev0_500=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_0_500)
AbsDrough2050_elev0_500_df=c()
for (i in 1:length(AbsDrough2050_elev0_500)){
  AbsDrough2050_elev0_500_df=c(AbsDrough2050_elev0_500_df, AbsDrough2050_elev0_500[[i]])
  
}
summary(AbsDrough2050_elev0_500_df)

### Import elevation range
Elev_shp_0_500_v2=shapefile("Path/to/working/directory/Elevation/Elevation_vectorised_0_500m_Alps_ETRS.shp")
Elev_shp_500_1000=shapefile("Path/to/working/directory/Elevation/Elevation_vectorised_500_1000m_Alps_ETRS.shp")
Elev_shp_1000_1500=shapefile("Path/to/working/directory/Elevation/Elevation_vectorised_1000_1500m_Alps_ETRS.shp")
Elev_shp_1500_2000=shapefile("Path/to/working/directory/Elevation/Elevation_vectorised_1500_2000m_Alps_ETRS.shp")
Elev_shp_2000_2500=shapefile("Path/to/working/directory/Elevation/Elevation_vectorised_2000_2500m_Alps_ETRS.shp")
Elev_shp_2500_3000=shapefile("Path/to/working/directory/Elevation/Elevation_vectorised_2500_3000m_Alps_ETRS.shp")
Elev_shp_3000_sup=shapefile("Path/to/working/directory/Elevation/Elevation_vectorised_3000m_sup_Alps_ETRS.shp")


AbsDrough2050_elev_500_1000=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_500_1000)
AbsDrough2050_elev_500_1000_df=c()
for (i in 1:length(AbsDrough2050_elev_500_1000)){
  AbsDrough2050_elev_500_1000_df=c(AbsDrough2050_elev_500_1000_df, AbsDrough2050_elev_500_1000[[i]])
}


AbsDrough2050_elev_1000_1500=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_1000_1500)
AbsDrough2050_elev_1000_1500_df=c()
for (i in 1:length(AbsDrough2050_elev_1000_1500)){
  AbsDrough2050_elev_1000_1500_df=c(AbsDrough2050_elev_1000_1500_df, AbsDrough2050_elev_1000_1500[[i]])
}
# AbsDrough2050_elev_500_1000

AbsDrough2050_elev_1000_1500=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_1000_1500)
AbsDrough2050_elev_500_1000_df=c()
for (i in 1:length(AbsDrough2050_elev_500_1000)){
  AbsDrough2050_elev_500_1000_df=c(AbsDrough2050_elev_500_1000_df, AbsDrough2050_elev_500_1000[[i]])
  
}
# AbsDrough2050_elev_500_1000=AbsDrough2050_elev_500_1000[[1]]


AbsDrough2050_elev_1500_2000=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_1500_2000)
AbsDrough2050_elev_1500_2000_df=c()
for (i in 1:length(AbsDrough2050_elev_1500_2000)){
  AbsDrough2050_elev_1500_2000_df=c(AbsDrough2050_elev_1500_2000_df, AbsDrough2050_elev_1500_2000[[i]])
  
}

AbsDrough2050_elev_2000_2500=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_2000_2500)
AbsDrough2050_elev_2000_2500_df=c()
for (i in 1:length(AbsDrough2050_elev_2000_2500)){
  AbsDrough2050_elev_2000_2500_df=c(AbsDrough2050_elev_2000_2500_df, AbsDrough2050_elev_2000_2500[[i]])
}
# AbsDrough2050_elev_2000_2500_df=AbsDrough2050_elev_2000_2500_df[[1]]

AbsDrough2050_elev_2500_3000=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_2500_3000)
AbsDrough2050_elev_2500_3000_df=c()
for (i in 1:length(AbsDrough2050_elev_2500_3000)){
  AbsDrough2050_elev_2500_3000_df=c(AbsDrough2050_elev_2500_3000_df, AbsDrough2050_elev_2500_3000[[i]])
}
# AbsDrough2050_elev_2500_3000_df=AbsDrough2050_elev_2500_3000_df[[1]]

AbsDrough2050_elev_3000_sup=raster::extract(Soil_moisture_Drought_RCP85_2050_cut, Elev_shp_3000_sup)
AbsDrough2050_elev_3000_sup_df=c()
for (i in 1:length(AbsDrough2050_elev_3000_sup)){
  AbsDrough2050_elev_3000_sup_df=c(AbsDrough2050_elev_3000_sup_df, AbsDrough2050_elev_3000_sup[[i]])
}
# AbsDrough2050_elev_2500_3000=AbsDrough2050_elev_2500_3000[[1]]


p=ggplot() +
  geom_boxplot(aes(x="0-500", y=AbsDrough2050_elev_500_1000_df), stat = "boxplot") +
  geom_boxplot(aes(x="0500-1000", y=AbsDrough2050_elev_500_1000_df), stat="boxplot")+
  geom_boxplot(aes(x="1000-1500", y=AbsDrough2050_elev_1000_1500_df), stat="boxplot")+
  geom_boxplot(aes(x="1500-2000", y=AbsDrough2050_elev_1500_2000_df), stat="boxplot")+
  geom_boxplot(aes(x="2000-2500", y=AbsDrough2050_elev_2000_2500_df), stat="boxplot")+
  geom_boxplot(aes(x="2500-3000", y=AbsDrough2050_elev_2500_3000_df), stat="boxplot")+
  geom_boxplot(aes(x="3000-4500", y=AbsDrough2050_elev_3000_sup_df), stat="boxplot")


```



## Groundwater recharge RCP8.5
Def CDS: Volume of percolating water through the unsaturated zone to the aquifer.

```{r groundwater}

dossier="Path/to/working/directory/CC_variable/CC_variable/CC_test/ClimateCentreDataStore/HydroChange/Groundwater/dataset-sis-water-hydrological-change-groundwater/"
files=list.files(dossier)
files_nc=files[(grep(pattern=".nc", as.character(files), value=F))]
files_nc_rcp=files_nc[(grep(pattern="8p5", as.character(files_nc), value=F))]

##########

# files_nc_historical=files_nc[(grep(pattern="histo", as.character(files_tif), value=F))]
# files_tif_rcp85=files_tif[(grep(pattern="rcp85", as.character(files_tif), value=F))]
seasons=c("DJF", "MAM", "JJA", "SON")

##### Historical value
Groundwater_historical_4_seasons=list()
for (i in 1:4){
  Groundwater_historical_4_seasons[i]=brick(paste(dossier, files_nc_rcp[grep(seasons[i], as.character(files_nc_rcp))], sep=''), var="ref_var_threshold")
}

str(Groundwater_historical_4_seasons[[1]])
# plot(Groundwater_historical_4_seasons[[1]]) + plot(Bounding_box_ETRS ,add=T, col='red')

### Change crs
Groundwater_historical_4_seasons_WGS84=list()
for (i in 1:length(Groundwater_historical_4_seasons)){
  crs(Groundwater_historical_4_seasons[[i]])@projargs=crs(Soil_moisture_Drought_1971_2000_ETRS)@projargs
  Groundwater_historical_4_seasons_WGS84[i]=projectRaster(Groundwater_historical_4_seasons[[i]], crs=crs(SM_Drought_RCP85_WGS84)@projargs)
  
}

str(Groundwater_historical_4_seasons_WGS84[[1]])
plot(Groundwater_historical_4_seasons_WGS84[[1]]) + plot(BB_Large_WGS84 ,add=T, col='red')
crs(Groundwater_historical_4_seasons_WGS84[[1]])@projargs==crs(SM_Drought_RCP85_WGS84)@projargs

summary(Groundwater_historical_4_seasons_WGS84[[4]]) # No <0 values 


### RCP 8.5 values
Groundwater_rcp85_4_seasons_abs_value_2100_WGS84=list()
for (i in 1:length(Groundwater_rcp85_4_seasons_WGS84)){
  Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]]=Groundwater_historical_4_seasons_WGS84[[i]]*(1+(Groundwater_rcp85_4_seasons_WGS84[[i]][[12]]/100))
}
summary(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[1]])
hist(log10(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[1]]))
for (i in 1:4){
  Values_raster=raster::extract(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]], extent(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]]))
  print(length(Values_raster[which(Values_raster<0)])/length(Values_raster)) # Proportion of <0 values:  1.3e-05 / 4.0e-06 / 6.3e-06 / 3.4e-05
  print(summary(Values_raster)[7]/ length(Values_raster)) # Proportion of NA : 85.8% for all seasons
  
  
  if (length(Values_raster[which(Values_raster<0)])!=0){
    Values_raster[which(Values_raster<0)]=0
    Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]]=setValues(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]], Values_raster)
  }
}

# Plot the 4 seasons values
x11() 
par(mfrow=c(2,2))
for (i in 1:4){plot(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]], xlab=seasons[i])}

# Plot cor between 2000 and 2100
summary(Groundwater_historical_4_seasons_WGS84[[1]])
summary(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[1]])

list_cor_Groundwater_2100_2000=list()
x11()
par(mfrow=c(2,2))
for (i in 1:4){
  list_cor_Groundwater_2100_2000[[i]]=corLocal(Groundwater_historical_4_seasons_WGS84[[i]], Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]], test = T)
  plot(list_cor_Groundwater_2100_2000[[i]]$pearson)
}
# Cor_Groundwater_DJF_2100_2000_sans_NA=corLocal(Groundwater_historical_4_seasons_WGS84[[1]], Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[1]], test = T, na.rm=T)
# plot(Cor_Groundwater_DJF_2100_2000$pearson)
# summary(Cor_Groundwater_DJF_2100_2000$pearson)


# Write raster absolute values 2100
for (i in 1:4){
  print(seasons[i])
  writeRaster(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]], paste(dossier, "groundwater_rcp85_mean_seasonal_abs_values_2100_", seasons[i], ".tif", sep=''), overwrite=T)
}


### Zonal stat by watersheds

### Zonal stat Drought by watersheds lv12
crs(Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]])@projargs==crs(HydroBasin_l12_cut)@projargs
Groundwater_2100_seasons_stat_zonal_WS12_WGS84=list()
for (i in 1:4){
  Groundwater_2100_seasons_stat_zonal_WS12_WGS84[[i]]=zonal.stats(HydroBasin_l12_ALPS_int_sp, Groundwater_rcp85_4_seasons_abs_value_2100_WGS84[[i]], stats='sum')
}

summary(Groundwater_2100_seasons_stat_zonal_WS12_WGS84[[1]]$sum.layer)
for (i in 1:4){
  # HydroBasin_l12_ALPS_int_sp[,ncol(HydroBasin_l12_ALPS_int_sp)+1]=Groundwater_2100_seasons_stat_zonal_WS12_WGS84[[i]]$sum.layer
    HydroBasin_l12_ALPS_int_sp=cbind(HydroBasin_l12_ALPS_int_sp,Groundwater_2100_seasons_stat_zonal_WS12_WGS84[[i]]$sum.layer)
}
new_colnames=c()
for (i in 1:4){
  new_colnames=c(new_colnames, paste("Groundwater_2100_", seasons[i], sep=''))
}

colnames(HydroBasin_l12_ALPS_int_sp@data)=c(colnames(HydroBasin_l12_ALPS_int_sp@data)[-c((ncol(HydroBasin_l12_ALPS_int_sp@data)-3):ncol(HydroBasin_l12_ALPS_int_sp@data))],new_colnames)

T %in% is.na(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_DJF) # FALSE => ok, no na
T %in% is.na(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_MAM) # FALSE => ok, no na
T %in% is.na(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA) # FALSE => ok, no na
T %in% is.na(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_SON) # FALSE => ok, no na

#### Divide by the surface of the watersheds

HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2050_DJF=HydroBasin_l12_ALPS_int_sp$Groundwater_2050_DJF/raster::area(HydroBasin_l12_ALPS_int_sp)
HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2050_MAM=HydroBasin_l12_ALPS_int_sp$Groundwater_2050_MAM/raster::area(HydroBasin_l12_ALPS_int_sp)
HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2050_JJA=HydroBasin_l12_ALPS_int_sp$Groundwater_2050_JJA/raster::area(HydroBasin_l12_ALPS_int_sp)
HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2050_SON=HydroBasin_l12_ALPS_int_sp$Groundwater_2050_SON/raster::area(HydroBasin_l12_ALPS_int_sp)
HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_DJF=HydroBasin_l12_ALPS_int_sp$Groundwater_2100_DJF/raster::area(HydroBasin_l12_ALPS_int_sp)
HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_MAM=HydroBasin_l12_ALPS_int_sp$Groundwater_2100_MAM/raster::area(HydroBasin_l12_ALPS_int_sp)
HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_JJA=HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA/raster::area(HydroBasin_l12_ALPS_int_sp)
HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_SON=HydroBasin_l12_ALPS_int_sp$Groundwater_2100_SON/raster::area(HydroBasin_l12_ALPS_int_sp)

```

### Correlation Abs Drought

```{r groundwater_drought}
# Correlation drought / groundwater
# With absolute and relative values
corrplot.mixed(cor(data_pca_sans_NA, method="spearman"), tl.cex=0.6, tl.pos="lt", lower="number", number.cex=0.6)
corrplot(cor(data_pca_sans_NA, method="pearson"), method ="number", tl.cex=0.6, type="lower", number.cex=0.8)
#
corrplot.mixed(cor(HydroBasin_l12_ALPS_int_sp@data[,c(grep("Drought2", colnames(HydroBasin_l12_ALPS_int_sp@data)),grep("Groundwater_2", colnames(HydroBasin_l12_ALPS_int_sp@data)))], method = "spearman"), tl.cex=0.6, tl.pos="lt", lower="number", number.cex=0.6)


##### 2100 
##########
dossier_models="Path/to/working/directory/R/Figure/Data_in_WS/Models/2100"
# Correlation Drought / Groundwater Winter
plot(HydroBasin_l12_ALPS_int_sp$Drought2100,
     log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_DJF)) # Seems to be negatively correlated with log
lm_Drought_Groundwater_Winter_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_DJF)~(HydroBasin_l12_ALPS_int_sp$Drought2100))
summary(lm_Drought_Groundwater_Winter_2100) #  p-value: < 2.2e-16 / r2 = 0.1561
plot_models(HydroBasin_l12_ALPS_int_sp, "Drought2100", "Groundwater_2100_DJF", lm_Drought_Groundwater_Winter_2100, dossier_models, TRUE)

# Correlation Drought / Groundwater Spring
plot(HydroBasin_l12_ALPS_int_sp$Drought2100,
     log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_MAM)) # Seems to be negatively correlated with log
lm_Drought_Groundwater_Spring_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_MAM)~(HydroBasin_l12_ALPS_int_sp$Drought2100))
summary(lm_Drought_Groundwater_Spring_2100) # p-value: < 2.2e-16 / r2 = 0.3072
plot_models(HydroBasin_l12_ALPS_int_sp, "Drought2100", "Groundwater_2100_MAM", lm_Drought_Groundwater_Spring_2100, dossier_models, TRUE)

# Correlation Drought / Groundwater Summer
plot(HydroBasin_l12_ALPS_int_sp$Drought2100,
     log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA)) # Seems to be negatively correlated with  log
lm_Drought_Groundwater_Summer_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA)~(HydroBasin_l12_ALPS_int_sp$Drought2100)) 
summary(lm_Drought_Groundwater_Summer_2100) #  p-value: < 2.2e-16 with log !! r2= 0.7026 !!!! 
plot_models(HydroBasin_l12_ALPS_int_sp, "Drought2100", "Groundwater_2100_JJA", lm_Drought_Groundwater_Summer_2100, dossier_models, TRUE)

# Correlation Drought / Groundwater Autumn
plot(HydroBasin_l12_ALPS_int_sp$Drought2100,
     log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_SON)) # Seems to be negatively correlated
lm_Drought_Groundwater_Autumn_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_SON)~(HydroBasin_l12_ALPS_int_sp$Drought2100))
summary(lm_Drought_Groundwater_Autumn_2100) # p-value: < 2.2e-16 # r2 = 0.546 
plot_models(HydroBasin_l12_ALPS_int_sp, "Drought2100", "Groundwater_2100_SON", lm_Drought_Groundwater_Autumn_2100, dossier_models, TRUE)




##### Correlation with mean groundwater (divided by WS surface)
# Correlation Drought / Groundwater Summer 2100
plot(HydroBasin_l12_ALPS_int_sp$Drought2100,
     log(HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_JJA)) # Seems to be negatively correlated with  log
lm_Drought_mean_Groundwater_Summer_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_JJA)~(HydroBasin_l12_ALPS_int_sp$Drought2100)) 
summary(lm_Drought_mean_Groundwater_Summer_2100) #  p-value: < 2.2e-16 with log !! r2= 0.63 !!!! 
plot_models(HydroBasin_l12_ALPS_int_sp, "Drought2100", "Groundwater_mean_2100_JJA", lm_Drought_mean_Groundwater_Summer_2100, dossier_models, TRUE)




```

#### Bias to map
```{r bias_groundwater_2100}
## Best model 2100: 
dossier_models="Path/to/working/directory/R/Figure/Data_in_WS/Models/Groundwater_Drought/2100/Drought_log_Groundwater_JJA_2100/"
##################
lm_Drought_Groundwater_Summer_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA)~(HydroBasin_l12_ALPS_int_sp$Drought2100)) 
summary(lm_Drought_Groundwater_Summer_2100) #  p-value: < 2.2e-16 with log. r2= 0.7026 
plot_models(HydroBasin_l12_ALPS_int_sp,x = "Drought2100", y ="Groundwater_2100_JJA",lm_Drought_Groundwater_Summer_2100, dossier_models, log=T  )



## plot with elevation
p=ggplot(HydroBasin_l12_ALPS_int_sp@data) + geom_point(aes(x=Drought2100/30, y=log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA), colour=Elevation_median)) + geom_smooth(aes(x=Drought2100/30, y=log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA)), colour="red", method="lm") + theme_classic()
fx(p)
ggsave(plot=p, filename = paste(dossier_models, "/geom_points_Abs_Drought_Log_Groundwater_JJA_2100_elevation", ".png", sep=''), width=7*2, height=5*2, limitsize=F, dpi = 300)

## Plot with number of months /year (=/30)
p=ggplot(HydroBasin_l12_ALPS_int_sp@data) + geom_point(aes(x=Drought2100/30, y=log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA), colour=Elevation_median)) + geom_smooth(aes(x=Drought2100/30, y=log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA)), colour="red", method="lm") + theme_classic() + scale_x_continuous(breaks = c(2, 4, 6, 8)) +  theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20), axis.title.x = element_text(size = 30), axis.title.y = element_text(size = 30)) +  xlab("Future soil moisture (number of months)
") + ylab("Log-transformed future summer groundwater")
fx(p)
ggsave(plot=p, filename = paste(dossier_models, "/geom_points_Abs_Drought_per_year_Log_Groundwater_JJA_2100_elevation_text_20", ".png", sep=''), width=7*2, height=5*2, limitsize=F, dpi = 300)
###


HydroBasin_l12_ALPS_int_sp$fitted_log_Groundwater_2100_JJA=(summary(lm_Drought_Groundwater_Summer_2100)$coefficients[1,1] + summary(lm_Drought_Groundwater_Summer_2100)$coefficients[2,1]*HydroBasin_l12_ALPS_int_sp$Drought2100)
HydroBasin_l12_ALPS_int_sp$Log_Groundwater_2100_JJA=log(HydroBasin_l12_ALPS_int_sp$Groundwater_2100_JJA)


### Compute the distance between observed and predicted values
HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_JJA=HydroBasin_l12_ALPS_int_sp$Log_Groundwater_2100_JJA-HydroBasin_l12_ALPS_int_sp$fitted_log_Groundwater_2100_JJA
# Plot
plot(HydroBasin_l12_ALPS_int_sp$Drought2100, HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_JJA)
abline(h=0, col='red')
### With elevation
p=ggplot(HydroBasin_l12_ALPS_int_sp@data) + geom_point(aes(x=Drought2100, y=dist_Groundwater_2100_JJA, colour=Elevation_median)) + geom_hline(yintercept = 0) + theme_classic()
fx(p)
ggsave(plot=p, filename = paste(dossier_models, "/geom_points_dist_model_Abs_Drought_Log_Groundwater_JJA_2100_elevation", ".png", sep=''), width=6*2, height=5*2, limitsize=F, dpi = 300)

### Plot value of dist but with relative change of drought
p=ggplot(HydroBasin_l12_ALPS_int_sp@data) + geom_point(aes(x=RelDrought2100, y=dist_Groundwater_2100_JJA, colour=Elevation_median)) + geom_hline(yintercept = 0) + theme_classic() +  theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20), axis.title.x = element_text(size = 30), axis.title.y = element_text(size = 30)) +  xlab("Relative change in drought duration (%)") + ylab("Groundwater anomalies
")
fx(p)
ggsave(plot=p, filename = paste(dossier_models, "/geom_points_dist_model_Abs_Drought_Log_Groundwater_with_RelDrought_JJA_2100_elevation_text_20", ".png", sep=''), width=6*2, height=5*2, limitsize=F, dpi = 300)


# spplot(HydroBasin_l12_ALPS_int_sp, zcol="dist_Groundwater_2100_JJA")
HydroBasin_l12_ALPS_int_sp=HydroBasin_l12_ALPS_int_sp[order(HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_JJA, decreasing = T),]
HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_JJA_RANK=1:nrow(HydroBasin_l12_ALPS_int_sp)
spplot(HydroBasin_l12_ALPS_int_sp, zcol="dist_Groundwater_2100_JJA_RANK")


# Select the top10 drought
HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100=HydroBasin_l12_ALPS_int_sp[which(HydroBasin_l12_ALPS_int_sp$Drought2100>quantile(HydroBasin_l12_ALPS_int_sp$Drought2100, 0.9)),]
# plot drought~dist
plot(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$Drought2100, HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_JJA)
abline(h=0, col='red')
# Assess the sign of the most distance to the predicted value

HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_TOP10_Drought_2100=0
# For positive ones (conservation priorities)
HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_JJA>quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_JJA, 0.9))]=1

# For negative ones (restoration priorities) 
HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_JJA<quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_JJA, 0.1))]=-1

HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_TOP10_Drought_2100=as.factor(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_TOP10_Drought_2100)

# plot dist~drought with the top10 for actions
p=ggplot(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100@data) + geom_point(aes(x=Drought2100,
     y= dist_Groundwater_2100_JJA,
     colour=TOP10_dist_Groundwater_TOP10_Drought_2100)) + scale_colour_manual(values=c("#E69F00","#000000","#009E73"))


p=ggplot(HydroBasin_l12_ALPS_int_sp@data) + geom_point(aes(x=Drought2100, y=Groundwater_2100_JJA)) +
  geom_point(data=HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100@data, aes(x=Drought2100,
     y= Groundwater_2100_JJA, colour=TOP10_dist_Groundwater_TOP10_Drought_2100)) + scale_colour_manual(values=c("#E69F00","#000000","#009E73"))

# #1f78b4 blue
# #b2df8a green
# color_VRK3=c("#07d400", "#b51b0d","#edca00", "#000000",  "#3347ff", "#00bcc9",  "#b60ddb", "#9fa4c9", "#FFFFFF")

# p=spplot(HydroBasin_l12_ALPS_int_sp, zcol=c("dist_Groundwater_2100_JJA"), col.regions=(gradient_n_pal(brewer_pal("div")(5))(seq(0,1, length.out=20))))
# fx(p)

# Try to plot the map  of the top10 <0 and >0
HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100=0
HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100[which(HydroBasin_l12_ALPS_int_sp$Drought2100>quantile(HydroBasin_l12_ALPS_int_sp$Drought2100, 0.9))]=1

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_TOP10_Drought_2100=0

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100==1 & HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_JJA>quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_JJA, 0.9))]=1

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100==1 & HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_JJA<quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_JJA, 0.1))]=-1

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_TOP10_Drought_2100=as.factor(HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_TOP10_Drought_2100)

p=spplot(HydroBasin_l12_ALPS_int_sp, zcol=c("TOP10_dist_Groundwater_TOP10_Drought_2100"), col.regions=c("#E69F00","#FFFFFF","#009E73"), sp.layout=Countries_BB_Large_WGS84_sp)
fx(p) 
# + plot(Countries_BB_Large_WGS84_sp, col='red', add=T)


# Select the top10 drought
HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100=HydroBasin_l12_ALPS_int_sp[which(HydroBasin_l12_ALPS_int_sp$Drought2100>quantile(HydroBasin_l12_ALPS_int_sp$Drought2100, 0.9)),]
# plot drought~dist
plot(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$Drought2100, HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_SON)
abline(h=0, col='red')
# Assess the sign of the most distance to the predicted value

HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_SON_TOP10_Drought_2100=0
# For positive ones (conservation priorities)
HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_SON_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_SON>quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_SON, 0.9))]=1

# For negative ones (restoration priorities) 
HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_SON_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_SON<quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_SON, 0.1))]=-1

HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_SON_TOP10_Drought_2100=as.factor(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$TOP10_dist_Groundwater_SON_TOP10_Drought_2100)

# plot dist~drought with the top10 for actions
p=ggplot(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100@data) + geom_point(aes(x=Drought2100,
     y= dist_Groundwater_2100_SON,
     colour=TOP10_dist_Groundwater_SON_TOP10_Drought_2100)) + scale_colour_manual(values=c("#E69F00","#000000","#009E73"))

p=ggplot(HydroBasin_l12_ALPS_int_sp@data) + geom_point(aes(x=Drought2100, y=Groundwater_2100_SON)) +
  geom_point(data=HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100@data, aes(x=Drought2100,
     y= Groundwater_2100_SON, colour=TOP10_dist_Groundwater_SON_TOP10_Drought_2100)) + scale_colour_manual(values=c("#E69F00","#000000","#009E73"))

# #1f78b4 blue
# #b2df8a green
# color_VRK3=c("#07d400", "#b51b0d","#edca00", "#000000",  "#3347ff", "#00bcc9",  "#b60ddb", "#9fa4c9", "#FFFFFF")

# p=spplot(HydroBasin_l12_ALPS_int_sp, zcol=c("dist_Groundwater_2100_SON"), col.regions=(gradient_n_pal(brewer_pal("div")(5))(seq(0,1, length.out=20))))
# fx(p)

# Try to plot the map  of the top10 <0 and >0
HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100=0
HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100[which(HydroBasin_l12_ALPS_int_sp$Drought2100>quantile(HydroBasin_l12_ALPS_int_sp$Drought2100, 0.9))]=1

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_SON_TOP10_Drought_2100=0

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_SON_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100==1 & HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_SON>quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_SON, 0.9))]=1

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_SON_TOP10_Drought_2100[which(HydroBasin_l12_ALPS_int_sp$TOP10_drought_2100==1 & HydroBasin_l12_ALPS_int_sp$dist_Groundwater_2100_SON<quantile(HydroBasin_l12_ALPS_int_sp_TOP10_Drought_2100$dist_Groundwater_2100_SON, 0.1))]=-1

HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_SON_TOP10_Drought_2100=as.factor(HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_SON_TOP10_Drought_2100)
summary(HydroBasin_l12_ALPS_int_sp$TOP10_dist_Groundwater_SON_TOP10_Drought_2100)

p=spplot(HydroBasin_l12_ALPS_int_sp, zcol=c("TOP10_dist_Groundwater_SON_TOP10_Drought_2100"), col.regions=c("#E69F00","#FFFFFF","#009E73"), sp.layout=Countries_BB_Large_WGS84_sp)
fx(p) 
# + plot(Countries_BB_Large_WGS84_sp, col='red', add=T)

### other models
lm_Drought_Groundwater_Winter_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_DJF)~(HydroBasin_l12_ALPS_int_sp$Drought2100)) 
summary(lm_Drought_Groundwater_Winter_2100) #  p-value: < 2.2e-16 with log !! r2= 0.03724 !!!! 

lm_Drought_Groundwater_Spring_2100=lm(log(HydroBasin_l12_ALPS_int_sp$Groundwater_mean_2100_MAM)~(HydroBasin_l12_ALPS_int_sp$Drought2100)) 
summary(lm_Drought_Groundwater_Spring_2100) #  p-value: < 2.2e-16 with log !! r2= 0.03724 !!!! 



```


## Watersheds
```{r watersheds}

# # Level 12
HydroBasin_l12=shapefile("Path/to/working/directory/CC_variable/CC_variable/CC_test/WWF_Hydro/BasinATLAS_Data_v10_shp/BasinATLAS_v10_Alps/BasinATLAS_v10_lev12_Alps.shp")
crs(HydroBasin_l12)@projargs==crs(BB_Large_WGS84)@projargs
HydroBasin_l12_cut=crop(HydroBasin_l12, BB_Large_WGS84)
plot(HydroBasin_l12_cut)

```


## LULC

```{r lulc}
CLC_Alps_raster=brick("Path/to/working/directory/CORINE_CLC_LULC/u2018_clc2018_v2020_20u1_raster100m/U2018_CLC2018_V2020_20u1_Alps_ETRS89.tif", write=F)

# PP_RCP8.5=brick("Path/to/working/directory/CC/Temperature/Annual/mean_Tmean_Yearly_rcp85_mean_v1_WGS84.tif", write=F)
plot(CLC_Alps_raster)
plot(BB_Large, add=T, col='red')
crs(CLC_Alps_raster)
crs(CLC_Alps_raster)@projargs==crs(BB_Large_ETRS89)@projargs

NAvalue(CLC_Alps_raster) # -Inf
summary(CLC_Alps_raster)
NAvalue(CLC_Alps_raster)=-99

writeRaster(CLC_Alps_raster, "Path/to/working/directory/CORINE_CLC_LULC/u2018_clc2018_v2020_20u1_raster100m/U2018_CLC2018_V2020_20u1_Alps__setNA_ETRS89.tif")

## LULC in the Alps
# LULC_shp=shapefile("Path/to/working/directory/CORINE_CLC_LULC/CLC_raster100m_vectorise_repare_cut_Alps.shp")
# crs(LULC_shp)@projargs==crs(AC_repair)@projargs
# AC_ETRS89=spTransform(AC_repair, crs(LULC_shp))
# crs(LULC_shp)@projargs==crs(AC_ETRS89)@projargs
# plot(LULC_shp)
# plot(AC_ETRS89, add=T, col='red')

Area_LULC=data.frame(LULC=NA, Area=NA)
# raster::area(LULC_shp[1,])
for (i in 1:nrow(LULC_shp@data)){
  Area_LULC[i,]=c(LULC_shp$DN[i] , raster::area(LULC_shp[i,]))
  
}
str(Area_LULC)
Area_LULC$LULC=as.factor(Area_LULC$LULC)
Area_LULC$Area=as.numeric(Area_LULC$Area)


summary(Area_LULC$Area)
p=ggplot(Area_LULC) + geom_boxplot(aes(x=LULC, y=log(Area), fill=LULC), stat = "boxplot")
fx(p)


legend_LULC=read.csv2("Path/to/working/directory/CORINE_CLC_LULC/CLC_legend_modif.csv")

Area_LULC$LU_modif=NA
for (i in levels(Area_LULC$LULC)){
  Area_LULC$LU_modif[which(Area_LULC$LULC==i)]=legend_LULC$CLC_modif[which(legend_LULC$GRID_CODE==i)]
  
}

Area_LULC$LU_modif=as.factor(Area_LULC$LU_modif)

p=ggplot(Area_LULC) + geom_boxplot(aes(x=LU_modif, y=log(Area), fill=LU_modif), stat = "boxplot")
fx(p)

Sum_LULC_Alps=data.frame(LULC=levels(Area_LULC$LU_modif), SumArea=NA)
for (i in levels(Area_LULC$LU_modif)){
  Sum_LULC_Alps$SumArea[which(Sum_LULC_Alps$LULC==i)]=sum(Area_LULC$Area[which(Area_LULC$LU_modif==i)])
  
}

Sum_LULC_Alps=Sum_LULC_Alps[order(Sum_LULC_Alps$SumArea, decreasing = T),]
Sum_LULC_Alps$LULC=factor(Sum_LULC_Alps$LULC, levels = Sum_LULC_Alps$LULC)
p=ggplot(Sum_LULC_Alps) + geom_bar(aes(x=(LULC), y=SumArea), stat="identity") + theme(axis.text.x = element_text(angle = 45, vjust = 0.6))

p=ggplot(Sum_LULC_Alps) + geom_bar(aes(x=(LULC), y=log(SumArea)), stat="identity") + theme(axis.text.x = element_text(angle = 45, vjust = 0.6))

Sum_LULC_Alps$Prop=(Sum_LULC_Alps$SumArea)/sum(Sum_LULC_Alps$SumArea)
Sum_LULC_Alps$CumProp=Sum_LULC_Alps$Prop[1]
for (i in 2:nrow(Sum_LULC_Alps)){
  Sum_LULC_Alps$CumProp[i]=Sum_LULC_Alps$CumProp[i-1]+Sum_LULC_Alps$Prop[i]
}

p=ggplot(Sum_LULC_Alps) + geom_bar(aes(x=(LULC), y=log(SumArea)), stat="identity") + theme(axis.text.x = element_text(angle = 45, vjust = 0.6)) + geom_point(aes(x=LULC, y=25*CumProp), stat="identity") + scale_y_continuous(
    
    # Features of the first axis
    name = "Area",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*4, name="Prop"))

Sum_LULC_Alps$LULC_ori=NA
for (i in 1:nrow(Sum_LULC_Alps)){
  Sum_LULC_Alps$LULC_ori[i]=legend_LULC$LABEL3[which(legend_LULC$CLC_modif==Sum_LULC_Alps$LULC[i])]
  
}

write.csv2(Sum_LULC_Alps, "Path/to/working/directory/Scenarios/CCA/CLC_in_Alps_by_categories.csv")



###### CLC in AS
CLC_AS=shapefile("Path/to/working/directory/CORINE_CLC_LULC/u2018_clc2018_v2020_20u1_geoPackage/CLC2018_AS_cut_WGS84.shp")

Water_bodies_in_AS_vector=CLC_AS[which(CLC_AS$Code_18 %in% legend_CLC_wet),]
Urban_in_AS_vector=CLC_AS[which(CLC_AS$Code_18 %in% legend_CLC_urban),]
Forest_in_AS_vector=CLC_AS[which(CLC_AS$Code_18 %in% legend_CLC_forest),]
Cropland_in_AS_vector=CLC_AS[which(CLC_AS$Code_18 %in% legend_CLC_crop),]

# Previous code 
# LULC_in_AC=sf::st_intersection(as(AC_ETRS89, "sf"), as(LULC_shp, "sf"))
# 
# NCP_in_NBS_i=sf::st_intersection(as(NBS[i,], "sf"), as(NCP_AlpES_WGS84_in_AC_std, "sf")) # Change NCP_AlpES_WGS84 with standardized value
#   NCP_in_NBS_i_sp=as_Spatial(NCP_in_NBS_i)
#   NCP_in_NBS_i_sp=NCP_in_NBS_i_sp[,colnames_NBS_NCP]


### RPG to see what is in French Alps
RPG_Alps=shapefile("Path/to/working/directory/LULC/RPG_2020_Alps_cut_ETRS89.shp")
crs(RPG_Alps)@projargs==crs(AC_ETRS89)@projargs
### Link RPG to CLC to see how it differ
plot(RPG_Alps)

Area_RPG=data.frame(RPG=NA, Area=NA)
# raster::area(LULC_shp[1,])
for (i in 1:nrow(RPG_Alps@data)){
  Area_RPG[i,]=c(RPG_Alps$CODE_CULTU[i] , raster::area(RPG_Alps[i,]))
}


str(Area_LULC)
Area_LULC$LULC=as.factor(Area_LULC$LULC)
Area_LULC$Area=as.numeric(Area_LULC$Area)



```



# NbS interventions

## Agroforestry * Hedgerows
```{r agrof_hedgerows}
# #### Global + agrof
dossier_af="Path/to/working/directory/R/Export_data/Agrof"

# Import slopes raster
# Slopes_raster_ETRS=raster("Path/to/working/directory/Slopes_Alps_ETRS.tif")
Slopes_raster_WGS84=projectRaster(Slopes_raster_ETRS, crs = crs(AS_fusion_WGS84)@projargs)
Slopes_raster_cut_WGS84=crop(Slopes_raster_WGS84,AS_fusion_WGS84)

# Slopes_raster_cut_WGS84=raster("Path/to/working/directory/Slopes_Alps_WGS84.tif")

legend_grid_crop=legend_LULC$GRID_CODE[which(legend_LULC$CLC_CODE %in% legend_CLC_crop)]
legend_grid_forest=legend_LULC$GRID_CODE[which(legend_LULC$CLC_CODE %in% legend_CLC_forest)]
legend_grid_urban=legend_LULC$GRID_CODE[which(legend_LULC$CLC_CODE %in% legend_CLC_urban)]
legend_grid_grasslands=legend_LULC$GRID_CODE[which(legend_LULC$CLC_CODE %in% legend_CLC_grasslands)]
legend_grid_wet=legend_LULC$GRID_CODE[which(legend_LULC$CLC_CODE %in% legend_CLC_wet)]

### Barriers agrof:
# - Need to be implemented in cropland
# - Slopes < 35-45%
# - Area/linear > x m-ha?

# Vector:
# Cropland_in_AS_shp=CLC_AS[which(CLC_AS$Code_18 %in% legend_CLC_crop),]
# Raster:
Cropland_masque=CLC_Alps_WGS84 %in% legend_grid_crop
Cropland_in_AS_raster=mask(CLC_Alps_WGS84, mask=Cropland_masque, maskvalue=0)
# Cropland_in_AS_raster=as.raster(Cropland_in_AS)

writeRaster(Cropland_in_AS, "Path/to/working/directory/R/Export_data/Agrof/Cropland_mask_in_CLC_AS_WGS84.tif", overwrite=T)

# Cropland_in_AS_ETRS=projectRaster(Cropland_in_AS, crs = crs(Slopes_raster_WGS84)@projargs)
# extent(Cropland_in_AS_ETRS)
# Extraction des zones agricoles selon la couche AC

# Filtrer les zones agricoles avec une pente infrieure  35%
res(Cropland_in_AS) # 0.001297000 0.000895796
res(Slopes_raster_cut_WGS84) # 0.008333333 0.008333333
# Slopes_raster_resampled_WGS84 <- resample(Slopes_raster_cut_WGS84, Cropland_in_AS, method = 'ngb') # method ngb for closest neighbours

extent(Cropland_in_AS)==extent(Slopes_raster_resampled_WGS84)

Cropland_in_AS_pente_inf35 <- mask(Cropland_in_AS, mask=Slopes_raster_resampled_WGS84 >= 10, maskvalue=0)

Cropland_in_AS_pente_inf35 <-mask(Cropland_in_AS_pente_inf35, mask=AS_fusion_WGS84)


writeRaster(Cropland_in_AS_pente_inf35, "Path/to/working/directory/R/Export_data/Agrof/Cropland_mask_in_CLC_slopes_inf35_AS_WGS84.tif", overwrite=T)


## Mask relative change of drought intensity and std
# Start with 2050 / with anomalies of drought~groundwater model

# Transform vector into raster

# Then mask raster with cropland_slopes_inf10

# Then vectorize resulting raster with zonal stat to get mean of drought??
Drought2050_in_WS_raster=Cropland_in_AS
Drought2050_in_WS_raster=rasterize(x= HydroBasin_l12_ALPS_int_sp,y=Drought2050_in_WS_raster, field="RelDrought2050")

Anomalies2100_in_WS_raster=Cropland_in_AS
Anomalies2100_in_WS_raster=rasterize(x= HydroBasin_l12_ALPS_int_sp,y=Anomalies2100_in_WS_raster, field="Multiply_anomalies_groundwater_reldrought_2100_JJA")

Groundwater2050_in_WS_raster=Cropland_in_AS
Groundwater2050_in_WS_raster=rasterize(x= HydroBasin_l12_ALPS_int_sp,y=Groundwater2050_in_WS_raster, field="Groundwater_2050_JJA")


Anomalies2100_in_WS_raster_cropland_masked=mask(Anomalies2100_in_WS_raster, Cropland_in_AS_pente_inf35)

writeRaster(Anomalies2100_in_WS_raster_cropland_masked, "Path/to/working/directory/R/Export_data/Agrof/Anomalies2100_in_WS_raster_cropland_masked_slopes_inf35_AS_WGS84.tif", overwrite=T)

plot(Anomalies2100_in_WS_raster_cropland_masked)
hist((Anomalies2100_in_WS_raster_cropland_masked@data@values))

Anomalies2100_in_WS_raster_cropland_masked_top_pres=mask(x=Anomalies2100_in_WS_raster_cropland_masked, mask=Anomalies2100_in_WS_raster_cropland_masked>quantile(Anomalies2100_in_WS_raster_cropland_masked@data@values, 0.75, na.rm=T), maskvalue=0 )

writeRaster(Anomalies2100_in_WS_raster_cropland_masked_top_pres, "Path/to/working/directory/R/Export_data/Agrof/Anomalies2100_in_WS_raster_cropland_masked_slopes_inf35_AS_TOP_preserv_WGS84.tif", overwrite=T)

Anomalies2100_in_WS_raster_cropland_masked_top_resto=mask(x=Anomalies2100_in_WS_raster_cropland_masked,mask=Anomalies2100_in_WS_raster_cropland_masked<quantile(Anomalies2100_in_WS_raster_cropland_masked@data@values, 0.25, na.rm=T), maskvalue=0)

writeRaster(Anomalies2100_in_WS_raster_cropland_masked_top_resto, "Path/to/working/directory/R/Export_data/Agrof/Anomalies2100_in_WS_raster_cropland_masked_slopes_inf35_AS_TOP_resto_WGS84.tif", overwrite=T)


##### Plot anomalies 

plot(Anomalies2100_in_WS_raster_cropland_masked)
hist((Anomalies2100_in_WS_raster_cropland_masked))
boxplot(Anomalies2100_in_WS_raster_cropland_masked@data@values)

data_anomalies=data.frame(Ano="Anomalies", Var=Anomalies2100_in_WS_raster_cropland_masked@data@values)
data_anomalies=data_anomalies[-is.na(data_anomalies$Var),]

quantile_points=data.frame(y=NA, x="Anomalies", group=c(25,75,10,90,50))
for (i in 1:5){
  quantile_points$y[i]=quantile(Anomalies2100_in_WS_raster_cropland_masked@data@values, quantile_points$group[i]/100, na.rm=T)
}
quantile_points$group=as.factor(c(25,25,10,10,50))

p=ggplot() + geom_violin(data=data_anomalies[sample(size=10^5, x=1:90492623),], aes(y=Var, x=Ano))+
  geom_point(data=quantile_points, aes(x=x, y=y, color=group)) + scale_color_manual(values=c(c("#0072B2", "#009E73", "#D55E00", "#000000")))
fx(p)


p=ggplot(data=data_anomalies[sample(size=10^5, x=1:90492623),]) + geom_violin(aes(y=Var, x=Ano))+
   geom_boxplot(aes(y=Var, x=Ano), width = 0.2, fill = "white", color = "black", outlier.shape = NA) +
  theme_bw() + theme(axis.text.x=element_blank(),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_y_continuous(breaks = seq(-1000, 1000, by = 200), limits=c(-800, 800))
  # geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/Anomalies" ,"/geom_violin_agrof_Anomalies", ".png", sep=''), width=4*2, height=8*2, limitsize=F, dpi = 300)

```

### Soil organic carbon

```{r soc_for_agrof}
# From derived data 2013

SOC_present_WGS84=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ESDAC/Derived_data_set_2013/SOC_top_soil_WGS84.tif")
crs(SOC_present_WGS84)@projargs==crs(BB_Large_WGS84)@projargs

## zonal stat in each selected polygons for restoration and preservation??j

SOC_present_cut=crop(SOC_present_WGS84, Cropland_in_AS_pente_inf35)
SOC_present_cut=resample(SOC_present_cut, Cropland_in_AS_pente_inf35,method = 'ngb')

SOC_present_masked_cropland_pente_inf35=mask(SOC_present_cut, Cropland_in_AS_pente_inf35)

# writeRaster(SOC_present_masked_cropland_pente_inf35, "Path/to/working/directory/R/Export_data/Agrof/SOC_present_masked_cropland_pente_inf35.tif")
# SOC_present_masked_cropland_pente_inf35=raster("Path/to/working/directory/R/Export_data/Agrof/SOC_present_masked_cropland_pente_inf35.tif")

# actual SOC in cropland

SOC_actual_masked_cropland_pente_inf35_top_preserv=mask(SOC_present_masked_cropland_pente_inf35, Anomalies2100_in_WS_raster_cropland_masked_top_pres)
# SOC_actual_masked_cropland_pente_inf35_top_preserv@data@values=as.numeric(SOC_actual_masked_cropland_pente_inf35_top_preserv@data@values)
# boxplot(SOC_actual_masked_cropland_pente_inf35_top_preserv)

sampleRandom(SOC_actual_masked_cropland_pente_inf35_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_soc_pres=data.frame(SOC= sampleRandom(SOC_actual_masked_cropland_pente_inf35_top_preserv, 10000, na.rm=T, xy=F), TOP=as.factor("Bright spot"))
colnames(data_soc_pres)=c("SOC", "TOP")

p=ggplot() + geom_violin(data=data_soc_pres, aes(y=SOC, x="Bright spot"))
fx(p)

### SOC in TOP restoration grasslands

SOC_actual_masked_cropland_pente_inf35_top_resto=mask(SOC_present_masked_cropland_pente_inf35, Anomalies2100_in_WS_raster_cropland_masked_top_resto)
# SOC_actual_masked_cropland_pente_inf35_top_resto@data@values=as.numeric(SOC_actual_masked_cropland_pente_inf35_top_resto@data@values)
# boxplot(SOC_actual_masked_cropland_pente_inf35_top_resto)

# sampleRandom(SOC_actual_masked_cropland_pente_inf35_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto=data.frame(SOC= sampleRandom(SOC_actual_masked_cropland_pente_inf35_top_resto, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))
colnames(data_soc_resto)=c("SOC", "TOP")

p=ggplot() + geom_violin(data=data_soc_resto, aes(y=SOC, x="Preservation"))
fx(p)

### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_soc_resto,data_soc_pres), aes(y=log10(SOC), x=TOP))
fx(p)



# sample data in AS
SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
SOC_in_AS_rd=data.frame(SOC=sampleRandom(SOC_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_AS_rd)=c("SOC", "TOP")

# sample data in all croplands
# SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
SOC_in_all_cropland_rd=data.frame(SOC=sampleRandom(SOC_present_masked_cropland_pente_inf35, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_all_cropland_rd)=c("SOC", "TOP")

### SOC in pres & resto
median_data <- rbind(data_soc_pres,data_soc_resto,SOC_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(median_soc = median(SOC)) %>% as.data.frame()

# AS:  SOC_in_AS_rd / croplands: SOC_in_all_cropland_rd
p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,SOC_in_all_cropland_rd), aes(y=log10(SOC), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.7 ,label = c("a", "b", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit")) +
  geom_point(data =median_data , aes(y = log10(median_soc), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_af, "/Figure/SOC" ,"/geom_violin_agrof_log_SOC_groups_croplands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


# AS:  SOC_in_AS_rd / croplands: SOC_in_all_cropland_rd
p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,SOC_in_all_cropland_rd), aes(y=SOC, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=42 ,label = c("a", "b", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit")) +
  geom_point(data =median_data , aes(y = median_soc, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_af, "/Figure/SOC" ,"/geom_violin_agrof_SOC_croplands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


############ ANOVA
###### AS:  SOC_in_AS_rd / 
aov_soc_af=aov(data=rbind(data_soc_resto,data_soc_pres,SOC_in_all_cropland_rd), SOC~TOP)
anova(aov_soc_af)
# AS              Df  Sum Sq Mean Sq F value    Pr(>F)   
# TOP           2    519 259.421  39.391 < 2.2e-16 ***

# Croplands
# TOP           2    270 135.143   16.84 4.926e-08 ***

TukeyHSD(aov_soc_af)
#   AS                         diff         lwr         upr     p adj
# Preservation < Restoration -0.22837476 -0.41199944 -0.04475008 0.0099605
# AS = Restoration            0.09211825 -0.09150643  0.27574293 0.4676441
# AS > Preservation           0.32049302  0.23542809  0.40555794 0.0000000

# Croplands
# Preservation < Restoration -0.228374762 -0.4310771 -0.02567243 0.0225415
# AS = Restoration           -0.002462756 -0.2051651  0.20023958 0.9995530
# AS > Preservation           0.225912006  0.1320093  0.31981473 0.0000000

HSD_AF=HSD.test(aov_soc_af, trt="TOP", group=T, alpha=0.05)
HSD_AF
# SOC groups
# AS           1.475862      a
# Restoration  1.383744      a
# Preservation 1.155369      b

# Croplands
# Restoration  1.383744      a
# AS           1.381281      a
# Preservation 1.155369      b




```



### NCP in Agrof priority
```{r ncp_in_agrof}


## Restoration priority area for Agrof
Top_resto_AF=shapefile("Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_sup_dist1000_to_forest_top_resto_sup100ha_NCP_WGS84.shp")

Top_resto_AF_df=Top_resto_AF@data
Top_resto_AF_df$TOP="Restoration"
rownames(Top_resto_AF_df)=Top_resto_AF_df$fid

# Preservation priority area for Agrof
Top_preserv_AF=shapefile("Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_sup_dist1000_to_forest_top_preserv_sup100ha_NCP_WGS84.shp")
Top_preserv_AF_df=Top_preserv_AF@data

Top_preserv_AF_df$TOP="Preservation"
colnames(Top_preserv_AF_df)=colnames(Top_resto_AF_df)
rownames(Top_preserv_AF_df)=Top_preserv_AF_df$fid

Top_df_AF=rbind(Top_resto_AF_df, Top_preserv_AF_df)
Top_df_AF=Top_df_AF[,-c(1:4)]

p=ggplot()
for (i in 1:(ncol(Top_df_AF)-1)){
  p=p+geom_violin(aes(x=as.character(colnames(Top_df_AF)[i]),y=Top_df_AF[,i], fill=Top_df_AF$TOP))
}


p=ggplot() + geom_boxplot(Top_df_AF, aes(Y=A_3,fill=TOP))

data_ncp_mean=Top_df_AF[1:2,-ncol(Top_df_AF)]
data_ncp_mean[1,]=apply(Top_df_AF[which(Top_df_AF$TOP=="Restoration"),-ncol(Top_df_AF)], 2, FUN="mean")
data_ncp_mean[2,]=apply(Top_df_AF[which(Top_df_AF$TOP=="Preservation"),-ncol(Top_df_AF)], 2, FUN="mean")
data_ncp_mean[3,]=apply(Top_df_AF[,-ncol(Top_df_AF)], 2, FUN="min")
data_ncp_mean[4,]=apply(Top_df_AF[,-ncol(Top_df_AF)], 2, FUN="max")

data_ncp_mean$TOP=c("Restoration","Preservation","Min","Max")



str(data_ncp_mean)

radarchart(data_ncp_mean[c(4,3,1),-ncol(data_ncp_mean)], maxmin = T)
radarchart(data_ncp_mean[c(4,3,2),-ncol(data_ncp_mean)], maxmin = T)


```

### Clustering Agrof NCP
```{r cluster_agrof}

Top_df_AF$A_2p1=Top_df_AF$A_2/(Top_df_AF$A_1+1)
Top_df_AF$B_2p1=Top_df_AF$B_2/(Top_df_AF$B_1+1)
Top_df_AF$C_2p1=Top_df_AF$C_2/(Top_df_AF$C_1+1)
# Top_df_AF$D_1_2
Top_df_AF$E_2p1=Top_df_AF$E_2/(Top_df_AF$E_1+1)
# Top_df_AF$F_1_2
Top_df_AF$G_2p1=Top_df_AF$G_2/(Top_df_AF$G_1+1)
Top_df_AF$H_2p1=Top_df_AF$H_2/(Top_df_AF$H_1+1)

str(Top_df_AF)
pca.agrof=PCA(Top_df_AF, graph=F, quali.sup = 22)

pca.var=pca.agrof$var
pca.ind=pca.agrof$ind

plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,3))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(2,3))

plot(pca.agrof,
     invisible = c("var", "ind"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))

plot(pca.agrof,
     invisible = c("ind", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))



# with cos2
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,2)
            # invisible=c("quali.sup"),
            )
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,3)
            # invisible=c("quali.sup"),
            )


eig.val <- pca.agrof$eig
barplot(eig.val[, 2], 
        names.arg = 1:nrow(eig.val), 
        main = "Variances Explained by Dimensions (%)",
        xlab = "Principal Dimensions",
        ylab = "Percentage of variances",
        col ="steelblue")
# Add connected line segments to the plot
lines(x = 1:nrow(eig.val), eig.val[, 2], 
      type = "b", pch = 19, col = "red")



## Clustering
clust.agrof3=HCPC(PCA(Top_df_AF[,-22], graph=F), metric="euclidean", nb.clust=3)

fviz_cluster(clust.agrof3,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = FALSE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
             )

plot(clust.agrof3, choice = "3D.map")

#test khi2
clust.agrof3$desc.var$test.chi2[which(as.integer(clust.agrof3$desc.var$test.chi2)<0.1),]

clust.agrof3$desc.var$category
######################
#######  C1  #########
######################
agrof.clust1=as.data.frame(clust.agrof3$desc.var$quanti$`1`)
agrof.clust1$Levers=rownames(agrof.clust1)
agrof.clust1$Signif=0
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test<0))]=-1
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test>0))]=1
agrof.clust1$Signif=as.factor(agrof.clust1$Signif)
agrof.clust1$diff_mean=agrof.clust1$`Mean in category`-agrof.clust1$`Overall mean`

# B_1, B_2,B_2p1, C_1, C_2,C_2p1,  F_1_2, G_1
# High Grasslands and wood production, high outdoor recreation supply

######################
#######  C2  #########
######################
agrof.clust2=as.data.frame(clust.agrof3$desc.var$quanti$`2`)
agrof.clust2$Levers=rownames(agrof.clust2)
agrof.clust2$Signif=0
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test<0))]=-1
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test>0))]=1
agrof.clust2$Signif=as.factor(agrof.clust2$Signif)
agrof.clust2$diff_mean=agrof.clust2$`Mean in category`-agrof.clust2$`Overall mean`

# A_1, C_2, C_2p1, E_1, E_2, E_3,E_2p1, G_1,G_2 H_1, H_2, H_2p1
# High Water supply, wood use, protected site, Outdoor recreation supply and use, and symbolic species flow/supply


######################
#######  C3  #########
######################
agrof.clust3=as.data.frame(clust.agrof3$desc.var$quanti$`3`)
agrof.clust3$Levers=rownames(agrof.clust3)
agrof.clust3$Signif=0
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test<0))]=-1
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test>0))]=1
agrof.clust3$Signif=as.factor(agrof.clust3$Signif)
agrof.clust3$diff_mean=agrof.clust3$`Mean in category`-agrof.clust3$`Overall mean`

# A_3, A_2, A_2p1  ,C_3,  D_1_2 , D_3, G_2, G_2p1  
# High water need and use, wood need, water filtration use and need, outdoor recreation flow/supply

### Summary:
# C1: High Grasslands and wood production, high outdoor recreation supply
# C2: High Water supply, wood use, protected site, Outdoor recreation supply and use, and symbolic species flow/supply
# C3: High water need and use, wood need, water filtration use and need, outdoor recreation flow/supply

### Export shp with clusters

Top_resto_AF$cluster=NA
for (i in 1:nrow(Top_resto_AF)){
  Top_resto_AF$cluster[i]=clust.agrof3$data.clust$clust[which(rownames(clust.agrof3$data.clust)==Top_resto_AF$fid[i])]
 
}
summary(as.factor(Top_resto_AF$cluster))
p=spplot(Top_resto_AF, zcol=c("cluster"))

# shapefile(Top_resto_AF, "Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_sup_dist1000_to_forest_top_resto_sup100ha_NCP_clust_WGS84.shp")


Top_preserv_AF$cluster=NA
for (i in 1:nrow(Top_preserv_AF)){
  Top_preserv_AF$cluster[i]=clust.agrof3$data.clust$clust[which(rownames(clust.agrof3$data.clust)==Top_preserv_AF$fid[i])]
 
}
summary(as.factor(Top_preserv_AF$cluster))
p=spplot(Top_preserv_AF, zcol=c("cluster"))


### Export in shp


# shapefile(Top_preserv_AF, "Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_sup_dist1000_to_forest_top_preserv_sup100ha_NCP_clust_WGS84.shp")



#### radar chart with each clusters

colnames(Top_preserv_AF@data)
colnames(Top_resto_AF@data)

# Atention : avec Elev = 26
data_ncp_mean=rbind(Top_preserv_AF@data[,-c(1:4,26)], Top_resto_AF@data[,-c(1:4,26)])
data_radar=data_ncp_mean[1:5,-ncol(data_ncp_mean)]
data_radar[1,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="max")
data_radar[2,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="min")

data_radar[3,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==1),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[4,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==2),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[5,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==3),-ncol(data_ncp_mean)], 2, FUN="mean")


data_radar$TOP=c("Max", "Min", "C1","C2", "C3")


# color_border_hexadec=c("#b200f8", "#5dbdfc", "#71daa7")
colors_border=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255))
colors_in=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.4*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.4*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.4*255))

colnames(data_radar)[22]
# radarchart(data_radar[3:5,-c(22,ncol(data_radar))], maxmin = F,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

radarchart(data_radar[,-c(22,ncol(data_radar))], maxmin = T,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

legend(x="topright", legend = c("C1", "C2", "C3"),col=colors_border, bty = "n", pch=20 , text.col = "black", cex=0.9, pt.cex=1.6)

### Colour clusters

color_clusters=palette.colors(palette="Set2")
Hillsides_out= rgb(102, 194, 165, maxColorValue = 255)
Hillsides_in= rgb(102, 194, 165, maxColorValue = 255, alpha=0.4*255)
Populated_out= rgb(252, 141, 98, maxColorValue = 255)
Populated_in= rgb(252, 141, 98, maxColorValue = 255, alpha=0.4*255)
Touristic_out= rgb(141, 160, 203, maxColorValue = 255)
Touristic_in= rgb(141, 160, 203, maxColorValue = 255, alpha=0.4*255)
Productive_out=rgb(231, 138, 195, maxColorValue = 255)
Productive_in=rgb(231, 138, 195, maxColorValue = 255, alpha=0.4*255)
Rural_out= rgb(166, 216, 84, maxColorValue = 255)
Rural_in= rgb(166, 216, 84, maxColorValue = 255, alpha=0.4*255)
# Rural_out=rgb(255, 217, 47, maxColorValue = 255)
# Rural_in=rgb(255, 217, 47, maxColorValue = 255, alpha=0.4*255)

color_cropland_out=c(Productive_out, Hillsides_out, Populated_out)
color_cropland_in=c(Productive_in, Hillsides_in, Populated_in)

radarchart(data_radar[,-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=color_cropland_out , pfcol=color_cropland_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")


### Plot C1 

radarchart(data_radar[c(1,2,3),-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=Productive_out , pfcol=Productive_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")
radarchart(data_radar[c(1,2,4),-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=Hillsides_out , pfcol=Hillsides_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")
radarchart(data_radar[c(1,2,5),-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=Populated_out , pfcol=Populated_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")



```

### Prop clusters

```{r prop_clusters_agrof}
colnames(Top_preserv_AF@data)
colnames(Top_resto_AF@data)

data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Top_preserv_AF@data$Area[which(Top_preserv_AF@data$cluster==i)]), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Top_resto_AF@data$Area[which(Top_resto_AF@data$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)

data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))
 


### Test with new area calculated
Area_preserv=data.frame(i=Top_preserv_AF$fid, area=NA)
for (i in 1:nrow(Top_preserv_AF@data)){
  Area_preserv$area[i]=raster::area(Top_preserv_AF[i,])
  
}

Area_resto=data.frame(i=Top_resto_AF$fid, area=NA)
for (i in 1:nrow(Top_resto_AF@data)){
  Area_resto$area[i]=raster::area(Top_resto_AF[i,])
  
}



data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Area_preserv$area[which(Top_preserv_AF$cluster==i)]), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Area_resto$area[which(Top_resto_AF$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)


data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


##Khi2 and plot

# khi2
khi_prop_clust=cbind(data_prop_clust$Area[1:3], data_prop_clust$Area[4:6])
khi_prop_clust_test=chisq.test(khi_prop_clust) # p-value < 2.2e-16
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("1", "2", "3")
100*khi_prop_clust_res/sum(khi_prop_clust_res) # cluster 2 very different from others


# Label preserv
label_pres=c(data_prop_preserv_clust$Prop[3]/2,
             data_prop_preserv_clust$Prop[3]+(data_prop_preserv_clust$Prop[2]/2),
             data_prop_preserv_clust$Prop[3]+data_prop_preserv_clust$Prop[2]+(data_prop_preserv_clust$Prop[1]/2)
             )
label_resto=c(data_prop_resto_clust$Prop[3]/2,
             1+data_prop_resto_clust$Prop[3]+(data_prop_resto_clust$Prop[2]/2),
             data_prop_resto_clust$Prop[3]+data_prop_resto_clust$Prop[2]+(data_prop_resto_clust$Prop[1]/2)
             )


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(data_prop_preserv_clust$Prop[c(3,2,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(data_prop_resto_clust$Prop[c(3,2,1)],0))), size=10) + 
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())


fx(p)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/Clusters" ,"/geom_bar_clusters_prop_agrof", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)




## ANOVA
data_prop_preserv_clust$TOP=as.factor(data_prop_preserv_clust$TOP)
data_prop_preserv_clust$Cluster=as.factor(data_prop_preserv_clust$Cluster)
data_prop_resto_clust$TOP=as.factor(data_prop_resto_clust$TOP)
data_prop_resto_clust$Cluster=as.factor(data_prop_resto_clust$Cluster)

# aov_clust_wr=aov(data=rbind(data_prop_preserv_clust, data_prop_resto_clust), Area~TOP:Cluster)
# anova(aov_clust_wr)
Top_preserv_AF$TOP=factor("Preservation")
Top_resto_AF$TOP=factor("Restoration")

Top_preserv_AF$Area=Area_preserv
Top_resto_AF$Area=Area_resto

### Need to calculate area of each polygons
Top_preserv_AF$Area=Top_preserv_AF$Area$area
Top_resto_AF$Area=Top_resto_AF$Area$area
data_clust_af=rbind(Top_preserv_AF@data[,c(4,27:28)], Top_resto_AF@data[,c(4,27:28)])


aov_clust_af=aov(data=data_clust_af, Area~TOP*cluster)
anova(aov_clust_af)

#              Df     Sum Sq    Mean Sq F value    Pr(>F)    
# TOP           1 8.0542e+16 8.0542e+16  66.1418 1.598e-15 ***
# cluster       1 1.2806e+17 1.2806e+17 105.1625 < 2.2e-16 ***
# TOP:cluster   1 2.4444e+15 2.4444e+15   2.0073    0.1569   

TukeyHSD(aov_clust_af)
#                                 diff       lwr       upr      p adj


HSD_AF=HSD.test(aov_clust_af, trt="TOP", group=T, alpha=0.05)

# Area groups
# Restoration  49844365      a
# Preservation 28757590      b

HSD_AF=HSD.test(aov_clust_af, trt="cluster", group=T, alpha=0.05)
#  Area groups
# 3 51077201      a
# 1 22788631      b
# 2 13482457      b




label_preserv=c(data_prop_preserv_clust$Prop[3]/2,data_prop_preserv_clust$Prop[3] + data_prop_preserv_clust$Prop[2]/2,data_prop_preserv_clust$Prop[3] +data_prop_preserv_clust$Prop[2]+ data_prop_preserv_clust$Prop[1]/2 )

label_resto=c(data_prop_resto_clust$Prop[3]/2,data_prop_resto_clust$Prop[3] +data_prop_resto_clust$Prop[2]+ data_prop_resto_clust$Prop[1]/2 )


### With cluster colors
p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') +
  scale_fill_manual(values=color_cropland_out) +theme_bw() +
  # geom_text(aes(x="Preservation", y=label_preserv, label=as.character(round(data_prop_preserv_clust$Prop[c(3,2,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(data_prop_resto_clust$Prop[c(3,1)],0))), size=10)+
  theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)  

ggsave(plot=p, filename = paste(dossier_af, "/Figure/Clusters" ,"/geom_bar_prop_NCP_clusters_croplands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/Clusters" ,"/geom_bar_prop_NCP_clusters_groups_croplands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


```



### Distrib elevation
```{r distrib_agrof_elevation}
### in function of elevation
# a=zonal.stats(Top_resto_AF[1,], Elevation_cut_WGS84, 'median')
a=raster::extract(Elevation_cut_WGS84, Top_resto_AF[1,], fun=mean)
Top_resto_AF$Elev=NA
for (i in 1:nrow(Top_resto_AF@data)){
  Top_resto_AF$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_resto_AF[i,], fun=mean)
}

Top_preserv_AF$Elev=NA
for (i in 1:nrow(Top_preserv_AF@data)){
  Top_preserv_AF$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_preserv_AF[i,], fun=mean)
}

p=ggplot() + geom_violin(aes(x="Resto", y=Top_resto_AF$Elev, fill='red')) + geom_violin(aes(x="Preservation", y=Top_preserv_AF$Elev, fill='blue'))   + geom_violin(aes(x="AS", y=raster::values(Elevation_cut_WGS84), fill='green'))  

# Elev in croplands 
Cropland_in_AS_pente_inf35_cut=crop(Cropland_in_AS_pente_inf35, Elevation_cut_WGS84)
Cropland_in_AS_pente_inf35_cut_resample=resample(Cropland_in_AS_pente_inf35_cut, Elevation_cut_WGS84, method = 'ngb')
Elev_in_cropland=mask(Elevation_cut_WGS84, Cropland_in_AS_pente_inf35_cut_resample)
summary(Elev_in_cropland)

length(Elev_in_cropland@data@values[-which(is.na(Elev_in_cropland@data@values))]) # 305079
Elev_in_cropland_rd=data.frame(Elev=sampleRandom(Elev_in_AS, 10^5, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_cropland_rd)=c("Elev", "TOP")  


## ANOVA
# random data in AS
Elev_in_AS=mask(Elevation_cut_WGS84, AS_fusion_WGS84)
Elev_in_AS_rd=data.frame(Elev=sampleRandom(Elev_in_AS, 10000, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_AS_rd)=c("Elev", "TOP")  

# AS: Elev_in_AS / Croplands: Elev_in_cropland_rd
aov_elev_af=aov(data=rbind(Top_preserv_AF@data[,c(26,28)], Top_resto_AF@data[,c(26,28)], Elev_in_cropland_rd), Elev~TOP)
anova(aov_elev_af)

#              Df     Sum Sq    Mean Sq F value    Pr(>F)    
# TOP           2 2.6831e+08 134154936  279.76 < 2.2e-16 ***

TukeyHSD(aov_elev_af)
#                                 diff       lwr       upr      p adj
# Restoration = Preservation -48.64387 -169.3132  72.02546 0.611886
# AS > Preservation          563.85320  492.8346 634.87181 0.000000
# AS > Restoration           612.49706  514.6701 710.32407 0.000000

HSD_AF=HSD.test(aov_elev_af, trt="TOP", group=T, alpha=0.05)
HSD_AF
#  Elev groups
# AS           831.8025      a
# Preservation 267.9493      b
# Restoration  219.3054      b

# AS: Elev_in_AS / Croplands: Elev_in_cropland_rd
median_data <- rbind(Top_preserv_AF@data[,c(26,28)], Top_resto_AF@data[,c(26,28)], Elev_in_cropland_rd) %>%
  group_by(TOP) %>%
  summarize(median_elev = median(Elev, na.rm=T)) %>% as.data.frame()


## PLOT
# AS: Elev_in_AS / Croplands: Elev_in_cropland_rd
p=ggplot() + 
  geom_violin(data=rbind(Top_preserv_AF@data[,c(26,28)], Top_resto_AF@data[,c(26,28)], Elev_in_cropland_rd), aes(x=TOP, y=Elev, fill=TOP))+
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=4300 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)


ggsave(plot=p, filename = paste(dossier_af, "/Figure/Elev" ,"/geom_violin_agrof_Elev_cropland", ".png", sep=''), width=10*2, height=8*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/Elev" ,"/geom_violin_agrof_Elev_groups_cropland", ".png", sep=''), width=10*2, height=8*2, limitsize=F, dpi = 300)






```


### Carbon potential

```{r carbon_pot_agrof}
str(Carbon_saturation_cut_WGS84)



SOC_potential_cropland_cut=crop(Carbon_saturation_cut_WGS84, Cropland_in_AS_pente_inf35)
SOC_potential_cropland_cut_cut=resample(SOC_potential_cropland_cut, Cropland_in_AS_pente_inf35,method = 'ngb')

SOC_potential_masked_cropland_slope_inf35=mask(SOC_potential_cropland_cut_cut, Cropland_in_AS_pente_inf35)

# writeRaster(SOC_potential_masked_cropland_slope_inf35, "Path/to/working/directory/R/Export_data/Agrof/SOC_potential_masked_cropland_slopes_inf35.tif")

### SOC in TOP preservation cropland

SOC_potential_masked_cropland_slope_inf35_top_preserv=mask(SOC_potential_masked_cropland_slope_inf35, Anomalies2100_in_WS_raster_cropland_masked_top_pres)
# SOC_potential_masked_cropland_slope_inf35_top_preserv@data@values=as.numeric(SOC_potential_masked_cropland_slope_inf35_top_preserv@data@values)

# boxplot(SOC_potential_masked_cropland_slope_inf35_top_preserv)

# sampleRandom(SOC_potential_masked_cropland_slope_inf35_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_sop_pres=data.frame(SOP=sampleRandom(SOC_potential_masked_cropland_slope_inf35_top_preserv$layer, 10000, na.rm=T, xy=F, sp=F), TOP=as.factor("Preservation"))

p=ggplot() + geom_violin(data=data_sop_pres, aes(y=SOC, x="Preservation"))
fx(p)

### SOC in TOP restoration cropland

SOC_potential_masked_cropland_slope_inf35_top_resto=mask(SOC_potential_masked_cropland_slope_inf35, Anomalies2100_in_WS_raster_cropland_masked_top_resto)
# SOC_potential_masked_cropland_slope_inf35_top_resto@data@values=as.numeric(SOC_potential_masked_cropland_slope_inf35_top_resto@data@values)
# boxplot(SOC_potential_masked_cropland_slope_inf35_top_resto)

# sampleRandom(SOC_potential_masked_cropland_slope_inf35_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_sop_resto=data.frame(SOP= sampleRandom(SOC_potential_masked_cropland_slope_inf35_top_resto$layer, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

p=ggplot() + geom_violin(data=data_sop_resto, aes(y=SOC, x="Restoration"))
fx(p)

### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_sop_resto,data_sop_pres), aes(y=SOC, x=TOP))
fx(p)


# sample data in AS
SOP_in_AS=mask(Carbon_saturation_cut_WGS84, AS_fusion_WGS84)
SOP_in_AS_rd=data.frame(SOP=sampleRandom(SOP_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_AS_rd)=c("SOP", "TOP")

# sample data in croplands
SOP_in_all_cropland_rd=data.frame(SOP=sampleRandom(SOC_potential_masked_cropland_slope_inf35, 10^5, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_all_cropland_rd)=c("SOP", "TOP")


### SOC in pres & resto
# AS: SOP_in_AS_rd/ croplands: SOP_in_all_cropland_rd
median_data <- rbind(data_sop_pres,data_sop_resto,SOP_in_all_cropland_rd) %>%
  group_by(TOP) %>%
  summarize(median_sop = median(SOP)) %>% as.data.frame()


p=ggplot() + geom_violin(data=rbind(data_sop_pres,data_sop_resto,SOP_in_all_cropland_rd), aes(y=SOP, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.03 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
   scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = (median_sop), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)

ggsave(plot=p, filename = paste(dossier_af, "/Figure/SOP" ,"/geom_violin_agrof_SOP_croplands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


### ANOVA
# AS: SOP_in_AS_rd/ croplands: SOP_in_all_cropland_rd
aov_sop_af=aov(data=rbind(data_sop_resto,data_sop_pres,SOP_in_all_cropland_rd), SOP~TOP)
anova(aov_sop_af)
#               Df  Sum Sq Mean Sq F value    Pr(>F)   
# TOP           2   11.56  5.7782  241.72 < 2.2e-16 ***

TukeyHSD(aov_sop_af)
#                                diff       lwr        upr p adj
# Preservation > Restoration 0.02104207 0.015917551 0.02616659     0
# AS > Restoration           0.03419704 0.030396596 0.03799749     0
# AS > Preservation          0.01315497 0.009354523 0.01695542     0

HSD_AF=HSD.test(aov_sop_af, trt="TOP", group=T, alpha=0.05)
HSD_AF
#                    SOP groups
# AS           0.5835614      a
# Preservation 0.5704064      b
# Restoration  0.5493643      c






```


### Protected area

```{r agrof_pa}
## done in QGIS: join protected area attribute (layer WDPA) to priority areas shapefile

Top_resto_FM_PA=shapefile("Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_top_resto_NCP_clust_WDPA_WGS84.shp")

Top_resto_FM_PA_df=Top_resto_FM_PA@data
levels(as.factor(Top_resto_FM_PA_df$IUCN_CAT))
# [1] "Ib"             "II"             "III"            "IV"            
# [5] "Not Applicable" "Not Assigned"   "Not Reported"   "VI" 
# Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="Ia")]=1
Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="Ib")]=1
Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="II")]=2
Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="III")]=3
Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="IV")]=4
# Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="V")]=5
# Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="VI")]=6
Top_resto_FM_PA_df$IUCN_CAT[which(is.na(Top_resto_FM_PA_df$IUCN_CAT))]=0
Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="Not Applicable")]=NA
Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="Not Assigned")]=NA
Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$IUCN_CAT=="Not Reported")]=NA

Top_resto_FM_PA_df$IUCN_CAT=as.integer(Top_resto_FM_PA_df$IUCN_CAT)

levels_fid=levels(as.factor(Top_resto_FM_PA_df$fid))
for (i in 1:nlevels(as.factor(Top_resto_FM_PA_df$fid))){
  print(i)
  print(nrow(Top_resto_FM_PA_df))
  print(Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$fid==levels_fid[i])])
  if (nrow(Top_resto_FM_PA_df[which(Top_resto_FM_PA_df$fid==levels_fid[i]),])>1){
    
    data_sans_0=Top_resto_FM_PA_df$IUCN_CAT[which(Top_resto_FM_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    
    if ((T %in% !is.na(data_sans_0))==F){
      Top_resto_FM_PA_df=Top_resto_FM_PA_df[-grep(levels_fid[i], Top_resto_FM_PA_df$fid)[1],]
    }
    if (F %in% is.na(data_sans_0)){
      
      if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
    
      min_level=min(data_sans_0, na.rm=T)
   
    
       Top_resto_FM_PA_df=Top_resto_FM_PA_df[-which(Top_resto_FM_PA_df$fid==levels_fid[i] & (is.na(Top_resto_FM_PA_df$IUCN_CAT) | Top_resto_FM_PA_df$IUCN_CAT != min_level)),]
    }
    
    
    
      if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
        Top_resto_FM_PA_df=Top_resto_FM_PA_df[-grep(levels_fid[i], Top_resto_FM_PA_df$fid)[-1],]
    }
    }
     
  }
  
}


Top_resto_FM_PA_sum=as.data.frame(summary(as.factor(Top_resto_FM_PA_df$IUCN_CAT)))
colnames(Top_resto_FM_PA_sum)=c("nb")
# Top_resto_FM_PA_sum=t(Top_resto_FM_PA_sum)
p=ggplot(Top_resto_FM_PA_sum) + geom_bar(aes(x="Restoration", y=nb, fill=rownames(Top_resto_FM_PA_sum)), stat="identity")



### For preservation
Top_preserv_FM_PA=shapefile("Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_top_preserv_NCP_clust_WDPA_WGS84.shp")

Top_preserv_FM_PA_df=Top_preserv_FM_PA@data

levels(as.factor(Top_preserv_FM_PA_df$IUCN_CAT))
#  [1] "Ia"           "Ib"           "III"          "IV"           "Not Assigned"
# [6] "Not Reported" "VI"  
Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="Ia")]=1
Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="Ib")]=1
# Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="II")]=2
Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="III")]=3
Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="IV")]=4
# Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="V")]=5
Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="VI")]=6
Top_preserv_FM_PA_df$IUCN_CAT[which(is.na(Top_preserv_FM_PA_df$IUCN_CAT))]=0

Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="Not Assigned")]=NA
Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$IUCN_CAT=="Not Reported")]=NA

Top_preserv_FM_PA_df$IUCN_CAT=as.integer(Top_preserv_FM_PA_df$IUCN_CAT)


levels_fid=levels(as.factor(Top_preserv_FM_PA_df$fid))
for (i in 1:nlevels(as.factor(Top_preserv_FM_PA_df$fid))){
  print(i)
  print(nrow(Top_preserv_FM_PA_df[which(Top_preserv_FM_PA_df$fid==levels_fid[i]),]))
  print(Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$fid==levels_fid[i])])
  if (nrow(Top_preserv_FM_PA_df[which(Top_preserv_FM_PA_df$fid==levels_fid[i]),])>1){
    
    data_sans_0=Top_preserv_FM_PA_df$IUCN_CAT[which(Top_preserv_FM_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    
    if ((T %in% !is.na(data_sans_0))==F){
      Top_preserv_FM_PA_df=Top_preserv_FM_PA_df[-grep(levels_fid[i], Top_preserv_FM_PA_df$fid)[1],]
    }
    if (F %in% is.na(data_sans_0)){
      
      if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
    
      min_level=min(data_sans_0, na.rm=T)
   
    
       Top_preserv_FM_PA_df=Top_preserv_FM_PA_df[-which(Top_preserv_FM_PA_df$fid==levels_fid[i] & (is.na(Top_preserv_FM_PA_df$IUCN_CAT) | Top_preserv_FM_PA_df$IUCN_CAT != min_level)),]
    }
    
    
    
      if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
        Top_preserv_FM_PA_df=Top_preserv_FM_PA_df[-grep(levels_fid[i], Top_preserv_FM_PA_df$fid)[-1],]
    }
    }
     
  }
  
}


nrow(Top_preserv_FM_PA_df)

Top_preserv_FM_PA_sum=as.data.frame(summary(as.factor(Top_preserv_FM_PA_df$IUCN_CAT)))


colnames(Top_preserv_FM_PA_sum)=c("nb")
# Top_preserv_FM_PA_sum=t(Top_preserv_FM_PA_sum)
p=ggplot(Top_preserv_FM_PA_sum) + geom_bar(aes(x="Preservation", y=nb, fill=rownames(Top_preserv_FM_PA_sum)), stat="identity")


### Both preserv and resto
p=ggplot() + geom_bar(data=Top_preserv_FM_PA_sum, aes(x="Preservation", y=nb, fill=rownames(Top_preserv_FM_PA_sum)), stat="identity") +
  geom_bar(data=Top_resto_FM_PA_sum, aes(x="Restoration", y=nb, fill=rownames(Top_resto_FM_PA_sum)), stat="identity")


### Geom_bar

Top_preserv_FM_PA_sum$TOP="Preservation"
Top_preserv_FM_PA_sum$PA=rownames(Top_preserv_FM_PA_sum)
Top_preserv_FM_PA_sum$PA[nrow(Top_preserv_FM_PA_sum)]="Not Categorised"
Top_resto_FM_PA_sum$TOP="Restoration"
Top_resto_FM_PA_sum$PA=rownames(Top_resto_FM_PA_sum)
Top_resto_FM_PA_sum$PA[nrow(Top_resto_FM_PA_sum)]="Not Categorised"
Top_FM_PA_sum=rbind(Top_preserv_FM_PA_sum,Top_resto_FM_PA_sum)

## Geom_bar - Prop


# Label preserv
label_pres=c(Top_preserv_FM_PA_sum$nb[5]/2,
             Top_preserv_FM_PA_sum$nb[5]+(Top_preserv_FM_PA_sum$nb[4]/2),
             Top_preserv_FM_PA_sum$nb[5]+Top_preserv_FM_PA_sum$nb[4]+Top_preserv_FM_PA_sum$nb[3]+Top_preserv_FM_PA_sum$nb[2]+(Top_preserv_FM_PA_sum$nb[1]/2)
             )
# Label resto
label_resto=c(Top_resto_FM_PA_sum$nb[6]/2,
             Top_resto_FM_PA_sum$nb[6]+(Top_resto_FM_PA_sum$nb[5]/2),
             Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+(Top_resto_FM_PA_sum$nb[4]/2),
             # Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+Top_resto_FM_PA_sum$nb[4]+(Top_resto_FM_PA_sum$nb[3]/2),
             # Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+Top_resto_FM_PA_sum$nb[4]+Top_resto_FM_PA_sum$nb[3]+(Top_resto_FM_PA_sum$nb[2]/2),
             Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+Top_resto_FM_PA_sum$nb[4]+Top_resto_FM_PA_sum$nb[3]+Top_resto_FM_PA_sum$nb[2]+(Top_resto_FM_PA_sum$nb[1]/2)
            )

# Color
color_values=c(rgb(128,128,128, maxColorValue=255))
color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(Top_FM_PA_sum$PA))+1))
## I remove the cat=5 and cat=6 colors to keep NA color
color_values=color_values[-c(6,7)]

Top_FM_PA_sum$TOP=as.factor(Top_FM_PA_sum$TOP)
Top_FM_PA_sum$PA=as.factor(Top_FM_PA_sum$PA)

p=ggplot() + geom_bar(data=Top_FM_PA_sum, aes(x=TOP, y=nb, fill=PA), stat="identity")+scale_fill_manual(values=color_values)+
    # geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_FM_PA_sum$nb[c(5,4,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_FM_PA_sum$nb[c(6,5,4,1)],0))), size=10)+ 
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)


ggsave(plot=p, filename = paste(dossier_af, "/Figure/PA" ,"/geom_bar_PA_agrof", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/PA" ,"/geom_bar_PA_agrof_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

#### with proportion

Top_preserv_FM_PA_sum$Prop=100*Top_preserv_FM_PA_sum$nb/sum(Top_preserv_FM_PA_sum$nb)

Top_resto_FM_PA_sum$Prop=100*Top_resto_FM_PA_sum$nb/sum(Top_resto_FM_PA_sum$nb)
Top_FM_PA_sum=rbind(Top_preserv_FM_PA_sum,Top_resto_FM_PA_sum)

# Label preserv
label_pres=c(Top_preserv_FM_PA_sum$Prop[5]/2,
             Top_preserv_FM_PA_sum$Prop[5]+(Top_preserv_FM_PA_sum$Prop[4]/2),
             Top_preserv_FM_PA_sum$Prop[5]+Top_preserv_FM_PA_sum$Prop[4]+Top_preserv_FM_PA_sum$Prop[3]+Top_preserv_FM_PA_sum$Prop[2]+(Top_preserv_FM_PA_sum$Prop[1]/2)
             )
# Label resto
label_resto=c(Top_resto_FM_PA_sum$Prop[6]/2,
             Top_resto_FM_PA_sum$Prop[6]+(Top_resto_FM_PA_sum$Prop[5]/2),
             Top_resto_FM_PA_sum$Prop[6]+Top_resto_FM_PA_sum$Prop[5]+(Top_resto_FM_PA_sum$Prop[4]/2),
             # Top_resto_FM_PA_sum$Prop[6]+Top_resto_FM_PA_sum$Prop[5]+Top_resto_FM_PA_sum$Prop[4]+(Top_resto_FM_PA_sum$Prop[3]/2),
             # Top_resto_FM_PA_sum$Prop[6]+Top_resto_FM_PA_sum$Prop[5]+Top_resto_FM_PA_sum$Prop[4]+Top_resto_FM_PA_sum$Prop[3]+(Top_resto_FM_PA_sum$Prop[2]/2),
             Top_resto_FM_PA_sum$Prop[6]+Top_resto_FM_PA_sum$Prop[5]+Top_resto_FM_PA_sum$Prop[4]+Top_resto_FM_PA_sum$Prop[3]+Top_resto_FM_PA_sum$Prop[2]+(Top_resto_FM_PA_sum$Prop[1]/2)
            )

p=ggplot() + geom_bar(data=Top_FM_PA_sum, aes(x=TOP, y=Prop, fill=PA), stat="identity")+scale_fill_manual(values=color_values)+
    # geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_FM_PA_sum$Prop[c(5,4,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_FM_PA_sum$Prop[c(6,5,4,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)


# ggsave(plot=p, filename = paste(dossier_af, "/Figure/PA" ,"/geom_bar_PA_agrof_prop_percentage_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/PA" ,"/geom_bar_PA_agrof_percentage_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

#### Avec bar en prop

# Label preserv
label_pres=c(Top_preserv_FM_PA_sum$nb[5]/2,
             Top_preserv_FM_PA_sum$nb[5]+(Top_preserv_FM_PA_sum$nb[4]/2),
             Top_preserv_FM_PA_sum$nb[5]+Top_preserv_FM_PA_sum$nb[4]+Top_preserv_FM_PA_sum$nb[3]+Top_preserv_FM_PA_sum$nb[2]+(Top_preserv_FM_PA_sum$nb[1]/2)
             )
# Label resto
label_resto=c(Top_resto_FM_PA_sum$nb[6]/2,
             Top_resto_FM_PA_sum$nb[6]+(Top_resto_FM_PA_sum$nb[5]/2),
             Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+(Top_resto_FM_PA_sum$nb[4]/2),
             # Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+Top_resto_FM_PA_sum$nb[4]+(Top_resto_FM_PA_sum$nb[3]/2),
             # Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+Top_resto_FM_PA_sum$nb[4]+Top_resto_FM_PA_sum$nb[3]+(Top_resto_FM_PA_sum$nb[2]/2),
             Top_resto_FM_PA_sum$nb[6]+Top_resto_FM_PA_sum$nb[5]+Top_resto_FM_PA_sum$nb[4]+Top_resto_FM_PA_sum$nb[3]+Top_resto_FM_PA_sum$nb[2]+(Top_resto_FM_PA_sum$nb[1]/2)
            )

p=ggplot() + geom_bar(data=Top_FM_PA_sum, aes(x=TOP, y=nb, fill=PA), stat="identity")+scale_fill_manual(values=color_values)+
    geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_FM_PA_sum$Prop[c(5,4,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_FM_PA_sum$Prop[c(6,5,4,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)


ggsave(plot=p, filename = paste(dossier_af, "/Figure/PA" ,"/geom_bar_PA_agrof_bar_nb_with_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)



#### Test stats
TOP_PA=data.frame(IUCN_CAT=0:7, Pres=NA, Resto=NA)
for (i in (1:7)){
  if ((i-1) %in% Top_preserv_FM_PA_sum$PA){
  TOP_PA$Pres[i]=Top_preserv_FM_PA_sum$nb[which(Top_preserv_FM_PA_sum$PA==as.character(i-1))]
  } else {TOP_PA$Pres[i]=0}
  
    if ((i-1) %in% Top_resto_FM_PA_sum$PA){
  TOP_PA$Resto[i]=Top_resto_FM_PA_sum$nb[which(Top_resto_FM_PA_sum$PA==as.character(i-1))]
    } else {TOP_PA$Resto[i]=0}
}
TOP_PA$Pres[8]=Top_preserv_FM_PA_sum$nb[which(Top_preserv_FM_PA_sum$PA=="Not Categorised")]
TOP_PA$Resto[8]=Top_resto_FM_PA_sum$nb[which(Top_resto_FM_PA_sum$PA=="Not Categorised")]




khi_prop_clust=TOP_PA[,-1]
khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust)
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c(0,1,2,3,4,"Not categorised")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#                   Preservation Restoration
# 0                         21          32
# 1                          0           0
# 2                          4           6
# 3                          7          11
# 4                          0           0
# Not categorised            8          12

# >10 => significant



```

### BD

```{r bd_agrof}
## Done in QGIS : join conservation status attribute (EEA layer) to priority areas shapefile

### BD in TOP RESTORATION 

Top_resto_AF_BD=shapefile("Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_top_resto_NCP_clust_BD_art17_WGS84.shp")

Top_resto_AF_BD_df=Top_resto_AF_BD@data


table(Top_resto_AF_BD_df[,c(grep("cluster", colnames(Top_resto_AF_BD_df)),grep("conclusion", colnames(Top_resto_AF_BD_df)))])
# cluster FV U1 U2 XX
#       1  2 38 67  3
#       2  1  1  0  1
#       3  1 78 83  0

Top_resto_AF_BD_sum=as.data.frame(table(Top_resto_AF_BD_df[,c(grep("cluster", colnames(Top_resto_AF_BD_df)),grep("conclusion", colnames(Top_resto_AF_BD_df)))]))
sum(Top_resto_AF_BD_sum$Freq) # 275 => ok


p=ggplot(Top_resto_AF_BD_sum) + geom_bar(aes(x=conclusion, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


Top_resto_AF_BD_summary=data.frame(conclusion=c("FV", "U1", "U2", "XX"), Freq=NA)
Top_resto_AF_BD_summary$conclusion=as.factor(Top_resto_AF_BD_summary$conclusion)
for (i in 1:nrow(Top_resto_AF_BD_summary)){
  Top_resto_AF_BD_summary$Freq[i]=sum(Top_resto_AF_BD_sum$Freq[which(Top_resto_AF_BD_sum$conclusion==Top_resto_AF_BD_summary$conclusion[i])])
}

p=ggplot(Top_resto_AF_BD_summary) + geom_bar(aes(x="Restoration", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))


## BD in TOP PRESERVATION


Top_preserv_AF_BD=shapefile("Path/to/working/directory/R/Export_data/Agrof/Dist_to_centroid/Anomalies_cropland_top_preserv_NCP_clust_BD_art17_WGS84.shp")

Top_preserv_AF_BD_df=Top_preserv_AF_BD@data
str(Top_preserv_AF_BD_df)

table(Top_preserv_AF_BD_df[,c(grep("cluster", colnames(Top_preserv_AF_BD_df)),grep("conclusion", colnames(Top_preserv_AF_BD_df)))])
# cluster  FV  U1  U2  XX
#       1   2  66 189   4
#       2   1  17  16   0
#       3   1  77 139   3

Top_preserv_AF_BD_sum=as.data.frame(table(Top_preserv_AF_BD_df[,c(grep("cluster", colnames(Top_preserv_AF_BD_df)),grep("conclusion", colnames(Top_preserv_AF_BD_df)))]))
sum(Top_preserv_AF_BD_sum$Freq) # 515 => ok


p=ggplot(Top_preserv_AF_BD_sum) + geom_bar(aes(x=conclusion, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


Top_preserv_AF_BD_summary=data.frame(conclusion=c("FV", "U1", "U2", "XX"), Freq=NA)
Top_preserv_AF_BD_summary$conclusion=as.factor(Top_preserv_AF_BD_summary$conclusion)
for (i in 1:nrow(Top_preserv_AF_BD_summary)){
  Top_preserv_AF_BD_summary$Freq[i]=sum(Top_preserv_AF_BD_sum$Freq[which(Top_preserv_AF_BD_sum$conclusion==Top_preserv_AF_BD_summary$conclusion[i])])
}

p=ggplot(Top_preserv_AF_BD_summary) + geom_bar(aes(x="Preservation", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))

### GRAPH WITH RESTO and PRESERV

p=ggplot() + geom_bar(data=Top_preserv_AF_BD_summary, aes(x="Preservation", y=Freq, fill=conclusion), stat="identity") + geom_bar(data=Top_resto_AF_BD_summary, aes(x="Restoration", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))


Top_preserv_AF_BD_summary$Prop=100*Top_preserv_AF_BD_summary$Freq/sum(Top_preserv_AF_BD_summary$Freq)
Top_resto_AF_BD_summary$Prop=100*Top_resto_AF_BD_summary$Freq/sum(Top_resto_AF_BD_summary$Freq)


Top_preserv_AF_BD_summary$TOP="Preservation"
Top_resto_AF_BD_summary$TOP="Restoration"
Top_AF_BD_summary=rbind(Top_preserv_AF_BD_summary, Top_resto_AF_BD_summary)

# Label preserv
label_pres=c(Top_preserv_AF_BD_summary$Freq[4]+Top_preserv_AF_BD_summary$Freq[3]/2,
             Top_preserv_AF_BD_summary$Freq[4]+Top_preserv_AF_BD_summary$Freq[3]+(Top_preserv_AF_BD_summary$Freq[2]/2),
             Top_preserv_AF_BD_summary$Freq[4]+Top_preserv_AF_BD_summary$Freq[3]+Top_preserv_AF_BD_summary$Freq[2]+(Top_preserv_AF_BD_summary$Freq[1]/2)
             )
# Label resto
label_resto=c(Top_resto_AF_BD_summary$Freq[4]+Top_resto_AF_BD_summary$Freq[3]/2,
             Top_resto_AF_BD_summary$Freq[4]+Top_resto_AF_BD_summary$Freq[3]+(Top_resto_AF_BD_summary$Freq[2]/2),
             Top_resto_AF_BD_summary$Freq[4]+Top_resto_AF_BD_summary$Freq[3]+Top_resto_AF_BD_summary$Freq[2]+(Top_resto_AF_BD_summary$Freq[1]/2)
             )

p=ggplot() + geom_bar(data=Top_AF_BD_summary, aes(x=TOP, y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_AF_BD_summary$Prop[c(3,2,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_AF_BD_summary$Prop[c(3,2,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())
  


# ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD" ,"/geom_bar_BD_agrof", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD" ,"/geom_bar_BD_prop_agrof", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)



#### Test stats
TOP_BD=data.frame(IUCN_CAT=c("FV", "U1", "U2", "XX"), Pres=NA, Resto=NA)

for (i in (1:4)){
  if (TOP_BD$IUCN_CAT[i] %in% Top_preserv_AF_BD_summary$conclusion){
  TOP_BD$Pres[i]=Top_preserv_AF_BD_summary$Freq[which(Top_preserv_AF_BD_summary$conclusion==TOP_BD$IUCN_CAT[i])]
  } else {TOP_BD$Pres[i]=0}
  
    if (TOP_BD$IUCN_CAT[i] %in% Top_resto_AF_BD_summary$conclusion){
  TOP_BD$Resto[i]=Top_resto_AF_BD_summary$Freq[which(Top_resto_AF_BD_summary$conclusion==TOP_BD$IUCN_CAT[i])]
    } else {TOP_BD$Resto[i]=0}
}





khi_prop_clust=TOP_BD[,-1]
# khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust)
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("FV", "U1", "U2", "XX")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#        Preservation Restoration
# FV            2           4
# U1           20          37
# U2           13          24
# XX            0           0
# >10 => significant




```


### BD-CCMa

```{r bd_ccm_agrof}

###### BD VS current carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_actual_masked_top_preserv_AF_FV=mask(SOC_present_masked_cropland_pente_inf35, Top_preserv_AF_BD[which(Top_preserv_AF_BD$conclusion=="FV"),])
# SOC_actual_masked_top_preserv_AF_FV=SOC_actual_masked_top_preserv_AF_FV[-which(is.na(SOC_actual_masked_top_preserv_AF_FV@data@values)),]
# SOC_actual_masked_top_preserv_AF_FV@data@values=as.numeric(SOC_actual_masked_top_preserv_AF_FV@data@values) # 7526 values
length(SOC_actual_masked_top_preserv_AF_FV)
# boxplot(SOC_actual_masked_top_preserv_AF_FV) 

# sampleRandom(SOC_actual_masked_top_preserv_AF_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_preserv_AF_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_AF_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")
colnames(data_soc_preserv_AF_FV)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_AF_FV, aes(y=SOC, x="Preservation FV"))
fx(p)

remove(SOC_actual_masked_top_preserv_AF_FV)

## In U1 state
SOC_actual_masked_top_preserv_AF_U1=mask(SOC_present_masked_cropland_pente_inf35, Top_preserv_AF_BD[which(Top_preserv_AF_BD$conclusion=="U1"),])
# SOC_actual_masked_top_preserv_AF_U1@data@values=as.numeric(SOC_actual_masked_top_preserv_AF_U1@data@values) # 7526 values
# length(SOC_actual_masked_top_preserv_AF_U1@data@values) # 90492624
# boxplot(SOC_actual_masked_top_preserv_AF_U1) 

# sampleRandom(SOC_actual_masked_top_preserv_AF_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_AF_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_AF_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")
colnames(data_soc_preserv_AF_U1)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_AF_U1, aes(y=SOC, x="Preservation U1"))
fx(p)

remove(SOC_actual_masked_top_preserv_AF_U1)

## In U2 state
SOC_actual_masked_top_preserv_AF_U2=mask(SOC_present_masked_cropland_pente_inf35, Top_preserv_AF_BD[which(Top_preserv_AF_BD$conclusion=="U2"),])
# SOC_actual_masked_top_preserv_AF_U2@data@values=as.numeric(SOC_actual_masked_top_preserv_AF_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_preserv_AF_U2) 

# sampleRandom(SOC_actual_masked_top_preserv_AF_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_AF_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_AF_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")
colnames(data_soc_preserv_AF_U2)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_AF_U2, aes(y=SOC, x="Preservation U2"))
fx(p)

remove(SOC_actual_masked_top_preserv_AF_U2)

# with all 3 state of BD
data_soc_preserv_AF_all=rbind(data_soc_preserv_AF_FV, data_soc_preserv_AF_U1, data_soc_preserv_AF_U2)
data_soc_preserv_AF_all$BD=as.factor(data_soc_preserv_AF_all$BD)

p=ggplot() + geom_violin(data=data_soc_preserv_AF_all, aes(y=SOC, x=BD)) 



### In Top restoration

## In BD favourable state
SOC_actual_masked_top_resto_AF_FV=mask(SOC_present_masked_cropland_pente_inf35, Top_resto_AF_BD[which(Top_resto_AF_BD$conclusion=="FV"),])
# SOC_actual_masked_top_resto_AF_FV@data@values=as.numeric(SOC_actual_masked_top_resto_AF_FV@data@values) # 7526 values
length(SOC_actual_masked_top_resto_AF_FV)
# boxplot(SOC_actual_masked_top_resto_AF_FV) 

# sampleRandom(SOC_actual_masked_top_resto_AF_FV,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_AF_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_AF_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")
# data_soc_resto_AF_FV=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="FV")
colnames(data_soc_resto_AF_FV)=c("SOC", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_resto_AF_FV, aes(y=SOC, x="Restoration FV"))
# fx(p)
remove(SOC_actual_masked_top_resto_AF_FV)

## In U1 state
SOC_actual_masked_top_resto_AF_U1=mask(SOC_present_masked_cropland_pente_inf35, Top_resto_AF_BD[which(Top_resto_AF_BD$conclusion=="U1"),])
# SOC_actual_masked_top_resto_AF_U1@data@values=as.numeric(SOC_actual_masked_top_resto_AF_U1@data@values) # 7526 values
length(SOC_actual_masked_top_resto_AF_U1@data@values) # 90492624
# boxplot(SOC_actual_masked_top_resto_AF_U1) 

# sampleRandom(SOC_actual_masked_top_resto_AF_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_AF_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_AF_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")
# data_soc_resto_AF_U1=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U1")
colnames(data_soc_resto_AF_U1)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_resto_AF_U1, aes(y=SOC, x="Restoration U1"))
fx(p)
remove(SOC_actual_masked_top_resto_AF_U1)

## In U2 state
SOC_actual_masked_top_resto_AF_U2=mask(SOC_present_masked_cropland_pente_inf35, Top_resto_AF_BD[which(Top_resto_AF_BD$conclusion=="U2"),])
# SOC_actual_masked_top_resto_AF_U2@data@values=as.numeric(SOC_actual_masked_top_resto_AF_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_resto_AF_U2) 
length(SOC_actual_masked_top_resto_AF_U2) # 90492624

# sampleRandom(SOC_actual_masked_top_resto_AF_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_AF_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_AF_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")
# data_soc_resto_AF_U2=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U2")
colnames(data_soc_resto_AF_U2)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_resto_AF_U2, aes(y=SOC, x="Restoration U2"))
fx(p)
remove(SOC_actual_masked_top_resto_AF_U2)



# with all 3 state of BD
data_soc_resto_AF_all=rbind(data_soc_resto_AF_FV, data_soc_resto_AF_U1, data_soc_resto_AF_U2)
data_soc_resto_AF_all$BD=as.factor(data_soc_resto_AF_all$BD)

p=ggplot() + geom_violin(data=data_soc_resto_AF_all, aes(y=SOC, x=BD)) 



# data_soc_AF_FV=rbind(data_soc_preserv_AF_FV, data_soc_resto_AF_FV)
# data_soc_AF_U1=rbind(data_soc_preserv_AF_U1, data_soc_resto_AF_U1)
# data_soc_AF_U2=rbind(data_soc_preserv_AF_U2, data_soc_resto_AF_U2)

# p=ggplot() +
#   geom_violin(data=data_soc_AF_FV, aes(y=SOC, x=TOP, fill=BD)) +
#   geom_violin(data=data_soc_AF_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_AF_U2, aes(y=SOC, x=TOP, fill=BD))


data_soc_all_AF_all=rbind(data_soc_preserv_AF_all, data_soc_resto_AF_all)

p=ggplot() + geom_violin(data=data_soc_all_AF_all, aes(y=SOC, x=BD:TOP, fill=TOP))
fx(p)

p=ggplot() + geom_violin(data=data_soc_all_AF_all, aes(y=SOC, x=TOP:BD, fill=BD))
fx(p)

### ANOVA

aov_AF=aov(data=data_soc_all_AF_all, SOC~TOP*BD)
anova(aov_AF) 

# Response: SOC
#              Df  Sum Sq Mean Sq F value    Pr(>F)    
# TOP           1    444  443.86 87.4873 < 2.2e-16 ***
# BD            2    100   49.99  9.8542 5.295e-05 ***
# TOP:BD        2     18    8.97  1.7681    0.1707  

TukeyHSD(aov_AF)
#                             diff         lwr         upr     p adj
# Restoration > Preservation 0.3846483 0.3040394 0.4652573     0
# U1 < FV                   -0.2171875 -0.33524489 -0.09913017 0.0000484
# U2 < FV                   -0.1546200 -0.27267739 -0.03656266 0.0060786
# U2 = U1                    0.0625675 -0.05548986  0.18062487 0.4282566

TukeyHSD(aov_AF)$`TOP:BD`[which(TukeyHSD(aov_AF)$`TOP:BD`[,4]<0.05),]
#                                      diff         lwr         upr        p adj
# Restoration:FV > Preservation:FV   0.326350  0.12333775  0.52936225 6.824758e-05
# Preservation:U1 < Preservation:FV -0.220845 -0.42385728 -0.01783277 2.376315e-02
# Preservation:U2 < Preservation:FV -0.238410 -0.44142228 -0.03539777 1.061392e-02
# Restoration:U2 > Preservation:FV   0.255520  0.05250772  0.45853223 4.525519e-03
# Preservation:U1 < Restoration:FV  -0.547195 -0.75020728 -0.34418278 0.000000e+00
# Restoration:U1 < Restoration:FV   -0.213530 -0.41654228 -0.01051777 3.254135e-02
# Preservation:U2 < Restoration:FV  -0.564760 -0.76777228 -0.36174777 0.000000e+00
# Restoration:U1 > Preservation:U1   0.333665  0.13065275  0.53667725 4.173975e-05
# Restoration:U2 > Preservation:U1   0.476365  0.27335275  0.67937726 0.000000e+00
# Preservation:U2 < Restoration:U1  -0.351230 -0.55424225 -0.14821775 1.227317e-05
# Restoration:U2 >Preservation:U2   0.493930  0.29091775  0.69694226 0.000000e+00

HSD_AF=HSD.test(aov_AF, trt="TOP", group=T, alpha=0.05)
# SOC groups
# Restoration  1.478048      a
# Preservation 1.093400      b


## Manual group
# "FV:Preservation"      a
# "FV:Restoration"   b
# "U1:Preservation"      a
# "U1:Restoration"     c
# "U2:Preservation"        d
# "U2:Restoration"   b

x_groups=c("FV:Preservation", "FV:Restoration", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
groups=c("a", "b", "a", "c", "d", "b")

### PLOT

data_soc_all_AF_all=rbind(data_soc_preserv_AF_all, data_soc_resto_AF_all)

p=ggplot() + geom_violin(data=data_soc_all_AF_all, aes(y=SOC, x=BD:TOP, fill=TOP))
fx(p)


Top_preserv_AF_BD_summary$Prop=100*Top_preserv_AF_BD_summary$Freq/sum(Top_preserv_AF_BD_summary$Freq)
Top_resto_AF_BD_summary$Prop=100*Top_resto_AF_BD_summary$Freq/sum(Top_resto_AF_BD_summary$Freq)


median_data <- data_soc_all_AF_all %>%
  group_by(BD:TOP) %>%
  summarize(median_soc = median(SOC, na.rm=T)) %>% as.data.frame()

# median_data=median_data[c(1,4,2,5,3,6),]
colnames(median_data)=c("TOP", "median_soc")


p=ggplot() + geom_violin(data=data_soc_all_AF_all, aes(y=SOC, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=x_groups, y=41 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = (median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)
  
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_groups_agrof", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_agrof", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)

# WITH LOG

p=ggplot() + geom_violin(data=data_soc_all_AF_all, aes(y=log10(SOC), x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=x_groups, y=1.7 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = log10(median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_groups_agrof", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_agrof", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)




```

### BD-CCMp

```{r bd_ccm_pot_agrof}

###### BD VS potential carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_potent_masked_top_preserv_AF_FV=mask(SOC_potential_masked_cropland_slope_inf35, Top_preserv_AF_BD[which(Top_preserv_AF_BD$conclusion=="FV"),])
# SOC_potent_masked_top_preserv_AF_FV=SOC_potent_masked_top_preserv_AF_FV[-which(is.na(SOC_potent_masked_top_preserv_AF_FV@data@values)),]
# SOC_potent_masked_top_preserv_AF_FV@data@values=as.numeric(SOC_potent_masked_top_preserv_AF_FV@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_AF_FV)
# boxplot(SOC_potent_masked_top_preserv_AF_FV) 

# sampleRandom(SOC_potent_masked_top_preserv_AF_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_pot_preserv_AF_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_AF_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")
colnames(data_soc_pot_preserv_AF_FV)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_AF_FV, aes(y=SOP, x="Preservation FV"))
fx(p)

remove(SOC_potent_masked_top_preserv_AF_FV)

## In U1 state
SOC_potent_masked_top_preserv_AF_U1=mask(SOC_potential_masked_cropland_slope_inf35, Top_preserv_AF_BD[which(Top_preserv_AF_BD$conclusion=="U1"),])
# SOC_potent_masked_top_preserv_AF_U1@data@values=as.numeric(SOC_potent_masked_top_preserv_AF_U1@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_AF_U1@data@values) # 90492624
# boxplot(SOC_potent_masked_top_preserv_AF_U1) 

# sampleRandom(SOC_potent_masked_top_preserv_AF_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_preserv_AF_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_AF_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")
colnames(data_soc_pot_preserv_AF_U1)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_AF_U1, aes(y=SOP, x="Preservation U1"))
fx(p)

remove(SOC_potent_masked_top_preserv_AF_U1)

## In U2 state
SOC_potent_masked_top_preserv_AF_U2=mask(SOC_potential_masked_cropland_slope_inf35, Top_preserv_AF_BD[which(Top_preserv_AF_BD$conclusion=="U2"),])
# SOC_potent_masked_top_preserv_AF_U2@data@values=as.numeric(SOC_potent_masked_top_preserv_AF_U2@data@values) # 90492624 values
length(SOC_potent_masked_top_preserv_AF_U2)
# boxplot(SOC_potent_masked_top_preserv_AF_U2) 

# sampleRandom(SOC_potent_masked_top_preserv_AF_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_preserv_AF_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_AF_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")
colnames(data_soc_pot_preserv_AF_U2)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_AF_U2, aes(y=SOP, x="Preservation U2"))
fx(p)

remove(SOC_potent_masked_top_preserv_AF_U2)

# with all 3 state of BD
data_sop_pot_preserv_AF_all=rbind(data_soc_pot_preserv_AF_FV, data_soc_pot_preserv_AF_U1, data_soc_pot_preserv_AF_U2)
data_sop_pot_preserv_AF_all$BD=as.factor(data_sop_pot_preserv_AF_all$BD)

p=ggplot() + geom_violin(data=data_soc_pot_preserv_AF_all, aes(y=SOP, x=BD)) 



### In Top restoration

## In BD favourable state
SOC_potent_masked_top_resto_AF_FV=mask(SOC_potential_masked_cropland_slope_inf35, Top_resto_AF_BD[which(Top_resto_AF_BD$conclusion=="FV"),])
# SOC_potent_masked_top_resto_AF_FV@data@values=as.numeric(SOC_potent_masked_top_resto_AF_FV@data@values) # 7526 values
length(SOC_potent_masked_top_resto_AF_FV)
# boxplot(SOC_potent_masked_top_resto_AF_FV) 

# sampleRandom(SOC_potent_masked_top_resto_AF_FV,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_AF_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_AF_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")
# data_soc_pot_resto_AF_FV=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="FV")
colnames(data_soc_pot_resto_AF_FV)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_AF_FV, aes(y=SOP, x="Restoration FV"))
fx(p)
remove(SOC_potent_masked_top_resto_AF_FV)

## In U1 state
SOC_potent_masked_top_resto_AF_U1=mask(SOC_potential_masked_cropland_slope_inf35, Top_resto_AF_BD[which(Top_resto_AF_BD$conclusion=="U1"),])
# SOC_potent_masked_top_resto_AF_U1@data@values=as.numeric(SOC_potent_masked_top_resto_AF_U1@data@values) # 7526 values
length(SOC_potent_masked_top_resto_AF_U1@data@values) # 90492624
# boxplot(SOC_potent_masked_top_resto_AF_U1) 

# sampleRandom(SOC_potent_masked_top_resto_AF_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_AF_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_AF_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")
# data_soc_pot_resto_AF_U1=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U1")
colnames(data_soc_pot_resto_AF_U1)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_AF_U1, aes(y=SOP, x="Restoration U1"))
fx(p)
remove(SOC_potent_masked_top_resto_AF_U1)



## In U2 state
SOC_potent_masked_top_resto_AF_U2=mask(SOC_potential_masked_cropland_slope_inf35, Top_resto_AF_BD[which(Top_resto_AF_BD$conclusion=="U2"),])
# SOC_potent_masked_top_resto_AF_U2@data@values=as.numeric(SOC_potent_masked_top_resto_AF_U2@data@values) # 90492624 values
# boxplot(SOC_potent_masked_top_resto_AF_U2) 
length(SOC_potent_masked_top_resto_AF_U2) # 90492624

# sampleRandom(SOC_potent_masked_top_resto_AF_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_AF_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_AF_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")
# data_soc_pot_resto_AF_U2=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U2")
colnames(data_soc_pot_resto_AF_U2)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_AF_U2, aes(y=SOP, x="Restoration U2"))
fx(p)
remove(SOC_potent_masked_top_resto_AF_U2)



# with all 3 state of BD
data_sop_pot_resto_AF_all=rbind(data_soc_pot_resto_AF_FV, data_soc_pot_resto_AF_U1, data_soc_pot_resto_AF_U2)
data_sop_pot_resto_AF_all$BD=as.factor(data_sop_pot_resto_AF_all$BD)

p=ggplot() + geom_violin(data=data_sop_pot_resto_AF_all, aes(y=SOP, x=BD)) 



# data_soc_pot_AF_FV=rbind(data_soc_pot_preserv_AF_FV, data_soc_pot_resto_AF_FV)
# data_soc_pot_AF_U1=rbind(data_soc_pot_preserv_AF_U1, data_soc_pot_resto_AF_U1)
# data_soc_pot_AF_U2=rbind(data_soc_pot_preserv_AF_U2, data_soc_pot_resto_AF_U2)

# p=ggplot() +
#   geom_violin(data=data_soc_pot_AF_FV, aes(y=SOC, x=TOP, fill=BD)) +
#   geom_violin(data=data_soc_pot_AF_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_pot_AF_U2, aes(y=SOC, x=TOP, fill=BD))


data_sop_pot_all_AF_all=rbind(data_soc_pot_preserv_AF_all, data_soc_pot_resto_AF_all)

p=ggplot() + geom_violin(data=data_soc_pot_all_AF_all, aes(y=SOP, x=BD:TOP, fill=TOP))
fx(p)

p=ggplot() + geom_violin(data=data_soc_pot_all_AF_all, aes(y=SOP, x=TOP:BD, fill=BD))
fx(p)

### ANOVA

aov_pot_AF=aov(data=data_sop_pot_all_AF_all, SOP~TOP*BD)
anova(aov_pot_AF) 

# Response: SOP
#              Df  Sum Sq Mean Sq  F value    Pr(>F)  
# TOP           1   0.501  0.5015  34.1779 5.161e-09 ***
# BD            2   0.207  0.1037   7.0664 0.0008569 ***
# TOP:BD        2  10.734  5.3671 365.7934 < 2.2e-16 ***

TukeyHSD(aov_pot_AF)
#                             diff          lwr            upr       p adj
# Restoration > Preservation  0.01292896   0.008594024  0.01726389     0
# U1 > FV                     0.009527886  0.003179075  0.015876698  0.0012700
# U2 = FV                     0.001653386 -0.004695425  0.008002198  0.8144222
# U2 <? U1                    -0.007874500 -0.014223312 -0.001525688 0.0102129

TukeyHSD(aov_pot_AF)$`TOP:BD`[which(TukeyHSD(aov_pot_AF)$`TOP:BD`[,4]<0.05),]
#                                      diff          lwr           upr
# .Restoration:U1 > Preservation:FV   0.03091575  0.019998287  0.0418332077
# .Restoration:U2 > Preservation:FV   0.04624310  0.035325636  0.0571605569
# .Preservation:U1 < Restoration:FV  -0.01185997 -0.022777435 -0.0009425139
# .Preservation:U2 < Restoration:FV  -0.04293632 -0.053853784 -0.0320188632
# .Restoration:U2 < Preservation:U1  -0.03506519 -0.045982654 -0.0241477333
# .Preservation:U2 > Restoration:U1   0.01931619  0.008398733  0.0302336543
# Restoration:FV > Preservation:FV   0.09316826  0.082250804  0.1040857251
# Preservation:U1 > Preservation:FV  0.08130829  0.070390830  0.0922257508
# Restoration:U2 > Restoration:U1    0.01532735  0.004409889  0.0262448097
# Preservation:U2 > Preservation:FV  0.05023194  0.039314480  0.0611494015
# Restoration:U1 < Restoration:FV   -0.06225252 -0.073169978 -0.0513350569
# Restoration:U2 < Restoration:FV   -0.04692517 -0.057842629 -0.0360077077
# Restoration:U1 < Preservation:U1  -0.05039254 -0.061310004 -0.0394750826
# Preservation:U2 < Preservation:U1 -0.03107635 -0.041993810 -0.0201588888

# Manual grouping

# "FV:Preservation"       a
# "FV:Restoration"  b
# "U1:Preservation"  c
# "U1:Restoration"    d
# "U2:Preservation"   d
# "U2:Restoration"   c

x_groups=c("FV:Preservation", "FV:Restoration", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
groups=c("a", "b", "c", "d", "d", "c")

### PLOT
# data_sop_pot_all_AF_all

p=ggplot() + geom_violin(data=data_sop_pot_all_AF_all, aes(y=SOP, x=BD:TOP, fill=TOP))
fx(p)


# Top_preserv_AF_BD_summary$Prop=100*Top_preserv_AF_BD_summary$Freq/sum(Top_preserv_AF_BD_summary$Freq)
# Top_resto_AF_BD_summary$Prop=100*Top_resto_AF_BD_summary$Freq/sum(Top_resto_WR_AF_summary$Freq)


median_data <- data_sop_pot_all_AF_all %>%
  group_by(BD:TOP) %>%
  summarize(median_sop = median(SOP, na.rm=T)) %>% as.data.frame()

# median_data=median_data[c(1,4,2,5,3,6),]
colnames(median_data)=c("TOP", "median_sop")


p=ggplot() + geom_violin(data=data_sop_pot_all_AF_all, aes(y=SOP, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=x_groups, y=1.05 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = (median_sop), x=`BD:TOP`), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)  
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_groups_agrof", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_agrof", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)


```

### CCM absolute

```{r absolute_ccm_croplands}
# Is it possible to compute the amount of carbon sequestrated with saturation and current stock
# Capacity=current stock/saturation

# SOC:
SOC_present_masked_cropland_pente_inf35
# SOP :
SOC_potential_masked_cropland_slope_inf35

Capacity_croplands=SOC_present_masked_cropland_pente_inf35*(1-SOC_potential_masked_cropland_slope_inf35)/SOC_potential_masked_cropland_slope_inf35

# Top preserv
Capacity_CCM_croplands_preserv=mask(Capacity_croplands, Anomalies2100_in_WS_raster_cropland_masked_top_pres)

length(Capacity_CCM_croplands_preserv@data@values[-which(is.na(Capacity_CCM_croplands_preserv@data@values))])

data_capacity_preserv=data.frame(Capacity=sampleRandom(Capacity_CCM_croplands_preserv$layer, 10000, na.rm=T, xy=F), TOP=as.factor("Preservation"))

str(data_capacity_preserv)


# Top resto
Capacity_CCM_croplands_resto=mask(Capacity_croplands, Anomalies2100_in_WS_raster_cropland_masked_top_resto)

length(Capacity_CCM_croplands_resto@data@values[-which(is.na(Capacity_CCM_croplands_resto@data@values))])

data_capacity_resto=data.frame(Capacity=sampleRandom(Capacity_CCM_croplands_resto$layer, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

str(data_capacity_resto)


# in AS
SOC_present_WGS84=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ESDAC/Derived_data_set_2013/SOC_top_soil_WGS84.tif")
crs(SOC_present_WGS84)@projargs==crs(AS_fusion_WGS84)@projargs
SOC_present_cut=crop(SOC_present_WGS84,AS_fusion_WGS84)
SOC_present_cut_resample=resample(SOC_present_cut, Carbon_saturation_cut_WGS84,method = 'ngb')

Capacity_CCM_in_AS=SOC_present_cut_resample*(1-Carbon_saturation_cut_WGS84)/Carbon_saturation_cut_WGS84
 
Capacity_CCM_in_AS=mask(Capacity_CCM_in_AS, AS_fusion_WGS84)

Capacity_CCM_in_AS_rd=data.frame(SOC=sampleRandom(Capacity_CCM_in_AS, 20000, na.rm=T, xy=F), TOP="AS")
colnames(Capacity_CCM_in_AS_rd)=c("Capacity", "TOP")





## ANOVA

aov_capacity_af=aov(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), Capacity~TOP)
anova(aov_capacity_af)
#              Df Sum Sq Mean Sq F value    Pr(>F) 
# TOP           2   4971 2485.42  861.27 < 2.2e-16 ***
# Residuals 39997 115421    2.89                           

TukeyHSD(aov_capacity_af)
# #                             diff         lwr       upr     p adj
# Restoration-Preservation  0.3267825  0.2704776  0.3830874     0
# AS-Preservation          -0.5027095 -0.5514710 -0.4539480     0
# AS-Restoration           -0.8294920 -0.8782536 -0.7807305     0

HSD_AF=HSD.test(aov_capacity_af, trt="TOP", group=T, alpha=0.05)
HSD_AF
# Capacity groups
# Restoration  1.2487293      a
# Preservation 0.9219468      b
# AS           0.4192373      c



### Capacity in pres & resto
median_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(median_cap = median(Capacity)) %>% as.data.frame()

median_log_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(median_cap = median(log10(Capacity))) %>% as.data.frame()

mean_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(mean_cap = mean(Capacity)) %>% as.data.frame()


mean_log_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(mean_cap = mean(log10(Capacity))) %>% as.data.frame()



p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = (median_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_af, "/Figure/CCM_capacity" ,"/geom_violin_croplands_CCM_capacity", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/CCM_capacity" ,"/geom_violin_croplands_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

### With log10

p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), aes(y=log10(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=2.5 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_log_data , aes(y = median_cap, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

# ggsave(plot=p, filename = paste(dossier_af, "/Figure/CCM_capacity" ,"/geom_violin_croplands_log_CCM_capacity", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_af, "/Figure/CCM_capacity" ,"/geom_violin_croplands_log_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


### Without AS
p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto), aes(y=log10(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration"), y=2.3 ,label = c("a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_log_data[-3,] , aes(y = (median_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

# ggsave(plot=p, filename = paste(dossier_af, "/Figure/CCM_capacity" ,"/geom_violin_croplands_log_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_af, "/Figure/CCM_capacity" ,"/geom_violin_croplands_log_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


##### AS only
# dossier_as="Path/to/working/directory/R/Export_data/AS/"
#   
# p=ggplot() + geom_violin(data=Capacity_CCM_in_AS_rd, aes(y=(Capacity), x=TOP, fill=TOP)) + 
#   scale_fill_manual(values=c(
#     # rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
#                # rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
#                # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
#                rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
#   # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
#   theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
#   geom_point(data =mean_data[-c(1,2),] , aes(y = (mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
# fx(p)
# 
# ggsave(plot=p, filename = paste(dossier_as, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# # ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

```



### Combined CCM index

```{r combined_ccm_index}
# >0: saturation (%) => high value to preserve
# <0: absolute carbon sequestration potential (tC/ha) = SOC*(1-saturation)

# SOC:
SOC_present_masked_cropland_pente_inf35
# Min.           0.00
# 1st Qu.        0.74
# Median         1.00
# 3rd Qu.        1.19
# Max.          39.40
# SOP :
SOC_potential_masked_cropland_slope_inf35
# Min.    2.706856e-01   0.27
# 1st Qu. 4.685622e-01   0.47
# Median  5.442965e-01   0.54
# 3rd Qu. 6.726968e-01   0.67
# Max.    1.000000e+00   1


list=1:length(SOC_present_masked_cropland_pente_inf35@data@values)
list=list[-which(is.na(SOC_present_masked_cropland_pente_inf35@data@values))]
length(list)/length(SOC_present_masked_cropland_pente_inf35@data@values) # 11%
list_sp=list[sample(list, 10^5)]

plot(SOC_present_masked_cropland_pente_inf35@data@values[list_sp], SOC_potential_masked_cropland_slope_inf35@data@values[list_sp])
### complicated to create one index...

summart(Capacity_croplands) #=SOC_present_masked_cropland_pente_inf35*(1-SOC_potential_masked_cropland_slope_inf35)/SOC_potential_masked_cropland_slope_inf35
# Min.    0.000000e+00
# 1st Qu. 4.606793e-01
# Median  7.430801e-01
# 3rd Qu. 1.088277e+00
# Max.    7.813310e+01


Cpot_add=SOC_present_masked_cropland_pente_inf35/SOC_potential_masked_cropland_slope_inf35
summary(Cpot_add)
# Min.    0.000000e+00
# 1st Qu. 1.317844e+00
# Median  1.637763e+00
# 3rd Qu. 2.272771e+00
# Max.    1.175331e+02

plot(SOC_present_masked_cropland_pente_inf35@data@values[list_sp], Cpot_add@data@values[list_sp])

### Preserv

Cpot_add_croplands_preserv=mask(Cpot_add, Anomalies2100_in_WS_raster_cropland_masked_top_pres)

length(Cpot_add_croplands_preserv@data@values[-which(is.na(Cpot_add_croplands_preserv@data@values))]) # 2527924

list=1:length(Cpot_add_croplands_preserv@data@values)
list=list[-which(is.na(Cpot_add_croplands_preserv@data@values))]
list_sp=list[sample(1:length(list), 10^5)]

data_cpot_add_preserv=data.frame(Cadd=Cpot_add_croplands_preserv@data@values[list_sp], SOC=SOC_actual_masked_cropland_pente_inf35_top_preserv@data@values[list_sp], TOP=as.factor("Surplus"))

data_cpot_add_preserv_reshp=reshape(data_cpot_add_preserv,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_preserv_reshp$time=factor(data_cpot_add_preserv_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


# Resto

Cpot_add_croplands_resto=mask(Cpot_add, Anomalies2100_in_WS_raster_cropland_masked_top_resto)

length(Cpot_add_croplands_resto@data@values[-which(is.na(Cpot_add_croplands_resto@data@values))]) # 2527924

list=1:length(Cpot_add_croplands_resto@data@values)
list=list[-which(is.na(Cpot_add_croplands_resto@data@values))]
list_sp=list[sample(1:length(list), 10^5)]

data_cpot_add_resto=data.frame(Cadd=Cpot_add_croplands_resto@data@values[list_sp], SOC=SOC_actual_masked_cropland_pente_inf35_top_resto@data@values[list_sp], TOP=as.factor("Deficit"))

data_cpot_add_resto_reshp=reshape(data_cpot_add_resto,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_resto_reshp$time=factor(data_cpot_add_resto_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


######## STATS
data_cpot_add_all_reshp=rbind(data_cpot_add_preserv_reshp, data_cpot_add_resto_reshp)

data_cpot_add_all_reshp$TOP=factor(data_cpot_add_all_reshp$TOP, ordered=T, levels = c("Surplus", "Deficit"))

aov_carbon=aov(data=data_cpot_add_all_reshp, Carbon~TOP*time)
anova(aov_carbon) 
# Response: Carbon
#              Df  Sum Sq Mean Sq  F value    Pr(>F)    
# TOP       1e+00   17717   17717  1573.81 < 2.2e-16 ***
# time      1e+00  114578  114578 10177.95 < 2.2e-16 ***
# TOP:time  1e+00    2150    2150   191.02 < 2.2e-16 ***

TukeyHSD(aov_carbon)
# $TOP
#                      diff       lwr       upr p adj
# Deficit > Surplus 0.4209169 0.4001215 0.4417124     0

# $time
#              diff      lwr      upr p adj
# Cadd > SOC 1.070411 1.049615 1.091206     0

TukeyHSD(aov_carbon)$`TOP:time`[which(TukeyHSD(aov_carbon)$`TOP:time`[,4]<0.05),]
# $`TOP:time`
#                                diff       lwr       upr p adj
# Deficit:SOC > Surplus:SOC   0.2742740 0.2357257 0.3128223     0
# Surplus:Cadd > Surplus:SOC  0.9237678 0.8852195 0.9623160     0
# Deficit:Cadd > Surplus:SOC  1.4913276 1.4527793 1.5298759     0
# Surplus:Cadd > Deficit:SOC  0.6494938 0.6109455 0.6880420     0
# Deficit:Cadd > Deficit:SOC  1.2170536 1.1785053 1.2556019     0
# Deficit:Cadd > Surplus:Cadd 0.5675598 0.5290116 0.6061081     0

# Manual grouping

# Surplus:SOC: a
# Surplus:Caad:    c
# Deficit:SOC:  b
# Deficit:Cadd:     d








######## PLOT


median_log_data <- data_cpot_add_all_reshp %>%
  group_by(TOP:time) %>%
  summarize(median_carbon = median(log10(Carbon), na.rm=T)) %>% as.data.frame()

### Without AS
p=ggplot() + geom_violin(data=data_cpot_add_all_reshp, aes(y=log10(Carbon), x=TOP, fill=TOP:time), position = position_dodge(0.8)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),rgb(1, 133, 113, maxColorValue = 255, alpha=0.6*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.6*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(data=median_log_data, aes(x=c(0.8, 1.2, 1.8, 2.2), y=2.2 ,label = c("a", "c", "b", "d")), stat="identity", vjust = 1.5, colour = "black",  size=10) +
    geom_point(data =median_log_data , aes(y = (median_carbon), x=c(0.8, 1.2, 1.8, 2.2)), shape = 4, size = 6, color = "black") +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

ggsave(plot=p, filename = paste(dossier_af, "/Figure/CCM_add" ,"/geom_bar_Carbon_SOC_add_groups_agrof", ".png", sep=''), width=7*2, height=10*2, limitsize=F, dpi = 300)



# 
# p=ggplot() + geom_violin(data=data_cpot_add_all_reshp, aes(y=log10(Carbon), x=TOP:time, fill=TOP)) + 
#   scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
#                rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
#                # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
#                rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
#   geom_text(aes(x=c("Surplus:SOC", "Surplus:Cadd", "Deficit:SOC", "Deficit:Cadd"), y=2.2 ,label = c("a", "c", "b", "d")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
#     geom_point(data =median_log_data , aes(y = (median_carbon), x=`TOP:time`), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75)) +
#   scale_x_discrete(labels = c("Current", "Potential", "Current", "Potential")) +
#   theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())








```


## Sylvopastoralism in grasslands

```{r sylvopasto_grasslands}
### Sylvopasto data
# dossier_sp="Path/to/working/directory/R/Export_data/Sylvopasto"


# Raster:
Grassland_masque=CLC_Alps_WGS84 %in% legend_grid_grasslands
Grassland_in_AS_raster=mask(CLC_Alps_WGS84, mask=Grassland_masque, maskvalue=0)
# Cropland_in_AS_raster=as.raster(Cropland_in_AS)
crs(Grassland_in_AS_raster)

# writeRaster(Grassland_in_AS_raster, "Path/to/working/directory/R/Export_data/Sylvopasto/Grassland_mask_in_CLC_AS_WGS84.tif", overwrite=T)
Grassland_in_AS_raster=raster("Path/to/working/directory/R/Export_data/Sylvopasto/Grassland_mask_in_CLC_AS_WGS84.tif")


# Cropland_in_AS_ETRS=projectRaster(Cropland_in_AS, crs = crs(Slopes_raster_WGS84)@projargs)
# extent(Cropland_in_AS_ETRS)
# Extraction des zones agricoles selon la couche AC

# Filtrer les zones agricoles avec une pente infrieure  35%
res(Grassland_in_AS_raster) # 0.001297000 0.000895796
res(Slopes_raster_cut_WGS84) # 0.008333333 0.008333333
# Slopes_raster_resampled_WGS84 <- resample(Slopes_raster_cut_WGS84, Grassland_in_AS_raster, method = 'ngb') # method ngb for closest neighbours

extent(Grassland_in_AS_raster)==extent(Slopes_raster_resampled_WGS84)

Grassland_in_AS_pente_inf35 <- mask(Grassland_in_AS_raster, mask=Slopes_raster_resampled_WGS84 >= 10, maskvalue=0)

Grassland_in_AS_pente_inf35 <-mask(Grassland_in_AS_pente_inf35, mask=AS_fusion_WGS84)


# writeRaster(Grassland_in_AS_pente_inf35, "Path/to/working/directory/R/Export_data/Sylvopasto/Grassland_mask_in_CLC_slopes_inf35_AS_WGS84.tif", overwrite=T)
Grassland_in_AS_pente_inf35=raster("Path/to/working/directory/R/Export_data/Sylvopasto/Grassland_mask_in_CLC_slopes_inf35_AS_WGS84.tif")


### Under the treeline 
# EU-Trees4F dataset

TreesCC_folder="Path/to/working/directory/CC_variable/CC_variable/CC_test/JRC/Forest_CC/EU-Trees4F_dataset/ens_sdms/bin/"

TreesCC_bin=list.files(TreesCC_folder)
TreesCC_rcp85_bin=TreesCC_bin[grep("rcp85", TreesCC_bin)]
TreesCC_rcp85_2065_bin=TreesCC_rcp85_bin[grep("fut2065", TreesCC_rcp85_bin)]
TreesCC_rcp85_2065_bin=TreesCC_rcp85_2065_bin[-grep("_lu.tif", TreesCC_rcp85_2065_bin)]
TreesCC_rcp85_2065_bin_pot=TreesCC_rcp85_2065_bin[grep("pot", TreesCC_rcp85_2065_bin)]
length(TreesCC_rcp85_2065_bin_pot)

### Tree a 
TreesCC_rcp85_2065_bin_a=raster(paste(TreesCC_folder, TreesCC_rcp85_2065_bin_pot[1], sep='' ))
crs(TreesCC_rcp85_2065_bin_a)@projargs=crs(AS_fusion_ETRS)@projargs

TreesCC_rcp85_2065_bin_a_WGS84=projectRaster(TreesCC_rcp85_2065_bin_a, crs= crs(AS_fusion_WGS84)@projargs)

res(TreesCC_rcp85_2065_bin_a_WGS84)
res(Grassland_in_AS_pente_inf35)
TreesCC_rcp85_2065_bin_a_WGS84_resampled=resample(TreesCC_rcp85_2065_bin_a_WGS84, Grassland_in_AS_pente_inf35, method='ngb')
res(Grassland_in_AS_pente_inf35)==res(TreesCC_rcp85_2065_bin_a_WGS84_resampled)
TreesCC_rcp85_2065_bin_a_WGS84_resampled@data@values=as.numeric(TreesCC_rcp85_2065_bin_a_WGS84_resampled@data@values)

### Tree b
# TreesCC_rcp85_2065_bin_b=raster(paste(TreesCC_folder, TreesCC_rcp85_2065_bin_pot[2], sep='' ))
# crs(TreesCC_rcp85_2065_bin_b)@projargs=crs(AS_fusion_ETRS)@projargs
# 
# TreesCC_rcp85_2065_bin_b_WGS84=projectRaster(TreesCC_rcp85_2065_bin_b, crs= crs(AS_fusion_WGS84)@projargs)
# 
# res(TreesCC_rcp85_2065_bin_b_WGS84)
# res(Grassland_in_AS_pente_inf35)
# TreesCC_rcp85_2065_bin_b_WGS84_resampled=resample(TreesCC_rcp85_2065_bin_b_WGS84, Grassland_in_AS_pente_inf35, method='ngb')
# res(Grassland_in_AS_pente_inf35)==res(TreesCC_rcp85_2065_bin_b_WGS84_resampled)
# TreesCC_rcp85_2065_bin_b_WGS84_resampled@data@values=as.numeric(TreesCC_rcp85_2065_bin_b_WGS84_resampled@data@values)



# Try with mask
TreesCC_rcp85_2065_bin_all=raster(Grassland_in_AS_pente_inf35)
TreesCC_rcp85_2065_bin_all[]=0
for (i in 1:length(TreesCC_rcp85_2065_bin_pot)){
  print(i)
  
    TreesCC_rcp85_2065_bin_i=raster(paste(TreesCC_folder, TreesCC_rcp85_2065_bin[i], sep='' ))
  crs(TreesCC_rcp85_2065_bin_i)@projargs=crs(AS_fusion_ETRS)@projargs
  
  TreesCC_rcp85_2065_bin_i=projectRaster(TreesCC_rcp85_2065_bin_i, crs= crs(AS_fusion_WGS84)@projargs)
  
  res(TreesCC_rcp85_2065_bin_i)
  res(Grassland_in_AS_pente_inf35)
  TreesCC_rcp85_2065_bin_i=resample(TreesCC_rcp85_2065_bin_i, Grassland_in_AS_pente_inf35, method='ngb')
  res(Grassland_in_AS_pente_inf35)==res(TreesCC_rcp85_2065_bin_i)
  TreesCC_rcp85_2065_bin_i@data@values=as.numeric(TreesCC_rcp85_2065_bin_i@data@values)
  
  TreesCC_rcp85_2065_bin_all=TreesCC_rcp85_2065_bin_all+TreesCC_rcp85_2065_bin_i

}

# 100*length(TreesCC_rcp85_2065_bin_all@data@values[TreesCC_rcp85_2065_bin_all@data@values==0])/length(TreesCC_rcp85_2065_bin_all@data@values[-which(is.na(TreesCC_rcp85_2065_bin_all@data@values))])
## 11.6% of 0 in total, 13.2% of no NA 

# TreesCC_rcp85_2065_bin_a_b=TreesCC_rcp85_2065_bin_b_WGS84_resampled+TreesCC_rcp85_2065_bin_a_WGS84_resampled

Grassland_in_AS_pente_inf35_masked_tree=mask(Grassland_in_AS_pente_inf35,TreesCC_rcp85_2065_bin_all, maskvalue=0)

# writeRaster(Grassland_in_AS_pente_inf35_masked_tree, "Path/to/working/directory/R/Export_data/Sylvopasto/Grassland_in_tree_sdm_rcp85.tif", overwrite=T)

Grassland_in_AS_pente_inf35_masked_tree=raster("Path/to/working/directory/R/Export_data/Sylvopasto/Grassland_in_tree_sdm_rcp85.tif")



### Priority for  sylvopasto in grasslands
# - under future tree line

##### Mask relative change of drought intensity and std
### Start with 2050 / with anomalies of drought~groundwater model

### Transform vector into raster

### Then mask raster with cropland_slopes_inf10

### Then vectorize resulting raster with zonal stat to get mean of drought??
# Drought2050_in_WS_raster=Grassland_in_AS_raster
# Drought2050_in_WS_raster=rasterize(x= HydroBasin_l12_ALPS_int_sp,y=Drought2050_in_WS_raster, field="RelDrought2050")

Anomalies2100_in_WS_raster=Grassland_in_AS_raster
Anomalies2100_in_WS_raster=rasterize(x= HydroBasin_l12_ALPS_int_sp,y=Anomalies2100_in_WS_raster, field="Multiply_anomalies_groundwater_reldrought_2100_JJA")


Anomalies2100_in_WS_raster_grassland_tree_masked=mask(Anomalies2100_in_WS_raster,Grassland_in_AS_pente_inf35_masked_tree)


# writeRaster(Anomalies2100_in_WS_raster_grassland_tree_masked, "Path/to/working/directory/R/Export_data/Sylvopasto/Anomalies2100_in_WS_raster_grassland_masked_slopes_inf35_pot_tree_AS_WGS84.tif", overwrite=T)
# Anomalies2100_in_WS_raster_grassland_tree_masked=raster("Path/to/working/directory/R/Export_data/Sylvopasto/Anomalies2100_in_WS_raster_grassland_masked_slopes_inf35_pot_tree_AS_WGS84.tif")


## Plot

plot(Anomalies2100_in_WS_raster_grassland_tree_masked)
hist((Anomalies2100_in_WS_raster_grassland_tree_masked))
boxplot(Anomalies2100_in_WS_raster_grassland_tree_masked@data@values)

data_anomalies=data.frame(Ano="Anomalies", Var=Anomalies2100_in_WS_raster_grassland_tree_masked@data@values)
data_anomalies=data_anomalies[-is.na(data_anomalies$Var),]

quantile_points=data.frame(y=NA, x="Anomalies", group=c(25,75,10,90,50))
for (i in 1:5){
  quantile_points$y[i]=quantile(Anomalies2100_in_WS_raster_grassland_tree_masked@data@values, quantile_points$group[i]/100, na.rm=T)
}
quantile_points$group=as.factor(c(25,25,10,10,50))

p=ggplot() + geom_violin(data=data_anomalies[sample(size=10^5, x=1:90492623),], aes(y=Var, x=Ano))+
  geom_point(data=quantile_points, aes(x=x, y=y, color=group)) + scale_color_manual(values=c(c("#0072B2", "#009E73", "#D55E00", "#000000")))
fx(p)

## nEw plot 
p=ggplot(data=data_anomalies[sample(size=10^5, x=1:90492623),]) + geom_violin(aes(y=Var, x=Ano))+
   geom_boxplot(aes(y=Var, x=Ano), width = 0.2, fill = "white", color = "black", outlier.shape = NA) +
  theme_bw() + theme(axis.text.x=element_blank(),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_y_continuous(breaks = seq(-1000, 1000, by = 200), limits=c(-800, 800))
  # geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/Anomalies" ,"/geom_violin_sylvopasto_Anomalies", ".png", sep=''), width=4*2, height=8*2, limitsize=F, dpi = 300)


## Select top preservation

Anomalies2100_in_WS_raster_grassland_tree_masked_top_pres=mask(x=Anomalies2100_in_WS_raster_grassland_tree_masked, mask=Anomalies2100_in_WS_raster_grassland_tree_masked>quantile(Anomalies2100_in_WS_raster_grassland_tree_masked[which(Anomalies2100_in_WS_raster_grassland_tree_masked@data@values>0)], 0.80, na.rm=T), maskvalue=0 )


writeRaster(Anomalies2100_in_WS_raster_grassland_tree_masked_top_pres, "Path/to/working/directory/R/Export_data/Sylvopasto/Anomalies2100_in_WS_raster_grassland_tree_masked_slopes_inf35_AS_TOP_preserv_WGS84.tif", overwrite=T)

## Select top restoration


Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto=mask(x=Anomalies2100_in_WS_raster_grassland_tree_masked,mask=Anomalies2100_in_WS_raster_grassland_tree_masked<quantile(Anomalies2100_in_WS_raster_grassland_tree_masked[which(Anomalies2100_in_WS_raster_grassland_tree_masked@data@values<0)], 0.50, na.rm=T), maskvalue=0)

writeRaster(Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto, "Path/to/working/directory/R/Export_data/Sylvopasto/Anomalies2100_in_WS_raster_grassland_tree_masked_slopes_inf35_AS_TOP_resto_WGS84.tif", overwrite=T)

summary(Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto)
100*length(Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto[Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto@data@values>0])/length(Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto[Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto@data@values<0])
# 50% >0

```



### Soil organic carbon

```{r soc_grasslands}

SOC_actual_grassland_cut=crop(SOC_present_WGS84, Grassland_in_AS_pente_inf35_masked_tree)
SOC_actual_grassland_cut=resample(SOC_actual_grassland_cut, Grassland_in_AS_pente_inf35_masked_tree,method = 'ngb')

SOC_actual_masked_grassland_pente_inf35_trees=mask(SOC_actual_grassland_cut, Grassland_in_AS_pente_inf35_masked_tree)

writeRaster(SOC_actual_masked_grassland_pente_inf35_trees, "Path/to/working/directory/R/Export_data/Sylvopasto/SOC_present_masked_grassland_pente_inf35_trees.tif")


# Sum_SOC_in_grassland=terra::zonal(as(SOC_actual_masked_grassland_pente_inf35_trees_raster, "SpatRaster"), as(Grassland_in_AS_pente_inf35_masked_tree, "SpatVector"), fun = 'sum')


### SOC in TOP preservation grasslands

SOC_actual_masked_grassland_pente_inf35_trees_top_preserv=mask(SOC_actual_masked_grassland_pente_inf35_trees, Anomalies2100_in_WS_raster_grassland_tree_masked_top_pres)
SOC_actual_masked_grassland_pente_inf35_trees_top_preserv@data@values=as.numeric(SOC_actual_masked_grassland_pente_inf35_trees_top_preserv@data@values)
boxplot(SOC_actual_masked_grassland_pente_inf35_trees_top_preserv)

sampleRandom(SOC_actual_masked_grassland_pente_inf35_trees_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_soc_pres=data.frame(SOC= sampleRandom(SOC_actual_masked_grassland_pente_inf35_trees_top_preserv, 10000, na.rm=T, xy=F), TOP=as.factor("Preservation"))

p=ggplot() + geom_violin(data=data_soc_pres, aes(y=SOC, x="Preservation"))
fx(p)

### SOC in TOP restoration grasslands

SOC_actual_masked_grassland_pente_inf35_trees_top_resto=mask(SOC_actual_masked_grassland_pente_inf35_trees, Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto)
SOC_actual_masked_grassland_pente_inf35_trees_top_resto@data@values=as.numeric(SOC_actual_masked_grassland_pente_inf35_trees_top_resto@data@values)
boxplot(SOC_actual_masked_grassland_pente_inf35_trees_top_resto)

# sampleRandom(SOC_actual_masked_grassland_pente_inf35_trees_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto=data.frame(SOC= sampleRandom(SOC_actual_masked_grassland_pente_inf35_trees_top_resto, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

p=ggplot() + geom_violin(data=data_soc_resto, aes(y=SOC, x="Preservation"))
fx(p)

### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_soc_resto,data_soc_pres), aes(y=SOC, x=TOP))
fx(p)




# sample data in AS
SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
SOC_in_AS_rd=data.frame(SOC=sampleRandom(SOC_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_AS_rd)=c("SOC", "TOP")


# sample data in all grasslands
# SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
SOC_in_all_grassland_rd=data.frame(SOC=sampleRandom(SOC_actual_masked_grassland_pente_inf35_trees, 10^5, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_all_grassland_rd)=c("SOC", "TOP")
SOC_in_all_grassland_rd$TOP=as.factor(SOC_in_all_grassland_rd$TOP)
summary(SOC_in_all_grassland_rd)

## ANOVA

# AS:  SOC_in_AS_rd / croplands: SOC_in_all_grassland_rd
aov_soc_sp=aov(data=rbind(data_soc_resto,data_soc_pres,SOC_in_all_grassland_rd), SOC~TOP)
anova(aov_soc_sp)
#  AS           Df  Sum Sq Mean Sq F value    Pr(>F)   
# TOP           2  226.1 113.046  237.39 < 2.2e-16 ***

# Grasslands
# TOP          2   6470  3235.1  389.73 < 2.2e-16 ***
                     


TukeyHSD(aov_soc_sp)
# AS                           diff         lwr         upr     p adj
# Preservation=Restoration 0.03005047 -0.07475895 0.1348599 0.7797508
# AS>Restoration           0.90965961  0.77021416 1.0491051 0.0000000
# AS>Preservation          0.87960914  0.78482877 0.9743895 0.0000000

# Grasslands
# Preservation=Restoration 0.03005047 -0.4074783 0.4675792 0.9858165
# AS>Restoration           0.86377751  0.4309638 1.2965912 0.0000087
# AS>Preservation          0.83372704  0.7629059 0.9045482 0.0000000

HSD_SP=HSD.test(aov_soc_sp, trt="TOP", group=T, alpha=0.05)

# SOC groups AS
# AS           1.7029000      a
# Preservation 0.8232909      b
# Restoration  0.7932404      b

# SOC groups Grasslands
# AS           1.7029000      a
# Preservation 0.8232909      b
# Restoration  0.7932404      b


### SOC in pres & resto
# AS:  SOC_in_AS_rd / croplands: SOC_in_all_grassland_rd
median_data <- rbind(data_soc_pres,data_soc_resto,SOC_in_all_grassland_rd) %>%
  group_by(TOP) %>%
  summarize(median_soc = median(SOC)) %>% as.data.frame()



# AS:  SOC_in_AS_rd / croplands: SOC_in_all_grassland_rd
p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,SOC_in_all_grassland_rd), aes(y=log10(SOC), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.7 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = log10(median_soc), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_sp, "/Figure/SOC" ,"/geom_violin_sylvop_log_SOC_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/SOC" ,"/geom_violin_sylvop_log_SOC_groups_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


### sans log
# AS:  SOC_in_AS_rd / croplands: SOC_in_all_grassland_rd
p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,SOC_in_all_grassland_rd), aes(y=SOC, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=42 ,label = c("a", "b", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = median_soc, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_sp, "/Figure/SOC" ,"/geom_violin_sylvop_SOC", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/SOC" ,"/geom_violin_sylvop_SOC_groups_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)



# Sans AS
p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto), aes(y=log10(SOC), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=42 ,label = c("a", "b", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit")) +
  geom_point(data =median_data[-3,] , aes(y = log10(median_soc), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)





```


### NCP in Sylvopasto priority
```{r ncp_in_agrof}
## Done with QGIS: join NCP values (AlpES layer) to priority areas shapefile

## Restoration priority area for Sylvopasto
Top_resto_SP=shapefile("Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies2100_grassland_masked_AS_TOP_resto_dist_to_forest_sup_NCP_WGS84.shp")

if (T %in% is.na(Top_resto_SP$NCP_A_3)){
  print('yes')
  Top_resto_SP=Top_resto_SP[-which(is.na(Top_resto_SP$NCP_A_3)),]
}


Top_resto_SP_df=Top_resto_SP@data

Top_resto_SP_df=Top_resto_SP_df[,-grep("NCP_Code_1", colnames(Top_resto_SP_df))]
Top_resto_SP_df$TOP="Restoration"
# Top_resto_SP_df=Top_resto_SP_df[-which(is.na(Top_resto_SP_df$NCP_A_3)),]
# rownames(Top_resto_SP_df)=Top_resto_SP_df$fid


# Preservation priority area for Sylvopasto
# Top_preserv_SP=shapefile("Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies_cropland_sup_dist1000_to_forest_top_preserv_sup100ha_NCP_WGS84.shp")
Top_preserv_SP=shapefile("Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies2100_grassland_masked_AS_TOP_preserv_dist_to_forest_sup_NCP_WGS84.shp")

if (T %in% is.na(Top_preserv_SP$NCP_A_3)){
  print('yes')
  Top_preserv_SP=Top_preserv_SP[-which(is.na(Top_preserv_SP$NCP_A_3)),]
}


Top_preserv_SP_df=Top_preserv_SP@data

Top_preserv_SP_df$TOP="Preservation"
colnames(Top_preserv_SP_df)=colnames(Top_resto_SP_df)
# rownames(Top_preserv_SP_df)=Top_preserv_SP_df$fid
# Top_preserv_SP_df=Top_preserv_SP_df[-which(is.na(Top_preserv_SP_df$NCP_A_3)),]

Top_df_SP=rbind(Top_resto_SP_df, Top_preserv_SP_df)
Top_df_SP=Top_df_SP[,-c(1:13)]
# Top_df_SP=Top_df_SP[-is.na(Top_df_SP$NCP_A_3),]

p=ggplot()
for (i in 1:(ncol(Top_df_SP)-1)){
  p=p+geom_violin(aes(x=as.character(colnames(Top_df_SP)[i]),y=Top_df_SP[,i], fill=Top_df_SP$TOP))
}


data_ncp_mean=Top_df_SP[1:2,-ncol(Top_df_SP)]
data_ncp_mean[1,]=apply(Top_df_SP[which(Top_df_SP$TOP=="Restoration"),-ncol(Top_df_SP)], 2, FUN="mean", na.rm=T)
data_ncp_mean[2,]=apply(Top_df_SP[which(Top_df_SP$TOP=="Preservation"),-ncol(Top_df_SP)], 2, FUN="mean", na.rm=T)
data_ncp_mean[3,]=apply(Top_df_SP[,-ncol(Top_df_SP)], 2, FUN="min", na.rm=T)
data_ncp_mean[4,]=apply(Top_df_SP[,-ncol(Top_df_SP)], 2, FUN="max", na.rm=T)

data_ncp_mean$TOP=c("Restoration","Preservation","Min","Max")



str(data_ncp_mean)


# x11()+par(mfrow=c(1,2))
radarchart(data_ncp_mean[c(4,3,1),-ncol(data_ncp_mean)], maxmin = T)
radarchart(data_ncp_mean[c(4,3,2),-ncol(data_ncp_mean)], maxmin = T)








```

### Clustering sylvopasto NCP
```{r cluster_agrof}
for (i in 1:(ncol(Top_df_SP)-1)){
  print(nrow(Top_df_SP[is.na(Top_df_SP[,i]),]))
}
# Top_df_SP=Top_df_SP[-which(is.na(Top_df_SP$NCP_A_3)),]

Top_df_SP$A_2p1=Top_df_SP$NCP_A_2/(Top_df_SP$NCP_A_1+1)
Top_df_SP$B_2p1=Top_df_SP$NCP_B_2/(Top_df_SP$NCP_B_1+1)
Top_df_SP$C_2p1=Top_df_SP$NCP_C_2/(Top_df_SP$NCP_C_1+1)
# Top_df_SP$D_1_2
Top_df_SP$E_2p1=Top_df_SP$NCP_E_2/(Top_df_SP$NCP_E_1+1)
# Top_df_SP$F_1_2
Top_df_SP$G_2p1=Top_df_SP$NCP_G_2/(Top_df_SP$NCP_G_1+1)
Top_df_SP$H_2p1=Top_df_SP$NCP_H_2/(Top_df_SP$NCP_H_1+1)

str(Top_df_SP)
pca.agrof=PCA(Top_df_SP, graph=F, quali.sup = 22)

pca.var=pca.agrof$var
pca.ind=pca.agrof$ind

plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,3))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(2,3))

plot(pca.agrof,
     invisible = c("var", "ind"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))

plot(pca.agrof,
     invisible = c("ind", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))



# with cos2
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,2)
            # invisible=c("quali.sup"),
            )
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,3)
            # invisible=c("quali.sup"),
            )


eig.val <- pca.agrof$eig
barplot(eig.val[, 2], 
        names.arg = 1:nrow(eig.val), 
        main = "Variances Explained by Dimensions (%)",
        xlab = "Principal Dimensions",
        ylab = "Percentage of variances",
        col ="steelblue")
# Add connected line segments to the plot
lines(x = 1:nrow(eig.val), eig.val[, 2], 
      type = "b", pch = 19, col = "red")



## Clustering
clust.agrof3=HCPC(PCA(Top_df_SP[,-22], graph=F), metric="euclidean", nb.clust=3)

fviz_cluster(clust.agrof3,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = FALSE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
             )

plot(clust.agrof3, choice = "3D.map")

#test khi2
clust.agrof3$desc.var$test.chi2[which(as.integer(clust.agrof3$desc.var$test.chi2)<0.1),]

clust.agrof3$desc.var$category
######################
#######  C1  #########
######################
agrof.clust1=as.data.frame(clust.agrof3$desc.var$quanti$`1`)
agrof.clust1$Levers=rownames(agrof.clust1)
agrof.clust1$Signif=0
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test<0))]=-1
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test>0))]=1
agrof.clust1$Signif=as.factor(agrof.clust1$Signif)
agrof.clust1$diff_mean=agrof.clust1$`Mean in category`-agrof.clust1$`Overall mean`

# A_2p1, B_3, B_2p1, B_2, B_1, C_1, D_3, D_1_2, F_1_2, 
# High freshwater use/supply, grasslands supply, use and demand, wood production (and Cseq), water filtration and demand, 

######################
#######  C2  #########
######################
agrof.clust2=as.data.frame(clust.agrof3$desc.var$quanti$`2`)
agrof.clust2$Levers=rownames(agrof.clust2)
agrof.clust2$Signif=0
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test<0))]=-1
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test>0))]=1
agrof.clust2$Signif=as.factor(agrof.clust2$Signif)
agrof.clust2$diff_mean=agrof.clust2$`Mean in category`-agrof.clust2$`Overall mean`

#  A_2p1, A_1, A_2, A_3, C_1, C_2, C_3, C_2p1, F_1_2, F_3, G_1, G_3,
# High Water supply, use, demand and F/S, wood (and Cseq) prod use and demand and F/S, Outdoor recreation supply and demand




######################
#######  C3  #########
######################
agrof.clust3=as.data.frame(clust.agrof3$desc.var$quanti$`3`)
agrof.clust3$Levers=rownames(agrof.clust3)
agrof.clust3$Signif=0
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test<0))]=-1
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test>0))]=1
agrof.clust3$Signif=as.factor(agrof.clust3$Signif)
agrof.clust3$diff_mean=agrof.clust3$`Mean in category`-agrof.clust3$`Overall mean`

# A_1, E_1, E_2, E_3, E_2p1, G_1, G_2, G_2p1, H_1, H_2, H_2p1
# High water supply, forest protection supply use demand and F/S, Outdoor recreation supply and flow, and F/S, biodiversity supply and use and F/S

### Summary:
# C1: High freshwater use/supply, grasslands supply, use and demand, wood production (and Cseq), water filtration and demand, 
# C2: High Water supply, use, demand and F/S, wood (and Cseq) prod use and demand and F/S, site, Outdoor recreation supply and demand
# C3: High water supply, forest protection supply use demand and F/S, Outdoor recreation supply and flow, and F/S, biodiversity supply and use and F/S

### Export shp with clusters
nrow(Top_resto_SP)+nrow(Top_preserv_SP)==nrow(clust.agrof3$data.clust)
Top_resto_SP$cluster=NA
# Top_df_SP=rbind(Top_resto_SP_df, Top_preserv_SP_df)
Top_resto_SP$cluster[1:nrow(Top_resto_SP@data)]=clust.agrof3$data.clust$clust[1:nrow(Top_resto_SP@data)]


# for (i in 1:nrow(Top_resto_SP)){
#   Top_resto_SP$cluster[i]=clust.agrof3$data.clust$clust[which(rownames(clust.agrof3$data.clust)==Top_resto_SP$fid[i])]
# }

summary(as.factor(Top_resto_SP$cluster))
p=spplot(Top_resto_SP, zcol=c("cluster"))

# shapefile(Top_resto_SP, "Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies_grasslands_dist_to_forest_sup_top_resto_NCP_clust_WGS84.shp")


Top_preserv_SP$cluster=NA
Top_preserv_SP$cluster=clust.agrof3$data.clust$clust[(nrow(Top_resto_SP@data)+1):nrow(clust.agrof3$data.clust)]

# for (i in 1:nrow(Top_preserv_SP)){
#   Top_preserv_SP$cluster[i]=clust.agrof3$data.clust$clust[which(rownames(clust.agrof3$data.clust)==Top_preserv_SP$fid[i])]
#  
# }
summary(as.factor(Top_preserv_SP$cluster))
p=spplot(Top_preserv_SP, zcol=c("cluster"))


### Export in shp


# shapefile(Top_preserv_SP, "Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies_grasslands_dist_to_forest_sup_top_preserv_NCP_clust_WGS84.shp")



#### radar chart with each clusters

colnames(Top_preserv_SP@data)==colnames(Top_resto_SP@data)

# Atention : avec Elev = 26
data_ncp_mean=rbind(Top_preserv_SP@data[,-c(1:13,36)], Top_resto_SP@data[,-c(1:14,37)])
data_radar=data_ncp_mean[1:5,-ncol(data_ncp_mean)]
data_radar[1,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="max")
data_radar[2,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="min")

data_radar[3,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==1),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[4,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==2),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[5,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==3),-ncol(data_ncp_mean)], 2, FUN="mean")


data_radar$TOP=c("Max", "Min", "C1","C2", "C3")


# color_border_hexadec=c("#b200f8", "#5dbdfc", "#71daa7")
colors_border=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255))
colors_in=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.4*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.4*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.4*255))

colnames(data_radar)[22]
# radarchart(data_radar[3:5,-c(22,ncol(data_radar))], maxmin = F,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

radarchart(data_radar[,-c(22,ncol(data_radar))], maxmin = T,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

legend(x="topright", legend = c("C1", "C2", "C3"),col=colors_border, bty = "n", pch=20 , text.col = "black", cex=0.9, pt.cex=1.6)


### Colour clusters

color_clusters=palette.colors(palette="Set2")
Hillsides_out= rgb(102, 194, 165, maxColorValue = 255)
Hillsides_in= rgb(102, 194, 165, maxColorValue = 255, alpha=0.4*255)
Populated_out= rgb(252, 141, 98, maxColorValue = 255)
Populated_in= rgb(252, 141, 98, maxColorValue = 255, alpha=0.4*255)
Touristic_out= rgb(141, 160, 203, maxColorValue = 255)
Touristic_in= rgb(141, 160, 203, maxColorValue = 255, alpha=0.4*255)
Productive_out=rgb(231, 138, 195, maxColorValue = 255)
Productive_in=rgb(231, 138, 195, maxColorValue = 255, alpha=0.4*255)
Rural_out= rgb(166, 216, 84, maxColorValue = 255)
Rural_in= rgb(166, 216, 84, maxColorValue = 255, alpha=0.4*255)
# Rural_out=rgb(255, 217, 47, maxColorValue = 255)
# Rural_in=rgb(255, 217, 47, maxColorValue = 255, alpha=0.4*255)

color_grassland_out=c(Rural_out, Touristic_out, Hillsides_out)
color_grassland_in=c(Rural_in, Touristic_in, Hillsides_in)

radarchart(data_radar[,-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=color_grassland_out , pfcol=color_grassland_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")


### Plot radar one cluster
radarchart(data_radar[c(1,2,3),-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=Rural_out , pfcol=Rural_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")
radarchart(data_radar[c(1,2,4),-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=Touristic_out , pfcol=Touristic_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")
radarchart(data_radar[c(1,2,5),-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=Hillsides_out , pfcol=Hillsides_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")




```


### Prop clusters

```{r prop_clusters_sylvopasto}
colnames(Top_preserv_SP@data)
colnames(Top_resto_SP@data)

data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Top_preserv_SP@data$Area[which(Top_preserv_SP@data$cluster==i)]), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Top_resto_SP@data$Area[which(Top_resto_SP@data$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)

data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))
 

### Test with new area calculated
Area_preserv=data.frame(i=Top_preserv_SP$fid, area=NA)
for (i in 1:nrow(Top_preserv_SP@data)){
  Area_preserv$area[i]=raster::area(Top_preserv_SP[i,])
  
}

Area_resto=data.frame(i=Top_resto_SP$fid, area=NA)
for (i in 1:nrow(Top_resto_SP@data)){
  Area_resto$area[i]=raster::area(Top_resto_SP[i,])
  
}



data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Area_preserv$area[which(Top_preserv_SP$cluster==i)]), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Area_resto$area[which(Top_resto_SP$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)


data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))

## Khi2 and plot


# khi2
khi_prop_clust=cbind(data_prop_clust$Area[1:3], data_prop_clust$Area[4:6])
khi_prop_clust_test=chisq.test(khi_prop_clust) # p-value < 2.2e-16
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("1", "2", "3")
100*khi_prop_clust_res/sum(khi_prop_clust_res) # Resto-1 and Resto-3 != others
#  Preservation Restoration
# 1     13.99992   49.020658
# 2      1.83121    6.411972
# 3      6.38371   22.352526
# > 10 => significant


# Label preserv
label_pres=c(data_prop_preserv_clust$Prop[3]/2,
             data_prop_preserv_clust$Prop[3]+(data_prop_preserv_clust$Prop[2]/2),
             data_prop_preserv_clust$Prop[3]+data_prop_preserv_clust$Prop[2]+(data_prop_preserv_clust$Prop[1]/2)
             )
label_resto=c(data_prop_resto_clust$Prop[3]/2,
             1+data_prop_resto_clust$Prop[3]+(data_prop_resto_clust$Prop[2]/2),
             data_prop_resto_clust$Prop[3]+data_prop_resto_clust$Prop[2]+(data_prop_resto_clust$Prop[1]/2)
             )


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(data_prop_preserv_clust$Prop[c(3,2,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(data_prop_resto_clust$Prop[c(3,2,1)],0))), size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())


fx(p)
# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/Clusters" ,"/geom_bar_clusters_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/Clusters" ,"/geom_bar_clusters_prop_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)




## ANOVA
data_prop_preserv_clust$TOP=as.factor(data_prop_preserv_clust$TOP)
data_prop_preserv_clust$Cluster=as.factor(data_prop_preserv_clust$Cluster)
data_prop_resto_clust$TOP=as.factor(data_prop_resto_clust$TOP)
data_prop_resto_clust$Cluster=as.factor(data_prop_resto_clust$Cluster)

# aov_clust_wr=aov(data=rbind(data_prop_preserv_clust, data_prop_resto_clust), Area~TOP:Cluster)
# anova(aov_clust_wr)
Top_preserv_SP$TOP=factor("Preservation")
Top_resto_SP$TOP=factor("Restoration")

Top_preserv_SP$Area=Area_preserv
Top_resto_SP$Area=Area_resto

### Need to calculate area of each polygons
Top_preserv_SP$Area=Top_preserv_SP$Area$area
Top_resto_SP$Area=Top_resto_SP$Area$area
data_clust_sp=rbind(Top_preserv_SP@data[,c(35:38)], Top_resto_SP@data[,c(36,37,39,40)])


aov_clust_sp=aov(data=data_clust_sp, Area~TOP*cluster)
anova(aov_clust_sp)

#              Df     Sum Sq    Mean Sq F value    Pr(>F)    
# TOP             1 1.6524e+16 1.6524e+16  244.66 < 2.2e-16 ***
# cluster         2 7.5982e+16 3.7991e+16  562.50 < 2.2e-16 ***
# TOP:cluster     2 5.3653e+15 2.6826e+15   39.72 < 2.2e-16 ***

TukeyHSD(aov_clust_sp)
#                              diff       lwr       upr      p adj
# Restoration < Preservation-1869438 -2103701 -1635175     0
# 2 = 1                     -186468.8 -508309.3  135371.8 0.3631923
# 3 > 1                      4391161.3 4036683.7 4745638.9 0.0000000
# 3 > 2                     4577630.1 4220077.6 4935182.5 0.0000000


HSD_SP=HSD.test(aov_clust_sp, trt="TOP", group=T, alpha=0.05)


HSD_SP=HSD.test(aov_clust_sp, trt="cluster", group=T, alpha=0.05)
HSD_SP

## PLOT

label_preserv=c(data_prop_preserv_clust$Prop[3]/2,data_prop_preserv_clust$Prop[3] + data_prop_preserv_clust$Prop[2]/2,data_prop_preserv_clust$Prop[3] +data_prop_preserv_clust$Prop[2]+ data_prop_preserv_clust$Prop[1]/2 )

label_resto=c(data_prop_resto_clust$Prop[3]/2,
              data_prop_resto_clust$Prop[3]+data_prop_resto_clust$Prop[2]/2
              ,data_prop_resto_clust$Prop[3] +data_prop_resto_clust$Prop[2]+ data_prop_resto_clust$Prop[1]/2 )


### With cluster colors
p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') +
  scale_fill_manual(values=color_grassland_out) +theme_bw() +
  # geom_text(aes(x="Preservation", y=label_preserv, label=as.character(round(data_prop_preserv_clust$Prop[c(3,2,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(data_prop_resto_clust$Prop[c(3,2,1)],0))), size=10)+
  theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)  

ggsave(plot=p, filename = paste(dossier_sp, "/Figure/Clusters" ,"/geom_bar_prop_NCP_clusters_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/Clusters" ,"/geom_bar_prop_NCP_clusters_groups_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)




```

### Distrib Elevation
```{r distrib_elev_sylvop}
### in function of elevation

Top_resto_SP$Elev=NA
for (i in 1:nrow(Top_resto_SP@data)){
  Top_resto_SP$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_resto_SP[i,], fun=mean, na.rm=T)
}

Top_preserv_SP$Elev=NA
for (i in 1:nrow(Top_preserv_SP@data)){
  Top_preserv_SP$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_preserv_SP[i,], fun=mean, na.rm=T)
}
summary(Top_resto_SP$Elev)
summary(Top_preserv_SP$Elev)

p=ggplot() + geom_violin(aes(x="Resto", y=Top_resto_SP$Elev, fill='red')) + geom_violin(aes(x="Preservation", y=Top_preserv_SP$Elev[-which(is.na(Top_preserv_SP$Elev))], fill='blue'))   + geom_violin(aes(x="AS", y=raster::values(Elevation_cut_WGS84), fill='green'))  


## ANOVA
# random data in AS
Elev_in_AS=mask(Elevation_cut_WGS84, AS_fusion_WGS84)
Elev_in_AS_rd=data.frame(Elev=sampleRandom(Elev_in_AS, 10000, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_AS_rd)=c("Elev", "TOP")  


# Elev in croplands 
Grassland_in_AS_pente_inf35_cut=crop(Grassland_in_AS_pente_inf35_masked_tree, Elevation_cut_WGS84)
Grassland_in_AS_pente_inf35_cut_resample=resample(Grassland_in_AS_pente_inf35_cut, Elevation_cut_WGS84, method = 'ngb')
Elev_in_grassland=mask(Elevation_cut_WGS84, Grassland_in_AS_pente_inf35_cut_resample)
summary(Elev_in_grassland)

length(Elev_in_grassland@data@values[-which(is.na(Elev_in_grassland@data@values))]) # 257632
Elev_in_grassland_rd=data.frame(Elev=sampleRandom(Elev_in_grassland, 10^5, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_grassland_rd)=c("Elev", "TOP")  
Elev_in_grassland_rd$TOP=as.factor(Elev_in_grassland_rd$TOP)  

### ANOVA
# AS: Elev_in_AS_rd / Grasslands: Elev_in_grassland_rd
aov_elev_sp=aov(data=rbind(Top_preserv_SP@data[,c(36,37)], Top_resto_SP@data[,c(37,39)], Elev_in_grassland_rd), Elev~TOP)
anova(aov_elev_sp)

# AS             Df     Sum Sq    Mean Sq F value    Pr(>F)    
# TOP           2 3.7158e+08 185787843  469.52 < 2.2e-16 ***

# Grasslands
# TOP            2 2.2339e+09 1116928086  2319.6 < 2.2e-16 ***

TukeyHSD(aov_elev_sp)
#     AS                       diff       lwr       upr      p adj
# Restoration < Preservation -279.9238 -301.3647 -258.48282     0
# AS < Preservation          -107.5992 -127.9779  -87.22046     0
# AS > Restoration            172.3246  150.4355  194.21372     0

# Grasslands
# Restoration < Preservation -279.9238 -303.5756 -256.2720     0
# AS > Preservation           218.9776  202.6280  235.3272     0
# AS > Restoration            498.9014  480.3273  517.4755     0

HSD_SP=HSD.test(aov_elev_sp, trt="TOP", group=T, alpha=0.05)
HSD_SP
#  AS               Elev  groups
# Preservation 943.0805      a
# AS           835.4813      b
# Restoration  663.1567      c

# Grasslands
# AS           1162.0581      a
# Preservation  943.0805      b
# Restoration   663.1567      c


median_data <- rbind(Top_preserv_SP@data[,c(36,37)], Top_resto_SP@data[,c(37,39)], Elev_in_grassland_rd) %>%
  group_by(TOP) %>%
  summarize(median_elev = median(Elev, na.rm=T)) %>% as.data.frame()


## PLOT
p=ggplot() + 
  geom_violin(data=rbind(Top_preserv_SP@data[,c(36,37)], Top_resto_SP@data[,c(37,39)], Elev_in_AS_rd), aes(x=TOP, y=Elev, fill=TOP))+
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=4500 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)


ggsave(plot=p, filename = paste(dossier_sp, "/Figure/Elev" ,"/geom_violin_sylvop_Elev", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/Elev" ,"/geom_violin_sylvop_Elev_groups_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)






```


### Carbon potential

```{r carbon_pot_sylvopasto}

str(Carbon_saturation_cut_WGS84)



SOC_potential_grassland_cut=crop(Carbon_saturation_cut_WGS84, Grassland_in_AS_pente_inf35_masked_tree)
SOC_potential_grassland_cut_cut=resample(SOC_potential_grassland_cut, Grassland_in_AS_pente_inf35_masked_tree,method = 'ngb')

SOC_potential_masked_grassland_slope_inf35=mask(SOC_potential_grassland_cut_cut, Grassland_in_AS_pente_inf35_masked_tree)

# writeRaster(SOC_potential_masked_grassland_slope_inf35, "Path/to/working/directory/R/Export_data/Sylvopasto/SOC_potential_masked_grassland_slopes_inf35.tif")
# SOC_potential_masked_grassland_slope_inf35=raster("Path/to/working/directory/R/Export_data/Sylvopasto/SOC_potential_masked_grassland_slopes_inf35.tif")
summary(SOC_potential_masked_grassland_slope_inf35)

### SOC in TOP preservation grassland

SOC_potential_masked_grassland_slope_inf35_top_preserv=mask(SOC_potential_masked_grassland_slope_inf35, Anomalies2100_in_WS_raster_grassland_tree_masked_top_pres)
# SOC_potential_masked_grassland_slope_inf35_top_preserv@data@values=as.numeric(SOC_potential_masked_grassland_slope_inf35_top_preserv@data@values)

# boxplot(SOC_potential_masked_grassland_slope_inf35_top_preserv)

# sampleRandom(SOC_potential_masked_grassland_slope_inf35_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_sop_pres=data.frame(SOP=sampleRandom(SOC_potential_masked_grassland_slope_inf35_top_preserv$SOCp_all_bil7, 10000, na.rm=T, xy=F, sp=F), TOP=as.factor("Preservation"))

p=ggplot() + geom_violin(data=data_sop_pres, aes(y=SOP, x="Preservation"))
fx(p)

### SOC in TOP restoration grassland

SOC_potential_masked_grassland_slope_inf35_top_resto=mask(SOC_potential_masked_grassland_slope_inf35, Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto)
# SOC_potential_masked_grassland_slope_inf35_top_resto@data@values=as.numeric(SOC_potential_masked_grassland_slope_inf35_top_resto@data@values)
# boxplot(SOC_potential_masked_grassland_slope_inf35_top_resto)

# sampleRandom(SOC_potential_masked_grassland_slope_inf35_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_sop_resto=data.frame(SOP= sampleRandom(SOC_potential_masked_grassland_slope_inf35_top_resto$SOCp_all_bil7, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

p=ggplot() + geom_violin(data=data_sop_resto, aes(y=SOP, x="Restoration"))
fx(p)

### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_sop_resto,data_sop_pres), aes(y=SOC, x=TOP))
fx(p)



# sample data in AS
SOP_in_AS=mask(Carbon_saturation_cut_WGS84, AS_fusion_WGS84)
SOP_in_AS_rd=data.frame(SOP=sampleRandom(SOP_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_AS_rd)=c("SOP", "TOP")


# sample data in croplands
Grassland_in_AS_pente_inf35_cut=crop(Grassland_in_AS_pente_inf35_masked_tree, Carbon_saturation_cut_WGS84)
Grassland_in_AS_pente_inf35_cut_resample=resample(Grassland_in_AS_pente_inf35_cut, Carbon_saturation_cut_WGS84, method = 'ngb')
SOP_in_grassland=mask(Carbon_saturation_cut_WGS84, Grassland_in_AS_pente_inf35_cut_resample)
summary(SOP_in_grassland)

SOP_in_grassland_rd=data.frame(SOP=sampleRandom(SOP_in_grassland, 10^5, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_grassland_rd)=c("SOP", "TOP")


### SOC in pres & resto
# AS: SOP_in_AS_rd/ grasslands: SOP_in_grassland_rd
median_data <- rbind(data_sop_pres,data_sop_resto,SOP_in_grassland_rd) %>%
  group_by(TOP) %>%
  summarize(median_sop = median(SOP)) %>% as.data.frame()

## ANOVA
# AS: SOP_in_AS_rd / grasslands: SOP_in_grassland_rd
aov_sop_sp=aov(data=rbind(data_sop_resto,data_sop_pres,SOP_in_grassland_rd), SOP~TOP)
anova(aov_sop_sp)
#    AS         Df  Sum Sq Mean Sq F value    Pr(>F)   
# TOP           2   0.35 0.175907  3.8969 0.02033 *

# Grasslands
# TOP            2    3.26 1.62758  63.208 < 2.2e-16 ***

 # C'est comme a qu'on reconnait le Martin 
TukeyHSD(aov_sop_sp)
# AS                         diff           lwr         upr     p adj
# Preservation > Restoration  0.04643757  0.0072891757 0.085585970 0.0150253
# AS > Restoration            0.03260333  0.0004624893 0.064744179 0.0458837
# AS = Preservation          -0.01383424 -0.0372685746 0.009600097 0.3494380

# Grasslands
# Preservation > Restoration 0.04643757 0.01687414 0.07600101 0.0006787
# AS > Restoration           0.09435402 0.07034610 0.11836194 0.0000000
# AS > Preservation          0.04791645 0.03058309 0.06524980 0.0000000


HSD_SP=HSD.test(aov_sop_sp, trt="TOP", group=T, alpha=0.05)

# AS               SOP groups
# Preservation 0.8401880      a
# AS           0.8263537      a
# Restoration  0.7937504      b

# Grasslands       SOP   groups
# AS           0.8881044      a
# Preservation 0.8401880      b
# Restoration  0.7937504      c





### SOC in pres & resto
median_data <- rbind(data_sop_pres,data_sop_resto,SOP_in_grassland_rd) %>%
  group_by(TOP) %>%
  summarize(median_sop = median(SOP)) %>% as.data.frame()


p=ggplot() + geom_violin(data=rbind(data_sop_pres,data_sop_resto,SOP_in_AS_rd), aes(y=SOP, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.03 ,label = c("a", "b", "a")),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = (median_sop), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)

# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/SOP" ,"/geom_violin_sylvop_SOP_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/SOP" ,"/geom_violin_sylvop_SOP_groups_grasslands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)





```

### Protected area

```{r sylvopasto_pa}
## done in QGIS: join protected area attribute (layer WDPA) to priority areas shapefile

Top_resto_SP_PA=shapefile("Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies_grasslands_top_resto_NCP_clust_WDPA_WGS84.shp")

Top_resto_SP_PA_df=Top_resto_SP_PA@data
levels(as.factor(Top_resto_SP_PA_df$IUCN_CAT))
 # "Ia"             "Ib"             "II"             "III"           
#  "IV"             "Not Applicable" "Not Assigned"   "Not Reported"  
#  "VI" 
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="Ia")]=1
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="Ib")]=1
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="II")]=2
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="III")]=3
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="IV")]=4
# Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="V")]=5
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="VI")]=6
Top_resto_SP_PA_df$IUCN_CAT[which(is.na(Top_resto_SP_PA_df$IUCN_CAT))]=0
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="Not Applicable")]=NA
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="Not Assigned")]=NA
Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$IUCN_CAT=="Not Reported")]=NA
Top_resto_SP_PA_df$IUCN_CAT=as.integer(Top_resto_SP_PA_df$IUCN_CAT)



levels_fid=levels(as.factor(Top_resto_SP_PA_df$fid))

for (i in 1:nlevels(as.factor(Top_resto_SP_PA_df$fid))){
  print(i)
  print(nrow(Top_resto_SP_PA_df))
  print(Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$fid==levels_fid[i])])
  if (nrow(Top_resto_SP_PA_df[which(Top_resto_SP_PA_df$fid==levels_fid[i]),])>1){
    
    data_sans_0=Top_resto_SP_PA_df$IUCN_CAT[which(Top_resto_SP_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    
    if ((T %in% !is.na(data_sans_0))==F){
      Top_resto_SP_PA_df=Top_resto_SP_PA_df[-grep(levels_fid[i], Top_resto_SP_PA_df$fid)[1],]
    }
    if (F %in% is.na(data_sans_0)){
      
      if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
    
      min_level=min(data_sans_0, na.rm=T)
   
    
       Top_resto_SP_PA_df=Top_resto_SP_PA_df[-which(Top_resto_SP_PA_df$fid==levels_fid[i] & (is.na(Top_resto_SP_PA_df$IUCN_CAT) | Top_resto_SP_PA_df$IUCN_CAT != min_level)),]
    }
    
    
    
      if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
        Top_resto_SP_PA_df=Top_resto_SP_PA_df[-grep(levels_fid[i], Top_resto_SP_PA_df$fid)[-1],]
    }
    }
     
  }
  
}




Top_resto_SP_PA_sum=as.data.frame(summary(as.factor(Top_resto_SP_PA_df$IUCN_CAT)))
colnames(Top_resto_SP_PA_sum)=c("nb")
# Top_resto_SP_PA_sum=t(Top_resto_SP_PA_sum)
p=ggplot(Top_resto_SP_PA_sum) + geom_bar(aes(x="Restoration", y=nb, fill=rownames(Top_resto_SP_PA_sum)), stat="identity")


### Top preservation

Top_preserv_SP_PA=shapefile("Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies_grasslands_top_preserv_NCP_clust_WDPA_WGS84.shp")

levels(as.factor(Top_preserv_SP_PA@data$IUCN_CAT))
# 1] "Ia"             "Ib"             "II"             "III"           
# [5] "IV"             "Not Applicable" "Not Assigned"   "Not Reported"  
# [9] "VI" 
Top_preserv_SP_PA_df=Top_preserv_SP_PA@data
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="Ia")]=1
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="Ib")]=1
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="II")]=2
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="III")]=3
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="IV")]=4
# Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="V")]=5
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="VI")]=6
Top_preserv_SP_PA_df$IUCN_CAT[which(is.na(Top_preserv_SP_PA_df$IUCN_CAT))]=0

Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="Not Assigned")]=NA
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="Not Reported")]=NA
Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$IUCN_CAT=="Not Applicable")]=NA

Top_preserv_SP_PA_df$IUCN_CAT=as.integer(Top_preserv_SP_PA_df$IUCN_CAT)



levels_fid=levels(as.factor(Top_preserv_SP_PA_df$fid))

for (i in 1:nlevels(as.factor(Top_preserv_SP_PA_df$fid))){
  print(i)
  print(nrow(Top_preserv_SP_PA_df))
  print(Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$fid==levels_fid[i])])
  if (nrow(Top_preserv_SP_PA_df[which(Top_preserv_SP_PA_df$fid==levels_fid[i]),])>1){
    
    data_sans_0=Top_preserv_SP_PA_df$IUCN_CAT[which(Top_preserv_SP_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    
    if ((T %in% !is.na(data_sans_0))==F){
      Top_preserv_SP_PA_df=Top_preserv_SP_PA_df[-grep(levels_fid[i], Top_preserv_SP_PA_df$fid)[1],]
    }
    if (F %in% is.na(data_sans_0)){
      
      if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
    
      min_level=min(data_sans_0, na.rm=T)
   
    
       Top_preserv_SP_PA_df=Top_preserv_SP_PA_df[-which(Top_preserv_SP_PA_df$fid==levels_fid[i] & (is.na(Top_preserv_SP_PA_df$IUCN_CAT) | Top_preserv_SP_PA_df$IUCN_CAT != min_level)),]
    }
    
    
    
      if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
        Top_preserv_SP_PA_df=Top_preserv_SP_PA_df[-grep(levels_fid[i], Top_preserv_SP_PA_df$fid)[-1],]
    }
    }
     
  }
  
}


Top_preserv_SP_PA_sum=as.data.frame(summary(as.factor(Top_preserv_SP_PA_df$IUCN_CAT)))
colnames(Top_preserv_SP_PA_sum)=c("nb")
# Top_preserv_SP_PA_sum=t(Top_preserv_SP_PA_sum)
p=ggplot(Top_preserv_SP_PA_sum) + geom_bar(aes(x="Preservation", y=nb, fill=rownames(Top_preserv_SP_PA_sum)), stat="identity")


### Both preserv and resto
p=ggplot() + geom_bar(data=Top_preserv_SP_PA_sum, aes(x="Preservation", y=nb, fill=rownames(Top_preserv_SP_PA_sum)), stat="identity") +
  geom_bar(data=Top_resto_SP_PA_sum, aes(x="Restoration", y=nb, fill=rownames(Top_resto_SP_PA_sum)), stat="identity")



## Geom_bar - Prop


Top_preserv_SP_PA_sum$TOP="Preservation"
Top_preserv_SP_PA_sum$PA=rownames(Top_preserv_SP_PA_sum)
Top_resto_SP_PA_sum$TOP="Restoration"
Top_resto_SP_PA_sum$PA=rownames(Top_resto_SP_PA_sum)
Top_SP_PA_sum=rbind(Top_preserv_SP_PA_sum,Top_resto_SP_PA_sum)

# Label preserv
label_pres=c(Top_preserv_SP_PA_sum$nb[7]/2,
             Top_preserv_SP_PA_sum$nb[7]+(Top_preserv_SP_PA_sum$nb[1]/2)
             )
# Label resto
label_resto=c(Top_resto_SP_PA_sum$nb[7]/2,
             Top_resto_SP_PA_sum$nb[7]+(Top_resto_SP_PA_sum$nb[5]/2),
             Top_resto_SP_PA_sum$nb[7]+Top_resto_SP_PA_sum$nb[5]+(Top_resto_SP_PA_sum$nb[1]/2)
            )

# Color
color_values=c(rgb(128,128,128, maxColorValue=255))
color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(Top_SP_PA_sum$PA))-1))

Top_SP_PA_sum$TOP=as.factor(Top_SP_PA_sum$TOP)
Top_SP_PA_sum$PA=as.factor(Top_SP_PA_sum$PA)
p=ggplot() + geom_bar(data=Top_SP_PA_sum, aes(x=TOP, y=nb, fill=PA), stat="identity")+scale_fill_manual(values=color_values)+
    geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_SP_PA_sum$nb[c(7,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_SP_PA_sum$nb[c(7,5,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())



# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/PA" ,"/geom_bar_PA_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/PA" ,"/geom_bar_PA_sylvop_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

#### Test stats
TOP_PA=data.frame(IUCN_CAT=0:7, Pres=NA, Resto=NA)
for (i in (1:7)){
  if ((i-1) %in% Top_preserv_SP_PA_sum$PA){
  TOP_PA$Pres[i]=Top_preserv_SP_PA_sum$nb[which(Top_preserv_SP_PA_sum$PA==as.character(i-1))]
  } else {TOP_PA$Pres[i]=0}
  
    if ((i-1) %in% Top_resto_SP_PA_sum$PA){
  TOP_PA$Resto[i]=Top_resto_SP_PA_sum$nb[which(Top_resto_SP_PA_sum$PA==as.character(i-1))]
    } else {TOP_PA$Resto[i]=0}
}
TOP_PA$Pres[8]=Top_preserv_SP_PA_sum$nb[which(Top_preserv_SP_PA_sum$PA=="NA's")]
TOP_PA$Resto[8]=Top_resto_SP_PA_sum$nb[which(Top_resto_SP_PA_sum$PA=="NA's")]




khi_prop_clust=TOP_PA[,-1]
khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust) # p-value = 3.676e-05
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c(0,1,2,3,4,6,"Not categorised")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#                   Preservation Restoration
# 0                          0           0
# 1                         71           3
# 2                          0           0
# 3                          0           0
# 4                         10           0
# 6                         10           0
# Not categorised            3           0

# >10 => significant


```

### BD

```{r bd_sylvo}

### BD in TOP RESTORATION 

Top_resto_SP_BD=shapefile("Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies_grasslands_top_resto_NCP_clust_BD_art17_WGS84.shp")

Top_resto_SP_BD_df=Top_resto_SP_BD@data

table(Top_resto_SP_BD_df[,c(grep("cluster", colnames(Top_resto_SP_BD_df)),grep("conclusion", colnames(Top_resto_SP_BD_df)))])

Top_resto_SP_BD_sum=as.data.frame(table(Top_resto_SP_BD_df[,c(grep("cluster", colnames(Top_resto_SP_BD_df)),grep("conclusion", colnames(Top_resto_SP_BD_df)))]))
sum(Top_resto_SP_BD_sum$Freq) # 8142 => ok


p=ggplot(Top_resto_SP_BD_sum) + geom_bar(aes(x=conclusion, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


Top_resto_SP_BD_summary=data.frame(conclusion=c("FV", "U1", "U2", "XX"), Freq=NA)
Top_resto_SP_BD_summary$conclusion=as.factor(Top_resto_SP_BD_summary$conclusion)
for (i in 1:nrow(Top_resto_SP_BD_summary)){
  Top_resto_SP_BD_summary$Freq[i]=sum(Top_resto_SP_BD_sum$Freq[which(Top_resto_SP_BD_sum$conclusion==Top_resto_SP_BD_summary$conclusion[i])])
}

p=ggplot(Top_resto_SP_BD_summary) + geom_bar(aes(x="Restoration", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))


## BD in TOP PRESERVATION


Top_preserv_SP_BD=shapefile("Path/to/working/directory/R/Export_data/Sylvopasto/Dist_to_centroid/Anomalies_grasslands_top_preserv_NCP_clust_BD_art17_WGS84.shp")

Top_preserv_SP_BD_df=Top_preserv_SP_BD@data
str(Top_preserv_SP_BD_df)

table(Top_preserv_SP_BD_df[,c(grep("cluster", colnames(Top_preserv_SP_BD_df)),grep("conclusion", colnames(Top_preserv_SP_BD_df)))])

Top_preserv_SP_BD_sum=as.data.frame(table(Top_preserv_SP_BD_df[,c(grep("cluster", colnames(Top_preserv_SP_BD_df)),grep("conclusion", colnames(Top_preserv_SP_BD_df)))]))
sum(Top_preserv_SP_BD_sum$Freq) # 10740 => ok


p=ggplot(Top_preserv_SP_BD_sum) + geom_bar(aes(x=conclusion, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


Top_preserv_SP_BD_summary=data.frame(conclusion=c("FV", "U1", "U2", "XX"), Freq=NA)
Top_preserv_SP_BD_summary$conclusion=as.factor(Top_preserv_SP_BD_summary$conclusion)
for (i in 1:nrow(Top_preserv_SP_BD_summary)){
  Top_preserv_SP_BD_summary$Freq[i]=sum(Top_preserv_SP_BD_sum$Freq[which(Top_preserv_SP_BD_sum$conclusion==Top_preserv_SP_BD_summary$conclusion[i])])
}

p=ggplot(Top_preserv_SP_BD_summary) + geom_bar(aes(x="Preservation", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))

### GRAPH WITH RESTO and PRESERV

p=ggplot() + geom_bar(data=Top_preserv_SP_BD_summary, aes(x="Preservation", y=Freq, fill=conclusion), stat="identity") + geom_bar(data=Top_resto_SP_BD_summary, aes(x="Restoration", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))


Top_preserv_SP_BD_summary$Prop=100*Top_preserv_SP_BD_summary$Freq/sum(Top_preserv_SP_BD_summary$Freq)
Top_resto_SP_BD_summary$Prop=100*Top_resto_SP_BD_summary$Freq/sum(Top_resto_SP_BD_summary$Freq)

Top_preserv_SP_BD_summary$TOP="Preservation"
Top_resto_SP_BD_summary$TOP="Restoration"
Top_SP_BD_summary=rbind(Top_preserv_SP_BD_summary, Top_resto_SP_BD_summary)

# Label preserv
label_pres=c(Top_preserv_SP_BD_summary$Freq[4]+Top_preserv_SP_BD_summary$Freq[3]/2,
             Top_preserv_SP_BD_summary$Freq[4]+Top_preserv_SP_BD_summary$Freq[3]+(Top_preserv_SP_BD_summary$Freq[2]/2),
             Top_preserv_SP_BD_summary$Freq[4]+Top_preserv_SP_BD_summary$Freq[3]+Top_preserv_SP_BD_summary$Freq[2]+(Top_preserv_SP_BD_summary$Freq[1]/2)
             )
# Label resto
label_resto=c(Top_resto_SP_BD_summary$Freq[4]+Top_resto_SP_BD_summary$Freq[3]/2,
             Top_resto_SP_BD_summary$Freq[4]+Top_resto_SP_BD_summary$Freq[3]+(Top_resto_SP_BD_summary$Freq[2]/2),
             Top_resto_SP_BD_summary$Freq[4]+Top_resto_SP_BD_summary$Freq[3]+Top_resto_SP_BD_summary$Freq[2]+(Top_resto_SP_BD_summary$Freq[1]/2)
             )

p=ggplot() + geom_bar(data=Top_SP_BD_summary, aes(x=TOP, y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_SP_BD_summary$Prop[c(3,2,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_SP_BD_summary$Prop[c(3,2,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())
  


# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD" ,"/geom_bar_BD_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD" ,"/geom_bar_BD_sylvop_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


#### Test stats
TOP_BD=data.frame(IUCN_CAT=c("FV", "U1", "U2", "XX"), Pres=NA, Resto=NA)

for (i in (1:4)){
  if (TOP_BD$IUCN_CAT[i] %in% Top_preserv_SP_BD_summary$conclusion){
  TOP_BD$Pres[i]=Top_preserv_SP_BD_summary$Freq[which(Top_preserv_SP_BD_summary$conclusion==TOP_BD$IUCN_CAT[i])]
  } else {TOP_BD$Pres[i]=0}
  
    if (TOP_BD$IUCN_CAT[i] %in% Top_resto_SP_BD_summary$conclusion){
  TOP_BD$Resto[i]=Top_resto_SP_BD_summary$Freq[which(Top_resto_SP_BD_summary$conclusion==TOP_BD$IUCN_CAT[i])]
    } else {TOP_BD$Resto[i]=0}
}





khi_prop_clust=TOP_BD[,-1]
# khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust)
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("FV", "U1", "U2", "XX")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#        Preservation Restoration
# FV            1           1
# U1           20          27
# U2           15          19
# XX            8          10
# >10 => significant




```


### BD-CCMa

```{r bd_ccm_sylvo}

###### BD VS current carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_actual_masked_top_preserv_SP_FV=mask(SOC_actual_masked_grassland_pente_inf35_trees, Top_preserv_SP_BD[which(Top_preserv_SP_BD$conclusion=="FV"),])
SOC_actual_masked_top_preserv_SP_FV@data@values=as.numeric(SOC_actual_masked_top_preserv_SP_FV@data@values) # 7526 values
length(SOC_actual_masked_top_preserv_SP_FV)
boxplot(SOC_actual_masked_top_preserv_SP_FV) 

# sampleRandom(SOC_actual_masked_top_preserv_SP_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_preserv_SP_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_SP_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")

p=ggplot() + geom_violin(data=data_soc_preserv_SP_FV, aes(y=SOC, x="Preservation FV"))
fx(p)

## In U1 state
SOC_actual_masked_top_preserv_SP_U1=mask(SOC_actual_masked_grassland_pente_inf35_trees, Top_preserv_SP_BD[which(Top_preserv_SP_BD$conclusion=="U1"),])
SOC_actual_masked_top_preserv_SP_U1@data@values=as.numeric(SOC_actual_masked_top_preserv_SP_U1@data@values) # 7526 values
length(SOC_actual_masked_top_preserv_SP_U1@data@values) # 90492624
boxplot(SOC_actual_masked_top_preserv_SP_U1) 

# sampleRandom(SOC_actual_masked_top_preserv_SP_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_SP_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_SP_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")

p=ggplot() + geom_violin(data=data_soc_preserv_SP_U1, aes(y=SOC, x="Preservation U1"))
fx(p)

## In U2 state
SOC_actual_masked_top_preserv_SP_U2=mask(SOC_actual_masked_grassland_pente_inf35_trees, Top_preserv_SP_BD[which(Top_preserv_SP_BD$conclusion=="U2"),])
SOC_actual_masked_top_preserv_SP_U2@data@values=as.numeric(SOC_actual_masked_top_preserv_SP_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_preserv_SP_U2) 

# sampleRandom(SOC_actual_masked_top_preserv_SP_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_SP_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_SP_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")

p=ggplot() + geom_violin(data=data_soc_preserv_SP_U2, aes(y=SOC, x="Preservation U2"))
fx(p)
# with all 3 state of BD
data_soc_preserv_SP_all=rbind(data_soc_preserv_SP_FV[], data_soc_preserv_SP_U1, data_soc_preserv_SP_U2)
data_soc_preserv_SP_all$BD=as.factor(data_soc_preserv_SP_all$BD)

p=ggplot() + geom_violin(data=data_soc_preserv_SP_all, aes(y=SOC, x=BD)) 





### In Top restoration

## In BD favourable state
SOC_actual_masked_top_resto_SP_FV=mask(SOC_actual_masked_grassland_pente_inf35_trees, Top_resto_SP_BD[which(Top_resto_SP_BD$conclusion=="FV"),])
SOC_actual_masked_top_resto_SP_FV@data@values=as.numeric(SOC_actual_masked_top_resto_SP_FV@data@values) # 7526 values
length(SOC_actual_masked_top_resto_SP_FV)
# boxplot(SOC_actual_masked_top_resto_SP_FV) 

# sampleRandom(SOC_actual_masked_top_resto_SP_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_resto_SP_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_SP_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")

# p=ggplot() + geom_violin(data=data_soc_resto_SP_FV, aes(y=SOC, x="Restoration FV"))
# fx(p)
remove(SOC_actual_masked_top_resto_SP_FV)

## In U1 state
SOC_actual_masked_top_resto_SP_U1=mask(SOC_actual_masked_grassland_pente_inf35_trees, Top_resto_SP_BD[which(Top_resto_SP_BD$conclusion=="U1"),])
SOC_actual_masked_top_resto_SP_U1@data@values=as.numeric(SOC_actual_masked_top_resto_SP_U1@data@values) # 7526 values
length(SOC_actual_masked_top_resto_SP_U1@data@values) # 90492624
# boxplot(SOC_actual_masked_top_resto_SP_U1) 

# sampleRandom(SOC_actual_masked_top_resto_SP_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_SP_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_SP_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")

# p=ggplot() + geom_violin(data=data_soc_resto_SP_U1, aes(y=SOC, x="Restoration U1"))
# fx(p)
remove(SOC_actual_masked_top_resto_SP_U1)

## In U2 state
SOC_actual_masked_top_resto_SP_U2=mask(SOC_actual_masked_grassland_pente_inf35_trees, Top_resto_SP_BD[which(Top_resto_SP_BD$conclusion=="U2"),])
SOC_actual_masked_top_resto_SP_U2@data@values=as.numeric(SOC_actual_masked_top_resto_SP_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_resto_SP_U2) 

# sampleRandom(SOC_actual_masked_top_resto_SP_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_SP_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_SP_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")

# p=ggplot() + geom_violin(data=data_soc_resto_SP_U2, aes(y=SOC, x="Restoration U2"))
# fx(p)
remove(SOC_actual_masked_top_resto_SP_U2)




# with all 3 state of BD
data_soc_resto_SP_all=rbind(data_soc_resto_SP_FV, data_soc_resto_SP_U1, data_soc_resto_SP_U2)
data_soc_resto_SP_all$BD=as.factor(data_soc_resto_SP_all$BD)

p=ggplot() + geom_violin(data=data_soc_resto_SP_all, aes(y=SOC, x=BD)) 




# BD VS potential carbon sequestration

# data_soc_SP_U1=rbind(data_soc_preserv_SP_U1, data_soc_resto_SP_U1)
# data_soc_SP_U2=rbind(data_soc_preserv_SP_U2, data_soc_resto_SP_U2)
# 
# p=ggplot() + geom_violin(data=data_soc_SP_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_SP_U2, aes(y=SOC, x=TOP, fill=BD))


data_soc_all_SP_all=rbind(data_soc_preserv_SP_all, data_soc_resto_SP_all)

p=ggplot() + geom_violin(data=data_soc_all_SP_all, aes(y=SOC, x=BD:TOP, fill=TOP))
fx(p)


### ANOVA

aov_SP=aov(data=data_soc_all_SP_all, SOC~TOP*BD)
anova(aov_SP) 

# Response: SOC
#             Df Sum Sq Mean Sq F value   Pr(>F)   
# TOP          1     64  63.562  8.9588 0.002770 **
# BD           2     85  42.723  6.0217 0.002437 **
# TOP:BD       2     13   6.258  0.8821 0.413954   

TukeyHSD(aov_SP)
#                             diff          lwr            upr     p adj
# Restoration > Preservation  0.1779295    0.0613999   0.294459  0.0027697
# U1 = FV                     0.004183329 -0.166785004 0.1751517 0.9981879
# U2 >? FV                    0.187842639 -0.008851873 0.3845371 0.0649142
# U2 > U1                     0.183659309  0.013506922 0.3538117 0.0306754

TukeyHSD(aov_SP)$`TOP:BD`[which(TukeyHSD(aov_SP)$`TOP:BD`[,4]<0.05),]
# diff        lwr       upr        p adj
# Restoration:U2 > Preservation:FV 0.37265 0.13255691 0.6127431 0.0001427703
# Restoration:U2 > Preservation:U1 0.26847 0.02837692 0.5085631 0.0180617418
# Restoration:U2 > Restoration:U1  0.29004 0.04994692 0.5301331 0.0076141262

## Manual group
# "FV:Preservation"      a
# "FV:Restoration"      c
# "U1:Preservation"      a
# "U1:Restoration"       a
# "U2:Preservation"     c
# "U2:Restoration"     b

x_groups=c("FV:Preservation", "FV:Restoration", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
groups=c("a", " ", "a", "a", "c", "b")

### PLOT

# 
Top_preserv_SP_BD_summary$Prop=100*Top_preserv_SP_BD_summary$Freq/sum(Top_preserv_SP_BD_summary$Freq)
Top_resto_SP_BD_summary$Prop=100*Top_resto_SP_BD_summary$Freq/sum(Top_resto_SP_BD_summary$Freq)


median_data <- data_soc_all_SP_all %>%
  group_by(BD:TOP) %>%
  summarize(median_soc = median(SOC, na.rm=T)) %>% as.data.frame()

# median_data=median_data[c(1,4,2,5,3,6),]
colnames(median_data)=c("TOP", "median_soc")


p=ggplot() + geom_violin(data=data_soc_all_SP_all, aes(y=SOC, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=41 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = (median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

  
# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_sylvop_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

# without restoration fv
x_groups_sans_resto_fv=x_groups[-2]
groups_sans_resto_fv=groups[-2]
median_data_sans_resto_fv=median_data[-2,]
data_soc_all_SP_all_without_resto_fv=data_soc_all_SP_all[-which(data_soc_all_SP_all$TOP=="Restoration" & data_soc_all_SP_all$BD=="FV"),]
p=ggplot() + geom_violin(data=data_soc_all_SP_all_without_resto_fv, aes(y=SOC, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups_sans_resto_fv, y=41 ,label = groups_sans_resto_fv),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data_sans_resto_fv , aes(y = (median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_sylvop_without_resto_fv", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_sylvop_groups_without_resto_fv", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


# WITH LOG

p=ggplot() + geom_violin(data=data_soc_all_SP_all, aes(y=log10(SOC), x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=1.7 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = log10(median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_sylvop_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


# WITH LOG WITHOUT RESTO FV

p=ggplot() + geom_violin(data=data_soc_all_SP_all_without_resto_fv, aes(y=log10(SOC), x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups_sans_resto_fv, y=1.7 ,label = groups_sans_resto_fv),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data_sans_resto_fv , aes(y = log10(median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_sylvop_sans_resto_fv", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_sylvop_groups_sans_resto_fv", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)





```


### BD-CCMp

```{r bd_ccm_pot_sylvopast}

###### BD VS potential carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_potent_masked_top_preserv_SP_FV=mask(SOC_potential_masked_grassland_slope_inf35, Top_preserv_SP_BD[which(Top_preserv_SP_BD$conclusion=="FV"),])
# SOC_potent_masked_top_preserv_SP_FV=SOC_potent_masked_top_preserv_SP_FV[-which(is.na(SOC_potent_masked_top_preserv_SP_FV@data@values)),]
# SOC_potent_masked_top_preserv_SP_FV@data@values=as.numeric(SOC_potent_masked_top_preserv_SP_FV@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_SP_FV)
# boxplot(SOC_potent_masked_top_preserv_SP_FV) 

# sampleRandom(SOC_potent_masked_top_preserv_SP_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_pot_preserv_SP_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_SP_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")
colnames(data_soc_pot_preserv_SP_FV)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_SP_FV, aes(y=SOP, x="Preservation FV"))
fx(p)

remove(SOC_potent_masked_top_preserv_SP_FV)

## In U1 state
SOC_potent_masked_top_preserv_SP_U1=mask(SOC_potential_masked_grassland_slope_inf35, Top_preserv_SP_BD[which(Top_preserv_SP_BD$conclusion=="U1"),])
# SOC_potent_masked_top_preserv_SP_U1@data@values=as.numeric(SOC_potent_masked_top_preserv_SP_U1@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_SP_U1@data@values) # 90492624
# boxplot(SOC_potent_masked_top_preserv_SP_U1) 

# sampleRandom(SOC_potent_masked_top_preserv_SP_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_preserv_SP_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_SP_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")
colnames(data_soc_pot_preserv_SP_U1)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_SP_U1, aes(y=SOP, x="Preservation U1"))
fx(p)

remove(SOC_potent_masked_top_preserv_SP_U1)

## In U2 state
SOC_potent_masked_top_preserv_SP_U2=mask(SOC_potential_masked_grassland_slope_inf35, Top_preserv_SP_BD[which(Top_preserv_SP_BD$conclusion=="U2"),])
# SOC_potent_masked_top_preserv_SP_U2@data@values=as.numeric(SOC_potent_masked_top_preserv_SP_U2@data@values) # 90492624 values
length(SOC_potent_masked_top_preserv_SP_U2)
# boxplot(SOC_potent_masked_top_preserv_SP_U2) 

# sampleRandom(SOC_potent_masked_top_preserv_SP_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_preserv_SP_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_SP_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")
colnames(data_soc_pot_preserv_SP_U2)=c("SOP", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_pot_preserv_SP_U2, aes(y=SOP, x="Preservation U2"))
# fx(p)

remove(SOC_potent_masked_top_preserv_SP_U2)

# with all 3 state of BD
data_soc_pot_preserv_SP_all=rbind(data_soc_pot_preserv_SP_FV, data_soc_pot_preserv_SP_U1, data_soc_pot_preserv_SP_U2)
data_soc_pot_preserv_SP_all$BD=as.factor(data_soc_pot_preserv_SP_all$BD)

p=ggplot() + geom_violin(data=data_soc_pot_preserv_SP_all, aes(y=SOP, x=BD)) 



### In Top restoration

## In BD favourable state
SOC_potent_masked_top_resto_SP_FV=mask(SOC_potential_masked_grassland_slope_inf35, Top_resto_SP_BD[which(Top_resto_SP_BD$conclusion=="FV"),])
# SOC_potent_masked_top_resto_SP_FV@data@values=as.numeric(SOC_potent_masked_top_resto_SP_FV@data@values) # 7526 values
length(SOC_potent_masked_top_resto_SP_FV)
# boxplot(SOC_potent_masked_top_resto_SP_FV) 

# sampleRandom(SOC_potent_masked_top_resto_SP_FV,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_SP_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_SP_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")
# data_soc_pot_resto_SP_FV=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="FV")
colnames(data_soc_pot_resto_SP_FV)=c("SOP", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_pot_resto_SP_FV, aes(y=SOP, x="Restoration FV"))
# fx(p)
remove(SOC_potent_masked_top_resto_SP_FV)

## In U1 state
SOC_potent_masked_top_resto_SP_U1=mask(SOC_potential_masked_grassland_slope_inf35, Top_resto_SP_BD[which(Top_resto_SP_BD$conclusion=="U1"),])
# SOC_potent_masked_top_resto_SP_U1@data@values=as.numeric(SOC_potent_masked_top_resto_SP_U1@data@values) # 7526 values
length(SOC_potent_masked_top_resto_SP_U1@data@values) # 90492624
# boxplot(SOC_potent_masked_top_resto_SP_U1) 

# sampleRandom(SOC_potent_masked_top_resto_SP_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_SP_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_SP_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")
# data_soc_pot_resto_SP_U1=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U1")
colnames(data_soc_pot_resto_SP_U1)=c("SOP", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_pot_resto_SP_U1, aes(y=SOP, x="Restoration U1"))
# fx(p)
remove(SOC_potent_masked_top_resto_SP_U1)


## In U2 state
SOC_potent_masked_top_resto_SP_U2=mask(SOC_potential_masked_grassland_slope_inf35, Top_resto_SP_BD[which(Top_resto_SP_BD$conclusion=="U2"),])
# SOC_potent_masked_top_resto_SP_U2@data@values=as.numeric(SOC_potent_masked_top_resto_SP_U2@data@values) # 90492624 values
# boxplot(SOC_potent_masked_top_resto_SP_U2) 
length(SOC_potent_masked_top_resto_SP_U2) # 90492624

# sampleRandom(SOC_potent_masked_top_resto_SP_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_SP_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_SP_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")
# data_soc_pot_resto_SP_U2=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U2")
colnames(data_soc_pot_resto_SP_U2)=c("SOP", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_pot_resto_SP_U2, aes(y=SOP, x="Restoration U2"))
# fx(p)
remove(SOC_potent_masked_top_resto_SP_U2)



# with all 3 state of BD
data_soc_pot_resto_SP_all=rbind(data_soc_pot_resto_SP_FV, data_soc_pot_resto_SP_U1, data_soc_pot_resto_SP_U2)
data_soc_pot_resto_SP_all$BD=as.factor(data_soc_pot_resto_SP_all$BD)

p=ggplot() + geom_violin(data=data_soc_pot_resto_SP_all, aes(y=SOP, x=BD)) 



# data_soc_pot_SP_FV=rbind(data_soc_pot_preserv_SP_FV, data_soc_pot_resto_SP_FV)
# data_soc_pot_SP_U1=rbind(data_soc_pot_preserv_SP_U1, data_soc_pot_resto_SP_U1)
# data_soc_pot_SP_U2=rbind(data_soc_pot_preserv_SP_U2, data_soc_pot_resto_SP_U2)

# p=ggplot() +
#   geom_violin(data=data_soc_pot_SP_FV, aes(y=SOC, x=TOP, fill=BD)) +
#   geom_violin(data=data_soc_pot_SP_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_pot_SP_U2, aes(y=SOC, x=TOP, fill=BD))


data_soc_pot_all_SP_all=rbind(data_soc_pot_preserv_SP_all, data_soc_pot_resto_SP_all)

p=ggplot() + geom_violin(data=data_soc_pot_all_SP_all, aes(y=SOP, x=BD:TOP, fill=TOP))
fx(p)

p=ggplot() + geom_violin(data=data_soc_pot_all_SP_all, aes(y=SOP, x=TOP:BD, fill=BD))
fx(p)

### ANOVA

aov_pot_SP=aov(data=data_soc_pot_all_SP_all, SOP~TOP*BD)
anova(aov_pot_SP) 

# Response: SOC
#              Df  Sum Sq Mean Sq F value    Pr(>F)    
# TOP           1   1.13  1.1271  36.910 1.275e-09 ***
# BD            2  52.11 26.0559 853.286 < 2.2e-16 ***
# TOP:BD        2   4.38  2.1875  71.638 < 2.2e-16 ***

TukeyHSD(aov_pot_SP)
#                             diff          lwr            upr     p adj
# Restoration < Preservation -0.01938282 -0.02563651 -0.01312912     0
# U1 < FV                    -0.04738259 -0.05654156 -0.03822362     0
# U2 < FV                    -0.15732538 -0.16648435 -0.14816641     0
# U2 < U1                    -0.10994279 -0.11910176 -0.10078381     0

TukeyHSD(aov_pot_SP)$`TOP:BD`[which(TukeyHSD(aov_pot_SP)$`TOP:BD`[,4]<0.05),]
# Restoration:U1<Preservation:FV  -0.08622987 -0.101979698 -0.07048004 0.000000000
# Preservation:U2<Preservation:FV -0.17031298 -0.186062810 -0.15456315 0.000000000
# Restoration:U2<Preservation:FV  -0.15076688 -0.166516709 -0.13501705 0.000000000
# Restoration:U1<Restoration:FV   -0.07980077 -0.095550596 -0.06405094 0.000000000
# Preservation:U2<Restoration:FV  -0.16388388 -0.179633709 -0.14813405 0.000000000
# Restoration:U2<Restoration:FV   -0.14433778 -0.160087607 -0.12858795 0.000000000
# Restoration:U1<Preservation:U1  -0.07126545 -0.087015279 -0.05551562 0.000000000
# Preservation:U2<Preservation:U1 -0.15534856 -0.171098392 -0.13959873 0.000000000
# Restoration:U2<Preservation:U1  -0.13580246 -0.151552291 -0.12005263 0.000000000
# Preservation:U2<Restoration:U1  -0.08408311 -0.099832943 -0.06833328 0.000000000
# Restoration:U2<Restoration:U1   -0.06453701 -0.080286842 -0.04878718 0.000000000
# Restoration:U2>Preservation:U2   0.01954610  0.003796271  0.03529593 0.005436845

# Interactions plot ?? 

# Manual grouping
# "FV:Preservation" a
# "FV:Restoration"  a
# "U1:Preservation" a
# "U1:Restoration"    b
# "U2:Preservation"      d
# "U2:Restoration"    b

x_groups=c("FV:Preservation", "FV:Restoration", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
groups=c("a", "a", "a", "b", "c", "b")

### PLOT
# data_soc_pot_all_SP_all

p=ggplot() + geom_violin(data=data_soc_pot_all_SP_all, aes(y=SOP, x=BD:TOP, fill=TOP))
fx(p)

# 
# Top_preserv_WR_BD_summary$Prop=100*Top_preserv_WR_BD_summary$Freq/sum(Top_preserv_WR_BD_summary$Freq)
# Top_resto_WR_BD_summary$Prop=100*Top_resto_WR_BD_summary$Freq/sum(Top_resto_WR_BD_summary$Freq)


median_data <- data_soc_pot_all_SP_all %>%
  group_by(BD:TOP) %>%
  summarize(median_sop = median(SOP, na.rm=T)) %>% as.data.frame()

# median_data=median_data[c(1,4,2,5,3,6),]
colnames(median_data)=c("TOP", "median_sop")


p=ggplot() + geom_violin(data=data_soc_pot_all_SP_all, aes(y=SOP, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=1.05 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = (median_sop), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

  
# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_groups_sylvop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)



```


### absolute CCM
```{r absolute_ccm_grasslands}
# SOC:
SOC_actual_masked_grassland_pente_inf35_trees
# SOP :
SOC_potential_masked_grassland_slope_inf35

Capacity_grasslands=SOC_actual_masked_grassland_pente_inf35_trees*(1-SOC_potential_masked_grassland_slope_inf35)/SOC_potential_masked_grassland_slope_inf35

# Top preserv
Capacity_CCM_grasslands_preserv=mask(Capacity_grasslands, Anomalies2100_in_WS_raster_grassland_tree_masked_top_pres)

length(Capacity_CCM_grasslands_preserv@data@values[-which(is.na(Capacity_CCM_grasslands_preserv@data@values))]) #1118799

data_capacity_preserv=data.frame(Capacity=sampleRandom(Capacity_CCM_grasslands_preserv$layer, 20000, na.rm=T, xy=F), TOP=as.factor("Preservation"))

str(data_capacity_preserv)


# Top resto
Capacity_CCM_grasslands_resto=mask(Capacity_grasslands, Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto)


length(Capacity_CCM_grasslands_resto@data@values[-which(is.na(Capacity_CCM_grasslands_resto@data@values))]) #540351

data_capacity_resto=data.frame(Capacity=sampleRandom(Capacity_CCM_grasslands_resto$layer, 20000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

str(data_capacity_resto)


# in AS
SOC_present_WGS84=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ESDAC/Derived_data_set_2013/SOC_top_soil_WGS84.tif")
crs(SOC_present_WGS84)@projargs==crs(AS_fusion_WGS84)@projargs
SOC_present_cut=crop(SOC_present_WGS84,AS_fusion_WGS84)
SOC_present_cut_resample=resample(SOC_present_cut, Carbon_saturation_cut_WGS84,method = 'ngb')

Capacity_CCM_in_AS=SOC_present_cut_resample*(1-Carbon_saturation_cut_WGS84)/Carbon_saturation_cut_WGS84
 
Capacity_CCM_in_AS=mask(Capacity_CCM_in_AS, AS_fusion_WGS84)

Capacity_CCM_in_AS_rd=data.frame(SOC=sampleRandom(Capacity_CCM_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(Capacity_CCM_in_AS_rd)=c("Capacity", "TOP")





## ANOVA

aov_capacity_sp=aov(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), Capacity~TOP)
anova(aov_capacity_sp)
#              Df Sum Sq Mean Sq F value    Pr(>F) 
# TOP           2    524 261.993  151.39 < 2.2e-16 ***
# Residuals 49997  86526   1.731                   

TukeyHSD(aov_capacity_sp)
# #                             diff         lwr       upr     p adj
# Restoration > Preservation  0.22581800  0.1949859  0.2566501 0.00e+00
# AS > Preservation           0.07100364  0.0332422  0.1087651 3.12e-05
# AS < Restoration           -0.15481437 -0.1925758 -0.1170529 0.00e+00

HSD_SP=HSD.test(aov_capacity_sp, trt="TOP", group=T, alpha=0.05)
HSD_SP
# Capacity groups
# Restoration  0.5715176      a
# AS           0.4167032      b
# Preservation 0.3456996      c



### Capacity in pres & resto
median_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(median_cap = median(Capacity)) %>% as.data.frame()

mean_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(mean_cap = mean(Capacity)) %>% as.data.frame()



p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data , aes(y = (mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_CCM_capacity", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


### PLOT LOG

p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), aes(y=log10(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=2 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = log10(median_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_log_CCM_capacity", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_sp, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_log_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


### Without AS
p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto), aes(y=log10(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration"), y=2 ,label = c("a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data[-3,] , aes(y = log10(mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_LOG_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_sp, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_LOG_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


##### AS only
dossier_as="Path/to/working/directory/R/Export_data/AS/"
  
p=ggplot() + geom_violin(data=Capacity_CCM_in_AS_rd, aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(
    # rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               # rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data[-c(1,2),] , aes(y = (mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_as, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_grasslands_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

```


### Combined CCM index

```{r combined_ccm_index}

# SOC:
summary(SOC_actual_masked_grassland_pente_inf35_trees)
# Min.                  0.00
# 1st Qu.               0.79
# Median                1.45
# 3rd Qu.               2.13
# Max.                 39.40
# NA's           83528808.00

# SOP :
summary(SOC_potential_masked_grassland_slope_inf35)
# Min.                                   3.048272e-01 0.30
# 1st Qu.                                7.839519e-01 0.78
# Median                                 1.000000e+00 1
# 3rd Qu.                                1.000000e+00 1
# Max.                                   1.000000e+00 1
# NA's                                   8.435813e+07 


# list=1:ncell(SOC_potential_masked_grassland_slope_inf35)
# list=raster::extract(SOC_potential_masked_grassland_slope_inf35, na.rm=T, y=Bounding_box, cellnumbers=T)
list=1:ncell(SOC_potential_masked_grassland_slope_inf35)
list=list[which(!is.na(SOC_potential_masked_grassland_slope_inf35[]))]
length(list)/ncell(SOC_potential_masked_grassland_slope_inf35) # 6.5%
list=as.vector(list)
list_sp=list[sample(x=1:length(list), size=10^5)]
summary(SOC_potential_masked_grassland_slope_inf35[list_sp])
summary(SOC_actual_masked_grassland_pente_inf35_trees[list_sp])
plot(SOC_actual_masked_grassland_pente_inf35_trees[list_sp], SOC_potential_masked_grassland_slope_inf35[list_sp])
### complicated to create one index...

# summary(Capacity_grasslands) 
# =SOC_actual_masked_grassland_pente_inf35_trees*(1-SOC_potential_masked_grassland_slope_inf35)/SOC_potential_masked_grassland_slope_inf35
# Min.    0.000000e+00
# 1st Qu. 0.000000e+00
# Median  0.000000e+00
# 3rd Qu. 3.112755e-01
# Max.    6.662530e+01


Cpot_add=SOC_actual_masked_grassland_pente_inf35_trees/SOC_potential_masked_grassland_slope_inf35
summary(Cpot_add)
# Min.    0.000000e+00
# 1st Qu. 1.046184e+00
# Median  1.577685e+00
# 3rd Qu. 2.130000e+00
# Max.    1.060253e+02
# NA's    8.454015e+07

plot(SOC_actual_masked_grassland_pente_inf35_trees[list_sp], Cpot_add[list_sp])

### Preserv

Cpot_add_grasslands_preserv=mask(Cpot_add, Anomalies2100_in_WS_raster_grassland_tree_masked_top_pres)

length(Cpot_add_grasslands_preserv[which(!is.na(Cpot_add_grasslands_preserv[]))]) # 1118799

list=1:ncell(Cpot_add_grasslands_preserv)
list=list[which(!is.na(Cpot_add_grasslands_preserv[]))]
list_sp=list[sample(x=1:length(list), size=10^5)]

data_cpot_add_preserv=data.frame(Cadd=Cpot_add_grasslands_preserv[list_sp], SOC=SOC_actual_masked_grassland_pente_inf35_trees[list_sp], TOP=as.factor("Surplus"))

data_cpot_add_preserv_reshp=reshape(data_cpot_add_preserv,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_preserv_reshp$time=factor(data_cpot_add_preserv_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


# Resto

Cpot_add_grasslands_resto=mask(Cpot_add, Anomalies2100_in_WS_raster_grassland_tree_masked_top_resto)

length(Cpot_add_grasslands_resto@data@values[which(!is.na(Cpot_add_grasslands_resto[]))]) # 540351

list=1:ncell(Cpot_add_grasslands_resto)
list=list[which(!is.na(Cpot_add_grasslands_resto[]))]
list_sp=list[x=sample(1:length(list), size=10^5)]

data_cpot_add_resto=data.frame(Cadd=Cpot_add_grasslands_resto[list_sp], SOC=SOC_actual_masked_grassland_pente_inf35_trees[list_sp], TOP=as.factor("Deficit"))

data_cpot_add_resto_reshp=reshape(data_cpot_add_resto,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_resto_reshp$time=factor(data_cpot_add_resto_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


######## STATS
data_cpot_add_all_reshp=rbind(data_cpot_add_preserv_reshp, data_cpot_add_resto_reshp)

data_cpot_add_all_reshp$TOP=factor(data_cpot_add_all_reshp$TOP, ordered=T, levels = c("Surplus", "Deficit"))

aov_carbon=aov(data=data_cpot_add_all_reshp, Carbon~TOP*time)
anova(aov_carbon) 
# Response: Carbon
#              Df  Sum Sq Mean Sq  F value    Pr(>F)    
# TOP       1e+00   11261 11260.6  1091.7 < 2.2e-16 ***
# time      1e+00   21361 21360.9  2071.0 < 2.2e-16 ***
# TOP:time  1e+00    1442  1441.9   139.8 < 2.2e-16 ***

TukeyHSD(aov_carbon)
# $TOP
#                      diff       lwr       upr p adj
# Deficit > Surplus 0.3355687 0.3156632 0.3554742     0

# $time
#              diff      lwr      upr p adj
# Cadd > SOC 0.4621791 0.4422736 0.4820845     0

TukeyHSD(aov_carbon)$`TOP:time`[which(TukeyHSD(aov_carbon)$`TOP:time`[,4]<0.05),]
# $`TOP:time`
#                                diff       lwr       upr p adj
# Deficit:SOC>Surplus:SOC   0.2154885 0.17858997 0.2523871     0
# Surplus:Cadd>Surplus:SOC  0.3420989 0.30520032 0.3789974     0
# Deficit:Cadd>Surplus:SOC  0.7977478 0.76084921 0.8346463     0
# Surplus:Cadd>Deficit:SOC  0.1266104 0.08971181 0.1635089     0
# Deficit:Cadd>Deficit:SOC  0.5822592 0.54536070 0.6191578     0
# Deficit:Cadd>Surplus:Cadd 0.4556489 0.41875034 0.4925474     0

# Manual grouping

# Surplus:SOC: a
# Surplus:Caad:    c
# Deficit:SOC:  b
# Deficit:Cadd:     d








######## PLOT


median_log_data <- data_cpot_add_all_reshp %>%
  group_by(TOP:time) %>%
  summarize(median_carbon = median(log10(Carbon), na.rm=T)) %>% as.data.frame()


### Without AS
# x=seq(from=0.8, to=2.2, length.out=4)
p=ggplot() + geom_violin(data=data_cpot_add_all_reshp, aes(y=log10(Carbon), x=TOP, fill=TOP:time), position = position_dodge(0.8)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),rgb(1, 133, 113, maxColorValue = 255, alpha=0.6*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.6*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(data=median_log_data, aes(x=c(0.8, 1.2, 1.8, 2.2), y=2.1 ,label = c("a", "c", "b", "d")), stat="identity", vjust = 1.5, colour = "black",  size=10) +
    geom_point(data =median_log_data , aes(y = (median_carbon), x=c(0.8, 1.2, 1.8, 2.2)), shape = 4, size = 6, color = "black") +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

ggsave(plot=p, filename = paste(dossier_sp, "/Figure/CCM_add" ,"/geom_bar_Carbon_SOC_add_sylvopasto", ".png", sep=''), width=7*2, height=10*2, limitsize=F, dpi = 300)







```





## Sustainable forests

```{r sustainable_forests}
### sustainable forest data
dossier_fm="Path/to/working/directory/R/Export_data/Sustainableforest/"

# Raster:
Forest_masque=CLC_Alps_WGS84 %in% legend_grid_forest

Forest_in_AS_raster=mask(CLC_Alps_WGS84, mask=Forest_masque, maskvalue=0)


crs(Forest_in_AS_raster)

# writeRaster(Forest_in_AS_raster, "Path/to/working/directory/R/Export_data/Sustainableforest/Forest_mask_in_CLC_AS_WGS84.tif", overwrite=T)
# Forest_in_AS_raster=raster("Path/to/working/directory/R/Export_data/Sylvopasto/Grassland_mask_in_CLC_AS_WGS84.tif")

### Select the forest with slopes < 35 (management is not possible - natural evolution anyway)
res(Forest_in_AS_raster) # 0.001297000 0.000895796
res(Slopes_raster_cut_WGS84) # 0.00827 0.00836
Slopes_raster_resampled_WGS84 <- resample(Slopes_raster_cut_WGS84, Forest_in_AS_raster, method = 'ngb') # method ngb for closest neighbours

extent(Forest_in_AS_raster)==extent(Slopes_raster_resampled_WGS84)

Forest_in_AS_pente_inf35 <- mask(Forest_in_AS_raster, mask=Slopes_raster_resampled_WGS84 >= 35, maskvalue=1)

Forest_in_AS_pente_inf35 <-mask(Forest_in_AS_pente_inf35, mask=AS_fusion_WGS84)


# writeRaster(Forest_in_AS_pente_inf35, "Path/to/working/directory/R/Export_data/Sustainableforest/Forest_mask_in_CLC_slopes_inf35_AS_WGS84.tif", overwrite=T)
Forest_in_AS_pente_inf35=raster("Path/to/working/directory/R/Export_data/Sustainableforest/Forest_mask_in_CLC_slopes_inf35_AS_WGS84.tif")



Anomalies2100_in_WS_forest_raster=Forest_in_AS_pente_inf35
Anomalies2100_in_WS_forest_raster=rasterize(x= HydroBasin_l12_ALPS_int_sp,y=Anomalies2100_in_WS_forest_raster, field="Multiply_anomalies_groundwater_reldrought_2100_JJA")


Anomalies2100_in_WS_raster_forest_masked=mask(Anomalies2100_in_WS_forest_raster,Forest_in_AS_pente_inf35)


writeRaster(Anomalies2100_in_WS_raster_forest_masked, "Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies2100_in_WS_raster_forest_slopes_inf35_AS_WGS84.tif", overwrite=T)



## Plot

plot(Anomalies2100_in_WS_raster_forest_masked)
hist((Anomalies2100_in_WS_raster_forest_masked))
boxplot(Anomalies2100_in_WS_raster_forest_masked@data@values)

data_anomalies=data.frame(Ano=as.factor("Anomalies"), Var=Anomalies2100_in_WS_raster_forest_masked@data@values)
data_anomalies=data_anomalies[-which(is.na(data_anomalies$Var)),]

quantile_points=data.frame(y=NA, x="Anomalies", group=c(25,75,10,90,50))
for (i in 1:5){
  quantile_points$y[i]=quantile(Anomalies2100_in_WS_raster_forest_masked@data@values, quantile_points$group[i]/100, na.rm=T)
}
quantile_points$group=as.factor(c(25,25,10,10,50))

p=ggplot() + geom_violin(data=data_anomalies[sample(size=10^5, x=1:nrow(data_anomalies)),], aes(y=Var, x=Ano))+
  geom_point(data=quantile_points, aes(x=x, y=y, color=group)) + scale_color_manual(values=c(c("#0072B2", "#009E73", "#D55E00", "#000000")))
fx(p)

## nEw plot 
p=ggplot(data=data_anomalies[sample(size=10^5, x=1:nrow(data_anomalies)),]) + geom_violin(aes(y=Var, x=Ano))+
   geom_boxplot(aes(y=Var, x=Ano), width = 0.2, fill = "white", color = "black", outlier.shape = NA) +
  theme_bw() + theme(axis.text.x=element_blank(),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_y_continuous(breaks = seq(-1000, 1000, by = 200), limits=c(-800, 800))
  # geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/Anomalies" ,"/geom_violin_forest_Anomalies", ".png", sep=''), width=4*2, height=8*2, limitsize=F, dpi = 300)


## Select top preservation

Anomalies2100_in_WS_raster_forest_masked_top_pres=mask(x=Anomalies2100_in_WS_raster_forest_masked, mask=Anomalies2100_in_WS_raster_forest_masked>quantile(Anomalies2100_in_WS_raster_forest_masked[which(Anomalies2100_in_WS_raster_forest_masked@data@values>0)], 0.80, na.rm=T), maskvalue=0 )


# writeRaster(Anomalies2100_in_WS_raster_forest_masked_top_pres, "Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies2100_in_WS_raster_forest_masked_AS_TOP_preserv_WGS84.tif", overwrite=T)

## Select top restoration


Anomalies2100_in_WS_raster_forest_masked_top_resto=mask(x=Anomalies2100_in_WS_raster_forest_masked,mask=Anomalies2100_in_WS_raster_forest_masked<quantile(Anomalies2100_in_WS_raster_forest_masked[which(Anomalies2100_in_WS_raster_forest_masked@data@values<0)], 0.50, na.rm=T), maskvalue=0)

# writeRaster(Anomalies2100_in_WS_raster_forest_masked_top_resto, "Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies2100_in_WS_raster_forest_masked_AS_TOP_resto_WGS84.tif", overwrite=T)

summary(Anomalies2100_in_WS_raster_forest_masked_top_resto)
100*length(Anomalies2100_in_WS_raster_forest_masked_top_resto[Anomalies2100_in_WS_raster_forest_masked_top_resto@data@values>0])/length(Anomalies2100_in_WS_raster_forest_masked_top_resto[Anomalies2100_in_WS_raster_forest_masked_top_resto@data@values<0])
# 50% >0



```


### Soil organic carbon
```{r forest_organic_carbon}


crs(SOC_present) ## ??

# SOC_present_in_AS=crop(SOC_present, BB_Large_WGS84)

# From derived data 2013

# SOC_present_WGS84=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ESDAC/Derived_data_set_2013/SOC_top_soil_WGS84.tif")
# crs(SOC_present_WGS84)@projargs==crs(BB_Large_WGS84)@projargs

## zonal stat in each selected polygons for restoration and preservation??j

SOC_current_forest_cut=crop(SOC_present_WGS84, Forest_in_AS_pente_inf35)
SOC_current_forest_cut_cut=resample(SOC_current_forest_cut, Forest_in_AS_pente_inf35,method = 'ngb')

SOC_current_masked_forest_slope_inf35=mask(SOC_current_forest_cut_cut, Forest_in_AS_pente_inf35)

# writeRaster(SOC_current_masked_forest_slope_inf35, "Path/to/working/directory/R/Export_data/Sustainableforest/SOC_current_masked_forest_slopes_inf35.tif")

### SOC in TOP preservation forest

SOC_actual_masked_forest_slope_inf35_top_preserv=mask(SOC_current_masked_forest_slope_inf35, Anomalies2100_in_WS_raster_forest_masked_top_pres)
# SOC_actual_masked_forest_slope_inf35_top_preserv@data@values=as.numeric(SOC_actual_masked_forest_slope_inf35_top_preserv@data@values)
boxplot(SOC_actual_masked_forest_slope_inf35_top_preserv)

sampleRandom(SOC_actual_masked_forest_slope_inf35_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_soc_pres=data.frame(SOC=sampleRandom(SOC_actual_masked_forest_slope_inf35_top_preserv$layer, 10000, na.rm=T, xy=F, sp=F), TOP=as.factor("Preservation"))

p=ggplot() + geom_violin(data=data_soc_pres, aes(y=SOC, x="Preservation"))
fx(p)

### SOC in TOP restoration forest

SOC_actual_masked_forest_slope_inf35_top_resto=mask(SOC_current_masked_forest_slope_inf35, Anomalies2100_in_WS_raster_forest_masked_top_resto)
# SOC_actual_masked_forest_slope_inf35_top_resto@data@values=as.numeric(SOC_actual_masked_forest_slope_inf35_top_resto@data@values)
boxplot(SOC_actual_masked_forest_slope_inf35_top_resto)

# sampleRandom(SOC_actual_masked_forest_slope_inf35_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto=data.frame(SOC= sampleRandom(SOC_actual_masked_forest_slope_inf35_top_resto$layer, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

p=ggplot() + geom_violin(data=data_soc_resto, aes(y=SOC, x="Restoration"))
fx(p)

### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_soc_resto[-which(data_soc_resto$SOC>10),],data_soc_pres[-which(data_soc_pres$SOC>10),]), aes(y=SOC, x=TOP))
fx(p)




# sample data in AS
SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
SOC_in_AS_rd=data.frame(SOC=sampleRandom(SOC_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_AS_rd)=c("SOC", "TOP")



# sample data in all forests
# SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
SOC_in_all_forest_rd=data.frame(SOC=sampleRandom(SOC_current_masked_forest_slope_inf35, 10^5, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_all_forest_rd)=c("SOC", "TOP")
SOC_in_all_forest_rd$TOP=as.factor(SOC_in_all_forest_rd$TOP)
summary(SOC_in_all_forest_rd$SOC)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.000   0.900   1.450   1.518   2.130  39.400 

## ANOVA
# AS: SOC_in_AS_rd/ forests: SOC_in_all_forest_rd
aov_soc_fm=aov(data=rbind(data_soc_resto,data_soc_pres,SOC_in_all_forest_rd), SOC~TOP)
anova(aov_soc_fm)
#  AS          Df Sum Sq Mean Sq F value    Pr(>F) 
# TOP           2     31 15.5319  3.5626 0.02838 *
# Forests
# TOP            2    269 134.387  34.446 1.109e-15 ***

TukeyHSD(aov_soc_fm)
# AS                          diff         lwr       upr     p adj
# Preservation=Restoration 0.035082 -0.034124445 0.1042885 0.4602807
# AS>Restoration           0.078668  0.009461556 0.1478745 0.0210734
# AS=Preservation          0.043586 -0.025620448 0.1127924 0.3024551
# Forests
# Preservation=Restoration 0.02629397 -0.127380998 0.1799689 0.9151854
# AS>Restoration           0.16689391  0.118341825 0.2154460 0.0000000
# AS=Preservation          0.14059994 -0.006666123 0.2878660 0.0650166

HSD_SP=HSD.test(aov_soc_fm, trt="TOP", group=T, alpha=0.05)
HSD_SP
# SOC groups
# AS           1.465694      a
# Preservation 1.422108     ab
# Restoration  1.387026      b

# Forests
# AS           1.518085      a
# Preservation 1.377485     ab
# Restoration  1.351191      b



### SOC in pres & resto
# AS: SOC_in_AS_rd/ forests: SOC_in_all_forest_rd
median_data <- rbind(data_soc_pres,data_soc_resto,SOC_in_all_forest_rd) %>%
  group_by(TOP) %>%
  summarize(median_soc = median(SOC)) %>% as.data.frame()


p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,SOC_in_all_forest_rd), aes(y=log10(SOC), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.7 ,label = c("ab", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = log10(median_soc), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/SOC" ,"/geom_violin_forest_log_SOC_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/SOC" ,"/geom_violin_forest_log_SOC_groups_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)



p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,data_soc_pres,data_soc_resto,SOC_in_all_forest_rd), aes(y=SOC, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=42 ,label = c("ab", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = median_soc, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/SOC" ,"/geom_violin_forest_SOC_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/SOC" ,"/geom_violin_forest_SOC_groups_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)



```


### Carbon potential

```{r carbon_pot_forest}
str(Carbon_saturation_cut_WGS84)



SOC_potential_forest_cut=crop(Carbon_saturation_cut_WGS84, Forest_in_AS_pente_inf35)
SOC_potential_forest_cut_cut=resample(SOC_potential_forest_cut, Forest_in_AS_pente_inf35,method = 'ngb')

SOC_potential_masked_forest_slope_inf35=mask(SOC_potential_forest_cut_cut, Forest_in_AS_pente_inf35)

# writeRaster(SOC_potential_masked_forest_slope_inf35, "Path/to/working/directory/R/Export_data/Sustainableforest/SOC_potential_masked_forest_slopes_inf35.tif")

### SOC in TOP preservation forest

SOC_potential_masked_forest_slope_inf35_top_preserv=mask(SOC_potential_masked_forest_slope_inf35, Anomalies2100_in_WS_raster_forest_masked_top_pres)
# SOC_potential_masked_forest_slope_inf35_top_preserv@data@values=as.numeric(SOC_potential_masked_forest_slope_inf35_top_preserv@data@values)
boxplot(SOC_potential_masked_forest_slope_inf35_top_preserv)

sampleRandom(SOC_potential_masked_forest_slope_inf35_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_sop_pres=data.frame(SOP=sampleRandom(SOC_potential_masked_forest_slope_inf35_top_preserv$layer, 10000, na.rm=T, xy=F, sp=F), TOP=as.factor("Preservation"))

p=ggplot() + geom_violin(data=data_sop_pres, aes(y=SOC, x="Preservation"))
fx(p)

### SOC in TOP restoration forest

SOC_potential_masked_forest_slope_inf35_top_resto=mask(SOC_potential_masked_forest_slope_inf35, Anomalies2100_in_WS_raster_forest_masked_top_resto)
# SOC_potential_masked_forest_slope_inf35_top_resto@data@values=as.numeric(SOC_potential_masked_forest_slope_inf35_top_resto@data@values)
boxplot(SOC_potential_masked_forest_slope_inf35_top_resto)

# sampleRandom(SOC_potential_masked_forest_slope_inf35_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_sop_resto=data.frame(SOP= sampleRandom(SOC_potential_masked_forest_slope_inf35_top_resto$layer, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

p=ggplot() + geom_violin(data=data_sop_resto, aes(y=SOC, x="Restoration"))
fx(p)

### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_sop_resto,data_sop_pres), aes(y=SOC, x=TOP))
fx(p)




# sample data in AS
SOP_in_AS=mask(Carbon_saturation_cut_WGS84, AS_fusion_WGS84)
SOP_in_AS_rd=data.frame(SOP=sampleRandom(SOP_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_AS_rd)=c("SOP", "TOP")



# sample data in croplands
Forest_in_AS_pente_inf35_cut=crop(Forest_in_AS_pente_inf35, Carbon_saturation_cut_WGS84)
Forest_in_AS_pente_inf35_cut_resample=resample(Forest_in_AS_pente_inf35_cut, Carbon_saturation_cut_WGS84, method = 'ngb')
SOP_in_forest=mask(Carbon_saturation_cut_WGS84, Forest_in_AS_pente_inf35_cut_resample)
summary(SOP_in_forest)

SOP_in_forest_rd=data.frame(SOP=sampleRandom(SOP_in_forest, 10^5, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_forest_rd)=c("SOP", "TOP")


## ANOVA
# AS: SOP_in_AS_rd / forests: SOP_in_forest_rd
aov_sop_fm=aov(data=rbind(data_sop_resto,data_sop_pres,SOP_in_forest_rd), SOP~TOP)
anova(aov_sop_fm)
# AS            Df  Sum Sq Mean Sq F value    Pr(>F)   
# TOP           2 100.13  50.067    2059 < 2.2e-16
# Forests
# TOP           2    5.6 2.80096  320.55 < 2.2e-16 ***

TukeyHSD(aov_sop_fm)
# AS                        diff           lwr         upr     p adj
# Preservation>Restoration  0.009520345  0.004351818  0.01468887 4.7e-05
# AS<Restoration           -0.117518291 -0.122686818 -0.11234976 0.0e+00
# AS<Preservation          -0.127038636 -0.132207163 -0.12187011 0.0e+00
# Forests
# Preservation>Restoration 0.009520345 0.006422035 0.01261865     0
# AS>Restoration           0.022336396 0.020038627 0.02463416     0
# AS>Preservation          0.012816051 0.010518282 0.01511382     0


HSD_SP=HSD.test(aov_sop_fm, trt="TOP", group=T, alpha=0.05)
HSD_SP
# AS                 SOP groups
# Preservation 0.9540650      a
# Restoration  0.9445446      b
# AS           0.8270263      c
# Forests
# AS           0.9668810      a
# Preservation 0.9540650      b
# Restoration  0.9445446      c




### SOC in pres & resto
# AS: SOP_in_AS_rd/ forests: SOP_in_forest_rd
median_data <- rbind(data_sop_pres,data_sop_resto,SOP_in_forest_rd) %>%
  group_by(TOP) %>%
  summarize(median_sop = median(SOP)) %>% as.data.frame()


p=ggplot() + geom_violin(data=rbind(data_sop_pres,data_sop_resto,SOP_in_forest_rd), aes(y=SOP, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.05 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = (median_sop), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)

# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/SOP" ,"/geom_violin_forest_SOP_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/SOP" ,"/geom_violin_forest_SOP_groups_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)






```





### mixed forest

```{r mixed forest}
# <10% BD & <10% CF => 0 (no trees)
# >10% BD & <10% CF => 1 (broadleaves)
# <10% BD & >10% CF => 2 (coniferous)
# >10% BD & >10% CF => 3 (mixed)

Forest_mixed_in_AS=Forest_in_AS_pente_inf35

BCD_WGS84=raster("Path/to/working/directory/Scenarios/CCA/LULC/Copernicus_expert_product/Forest_copernicus/BCD_Broadleaves_Cover_Density_2018_100m_eu_03035_V1_0/BCD_2018_crop_AS_WGS84.tif")

res(BCD_WGS84)
res(Forest_mixed_in_AS)
BCD_WGS84_resampled=resample(BCD_WGS84, Forest_in_AS_pente_inf35, method="ngb")


CCD_WGS84=raster("Path/to/working/directory/Scenarios/CCA/LULC/Copernicus_expert_product/Forest_copernicus/CCD_Conifers_Cover_Density_2018_100m_eu_03035_V1_0/CCD_2018_crop_AS_WGS84.tif")
res(CCD_WGS84)
res(Forest_mixed_in_AS)
CCD_WGS84_resampled=resample(CCD_WGS84, Forest_in_AS_pente_inf35, method="ngb")

Forest_mixed_in_AS[which(BCD_WGS84_resampled@data@values<10 & CCD_WGS84_resampled@data@values<10)]=0
Forest_mixed_in_AS[which(BCD_WGS84_resampled@data@values>=10 & CCD_WGS84_resampled@data@values<=10)]=1
Forest_mixed_in_AS[which(BCD_WGS84_resampled@data@values<=10 & CCD_WGS84_resampled@data@values>=10)]=2
Forest_mixed_in_AS[which(BCD_WGS84_resampled@data@values>=10 & CCD_WGS84_resampled@data@values>=10)]=3


Forest_mixed_in_AS=mask(Forest_mixed_in_AS, Forest_in_AS_pente_inf35)
writeRaster(Forest_mixed_in_AS, "Path/to/working/directory/R/Export_data/Sustainableforest/Type_of_forest_compo_in_AS_slopes_inf35.tif")


### Forest compo in top preserv
Forest_mixed_in_AS_top_preserv=mask(Forest_mixed_in_AS, Anomalies2100_in_WS_raster_forest_masked_top_pres)

boxplot(Forest_mixed_in_AS_top_preserv)

# sampleRandom(Forest_mixed_in_AS_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_soc_pres=data.frame(ForestType=sampleRandom(Forest_mixed_in_AS_top_preserv, 10000, na.rm=T, xy=F, sp=F), TOP=as.factor("Preservation"))
colnames(data_soc_pres)=c("ForestType", "TOP")

data_soc_pres$ForestType=as.factor(data_soc_pres$ForestType)
data_soc_pres_df=summary(data_soc_pres$ForestType)
data_soc_pres_df=as.data.frame(data_soc_pres_df)
data_soc_pres_df$ForestType=as.factor(rownames(data_soc_pres_df))
data_soc_pres_df$data_soc_pres_df_prop=100*data_soc_pres_df$data_soc_pres_df/sum(data_soc_pres_df$data_soc_pres_df)


p=ggplot() + geom_bar(data=data_soc_pres_df, aes(fill=ForestType, x="Preservation", y=data_soc_pres_df), stat ='identity')
fx(p)




### Forest compo in top resto

Forest_mixed_in_AS_top_resto=mask(Forest_mixed_in_AS, Anomalies2100_in_WS_raster_forest_masked_top_resto)
# SOC_actual_masked_forest_slope_inf35_top_resto@data@values=as.numeric(SOC_actual_masked_forest_slope_inf35_top_resto@data@values)
boxplot(Forest_mixed_in_AS_top_resto)


data_soc_resto=data.frame(ForestType=sampleRandom(Forest_mixed_in_AS_top_resto, 10000, na.rm=T, xy=F, sp=F), TOP=as.factor("Restoration"))
colnames(data_soc_resto)=c("ForestType", "TOP")

data_soc_resto$ForestType=as.factor(data_soc_resto$ForestType)
data_soc_resto_df=summary(data_soc_resto$ForestType)
data_soc_resto_df=as.data.frame(data_soc_resto_df)
data_soc_resto_df$ForestType=as.factor(rownames(data_soc_resto_df))
data_soc_resto_df$data_soc_resto_df_prop=100*data_soc_resto_df$data_soc_resto_df/sum(data_soc_resto_df$data_soc_resto_df)

p=ggplot() + geom_bar(data=data_soc_resto_df, aes(fill=ForestType, x="Restoration", y=data_soc_resto_df), stat ='identity')
fx(p)

### Forest compo in both preserv and resto

p=ggplot() +
  geom_bar(data=data_soc_pres_df, aes(fill=ForestType, x="Preservation", y=data_soc_pres_df_prop), stat ='identity') +
  geom_bar(data=data_soc_resto_df, aes(fill=ForestType, x="Restoration", y=data_soc_resto_df_prop), stat ='identity')
fx(p)


### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_soc_resto[-which(data_soc_resto$SOC>10),],data_soc_pres[-which(data_soc_pres$SOC>10),]), aes(y=SOC, x=TOP))
fx(p)



```





### NCP in forest priority

```{r ncp_forest}

## Done with QGIS: join NCP values (AlpES layer) to priority areas shapefile

## Restoration priority area for sustainable forest
Top_resto_FM=shapefile("Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies2100_in_WS_forest_masked_AS_vector_TOP_resto_NCP_WGS84.shp")

if (T %in% is.na(Top_resto_FM$A_3)){
  print('yes')
  Top_resto_FM=Top_resto_FM[-which(is.na(Top_resto_FM$A_3)),]
}


Top_resto_FM_df=Top_resto_FM@data
summary(Top_resto_FM_df)
Top_resto_FM_df=Top_resto_FM_df[,1:27]

Top_resto_FM_df$DN=as.numeric(Top_resto_FM_df$DN)
# quantile(as.numeric(Top_resto_FM_df$DN))
Top_resto_FM_df=Top_resto_FM_df[which(Top_resto_FM_df$DN<=quantile(Top_resto_FM_df$DN, 0.5)),]

# Top_resto_FM_df=Top_resto_FM_df[,-grep("NCP_Code_1", colnames(Top_resto_FM_df))]
Top_resto_FM_df$TOP=as.factor("Restoration")
# Top_resto_FM_df=Top_resto_FM_df[-which(is.na(Top_resto_FM_df$A_3)),]
# rownames(Top_resto_FM_df)=Top_resto_FM_df$fid


# Preservation priority area for Sylvopasto
Top_preserv_FM=shapefile("Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies2100_in_WS_forest_masked_AS_vector_TOP_preserv_NCP_WGS84.shp")

if (T %in% is.na(Top_preserv_FM$A_3)){
  print('yes')
  Top_preserv_FM=Top_preserv_FM[-which(is.na(Top_preserv_FM$A_3)),]
}


Top_preserv_FM_df=Top_preserv_FM@data
colnames(Top_preserv_FM_df)
Top_preserv_FM_df=Top_preserv_FM_df[,-c(4:8)]

Top_preserv_FM_df$DN=as.numeric(Top_preserv_FM_df$DN)
quantile((Top_preserv_FM_df$DN))
Top_preserv_FM_df=Top_preserv_FM_df[which(Top_preserv_FM_df$DN>=quantile(Top_preserv_FM_df$DN, 0.5)),]
nrow(Top_preserv_FM_df)

Top_preserv_FM_df$TOP=as.factor("Preservation")

ncol(Top_resto_FM_df)==ncol(Top_preserv_FM_df)
colnames(Top_preserv_FM_df)=colnames(Top_resto_FM_df)
# rownames(Top_preserv_FM_df)=Top_preserv_FM_df$fid
# Top_preserv_FM_df=Top_preserv_FM_df[-which(is.na(Top_preserv_FM_df$A_3)),]

Top_df_FM=rbind(Top_resto_FM_df, Top_preserv_FM_df)
colnames(Top_df_FM)
Top_df_FM=Top_df_FM[,-c(1:4, 26)]
colnames(Top_df_FM)
# Top_df_FM=Top_df_FM[-is.na(Top_df_FM$A_3),]

# p=ggplot()
for (i in 1:(ncol(Top_df_FM)-1)){
  # p=p+geom_violin(aes(x=as.character(colnames(Top_df_FM)[i]),y=Top_df_FM[,i], fill=Top_df_FM$TOP))
  p=ggplot()+geom_violin(aes(x=as.character(colnames(Top_df_FM)[i]),y=Top_df_FM[,i], fill=Top_df_FM$TOP))
  fx(p)
}
# fx(p)

data_ncp_mean=Top_df_FM[1:2,-ncol(Top_df_FM)]
data_ncp_mean[1,]=apply(Top_df_FM[which(Top_df_FM$TOP=="Restoration"),-ncol(Top_df_FM)], 2, FUN="mean", na.rm=T)
data_ncp_mean[2,]=apply(Top_df_FM[which(Top_df_FM$TOP=="Preservation"),-ncol(Top_df_FM)], 2, FUN="mean", na.rm=T)
data_ncp_mean[3,]=apply(Top_df_FM[,-ncol(Top_df_FM)], 2, FUN="min", na.rm=T)
data_ncp_mean[4,]=apply(Top_df_FM[,-ncol(Top_df_FM)], 2, FUN="max", na.rm=T)

data_ncp_mean$TOP=c("Restoration","Preservation","Min","Max")



str(data_ncp_mean)


# x11()+par(mfrow=c(1,2))
radarchart(data_ncp_mean[c(4,3,1),-ncol(data_ncp_mean)], maxmin = T)
radarchart(data_ncp_mean[c(4,3,2),-ncol(data_ncp_mean)], maxmin = T)




```






### Clustering Forest NCP

```{r clustering_forest_ncp}

for (i in 1:(ncol(Top_df_FM)-1)){
  print(nrow(Top_df_FM[is.na(Top_df_FM[,i]),]))
}
# Top_df_FM=Top_df_FM[-which(is.na(Top_df_FM$A_3)),]

Top_df_FM$A_2p1=Top_df_FM$A_2/(Top_df_FM$A_1+1)
Top_df_FM$B_2p1=Top_df_FM$B_2/(Top_df_FM$B_1+1)
Top_df_FM$C_2p1=Top_df_FM$C_2/(Top_df_FM$C_1+1)
# Top_df_FM$D_1_2
Top_df_FM$E_2p1=Top_df_FM$E_2/(Top_df_FM$E_1+1)
# Top_df_FM$F_1_2
Top_df_FM$G_2p1=Top_df_FM$G_2/(Top_df_FM$G_1+1)
Top_df_FM$H_2p1=Top_df_FM$H_2/(Top_df_FM$H_1+1)

str(Top_df_FM)
colnames(Top_df_FM)[23]
pca.agrof=PCA(Top_df_FM, graph=F, quali.sup = 23)

pca.var=pca.agrof$var
pca.ind=pca.agrof$ind

plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,3))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(2,3))

plot(pca.agrof,
     invisible = c("var", "ind"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))

plot(pca.agrof,
     invisible = c("ind", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))



# with cos2
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,2)
            # invisible=c("quali.sup"),
            )
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,3)
            # invisible=c("quali.sup"),
            )


eig.val <- pca.agrof$eig
barplot(eig.val[, 2], 
        names.arg = 1:nrow(eig.val), 
        main = "Variances Explained by Dimensions (%)",
        xlab = "Principal Dimensions",
        ylab = "Percentage of variances",
        col ="steelblue")
# Add connected line segments to the plot
lines(x = 1:nrow(eig.val), eig.val[, 2], 
      type = "b", pch = 19, col = "red")



##### Clustering
################ Try to get 
# clust.agrof3=HCPC(PCA(Top_df_FM[sample(x=1:nrow(Top_df_FM), size=nrow(Top_df_FM)/2),-c(23:ncol(Top_df_FM))], graph=F), metric="euclidean", nb.clust=3)
# 
# center_clusters=matrix(nrow=5, ncol=3)
# for (j in 1:3){
# for (i in 1:5){
#   center_clusters[i,j]=mean(clust.agrof3$call$X[which(clust.agrof3$call$X$clust==j),i], na.rm=T)
# }}
# center_clusters=t(center_clusters)
# center_clusters=as.data.frame(center_clusters)
# colnames(center_clusters)=colnames(pca.fm$ind$coord)
# 
# pca.fm=PCA(Top_df_FM[,-c(23:ncol(Top_df_FM))], graph=F)
# coordinates.pca.fm <- pca.fm$ind$coord
# 
# 
# distances <- dist(rbind(pca.fm$ind$coord, center_clusters))
# 
# predicted_clusters <- cutree(distances, nrow(pca.fm$ind$coord))
#################

### All data
clust.agrof3=HCPC(PCA(Top_df_FM[,-c(23:ncol(Top_df_FM))], graph=F), metric="euclidean", nb.clust=3)

### In two part:
# clust.agrof3_1=HCPC(PCA(Top_df_FM[1:(nrow(Top_df_FM)/2),-c(23:ncol(Top_df_FM))], graph=F), metric="euclidean", nb.clust=3)
# clust.agrof3_2=HCPC(PCA(Top_df_FM[((nrow(Top_df_FM)/2)+1):(nrow(Top_df_FM)),-c(23:ncol(Top_df_FM))], graph=F), metric="euclidean", nb.clust=3)

fviz_cluster(clust.agrof3,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = FALSE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
             )

plot(clust.agrof3, choice = "3D.map")

#test khi2
clust.agrof3$desc.var$test.chi2[which(as.integer(clust.agrof3$desc.var$test.chi2)<0.1),]

clust.agrof3$desc.var$category
######################
#######  C1  #########
######################
agrof.clust1=as.data.frame(clust.agrof3$desc.var$quanti$`1`)
agrof.clust1$Levers=rownames(agrof.clust1)
agrof.clust1$Signif=0
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test<0))]=-1
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test>0))]=1
agrof.clust1$Signif=as.factor(agrof.clust1$Signif)
agrof.clust1$diff_mean=agrof.clust1$`Mean in category`-agrof.clust1$`Overall mean`

#  B_1, B_2, B_3, C_1, D_1_2, D_3, F_1_2 
# Grassland SFD, wood production (Cseq), walter fitration and demand

######################
#######  C2  #########
######################
agrof.clust2=as.data.frame(clust.agrof3$desc.var$quanti$`2`)
agrof.clust2$Levers=rownames(agrof.clust2)
agrof.clust2$Signif=0
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test<0))]=-1
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test>0))]=1
agrof.clust2$Signif=as.factor(agrof.clust2$Signif)
agrof.clust2$diff_mean=agrof.clust2$`Mean in category`-agrof.clust2$`Overall mean`

#  A_1, C_2_for,C_2,E_1, E_3, E_2, G_1, G_2, H_1,H_2,
# Water supply, Wood use, protecive forest SFD, outdoor supply and use, BD supply and use


######################
#######  C3  #########
######################
agrof.clust3=as.data.frame(clust.agrof3$desc.var$quanti$`3`)
agrof.clust3$Levers=rownames(agrof.clust3)
agrof.clust3$Signif=0
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test<0))]=-1
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test>0))]=1
agrof.clust3$Signif=as.factor(agrof.clust3$Signif)
agrof.clust3$diff_mean=agrof.clust3$`Mean in category`-agrof.clust3$`Overall mean`

# A_1, A_2, A_3, C_2, C_2for  C_3,F_3, G_1,G_2,G_3,   H_2,
# High water SFD, forest use and demand (Cseq), outdoor SFD, BD use


### Summary:
# C1: Grassland SFD, wood production (Cseq), walter fitration and demand

# C2: Water supply, Wood use, protecive forest SFD, outdoor supply and use, BD supply and use

# C3: High water SFD, forest use and demand (Cseq), outdoor SFD, BD use

### Export shp with clusters
## For restoration
Top_resto_FM$DN=as.numeric(Top_resto_FM$DN)
Top_resto_FM_50=Top_resto_FM[which(!is.na(Top_resto_FM$A_3) & Top_resto_FM$DN<=quantile(as.numeric(Top_resto_FM$DN), 0.5)),]


nrow(Top_resto_FM_50)+nrow(Top_preserv_FM_50)==nrow(clust.agrof3$data.clust)
Top_resto_FM_50$cluster=NA


# Top_df_FM=rbind(Top_resto_FM_df, Top_preserv_FM_df)
Top_resto_FM_50$cluster=clust.agrof3$data.clust$clust[1:nrow(Top_resto_FM_50@data)]


summary(as.factor(Top_resto_FM_50$cluster))
p=spplot(Top_resto_FM_50, zcol=c("cluster"))

# shapefile(Top_resto_FM_50, "Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies_forest_TOP50_resto_NCP_clust_WGS84.shp")

## For preservation
Top_preserv_FM_df=Top_preserv_FM_df[which(Top_preserv_FM_df$DN>=quantile(Top_preserv_FM_df$DN, 0.5)),]
Top_preserv_FM_50=Top_preserv_FM[which(!is.na(Top_preserv_FM$A_3) & Top_preserv_FM$DN>=quantile(as.numeric(Top_preserv_FM$DN), 0.5)),]
Top_preserv_FM_50$cluster=NA
Top_preserv_FM_50$cluster=clust.agrof3$data.clust$clust[(nrow(Top_resto_FM_50@data)+1):nrow(clust.agrof3$data.clust)]


summary(as.factor(Top_preserv_FM_50$cluster))
p=spplot(Top_preserv_FM, zcol=c("cluster"))


### Export in shp


# shapefile(Top_preserv_FM_50, "Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies_forest_TOP50_preserv_NCP_clust_WGS84.shp")


### Radarchart of NCP for each clusters ??


data_ncp_mean=rbind(Top_preserv_FM_50@data[,-c(1:9)], Top_resto_FM_50@data[,-c(1:4)])
data_radar=data_ncp_mean[1:5,-ncol(data_ncp_mean)]
data_radar[1,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="max")
data_radar[2,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="min")

data_radar[3,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==1),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[4,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==2),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[5,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==3),-ncol(data_ncp_mean)], 2, FUN="mean")


data_radar$TOP=c("Max", "Min", "C1","C2", "C3")

# 
# color_border_hexadec=c("#b200f8", "#5dbdfc", "#71daa7")
colors_border=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255))
colors_in=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.4*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.4*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.4*255))

colnames(data_radar)[22]
# radarchart(data_radar[3:5,-c(22,ncol(data_radar))], maxmin = F,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

radarchart(data_radar[,-c(22,ncol(data_radar))], maxmin = T,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

legend(x="right", y=1, legend = c("C1", "C2", "C3"),col=colors_border, bty = "n", pch=20 , text.col = "black", cex=0.9, pt.cex=1.6)

### Need to remove C2_for

radarchart(data_radar[,-c(22,23,ncol(data_radar))], maxmin = T,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

legend(x="right", y=1, legend = c("C1", "C2", "C3"),col=colors_border, bty = "n", pch=20 , text.col = "black", cex=0.9, pt.cex=1.6)

# without variables

radarchart(data_radar[,-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")

# with color of clusters
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") # 0, 1, 2, 3, 4, 5
# 1:
# 2:
# 3:
# 4:
# 5:

color_clusters=palette.colors(palette="Set2")
Hillsides_out= rgb(102, 194, 165, maxColorValue = 255)
Hillsides_in= rgb(102, 194, 165, maxColorValue = 255, alpha=0.4*255)
Populated_out= rgb(252, 141, 98, maxColorValue = 255)
Populated_in= rgb(252, 141, 98, maxColorValue = 255, alpha=0.4*255)
Touristic_out= rgb(141, 160, 203, maxColorValue = 255)
Touristic_in= rgb(141, 160, 203, maxColorValue = 255, alpha=0.4*255)
Productive_out=rgb(231, 138, 195, maxColorValue = 255)
Productive_in=rgb(231, 138, 195, maxColorValue = 255, alpha=0.4*255)
Rural_out= rgb(166, 216, 84, maxColorValue = 255)
Rural_in= rgb(166, 216, 84, maxColorValue = 255, alpha=0.4*255)
# Rural_out=rgb(255, 217, 47, maxColorValue = 255)
# Rural_in=rgb(255, 217, 47, maxColorValue = 255, alpha=0.4*255)

color_forest_out=c(Rural_out, Hillsides_out, Touristic_out)
color_forest_in=c(Rural_in, Hillsides_in, Touristic_in)

radarchart(data_radar[,-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=color_forest_out , pfcol=color_forest_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")

```



### Prop clusters

```{r prop_clusters_forests}
colnames(Top_preserv_FM_50@data)
raster::area(Top_preserv_FM_50@data$Area_Ha)
colnames(Top_resto_FM_50@data)

Area_resto=data.frame(i=Top_resto_FM_50$fid, area=NA)
for (i in 1:nrow(Top_resto_FM_50@data)){
  Area_resto$area[i]=raster::area(Top_resto_FM_50[i,])
  
}

sum(Area_resto$area[which(Top_resto_FM_50$cluster==1)])

data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Top_preserv_FM_50@data$Area_Fore[which(Top_preserv_FM_50@data$cluster==i)], na.rm=T), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Top_resto_FM_50@data$Area_Fore[which(Top_resto_FM_50@data$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)

data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)

# khi2
khi_prop_clust=cbind(data_prop_clust$Area[1:3], data_prop_clust$Area[4:6])
khi_prop_clust_test=chisq.test(khi_prop_clust) # p-value < 2.2e-16
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("1", "2", "3")
100*khi_prop_clust_res/sum(khi_prop_clust_res) # Resto-1 and Resto-3 != others
#  Preservation Restoration
# 1    11.780291   10.959560
# 2    31.705381   29.496475
# 3     8.318936    7.739357
# > 10 => significant


# plot


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))
 

### Test with new area calculated
Area_preserv=data.frame(i=Top_preserv_FM_50$fid, area=NA)
for (i in 1:nrow(Top_preserv_FM_50@data)){
  Area_preserv$area[i]=raster::area(Top_preserv_FM_50[i,])
  
}

Area_resto=data.frame(i=Top_resto_FM_50$fid, area=NA)
for (i in 1:nrow(Top_resto_FM_50@data)){
  Area_resto$area[i]=raster::area(Top_resto_FM_50[i,])
  
}



data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Area_preserv$area[which(Top_preserv_FM_50$cluster==i)]), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Area_resto$area[which(Top_resto_FM_50$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)


data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


### With cluster colors
p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') +
  scale_fill_manual(values=color_forest_out) +theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())
  
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/Clusters" ,"/geom_bar_prop_NCP_clusters_forest", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


```



### Distrib elevation

```{r elevation_forests}

### in function of elevation

Top_resto_FM$Elev=NA
for (i in 1:nrow(Top_resto_FM@data)){
  Top_resto_FM$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_resto_FM[i,], fun=mean, na.rm=T)
}
Top_resto_FM$TOP="Restoration"

Top_preserv_FM$Elev=NA
for (i in 1:nrow(Top_preserv_FM@data)){
  Top_preserv_FM$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_preserv_FM[i,], fun=mean, na.rm=T)
}
Top_preserv_FM$TOP="Preservation"

summary(Top_resto_FM$Elev)
summary(Top_preserv_FM$Elev)





# random data in AS
Elev_in_AS=mask(Elevation_cut_WGS84, AS_fusion_WGS84)
Elev_in_AS_rd=data.frame(Elev=sampleRandom(Elev_in_AS, 10000, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_AS_rd)=c("Elev", "TOP")  


# Elev in forests
Forest_in_AS_pente_inf35_cut=crop(Forest_in_AS_pente_inf35_cut_resample, Elevation_cut_WGS84)
Forest_in_AS_pente_inf35_cut_resample=resample(Forest_in_AS_pente_inf35_cut, Elevation_cut_WGS84, method = 'ngb')
Elev_in_forest=mask(Elevation_cut_WGS84, Forest_in_AS_pente_inf35_cut_resample)
summary(Elev_in_forest)

length(Elev_in_forest@data@values[-which(is.na(Elev_in_forest@data@values))]) # 291799
Elev_in_forest_rd=data.frame(Elev=sampleRandom(Elev_in_forest, 10^5, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_forest_rd)=c("Elev", "TOP")  
Elev_in_forest_rd$TOP=as.factor(Elev_in_forest_rd$TOP)  

## ANOVA  
#AS: Elev_in_AS_rd / forests: Elev_in_forest_rd
aov_elev_fm=aov(data=rbind(Top_preserv_FM@data[,c(33,34)], Top_resto_FM@data[,c(28,29)], Elev_in_forest_rd), Elev~TOP)
anova(aov_elev_fm)

#  AS           Df     Sum Sq    Mean Sq F value    Pr(>F)    
# TOP           2  879352244 439676122  1993.6 < 2.2e-16 ***
# Forests
# TOP            2 2.5991e+09 1299525844  6710.4 < 2.2e-16 ***

TukeyHSD(aov_elev_fm)
# AS                              diff       lwr       upr      p adj
# Preservation < AS          -256.4312 -270.8439 -242.0185     0
# Restoration < AS           -394.7218 -409.4696 -379.9739     0
# Restoration < Preservation -138.2906 -151.8162 -124.7649     0
# Forests
# Preservation < AS          -277.7707 -287.0804 -268.4611     0
# Restoration < AS           -416.0613 -425.8210 -406.3016     0
# Restoration < Preservation -138.2906 -150.9651 -125.6160     0

HSD_SP=HSD.test(aov_elev_fm, trt="TOP", group=T, alpha=0.05)
HSD_SP
# AS              Elev groups
# AS           827.2287      a
# Preservation 570.7975      b
# Restoration  432.5069      c
# Forests
# AS           848.5683      a
# Preservation 570.7975      b
# Restoration  432.5069      c


median_data <- rbind(Top_preserv_FM@data[,c(33,34)], Top_resto_FM@data[,c(28,29)], Elev_in_forest_rd) %>%
  group_by(TOP) %>%
  summarize(median_elev = median(Elev, na.rm=T)) %>% as.data.frame()

data_elev_bind=rbind(Top_preserv_FM@data[,c(33,34)], Top_resto_FM@data[,c(28,29)], Elev_in_forest_rd)
data_elev_bind$TOP=factor(data_elev_bind$TOP, ordered=T, levels=c( "Preservation", "Restoration", "AS"))
## PLOT
p=ggplot() + 
  geom_violin(data=data_elev_bind, aes(x=TOP, y=Elev, fill=TOP))+
  scale_fill_manual(values=c( rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
              )) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS" ), y=4000 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)


ggsave(plot=p, filename = paste(dossier_fm, "/Figure/Elev" ,"/geom_violin_forest_Elev_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/Elev" ,"/geom_violin_forest_Elev_groups_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

### Plot without AS but with std ylim

p=ggplot() + 
  geom_violin(data=rbind(Top_preserv_FM@data[,c(33,34)], Top_resto_FM@data[,c(28,29)]), aes(x=TOP, y=Elev, fill=TOP))+ ylim(0,4000)+
  scale_fill_manual(values=c(
    rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255)
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               # rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)
                   )) +
  geom_text(aes(x=c("Preservation", "Restoration"), y=4000 ,label = c("a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit")) +
  geom_point(data =median_data[-1,] , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/Elev" ,"/geom_violin_forest_Elev_without_AS_groups_forests", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

```



### In protected area

```{r forest_top_in_pa}
## done in QGIS: join protected area attribute (layer WDPA) to priority areas shapefile

################ RESTORATION

# Top_resto_FM_50_PA=shapefile("Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies_forest_TOP50_resto_NCP_clust_WDPA_WGS84.shp")

levels(as.factor(Top_resto_FM_50_PA@data$IUCN_CAT))
# [1] "Ia"             "Ib"             "II"            
#  [4] "III"            "IV"             "Not Applicable"
#  [7] "Not Assigned"   "Not Reported"   "V"             
# [10] "VI" 
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="Ia")]=1
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="Ib")]=1
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="II")]=2
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="III")]=3
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="IV")]=4
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="V")]=5
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="VI")]=6
Top_resto_FM_50_PA@data$IUCN_CAT[which(is.na(Top_resto_FM_50_PA@data$IUCN_CAT))]=0
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="Not Applicable")]=NA
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="Not Assigned")]=NA
Top_resto_FM_50_PA@data$IUCN_CAT[which(Top_resto_FM_50_PA@data$IUCN_CAT=="Not Reported")]=NA
Top_resto_FM_50_PA@data$IUCN_CAT=as.factor(Top_resto_FM_50_PA@data$IUCN_CAT)

### Previous plot
# Top_resto_FM_50_PA_df=as.data.frame(summary(Top_resto_FM_50_PA@data$IUCN_CAT))
# colnames(Top_resto_FM_50_PA_df)=c("nb")
# # Top_resto_FM_50_PA_df=t(Top_resto_FM_50_PA_df)
# p=ggplot(Top_resto_FM_50_PA_df) + geom_bar(aes(x="Restoration", y=nb, fill=rownames(Top_resto_FM_50_PA_df)), stat="identity")
###

Top_resto_FM_50_PA_df=Top_resto_FM_50_PA@data

Top_resto_FM_50_PA_df$IUCN_CAT=as.integer(Top_resto_FM_50_PA_df$IUCN_CAT)

levels_fid=levels(as.factor(Top_resto_FM_50_PA_df$fid))

for (i in 1:nlevels(as.factor(Top_resto_FM_50_PA_df$fid))){
  print(i)
  print(nrow(Top_resto_FM_50_PA_df))
  print(Top_resto_FM_50_PA_df$IUCN_CAT[which(Top_resto_FM_50_PA_df$fid==levels_fid[i])])
  if (nrow(Top_resto_FM_50_PA_df[which(Top_resto_FM_50_PA_df$fid==levels_fid[i]),])>1){
    
    data_sans_0=Top_resto_FM_50_PA_df$IUCN_CAT[which(Top_resto_FM_50_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    
    if ((T %in% !is.na(data_sans_0))==F){
      Top_resto_FM_50_PA_df=Top_resto_FM_50_PA_df[-grep(levels_fid[i], Top_resto_FM_50_PA_df$fid)[1],]
    }
    if (F %in% is.na(data_sans_0)){
      
      if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
    
      min_level=min(data_sans_0, na.rm=T)
   
    
       Top_resto_FM_50_PA_df=Top_resto_FM_50_PA_df[-which(Top_resto_FM_50_PA_df$fid==levels_fid[i] & (is.na(Top_resto_FM_50_PA_df$IUCN_CAT) | Top_resto_FM_50_PA_df$IUCN_CAT != min_level)),]
    }
    
    
    
      if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
        Top_resto_FM_50_PA_df=Top_resto_FM_50_PA_df[-grep(levels_fid[i], Top_resto_FM_50_PA_df$fid)[-1],]
    }
    }
     
  }
  
}



Top_resto_FM_PA_sum=as.data.frame(summary(as.factor(Top_resto_FM_50_PA_df$IUCN_CAT)))
colnames(Top_resto_FM_PA_sum)=c("nb")
### I think (but I am not sure) that I need to change the rownames to correspon to 0 = no PA
rownames(Top_resto_FM_PA_sum)=c(0:6,"Not Categorised")

# Top_resto_SP_PA_sum=t(Top_resto_SP_PA_sum)
p=ggplot(Top_resto_FM_PA_sum) + geom_bar(aes(x="Restoration", y=nb, fill=rownames(Top_resto_FM_PA_sum)), stat="identity")

################ PRESERV


# Top_preserv_FM_50_PA=shapefile("Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies_forest_TOP50_preserv_NCP_clust_WDPA_WGS84.shp")

levels(as.factor(Top_preserv_FM_50_PA@data$IUCN_CAT))
# [1] "II"           "IV"           "Not Assigned" "Not Reported"
# [5] "V" 
Top_preserv_FM_50_PA@data$IUCN_CAT[which(Top_preserv_FM_50_PA@data$IUCN_CAT=="II")]=2

Top_preserv_FM_50_PA@data$IUCN_CAT[which(Top_preserv_FM_50_PA@data$IUCN_CAT=="IV")]=4
Top_preserv_FM_50_PA@data$IUCN_CAT[which(Top_preserv_FM_50_PA@data$IUCN_CAT=="V")]=5

Top_preserv_FM_50_PA@data$IUCN_CAT[which(is.na(Top_preserv_FM_50_PA@data$IUCN_CAT))]=0

Top_preserv_FM_50_PA@data$IUCN_CAT[which(Top_preserv_FM_50_PA@data$IUCN_CAT=="Not Assigned")]=NA
Top_preserv_FM_50_PA@data$IUCN_CAT[which(Top_preserv_FM_50_PA@data$IUCN_CAT=="Not Reported")]=NA

Top_preserv_FM_50_PA@data$IUCN_CAT=as.factor(Top_preserv_FM_50_PA@data$IUCN_CAT)

### Previous plot
# Top_preserv_FM_50_PA_df=as.data.frame(summary(Top_preserv_FM_50_PA@data$IUCN_CAT))
# colnames(Top_preserv_FM_50_PA_df)=c("nb")
# # Top_preserv_FM_50_PA_df=t(Top_preserv_FM_50_PA_df)
# p=ggplot(Top_preserv_FM_50_PA_df) + geom_bar(aes(x="Preservation", y=nb, fill=rownames(Top_preserv_FM_50_PA_df)), stat="identity")
####
Top_preserv_FM_50_PA_df=Top_preserv_FM_50_PA@data
Top_preserv_FM_50_PA_df$IUCN_CAT=as.integer(Top_preserv_FM_50_PA_df$IUCN_CAT)




levels_fid=levels(as.factor(Top_preserv_FM_50_PA_df$fid))

for (i in 1:nlevels(as.factor(Top_preserv_FM_50_PA_df$fid))){
  print(i)
  print(nrow(Top_preserv_FM_50_PA_df))
  print(Top_preserv_FM_50_PA_df$IUCN_CAT[which(Top_preserv_FM_50_PA_df$fid==levels_fid[i])])
  if (nrow(Top_preserv_FM_50_PA_df[which(Top_preserv_FM_50_PA_df$fid==levels_fid[i]),])>1){
    
    data_sans_0=Top_preserv_FM_50_PA_df$IUCN_CAT[which(Top_preserv_FM_50_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    
    if ((T %in% !is.na(data_sans_0))==F){
      Top_preserv_FM_50_PA_df=Top_preserv_FM_50_PA_df[-grep(levels_fid[i], Top_preserv_FM_50_PA_df$fid)[1],]
    }
    if (F %in% is.na(data_sans_0)){
      
      if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
    
      min_level=min(data_sans_0, na.rm=T)
   
    
       Top_preserv_FM_50_PA_df=Top_preserv_FM_50_PA_df[-which(Top_preserv_FM_50_PA_df$fid==levels_fid[i] & (is.na(Top_preserv_FM_50_PA_df$IUCN_CAT) | Top_preserv_FM_50_PA_df$IUCN_CAT != min_level)),]
    }
    
    
    
      if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
        Top_preserv_FM_50_PA_df=Top_preserv_FM_50_PA_df[-grep(levels_fid[i], Top_preserv_FM_50_PA_df$fid)[-1],]
    }
    }
     
  }
  
}


Top_preserv_FM_PA_sum=as.data.frame(summary(as.factor(Top_preserv_FM_50_PA_df$IUCN_CAT)))
colnames(Top_preserv_FM_PA_sum)=c("nb")
### I think (but I am not sure) that I need to change the rownames to correspon to 0 = no PA
rownames(Top_preserv_FM_PA_sum)=c(0,2,4,5,"Not Categorised")

# Top_preserv_SP_PA_sum=t(Top_preserv_FM_PA_sum)
p=ggplot(Top_preserv_FM_PA_sum) + geom_bar(aes(x="Preservation", y=nb, fill=rownames(Top_preserv_FM_PA_sum)), stat="identity")





## Geom_bar - Prop


Top_preserv_FM_PA_sum$TOP="Preservation"
Top_preserv_FM_PA_sum$PA=rownames(Top_preserv_FM_PA_sum)
Top_resto_FM_PA_sum$TOP="Restoration"
Top_resto_FM_PA_sum$PA=rownames(Top_resto_FM_PA_sum)
Top_FM_PA_sum=rbind(Top_preserv_FM_PA_sum,Top_resto_FM_PA_sum)

# Label preserv
label_pres=c(Top_preserv_FM_PA_sum$nb[5]/2,
             Top_preserv_FM_PA_sum$nb[5]+Top_preserv_FM_PA_sum$nb[4]/2,
             Top_preserv_FM_PA_sum$nb[5]+Top_preserv_FM_PA_sum$nb[4] +Top_preserv_FM_PA_sum$nb[1]/2)

# Label resto
label_resto=c(Top_resto_FM_PA_sum$nb[8]/2,
             Top_resto_FM_PA_sum$nb[8]+(Top_resto_FM_PA_sum$nb[6]/2),
             Top_resto_FM_PA_sum$nb[8]+Top_resto_FM_PA_sum$nb[6]+(Top_resto_FM_PA_sum$nb[1]/2)
            )

# Color
color_values=c(rgb(128,128,128, maxColorValue=255))
color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(Top_FM_PA_sum$PA))-1))

Top_FM_PA_sum$TOP=as.factor(Top_FM_PA_sum$TOP)
Top_FM_PA_sum$PA=as.factor(Top_FM_PA_sum$PA)
p=ggplot() + geom_bar(data=Top_FM_PA_sum, aes(x=TOP, y=nb, fill=PA), stat="identity")+scale_fill_manual(values=color_values)+
    geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_FM_PA_sum$nb[c(5,4,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_FM_PA_sum$nb[c(8,6,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/PA" ,"/geom_bar_PA_forest", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/PA" ,"/geom_bar_PA_forest_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


#### PLOT by PROP

Top_preserv_FM_PA_sum$Prop=100*Top_preserv_FM_PA_sum$nb/sum(Top_preserv_FM_PA_sum$nb)
Top_resto_FM_PA_sum$Prop=100*Top_resto_FM_PA_sum$nb/sum(Top_resto_FM_PA_sum$nb)
Top_FM_PA_sum_prop=rbind(Top_preserv_FM_PA_sum,Top_resto_FM_PA_sum)

# Label preserv
label_pres=c(Top_preserv_FM_PA_sum$Prop[5]/2,
             Top_preserv_FM_PA_sum$Prop[5]+Top_preserv_FM_PA_sum$Prop[4]/2,
             Top_preserv_FM_PA_sum$Prop[5]+Top_preserv_FM_PA_sum$Prop[4] +Top_preserv_FM_PA_sum$Prop[1]/2)

# Label resto
label_resto=c(Top_resto_FM_PA_sum$Prop[8]/2,
             Top_resto_FM_PA_sum$Prop[8]+(Top_resto_FM_PA_sum$Prop[6]/2),
             Top_resto_FM_PA_sum$Prop[8]+Top_resto_FM_PA_sum$Prop[6]+(Top_resto_FM_PA_sum$Prop[1]/2)
            )

# Color
color_values=c(rgb(128,128,128, maxColorValue=255))
color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(Top_FM_PA_sum$PA))-1))

Top_FM_PA_sum_prop$TOP=as.factor(Top_FM_PA_sum_prop$TOP)
Top_FM_PA_sum_prop$PA=as.factor(Top_FM_PA_sum_prop$PA)
p=ggplot() + geom_bar(data=Top_FM_PA_sum_prop, aes(x=TOP, y=Prop, fill=PA), stat="identity")+scale_fill_manual(values=color_values)+
  #   geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_FM_PA_sum$Prop[c(5,4,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_FM_PA_sum$Prop[c(8,6,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) 

fx(p)

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/PA" ,"/geom_bar_PA_forest_percentage", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/PA" ,"/geom_bar_PA_forest_prop_percentage", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)




#### Test stats
TOP_PA=data.frame(IUCN_CAT=0:7, Pres=NA, Resto=NA)
for (i in (1:7)){
  if ((i-1) %in% Top_preserv_FM_PA_sum$PA){
  TOP_PA$Pres[i]=Top_preserv_FM_PA_sum$nb[which(Top_preserv_FM_PA_sum$PA==as.character(i-1))]
  } else {TOP_PA$Pres[i]=0}
  
    if ((i-1) %in% Top_resto_FM_PA_sum$PA){
  TOP_PA$Resto[i]=Top_resto_FM_PA_sum$nb[which(Top_resto_FM_PA_sum$PA==as.character(i-1))]
    } else {TOP_PA$Resto[i]=0}
}
TOP_PA$Pres[8]=Top_preserv_FM_PA_sum$nb[which(Top_preserv_FM_PA_sum$PA=="Not Categorised")]
TOP_PA$Resto[8]=Top_resto_FM_PA_sum$nb[which(Top_resto_FM_PA_sum$PA=="Not Categorised")]




khi_prop_clust=TOP_PA[,-1]
# khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust) # p-value = 3.676e-05
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c(0,1,2,3,4,5,6,"Not categorised")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#                   Preservation Restoration
# 0                         17          19
# 1                          1           1
# 2                          0           0
# 3                          1           2
# 4                          0           0
# 5                         10          11
# 6                          1           1
# Not categorised           18          20

# >10 => significant

```


### BD

```{r bd_forest}

### BD in TOP RESTORATION 

Top_resto_FM_BD=shapefile("Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies_forest_TOP50_resto_NCP_clust_BD_art17_WGS84.shp")

Top_resto_FM_BD_df=Top_resto_FM_BD@data


table(Top_resto_FM_BD_df[,c(grep("cluster", colnames(Top_resto_FM_BD_df)),grep("conclusi_1", colnames(Top_resto_FM_BD_df)))])

Top_resto_FM_BD_sum=as.data.frame(table(Top_resto_FM_BD_df[,c(grep("cluster", colnames(Top_resto_FM_BD_df)),grep("conclusi_1", colnames(Top_resto_FM_BD_df)))]))
sum(Top_resto_FM_BD_sum$Freq) # 8142 => ok


p=ggplot(Top_resto_FM_BD_sum) + geom_bar(aes(x=conclusi_1, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


Top_resto_FM_BD_summary=data.frame(conclusi_1=c("FV", "U1", "U2", "XX"), Freq=NA)
Top_resto_FM_BD_summary$conclusi_1=as.factor(Top_resto_FM_BD_summary$conclusi_1)
for (i in 1:nrow(Top_resto_FM_BD_summary)){
  Top_resto_FM_BD_summary$Freq[i]=sum(Top_resto_FM_BD_sum$Freq[which(Top_resto_FM_BD_sum$conclusi_1==Top_resto_FM_BD_summary$conclusi_1[i])])
}

p=ggplot(Top_resto_FM_BD_summary) + geom_bar(aes(x="Restoration", y=Freq, fill=conclusi_1), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))


## BD in TOP PRESERVATION


Top_preserv_FM_BD=shapefile("Path/to/working/directory/R/Export_data/Sustainableforest/Anomalies_forest_TOP50_preserv_NCP_clust_BD_art17_WGS84.shp")

Top_preserv_FM_BD_df=Top_preserv_FM_BD@data
str(Top_preserv_FM_BD_df)

table(Top_preserv_FM_BD_df[,c(grep("cluster", colnames(Top_preserv_FM_BD_df)),grep("conclusi_1", colnames(Top_preserv_FM_BD_df)))])

Top_preserv_FM_BD_sum=as.data.frame(table(Top_preserv_FM_BD_df[,c(grep("cluster", colnames(Top_preserv_FM_BD_df)),grep("conclusi_1", colnames(Top_preserv_FM_BD_df)))]))
sum(Top_preserv_FM_BD_sum$Freq) # 10740 => ok


p=ggplot(Top_preserv_FM_BD_sum) + geom_bar(aes(x=conclusi_1, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


Top_preserv_FM_BD_summary=data.frame(conclusi_1=c("FV", "U1", "U2", "XX"), Freq=NA)
Top_preserv_FM_BD_summary$conclusi_1=as.factor(Top_preserv_FM_BD_summary$conclusi_1)
for (i in 1:nrow(Top_preserv_FM_BD_summary)){
  Top_preserv_FM_BD_summary$Freq[i]=sum(Top_preserv_FM_BD_sum$Freq[which(Top_preserv_FM_BD_sum$conclusi_1==Top_preserv_FM_BD_summary$conclusi_1[i])])
}

p=ggplot(Top_preserv_FM_BD_summary) + geom_bar(aes(x="Preservation", y=Freq, fill=conclusi_1), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))

### PREVIOUS GRAPH WITH RESTO and PRESERV

p=ggplot() + geom_bar(data=Top_preserv_FM_BD_summary, aes(x="Preservation", y=Freq, fill=conclusi_1), stat="identity") + geom_bar(data=Top_resto_FM_BD_summary, aes(x="Restoration", y=Freq, fill=conclusi_1), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))


Top_preserv_FM_BD_summary$Prop=100*Top_preserv_FM_BD_summary$Freq/sum(Top_preserv_FM_BD_summary$Freq)
Top_resto_FM_BD_summary$Prop=100*Top_resto_FM_BD_summary$Freq/sum(Top_resto_FM_BD_summary$Freq)

#########################


Top_preserv_FM_BD_summary$TOP="Preservation"
Top_resto_FM_BD_summary$TOP="Restoration"
Top_FM_BD_summary=rbind(Top_preserv_FM_BD_summary, Top_resto_FM_BD_summary)

# Label preserv
label_pres=c(Top_preserv_FM_BD_summary$Freq[4]+Top_preserv_FM_BD_summary$Freq[3]/2,
             Top_preserv_FM_BD_summary$Freq[4]+Top_preserv_FM_BD_summary$Freq[3]+(Top_preserv_FM_BD_summary$Freq[2]/2),
             Top_preserv_FM_BD_summary$Freq[4]+Top_preserv_FM_BD_summary$Freq[3]+Top_preserv_FM_BD_summary$Freq[2]+(Top_preserv_FM_BD_summary$Freq[1]/2)
             )
# Label resto
label_resto=c(Top_resto_FM_BD_summary$Freq[4]+Top_resto_FM_BD_summary$Freq[3]/2,
             Top_resto_FM_BD_summary$Freq[4]+Top_resto_FM_BD_summary$Freq[3]+(Top_resto_FM_BD_summary$Freq[2]/2),
             Top_resto_FM_BD_summary$Freq[4]+Top_resto_FM_BD_summary$Freq[3]+Top_resto_FM_BD_summary$Freq[2]+(Top_resto_FM_BD_summary$Freq[1]/2)
             )

p=ggplot() + geom_bar(data=Top_FM_BD_summary, aes(x=TOP, y=Freq, fill=conclusi_1), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_FM_BD_summary$Prop[c(3,2,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_FM_BD_summary$Prop[c(3,2,1)],0))), size=10)+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())
  
fx(p)

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD" ,"/geom_bar_BD_forest", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD" ,"/geom_bar_BD_forest_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


#### Test stats
TOP_BD=data.frame(IUCN_CAT=c("FV", "U1", "U2", "XX"), Pres=NA, Resto=NA)

for (i in (1:4)){
  if (TOP_BD$IUCN_CAT[i] %in% Top_preserv_FM_BD_summary$conclusi_1){
  TOP_BD$Pres[i]=Top_preserv_FM_BD_summary$Freq[which(Top_preserv_FM_BD_summary$conclusi_1==TOP_BD$IUCN_CAT[i])]
  } else {TOP_BD$Pres[i]=0}
  
    if (TOP_BD$IUCN_CAT[i] %in% Top_resto_FM_BD_summary$conclusi_1){
  TOP_BD$Resto[i]=Top_resto_FM_BD_summary$Freq[which(Top_resto_FM_BD_summary$conclusi_1==TOP_BD$IUCN_CAT[i])]
    } else {TOP_BD$Resto[i]=0}
}

# IUCN_CAT Pres Resto
# 1       FV   41    93
# 2       U1 1954  1963
# 3       U2 4931  4015
# 4       XX   23   155

## Sans XX
TOP_BD=TOP_BD[-4,]

khi_prop_clust=TOP_BD[,-1]
# khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust)
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("FV", "U1", "U2")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#  Preservation Restoration
# FV            7           8
# U1            4           4
# U2            6           6
# XX           31          35
# >10 => significant

# Sans XX
#         Preservation Restoration
# FV           22          25
# U1           15          17
# U2           10          11


```

### BD-CCMa

```{r bd_ccm_forest}

###### BD VS current carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_actual_masked_top_preserv_FM_FV=mask(SOC_actual_masked_forest_slope_inf35_top_preserv, Top_preserv_FM_BD[which(Top_preserv_FM_BD$conclusi_1=="FV"),])
# SOC_actual_masked_top_preserv_FM_FV=SOC_actual_masked_top_preserv_FM_FV[-which(is.na(SOC_actual_masked_top_preserv_FM_FV@data@values)),]
# SOC_actual_masked_top_preserv_FM_FV@data@values=as.numeric(SOC_actual_masked_top_preserv_FM_FV@data@values) # 7526 values
length(SOC_actual_masked_top_preserv_FM_FV)
# boxplot(SOC_actual_masked_top_preserv_FM_FV) 

# sampleRandom(SOC_actual_masked_top_preserv_FM_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_preserv_FM_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_FM_FV,10000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")
colnames(data_soc_preserv_FM_FV)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_FM_FV, aes(y=SOC, x="Preservation FV"))
fx(p)

remove(SOC_actual_masked_top_preserv_FM_FV)

## In U1 state
SOC_actual_masked_top_preserv_FM_U1=mask(SOC_actual_masked_forest_slope_inf35_top_preserv, Top_preserv_FM_BD[which(Top_preserv_FM_BD$conclusi_1=="U1"),])
# SOC_actual_masked_top_preserv_FM_U1@data@values=as.numeric(SOC_actual_masked_top_preserv_FM_U1@data@values) # 7526 values
length(SOC_actual_masked_top_preserv_FM_U1@data@values) # 90492624
# boxplot(SOC_actual_masked_top_preserv_FM_U1) 

# sampleRandom(SOC_actual_masked_top_preserv_FM_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_FM_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_FM_U1,10000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")
colnames(data_soc_preserv_FM_U1)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_FM_U1, aes(y=SOC, x="Preservation U1"))
fx(p)

remove(SOC_actual_masked_top_preserv_FM_U1)

## In U2 state
SOC_actual_masked_top_preserv_FM_U2=mask(SOC_actual_masked_forest_slope_inf35_top_preserv, Top_preserv_FM_BD[which(Top_preserv_FM_BD$conclusi_1=="U2"),])
# SOC_actual_masked_top_preserv_FM_U2@data@values=as.numeric(SOC_actual_masked_top_preserv_FM_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_preserv_FM_U2) 
length(SOC_actual_masked_top_preserv_FM_U2@data@values) # 90492624
# sampleRandom(SOC_actual_masked_top_preserv_FM_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_FM_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_FM_U2,10000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")
colnames(data_soc_preserv_FM_U2)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_FM_U2, aes(y=SOC, x="Preservation U2"))
fx(p)

remove(SOC_actual_masked_top_preserv_FM_U2)

# with all 3 state of BD
data_soc_preserv_FM_all=rbind(data_soc_preserv_FM_FV, data_soc_preserv_FM_U1, data_soc_preserv_FM_U2)
data_soc_preserv_FM_all$BD=as.factor(data_soc_preserv_FM_all$BD)

p=ggplot() + geom_violin(data=data_soc_preserv_FM_all, aes(y=SOC, x=BD)) 
fx(p)



### In Top restoration

## In BD favourable state
SOC_actual_masked_top_resto_FM_FV=mask(SOC_current_masked_forest_slope_inf35, Top_resto_FM_BD[which(Top_resto_FM_BD$conclusi_1=="FV"),])
# SOC_actual_masked_top_resto_FM_FV@data@values=as.numeric(SOC_actual_masked_top_resto_FM_FV@data@values) # 7526 values
length(SOC_actual_masked_top_resto_FM_FV)
# boxplot(SOC_actual_masked_top_resto_FM_FV) 

# sampleRandom(SOC_actual_masked_top_resto_FM_FV,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_FM_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_FM_FV,10000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")
# data_soc_resto_FM_FV=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="FV")
colnames(data_soc_resto_FM_FV)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_resto_FM_FV, aes(y=SOC, x="Restoration FV"))
fx(p)

remove(SOC_actual_masked_top_resto_FM_FV)

## In U1 state
SOC_actual_masked_top_resto_FM_U1=mask(SOC_current_masked_forest_slope_inf35, Top_resto_FM_BD[which(Top_resto_FM_BD$conclusi_1=="U1"),])
# SOC_actual_masked_top_resto_FM_U1@data@values=as.numeric(SOC_actual_masked_top_resto_FM_U1@data@values) # 7526 values
length(SOC_actual_masked_top_resto_FM_U1@data@values) # 90492624
# boxplot(SOC_actual_masked_top_resto_FM_U1) 

# sampleRandom(SOC_actual_masked_top_resto_FM_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_FM_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_FM_U1,10000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")
# data_soc_resto_FM_U1=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U1")
colnames(data_soc_resto_FM_U1)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_resto_FM_U1, aes(y=SOC, x="Restoration U1"))
fx(p)

remove(SOC_actual_masked_top_resto_FM_U1)

## In U2 state
SOC_actual_masked_top_resto_FM_U2=mask(SOC_current_masked_forest_slope_inf35, Top_resto_FM_BD[which(Top_resto_FM_BD$conclusi_1=="U2"),])
# SOC_actual_masked_top_resto_FM_U2@data@values=as.numeric(SOC_actual_masked_top_resto_FM_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_resto_FM_U2) 
length(SOC_actual_masked_top_resto_FM_U2) # 90492624
# sampleRandom(SOC_actual_masked_top_resto_FM_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_FM_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_FM_U2,10000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")
# data_soc_resto_FM_U2=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U2")
colnames(data_soc_resto_FM_U2)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_resto_FM_U2, aes(y=SOC, x="Restoration U2"))
fx(p)
remove(SOC_actual_masked_top_resto_FM_U2)



# with all 3 state of BD
data_soc_resto_FM_all=rbind(data_soc_resto_FM_FV, data_soc_resto_FM_U1, data_soc_resto_FM_U2)
data_soc_resto_FM_all$BD=as.factor(data_soc_resto_FM_all$BD)

p=ggplot() + geom_violin(data=data_soc_resto_FM_all, aes(y=SOC, x=BD)) 
fx(p)



# BD VS potential carbon sequestration

data_soc_FM_FV=rbind(data_soc_preserv_FM_FV, data_soc_resto_FM_FV)
data_soc_FM_U1=rbind(data_soc_preserv_FM_U1, data_soc_resto_FM_U1)
data_soc_FM_U2=rbind(data_soc_preserv_FM_U2, data_soc_resto_FM_U2)

# p=ggplot() +
#   geom_violin(data=data_soc_FM_FV, aes(y=SOC, x=TOP, fill=BD)) +
#   geom_violin(data=data_soc_FM_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_FM_U2, aes(y=SOC, x=TOP, fill=BD))


data_soc_all_FM_all=rbind(data_soc_preserv_FM_all, data_soc_resto_FM_all)

p=ggplot() + geom_violin(data=data_soc_all_FM_all, aes(y=SOC, x=BD:TOP, fill=TOP))
fx(p)

p=ggplot() + geom_violin(data=data_soc_all_FM_all, aes(y=SOC, x=TOP:BD, fill=BD))
fx(p)

### ANOVA

aov_fm=aov(data=data_soc_all_FM_all, SOC~TOP*BD)
anova(aov_fm) 

# Response: SOC
#              Df  Sum Sq Mean Sq F value    Pr(>F)    
# TOP           1     16  15.568  8.3645  0.003828 ** 
# BD            2     70  34.872 18.7365 7.345e-09 ***
# TOP:BD        2    129  64.615 34.7168 8.579e-16 ***

TukeyHSD(aov_fm)
#                             diff         lwr         upr     p adj
# Restoration < Preservation -0.03632226 -0.06093734 -0.01170718 0.0038262

# U1 >FV                      0.09620311  0.05524343 0.13716279 0.0000001
# U2 > FV                     0.08300961  0.04204993 0.12396929 0.0000061
# U2 = U1                    -0.01319350 -0.04516759 0.01878058 0.5977254

TukeyHSD(aov_fm)$`TOP:BD`[which(TukeyHSD(aov_fm)$`TOP:BD`[,4]<0.05),]
#                                     diff         lwr         upr        p adj
# Preservation:U1>Restoration:FV   0.1730232  0.11610919  0.22993716 5.084821e-14
# Restoration:U2>Restoration:FV    0.1552852  0.09837119  0.21219916 1.482148e-13
# Restoration:U1<Preservation:U1  -0.1180340 -0.17301478 -0.06305322 1.421307e-08
# Preservation:U2<Preservation:U1 -0.1266830 -0.18166379 -0.07170222 7.744532e-10
# Restoration:U2>Restoration:U1    0.1002960  0.04531521  0.15527678 2.991281e-06
# Restoration:U2>Preservation:U2   0.1089450  0.05396422  0.16392579 2.445093e-07

## Manual group
# "FV:Preservation"     ab 
# "FV:Restoration"      b
# "U1:Preservation"      a
# "U1:Restoration"      b 
# "U2:Preservation"     b
# "U2:Restoration"       a


x_groups=c("FV:Preservation", "FV:Restoration", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
groups=c("ab", "b", "a", "b", "b", "a")

### PLOT

# 
Top_preserv_FM_BD_summary$Prop=100*Top_preserv_FM_BD_summary$Freq/sum(Top_preserv_FM_BD_summary$Freq)
Top_resto_FM_BD_summary$Prop=100*Top_resto_FM_BD_summary$Freq/sum(Top_resto_FM_BD_summary$Freq)


median_data <- data_soc_all_FM_all %>%
  group_by(BD:TOP) %>%
  summarize(median_soc = median(SOC, na.rm=T)) %>% as.data.frame()

# median_data=median_data[c(1,4,2,5,3,6),]
colnames(median_data)=c("TOP", "median_soc")


p=ggplot() + geom_violin(data=data_soc_all_FM_all, aes(y=SOC, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=41 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = (median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)

# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_forest", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_forest_groups", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)



# WITH LOG

p=ggplot() + geom_violin(data=data_soc_all_FM_all, aes(y=log10(SOC), x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=x_groups, y=1.7 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = log10(median_soc), x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_forest", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_forest_groups", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)




```

### BD-CCMp

```{r bd_ccm_pot_forest}

###### BD VS potential carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_potent_masked_top_preserv_FM_FV=mask(SOC_potential_masked_forest_slope_inf35, Top_preserv_FM_BD[which(Top_preserv_FM_BD$conclusi_1=="FV"),])
# SOC_potent_masked_top_preserv_FM_FV=SOC_potent_masked_top_preserv_FM_FV[-which(is.na(SOC_potent_masked_top_preserv_FM_FV@data@values)),]
# SOC_potent_masked_top_preserv_FM_FV@data@values=as.numeric(SOC_potent_masked_top_preserv_FM_FV@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_FM_FV)
# boxplot(SOC_potent_masked_top_preserv_FM_FV) 

# sampleRandom(SOC_potent_masked_top_preserv_FM_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_pot_preserv_FM_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_FM_FV,10000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")
colnames(data_soc_pot_preserv_FM_FV)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_FM_FV, aes(y=SOP, x="Preservation FV"))
fx(p)

remove(SOC_potent_masked_top_preserv_FM_FV)

## In U1 state
SOC_potent_masked_top_preserv_FM_U1=mask(SOC_potential_masked_forest_slope_inf35, Top_preserv_FM_BD[which(Top_preserv_FM_BD$conclusi_1=="U1"),])
# SOC_potent_masked_top_preserv_FM_U1@data@values=as.numeric(SOC_potent_masked_top_preserv_FM_U1@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_FM_U1) # 90492624
# boxplot(SOC_potent_masked_top_preserv_FM_U1) 

# sampleRandom(SOC_potent_masked_top_preserv_FM_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_preserv_FM_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_FM_U1,10000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")
colnames(data_soc_pot_preserv_FM_U1)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_FM_U1, aes(y=SOP, x="Preservation U1"))
fx(p)

remove(SOC_potent_masked_top_preserv_FM_U1)

## In U2 state
SOC_potent_masked_top_preserv_FM_U2=mask(SOC_potential_masked_forest_slope_inf35, Top_preserv_FM_BD[which(Top_preserv_FM_BD$conclusi_1=="U2"),])
# SOC_potent_masked_top_preserv_FM_U2@data@values=as.numeric(SOC_potent_masked_top_preserv_FM_U2@data@values) # 90492624 values
length(SOC_potent_masked_top_preserv_FM_U2)
# boxplot(SOC_potent_masked_top_preserv_FM_U2) 

# sampleRandom(SOC_potent_masked_top_preserv_FM_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_preserv_FM_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_FM_U2,10000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")
colnames(data_soc_pot_preserv_FM_U2)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_FM_U2, aes(y=SOP, x="Preservation U2"))
fx(p)

remove(SOC_potent_masked_top_preserv_FM_U2)

# with all 3 state of BD
data_soc_pot_preserv_FM_all=rbind(data_soc_pot_preserv_FM_FV, data_soc_pot_preserv_FM_U1, data_soc_pot_preserv_FM_U2)
data_soc_pot_preserv_FM_all$BD=as.factor(data_soc_pot_preserv_FM_all$BD)

p=ggplot() + geom_violin(data=data_soc_pot_preserv_FM_all, aes(y=SOP, x=BD)) 
fx(p)

### In Top restoration

## In BD favourable state
SOC_potent_masked_top_resto_FM_FV=mask(SOC_potential_masked_forest_slope_inf35, Top_resto_FM_BD[which(Top_resto_FM_BD$conclusi_1=="FV"),])
# SOC_potent_masked_top_resto_FM_FV@data@values=as.numeric(SOC_potent_masked_top_resto_FM_FV@data@values) # 7526 values
length(SOC_potent_masked_top_resto_FM_FV)
# boxplot(SOC_potent_masked_top_resto_FM_FV) 

# sampleRandom(SOC_potent_masked_top_resto_FM_FV,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_FM_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_FM_FV,10000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")
# data_soc_pot_resto_FM_FV=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="FV")
colnames(data_soc_pot_resto_FM_FV)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_FM_FV, aes(y=SOP, x="Restoration FV"))
fx(p)
remove(SOC_potent_masked_top_resto_FM_FV)

## In U1 state
SOC_potent_masked_top_resto_FM_U1=mask(SOC_potential_masked_forest_slope_inf35, Top_resto_FM_BD[which(Top_resto_FM_BD$conclusi_1=="U1"),])
# SOC_potent_masked_top_resto_FM_U1@data@values=as.numeric(SOC_potent_masked_top_resto_FM_U1@data@values) # 7526 values
length(SOC_potent_masked_top_resto_FM_U1@data@values[-which(is.na(SOC_potent_masked_top_resto_FM_U1@data@values))]) # 334516
# boxplot(SOC_potent_masked_top_resto_FM_U1) 

# sampleRandom(SOC_potent_masked_top_resto_FM_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_FM_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_FM_U1,10000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")
# data_soc_pot_resto_FM_U1=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U1")
colnames(data_soc_pot_resto_FM_U1)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_FM_U1, aes(y=SOP, x="Restoration U1"))
fx(p)
remove(SOC_potent_masked_top_resto_FM_U1)


## In U2 state
SOC_potent_masked_top_resto_FM_U2=mask(SOC_potential_masked_forest_slope_inf35, Top_resto_FM_BD[which(Top_resto_FM_BD$conclusi_1=="U2"),])
# SOC_potent_masked_top_resto_FM_U2@data@values=as.numeric(SOC_potent_masked_top_resto_FM_U2@data@values) # 90492624 values
# boxplot(SOC_potent_masked_top_resto_FM_U2) 

length(SOC_potent_masked_top_resto_FM_U2@data@values[-which(is.na(SOC_potent_masked_top_resto_FM_U2@data@values))]) # 493806
# sampleRandom(SOC_potent_masked_top_resto_FM_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_pot_resto_FM_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_FM_U2,10000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")
# data_soc_pot_resto_FM_U2=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U2")
colnames(data_soc_pot_resto_FM_U2)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_FM_U2, aes(y=SOP, x="Restoration U2"))
fx(p)
remove(SOC_potent_masked_top_resto_FM_U2)



# with all 3 state of BD
data_soc_pot_resto_FM_all=rbind(data_soc_pot_resto_FM_FV, data_soc_pot_resto_FM_U1, data_soc_pot_resto_FM_U2)
data_soc_pot_resto_FM_all$BD=as.factor(data_soc_pot_resto_FM_all$BD)

p=ggplot() + geom_violin(data=data_soc_pot_resto_FM_all, aes(y=SOP, x=BD)) 
fx(p)


# data_soc_pot_FM_FV=rbind(data_soc_pot_preserv_FM_FV, data_soc_pot_resto_FM_FV)
# data_soc_pot_FM_U1=rbind(data_soc_pot_preserv_FM_U1, data_soc_pot_resto_FM_U1)
# data_soc_pot_FM_U2=rbind(data_soc_pot_preserv_FM_U2, data_soc_pot_resto_FM_U2)

# p=ggplot() +
#   geom_violin(data=data_soc_pot_FM_FV, aes(y=SOC, x=TOP, fill=BD)) +
#   geom_violin(data=data_soc_pot_FM_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_pot_FM_U2, aes(y=SOC, x=TOP, fill=BD))


data_soc_pot_all_FM_all=rbind(data_soc_pot_preserv_FM_all, data_soc_pot_resto_FM_all)

p=ggplot() + geom_violin(data=data_soc_pot_all_FM_all, aes(y=SOP, x=BD:TOP, fill=TOP))
fx(p)

p=ggplot() + geom_violin(data=data_soc_pot_all_FM_all, aes(y=SOP, x=TOP:BD, fill=BD))
fx(p)

### ANOVA

aov_pot_FM=aov(data=data_soc_pot_all_FM_all, SOP~TOP*BD)
anova(aov_pot_FM) 

# Response: SOC
#              Df  Sum Sq Mean Sq F value    Pr(>F)  
# TOP           1   0.00  0.0042   0.3258 0.5681    
# BD            2   9.81  4.9038 379.4382 <2e-16 ***
# TOP:BD        2   3.93  1.9669 152.1930 <2e-16 ***

TukeyHSD(aov_pot_FM)
#                             diff          lwr            upr     p adj
# U1<FV                     -0.01881230 -0.02152188 -0.01610271     0
# U2<FV                     -0.03170766 -0.03441725 -0.02899808     0
# U2<U1                     -0.01289537 -0.01555975 -0.01023098     0

TukeyHSD(aov_pot_FM)$`TOP:BD`[which(TukeyHSD(aov_pot_FM)$`TOP:BD`[,4]<0.05),]

# Restoration:FV < Preservation:FV  -0.0175528736 0.000000e+00
# Preservation:U1 < Preservation:FV -0.0265506246 0.000000e+00
# Restoration:U1 < Preservation:FV  -0.0227212379 0.000000e+00
# Preservation:U2 < Preservation:FV -0.0463203513 0.000000e+00
# Restoration:U2 < Preservation:FV  -0.0287422435 0.000000e+00
# Preservation:U1 < Restoration:FV  -0.0040856342 1.702748e-06
# Restoration:U1 < Restoration:FV   -0.0002562475 3.193503e-02
# Preservation:U2 < Restoration:FV  -0.0238553609 0.000000e+00
# Restoration:U2 < Restoration:FV   -0.0062772531 5.452544e-10
# Preservation:U2 < Preservation:U1 -0.0151882058 0.000000e+00
# Preservation:U2 < Restoration:U1  -0.0190175925 0.000000e+00
# Restoration:U2 < Restoration:U1   -0.0014394847 2.485823e-03
# Restoration:U2 > Preservation:U2   0.0221596287 5.895284e-14

#  Manual grouping
# "FV:Preservation"     a
# "FV:Restoration"    b
# "U1:Preservation"  cd
# "U1:Restoration"   c
# "U2:Preservation"e
# "U2:Restoration"  d


x_groups=c("FV:Preservation", "FV:Restoration", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
# previous_groups=c("a", "a", "a", "b", "c", "b")
groups=c("a", "b", "cd", "c", "e", "d")

### PLOT
# data_soc_pot_all_FM_all

p=ggplot() + geom_violin(data=data_soc_pot_all_FM_all, aes(y=SOP, x=BD:TOP, fill=TOP))
fx(p)

# 
# Top_preserv_WR_BD_summary$Prop=100*Top_preserv_WR_BD_summary$Freq/sum(Top_preserv_WR_BD_summary$Freq)
# Top_resto_WR_BD_summary$Prop=100*Top_resto_WR_BD_summary$Freq/sum(Top_resto_WR_BD_summary$Freq)


median_data <- data_soc_pot_all_FM_all %>%
  group_by(BD:TOP) %>%
  summarize(median_sop = median(SOP, na.rm=T)) %>% as.data.frame()

# median_data=median_data[c(1,4,2,5,3,6),]
colnames(median_data)=c("TOP", "median_sop")

mean_data <- data_soc_pot_all_FM_all %>%
  group_by(BD:TOP) %>%
  summarize(mean_sop = mean(SOP, na.rm=T)) %>% as.data.frame()
colnames(mean_data)=c("TOP", "mean_sop")

#          TOP      mean_sop
# 1 FV:Preservation 0.9779904
# 2  FV:Restoration 0.9556907
# 3 U1:Preservation 0.9468582
# 4  U1:Restoration 0.9506876
# 5 U2:Preservation 0.9270885
# 6  U2:Restoration 0.9446666

p=ggplot() + geom_violin(data=data_soc_pot_all_FM_all, aes(y=SOP, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=x_groups, y=1.05 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y=median_sop, x=`BD:TOP`), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

  
fx(p)

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_forest", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_groups_forest", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)


#### PLOT WITH MEAN

p=ggplot() + geom_violin(data=data_soc_pot_all_FM_all, aes(y=SOP, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=1.05 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data , aes(y=mean_sop, x=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

  
fx(p)

# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_mean_forest", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_mean_groups_forest", ".png", sep=''), width=9*2, height=10*2, limitsize=F, dpi = 300)



```

### absolute CCM
```{r absolute_ccm_forest}


# SOC:
SOC_current_masked_forest_slope_inf35
# SOP :
SOC_potential_masked_forest_slope_inf35

Capacity_forests=SOC_current_masked_forest_slope_inf35*(1-SOC_potential_masked_forest_slope_inf35)/SOC_potential_masked_forest_slope_inf35

# Top preserv
Capacity_CCM_forest_preserv=mask(Capacity_forests, Anomalies2100_in_WS_raster_forest_masked_top_pres)

data_capacity_preserv=data.frame(Capacity=sampleRandom(Capacity_CCM_forest_preserv$layer, 10000, na.rm=T, xy=F), TOP=as.factor("Preservation"))

str(data_capacity_preserv)


# Top resto
Capacity_CCM_forest_resto=mask(Capacity_forests, Anomalies2100_in_WS_raster_forest_masked_top_resto)

data_capacity_resto=data.frame(Capacity=sampleRandom(Capacity_CCM_forest_resto$layer, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))

str(data_capacity_resto)


# in AS
SOC_present_WGS84=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ESDAC/Derived_data_set_2013/SOC_top_soil_WGS84.tif")
crs(SOC_present_WGS84)@projargs==crs(AS_fusion_WGS84)@projargs
SOC_present_cut=crop(SOC_present_WGS84,AS_fusion_WGS84)
SOC_present_cut_resample=resample(SOC_present_cut, Carbon_saturation_cut_WGS84,method = 'ngb')

Capacity_CCM_in_AS=SOC_present_cut_resample*(1-Carbon_saturation_cut_WGS84)/Carbon_saturation_cut_WGS84
 
Capacity_CCM_in_AS=mask(Capacity_CCM_in_AS, AS_fusion_WGS84)

Capacity_CCM_in_AS_rd=data.frame(SOC=sampleRandom(Capacity_CCM_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(Capacity_CCM_in_AS_rd)=c("Capacity", "TOP")





## ANOVA

aov_capacity_fm=aov(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), Capacity~TOP)
anova(aov_capacity_fm)
#              Df Sum Sq Mean Sq F value    Pr(>F) 
# TOP           2   513.9 256.950  318.63 < 2.2e-16 ***
# Residuals 20656 16657.5   0.806                      

TukeyHSD(aov_capacity_fm)
# #                             diff         lwr       upr     p adj
# Restoration = Preservation 0.02748918 -0.05716166 0.112140 0.7268686
# AS > Preservation          0.31715533  0.28738863 0.346922 0.0000000
# AS > Restoration           0.28966615  0.20501531 0.374317 0.0000000

HSD_FM=HSD.test(aov_capacity_fm, trt="TOP", group=T, alpha=0.05)
HSD_FM
# Capacity groups
# AS           0.40044706      a
# Restoration  0.11078091      b
# Preservation 0.08329173      b



### Capacity in pres & resto
median_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(median_cap = median(Capacity)) %>% as.data.frame()

mean_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(mean_cap = mean(Capacity)) %>% as.data.frame()



p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data , aes(y = (mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


### Without AS
p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto), aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data[-3,] , aes(y = (mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


##### AS only
dossier_as="Path/to/working/directory/R/Export_data/AS/"
  
p=ggplot() + geom_violin(data=Capacity_CCM_in_AS_rd, aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(
    # rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               # rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data[-c(1,2),] , aes(y = (mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_as, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

```



### Combined CCM index

```{r combined_ccm_index}

# SOC:
summary(SOC_current_masked_forest_slope_inf35)
# Min.           0.00
# 1st Qu.        0.90
# Median         1.45
# 3rd Qu.        2.13
# Max.          39.40
# NA's    75909735.00

# SOP :
summary(SOC_potential_masked_forest_slope_inf35)
# Min.    2.912438e-01 0.29
# 1st Qu. 1.000000e+00 1
# Median  1.000000e+00 1
# 3rd Qu. 1.000000e+00 1
# Max.    1.000000e+00 1
# NA's    7.714570e+07


# list=1:ncell(SOC_potential_masked_forest_slope_inf35)
# list=raster::extract(SOC_potential_masked_forest_slope_inf35, na.rm=T, y=Bounding_box, cellnumbers=T)
list=1:ncell(SOC_potential_masked_forest_slope_inf35)
list=list[which(!is.na(SOC_potential_masked_forest_slope_inf35[]))]
length(list)/ncell(SOC_potential_masked_forest_slope_inf35) # 14%
list=as.vector(list)
list_sp=list[sample(x=1:length(list), size=10^5)]
summary(SOC_potential_masked_forest_slope_inf35[list_sp])
summary(SOC_current_masked_forest_slope_inf35[list_sp])
plot(SOC_current_masked_forest_slope_inf35[list_sp], SOC_potential_masked_forest_slope_inf35[list_sp])
### complicated to create one index...

summary(Capacity_forests)
# Capacity_forests=SOC_current_masked_forest_slope_inf35*(1-SOC_potential_masked_forest_slope_inf35)/SOC_potential_masked_forest_slope_inf35
# remove(Capacity_forests)
# Min.    0.000000e+00
# 1st Qu. 0.000000e+00
# Median  0.000000e+00
# 3rd Qu. 0.000000e+00
# Max.    5.933014e+01
# NA's    7.714570e+07


Cpot_add=SOC_current_masked_forest_slope_inf35/SOC_potential_masked_forest_slope_inf35
summary(Cpot_add)
# Min.    0.000000e+00
# 1st Qu. 9.800000e-01
# Median  1.450000e+00
# 3rd Qu. 2.130000e+00
# Max.    9.873014e+01
# NA's    7.714570e+07

plot(SOC_current_masked_forest_slope_inf35[list_sp], Cpot_add[list_sp])

### Preserv

Cpot_add_forests_preserv=mask(Cpot_add, Anomalies2100_in_WS_raster_forest_masked_top_pres)

length(Cpot_add_forests_preserv[which(!is.na(Cpot_add_forests_preserv[]))]) # 2204374

list=1:ncell(Cpot_add_forests_preserv)
list=list[which(!is.na(Cpot_add_forests_preserv[]))]
list_sp=list[sample(x=1:length(list), size=10^5)]

data_cpot_add_preserv=data.frame(Cadd=Cpot_add_forests_preserv[list_sp], SOC=SOC_current_masked_forest_slope_inf35[list_sp], TOP=as.factor("Surplus"))
colnames(data_cpot_add_preserv)=c("Cadd", "SOC", "TOP")

data_cpot_add_preserv_reshp=reshape(data_cpot_add_preserv,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_preserv_reshp$time=factor(data_cpot_add_preserv_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


# Resto

Cpot_add_forests_resto=mask(Cpot_add, Anomalies2100_in_WS_raster_forest_masked_top_resto)

length(Cpot_add_forests_resto@data@values[which(!is.na(Cpot_add_forests_resto[]))]) # 1530036

list=1:ncell(Cpot_add_forests_resto)
list=list[which(!is.na(Cpot_add_forests_resto[]))]
list_sp=list[x=sample(1:length(list), size=10^5)]

data_cpot_add_resto=data.frame(Cadd=Cpot_add_forests_resto[list_sp], SOC=SOC_current_masked_forest_slope_inf35[list_sp], TOP=as.factor("Deficit"))
colnames(data_cpot_add_resto)=c("Cadd", "SOC", "TOP")

data_cpot_add_resto_reshp=reshape(data_cpot_add_resto,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_resto_reshp$time=factor(data_cpot_add_resto_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


######## STATS
data_cpot_add_all_reshp=rbind(data_cpot_add_preserv_reshp, data_cpot_add_resto_reshp)

data_cpot_add_all_reshp$TOP=factor(data_cpot_add_all_reshp$TOP, ordered=T, levels = c("Surplus", "Deficit"))

aov_carbon=aov(data=data_cpot_add_all_reshp, Carbon~TOP*time)
anova(aov_carbon) 
# Response: Carbon
#              Df  Sum Sq Mean Sq  F value    Pr(>F)    
# TOP       1e+00    519  519.47 300.856 < 2.2e-16 ***
# time      1e+00    946  946.36 548.096 < 2.2e-16 ***
# TOP:time  1e+00     19   19.02  11.015 0.0009041 ***

TukeyHSD(aov_carbon)
# $TOP
#                      diff       lwr       upr p adj
# Deficit < Surplus -0.07207418 -0.08021837 -0.06392998     0

# $time
#              diff      lwr      upr p adj
# Cadd > SOC 0.09728108 0.08913689 0.1054253     0

TukeyHSD(aov_carbon)$`TOP:time`[which(TukeyHSD(aov_carbon)$`TOP:time`[,4]<0.05),]
# $`TOP:time`
#                                diff       lwr       upr p adj
# Deficit:SOC<Surplus:SOC   -0.08586481 -0.10096159 -0.07076802 0.000000e+00
# Surplus:Cadd>Surplus:SOC   0.08349045  0.06839367  0.09858724 0.000000e+00
# Deficit:Cadd>Surplus:SOC   0.02520691  0.01011012  0.04030369 1.054035e-04
# Surplus:Cadd>Deficit:SOC   0.16935526  0.15425848  0.18445204 0.000000e+00
# Deficit:Cadd>Deficit:SOC   0.11107171  0.09597493  0.12616850 0.000000e+00
# Deficit:Cadd<Surplus:Cadd -0.05828355 -0.07338033 -0.04318676 3.508305e-14
# Manual grouping

# Surplus:SOC:   b
# Surplus:Cadd:     d
# Deficit:SOC:  a
# Deficit:Cadd:   c








######## PLOT


median_log_data <- data_cpot_add_all_reshp %>%
  group_by(TOP:time) %>%
  summarize(median_carbon = median(log10(Carbon), na.rm=T)) %>% as.data.frame()


### Without AS
# x=seq(from=0.8, to=2.2, length.out=4)
p=ggplot() + geom_violin(data=data_cpot_add_all_reshp, aes(y=log10(Carbon), x=TOP, fill=TOP:time), position = position_dodge(0.8)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),rgb(1, 133, 113, maxColorValue = 255, alpha=0.6*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.6*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(data=median_log_data, aes(x=c(0.8, 1.2, 1.8, 2.2), y=2.1 ,label = c("b", "d", "a", "c")), stat="identity", vjust = 1.5, colour = "black",  size=10) +
    geom_point(data =median_log_data , aes(y = (median_carbon), x=c(0.8, 1.2, 1.8, 2.2)), shape = 4, size = 6, color = "black") +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_add" ,"/geom_bar_Carbon_SOC_add_groups_forests", ".png", sep=''), width=7*2, height=10*2, limitsize=F, dpi = 300)







```


## Wetland restoration 

```{r wetland_restoration}
### wetland resto
dossier_wr="Path/to/working/directory/R/Export_data/Wetland"


## Wetland in CLC

# Raster:
Wetland_masque=CLC_Alps_WGS84 %in% c(35,36) # 35/411: Inland marshes / 36/412: Peat bogs

Wetland_in_AS_raster=mask(CLC_Alps_WGS84, mask=Wetland_masque, maskvalue=0)


crs(Wetland_in_AS_raster) # WGS84

# writeRaster(Wetland_in_AS_raster, "Path/to/working/directory/R/Export_data/Wetland/Wetland_in_AS_raster_411_412_WGS84.tif", overwrite=T)


Anomalies2100_in_WS_wetland_raster=Wetland_in_AS_raster
Anomalies2100_in_WS_wetland_raster=rasterize(x= HydroBasin_l12_ALPS_int_sp,y=Anomalies2100_in_WS_wetland_raster, field="Multiply_anomalies_groundwater_reldrought_2100_JJA")


Anomalies2100_in_WS_raster_wetland_masked=mask(Anomalies2100_in_WS_wetland_raster,Wetland_in_AS_raster)


# writeRaster(Anomalies2100_in_WS_raster_wetland_masked, "Path/to/working/directory/R/Export_data/Wetland/Anomalies2100_in_WS_raster_wetland_AS_WGS84.tif", overwrite=T)



## Plot

plot(Anomalies2100_in_WS_raster_wetland_masked)
hist((Anomalies2100_in_WS_raster_wetland_masked))
boxplot(Anomalies2100_in_WS_raster_wetland_masked@data@values)

data_anomalies=data.frame(Ano=as.factor("Anomalies"), Var=Anomalies2100_in_WS_raster_wetland_masked@data@values)
data_anomalies=data_anomalies[-which(is.na(data_anomalies$Var)),]

quantile_points=data.frame(y=NA, x="Anomalies", group=c(25,75,10,90,50))
for (i in 1:5){
  quantile_points$y[i]=quantile(Anomalies2100_in_WS_raster_wetland_masked@data@values, quantile_points$group[i]/100, na.rm=T)
}
quantile_points$group=as.factor(c(25,25,10,10,50))

p=ggplot() + geom_violin(data=data_anomalies, aes(y=Var, x=Ano))+
  geom_point(data=quantile_points, aes(x=x, y=y, color=group)) + scale_color_manual(values=c(c("#0072B2", "#009E73", "#D55E00", "#000000")))
fx(p)

## nEw plot 
p=ggplot(data=data_anomalies) + geom_violin(aes(y=Var, x=Ano))+
   geom_boxplot(aes(y=Var, x=Ano), width = 0.2, fill = "white", color = "black", outlier.shape = NA) +
  theme_bw() + theme(axis.text.x=element_blank(),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
   scale_y_continuous(breaks = seq(-1000, 1000, by = 200), limits=c(-800, 800))
  # geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/Anomalies" ,"/geom_violin_wetlands_Anomalies", ".png", sep=''), width=4*2, height=8*2, limitsize=F, dpi = 300)


## Select top preservation

Anomalies2100_in_WS_raster_wetland_masked_top_pres=mask(x=Anomalies2100_in_WS_raster_wetland_masked, mask=Anomalies2100_in_WS_raster_wetland_masked>quantile(Anomalies2100_in_WS_raster_wetland_masked[which(Anomalies2100_in_WS_raster_wetland_masked@data@values>0)], 0.80, na.rm=T), maskvalue=0 )


# writeRaster(Anomalies2100_in_WS_raster_wetland_masked_top_pres, "Path/to/working/directory/R/Export_data/Wetland/Anomalies2100_in_WS_raster_wetland_masked_AS_TOP_preserv_WGS84.tif", overwrite=T)

## Select top restoration


Anomalies2100_in_WS_raster_wetland_masked_top_resto=mask(x=Anomalies2100_in_WS_raster_wetland_masked,mask=Anomalies2100_in_WS_raster_wetland_masked<quantile(Anomalies2100_in_WS_raster_wetland_masked[which(Anomalies2100_in_WS_raster_wetland_masked@data@values<0)], 0.50, na.rm=T), maskvalue=0)

# writeRaster(Anomalies2100_in_WS_raster_wetland_masked_top_resto, "Path/to/working/directory/R/Export_data/Wetland/Anomalies2100_in_WS_raster_wetland_masked_AS_TOP_resto_WGS84.tif", overwrite=T)

summary(Anomalies2100_in_WS_raster_wetland_masked_top_resto)
100*length(Anomalies2100_in_WS_raster_wetland_masked_top_resto[Anomalies2100_in_WS_raster_wetland_masked_top_resto@data@values>0])/length(Anomalies2100_in_WS_raster_wetland_masked_top_resto[Anomalies2100_in_WS_raster_wetland_masked_top_resto@data@values<0])
# 50% >0





```


### Soil organic carbon

```{r soc_wetlands}

SOC_actual_wetland_cut=crop(SOC_present_WGS84, Wetland_in_AS_raster)
SOC_actual_wetland_cut=resample(SOC_actual_wetland_cut, Wetland_in_AS_raster,method = 'ngb')

SOC_actual_masked_wetland=mask(SOC_actual_wetland_cut, Wetland_in_AS_raster)

# writeRaster(SOC_actual_masked_wetland, "Path/to/working/directory/R/Export_data/Wetland/SOC_actual_masked_wetland.tif")
SOC_actual_masked_wetland=raster("Path/to/working/directory/R/Export_data/Wetland/SOC_actual_masked_wetland.tif")


### SOC in TOP preservation wetland

SOC_actual_masked_wetland_top_preserv=mask(SOC_actual_masked_wetland, Anomalies2100_in_WS_raster_wetland_masked_top_pres)
# SOC_actual_masked_wetland_top_preserv@data@values=as.numeric(SOC_actual_masked_wetland_top_preserv@data@values)
boxplot(SOC_actual_masked_wetland_top_preserv)

# sampleRandom(SOC_actual_masked_wetland_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_soc_pres=data.frame(SOC= sampleRandom(SOC_actual_masked_wetland_top_preserv, 10000, na.rm=T, xy=F), TOP=as.factor("Preservation"))
colnames(data_soc_pres)=c("SOC", "TOP")

p=ggplot() + geom_violin(data=data_soc_pres, aes(y=SOC, x="Preservation"))
fx(p)

### SOC in TOP restoration wetland

SOC_actual_masked_wetland_top_resto=mask(SOC_actual_masked_wetland, Anomalies2100_in_WS_raster_wetland_masked_top_resto)
# SOC_actual_masked_wetland_top_resto@data@values=as.numeric(SOC_actual_masked_wetland_top_resto@data@values)
boxplot(SOC_actual_masked_wetland_top_resto)

# sampleRandom(SOC_actual_masked_wetland_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto=data.frame(SOC= sampleRandom(SOC_actual_masked_wetland_top_resto, 10000, na.rm=T, xy=F), TOP=as.factor("Restoration"))
colnames(data_soc_resto)=c("SOC", "TOP")

p=ggplot() + geom_violin(data=data_soc_resto, aes(y=SOC, x="Restoration"))
fx(p)




# sample data in AS
SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
SOC_in_AS_rd=data.frame(SOC=sampleRandom(SOC_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_AS_rd)=c("SOC", "TOP")


# sample data in all forests
# SOC_in_AS=mask(SOC_present_WGS84, AS_fusion_WGS84)
# list=1:ncell(SOC_actual_masked_wetland)
# list=list[which(!is.na(SOC_actual_masked_wetland[]))]
# list_sp=sample(x=SOC_actual_masked_wetland[list], size=10^5) # same results

SOC_in_all_wetland_rd=data.frame(SOC=sampleRandom(SOC_actual_masked_wetland, 10^5, na.rm=T, xy=F), TOP="AS")
colnames(SOC_in_all_wetland_rd)=c("SOC", "TOP")
SOC_in_all_wetland_rd$TOP=as.factor(SOC_in_all_wetland_rd$TOP)
summary(SOC_in_all_wetland_rd$SOC)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 # 0.0000  0.0000  0.0000  0.3454  0.0000 39.4000



## ANOVA
#AS: SOC_in_AS_rd / wetlands: SOC_in_all_wetland_rd
aov_soc_wr=aov(data=rbind(data_soc_resto,data_soc_pres,SOC_in_all_wetland_rd), SOC~TOP)
anova(aov_soc_wr)
# AS            Df  Sum Sq Mean Sq F value    Pr(>F)   
# TOP           2  714288  357144  3274.1 < 2.2e-16 ***
# Wetlands
# TOP           2 1027821  513910  7772.9 < 2.2e-16 ***

TukeyHSD(aov_soc_wr)
#  AS                              diff       lwr       upr      p adj
# Preservation < Restoration -10.45396812 -10.8071102 -10.1008261 0.0000000
# AS < Restoration           -10.38476139 -10.7309363 -10.0385865 0.0000000
# AS=Preservation            0.06920673  -0.2839353   0.4223488 0.8902463
# Wetlands
# Preservation < Restoration -10.45397 -10.728899 -10.1790370     0
# AS < Restoration           -11.48339 -11.701564 -11.2652116     0
# AS < Preservation           -1.02942  -1.254262  -0.8045776     0

HSD_WR=HSD.test(aov_soc_wr, trt="TOP", group=T, alpha=0.05)
HSD_WR
# AS                  SOC groups
# Restoration  11.828825      a
# AS            1.444064      b
# Preservation  1.374857      b
# Wetlands
# Restoration  11.8288254      a
# Preservation  1.3748573      b
# AS            0.3454376      c

# median
# AS: SOC_in_AS_rd/ forests: SOC_in_all_forest_rd
median_data <- rbind(data_soc_pres,data_soc_resto,SOC_in_all_wetland_rd) %>%
  group_by(TOP) %>%
  summarize(median_soc = median(SOC)) %>% as.data.frame()

# remove AS because chiant
median_data=median_data[-3,]

### SOC in pres & resto
#AS: SOC_in_AS_rd / wetlands: SOC_in_all_wetland_rd
p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,SOC_in_all_wetland_rd), aes(y=log10(SOC), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.7 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = log10(median_soc), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75)) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())
fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/SOC" ,"/geom_violin_wetlands_log_SOC_groups_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

p=ggplot() + geom_violin(data=rbind(data_soc_pres,data_soc_resto,SOC_in_all_wetland_rd), aes(y=SOC, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=42 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = (median_soc), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75)) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/SOC" ,"/geom_violin_wetlands_SOC_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)




```



### Carbon potential

```{r potential_carbon_wetland}
str(Carbon_saturation_cut_WGS84)



SOC_potential_wetland_cut=crop(Carbon_saturation_cut_WGS84, Wetland_in_AS_raster)
SOC_potential_wetland_cut_cut=resample(SOC_potential_wetland_cut, Wetland_in_AS_raster,method = 'ngb')

SOC_potential_masked_wetland=mask(SOC_potential_wetland_cut_cut, Wetland_in_AS_raster)

# writeRaster(SOC_potential_masked_wetland, "Path/to/working/directory/R/Export_data/Wetland/SOC_potential_masked_wetland.tif")
# SOC_potential_masked_wetland=raster("Path/to/working/directory/R/Export_data/Wetland/SOC_potential_masked_wetland.tif")

### SOC in TOP preservation wetland

SOC_potential_masked_wetland_top_preserv=mask(SOC_potential_masked_wetland, Anomalies2100_in_WS_raster_wetland_masked_top_pres)
# SOC_potential_masked_wetland_top_preserv@data@values=as.numeric(SOC_potential_masked_wetland_top_preserv@data@values)
boxplot(SOC_potential_masked_wetland_top_preserv)

sampleRandom(SOC_potential_masked_wetland_top_preserv,2000, na.rm=TRUE, xy=TRUE)

data_sop_pres=data.frame(SOP=SOC_potential_masked_wetland_top_preserv@data@values[-which(is.na(SOC_potential_masked_wetland_top_preserv@data@values))], TOP=as.factor("Preservation"))
colnames(data_sop_pres)=c("SOP", "TOP")

p=ggplot() + geom_violin(data=data_sop_pres, aes(y=SOP, x="Preservation"))
fx(p)

### SOC in TOP restoration wetland

SOC_potential_masked_wetland_top_resto=mask(SOC_potential_masked_wetland, Anomalies2100_in_WS_raster_wetland_masked_top_resto)
# SOC_potential_masked_wetland_top_resto@data@values=as.numeric(SOC_potential_masked_wetland_top_resto@data@values)
boxplot(SOC_potential_masked_wetland_top_resto)

# sampleRandom(SOC_potential_masked_wetland_top_resto,2000, na.rm=TRUE, xy=TRUE)

data_sop_resto=data.frame(SOP= SOC_potential_masked_wetland_top_resto@data@values[-which(is.na(SOC_potential_masked_wetland_top_resto@data@values))], TOP=as.factor("Restoration"))
colnames(data_sop_resto)=c("SOP", "TOP")

p=ggplot() + geom_violin(data=data_sop_resto, aes(y=SOP, x="Restoration"))
fx(p)

### SOC in pres & resto
p=ggplot() + geom_violin(data=rbind(data_sop_resto,data_sop_pres), aes(y=SOP, x=TOP))
fx(p)



# sample data in AS
SOP_in_AS=mask(Carbon_saturation_cut_WGS84, AS_fusion_WGS84)
SOP_in_AS_rd=data.frame(SOP=sampleRandom(SOP_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_AS_rd)=c("SOP", "TOP")

# sample data in wetlands
Wetland_in_AS_pente_inf35_cut=crop(Wetland_in_AS_raster, Carbon_saturation_cut_WGS84)
Wetland_in_AS_pente_inf35_cut_resample=resample(Carbon_saturation_cut_WGS84, Carbon_saturation_cut_WGS84, method = 'ngb')
SOP_in_wetland=mask(Carbon_saturation_cut_WGS84, Wetland_in_AS_pente_inf35_cut_resample)
summary(SOP_in_wetland)

SOP_in_wetland_rd=data.frame(SOP=sampleRandom(SOP_in_wetland, 10^5, na.rm=T, xy=F), TOP="AS")
colnames(SOP_in_wetland_rd)=c("SOP", "TOP")



## ANOVA
# AS: SOP_in_AS_rd / wetlands: SOP_in_wetland_rd
aov_sop_wr=aov(data=rbind(data_sop_resto,data_sop_pres,SOP_in_wetland_rd), SOP~TOP)
anova(aov_sop_wr)
# AS            Df  Sum Sq Mean Sq F value    Pr(>F)   
# TOP           2 168.75  84.377  2046.8 < 2.2e-16 ***
# Wetlands
# TOP           2  161.7  80.833  1613.9 < 2.2e-16 ***

TukeyHSD(aov_sop_wr)
# AS                              diff       lwr       upr      p adj
# Preservation>Restoration    0.22165989 0.20877590 0.2345439     0
# AS>Restoration              0.31861291 0.30667396 0.3305519     0
# AS>Preservation             0.09695302 0.08866123 0.1052448     0
# Wetlands
# Preservation>Restoration 0.2216599 0.20745953 0.23586025     0
# AS>Restoration           0.2819975 0.26981585 0.29417913     0
# AS>Preservation          0.0603376 0.05267208 0.06800312     0


HSD_WR=HSD.test(aov_sop_wr, trt="TOP", group=T, alpha=0.05)
HSD_WR
# AS                   SOC groups
# AS           0.8265389      a
# Preservation 0.7295859      b
# Restoration  0.5079260      c
# Wetlands
# AS           0.7899235      a
# Preservation 0.7295859      b
# Restoration  0.5079260      c



### SOC in pres & resto
# AS: SOP_in_AS_rd / wetlands: SOP_in_wetland_rd
median_data <- rbind(data_sop_pres,data_sop_resto,SOP_in_wetland_rd) %>%
  group_by(TOP) %>%
  summarize(median_sop = median(SOP)) %>% as.data.frame()


# AS: SOP_in_AS_rd / wetlands: SOP_in_wetland_rd
p=ggplot() + geom_violin(data=rbind(data_sop_pres,data_sop_resto,SOP_in_wetland_rd), aes(y=log10(SOP), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=0.05 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = log10(median_sop), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/SOP" ,"/geom_violin_wetlands_log_SOP_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

p=ggplot() + geom_violin(data=rbind(data_sop_pres,data_sop_resto,SOP_in_AS_rd), aes(y=SOP, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.05 ,label = c("a", "b", "b")),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = (median_sop), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))

fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/SOP" ,"/geom_violin_wetlands_SOP_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


p=ggplot() + geom_violin(data=rbind(data_sop_pres,data_sop_resto,SOP_in_forest_rd), aes(y=SOP, x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=1.05 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = (median_sop), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))



```



### NCP in wetland priority

```{r ncp_wetlands}


## Done with QGIS: join NCP values (AlpES layer) to priority areas shapefile

## Restoration priority area for wetland
Top_resto_WR=shapefile("Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_AS_TOP_resto_vector_NCP_WGS84.shp")

if (T %in% is.na(Top_resto_WR$A_3)){
  print('yes')
  Top_resto_WR=Top_resto_WR[-which(is.na(Top_resto_WR$A_3)),]
}


Top_resto_WR_df=Top_resto_WR@data
summary(Top_resto_WR_df)


Top_resto_WR_df$DN=as.numeric(Top_resto_WR_df$DN)
# quantile(as.numeric(Top_resto_WR_df$DN))
### To divide in two if too big (NO) :
# Top_resto_WR_df=Top_resto_WR_df[which(Top_resto_WR_df$DN<=quantile(Top_resto_WR_df$DN, 0.5)),]

# Top_resto_WR_df=Top_resto_WR_df[,-grep("NCP_Code_1", colnames(Top_resto_WR_df))]
Top_resto_WR_df$TOP=as.factor("Restoration")
# Top_resto_WR_df=Top_resto_WR_df[-which(is.na(Top_resto_WR_df$A_3)),]
# rownames(Top_resto_WR_df)=Top_resto_WR_df$fid


# Preservation priority area for wetland 
Top_preserv_WR=shapefile("Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_AS_TOP_preserv_vector_NCP_WGS84.shp")

if (T %in% is.na(Top_preserv_WR$A_3)){
  print('yes')
  Top_preserv_WR=Top_preserv_WR[-which(is.na(Top_preserv_WR$A_3)),]
}


Top_preserv_WR_df=Top_preserv_WR@data
colnames(Top_preserv_WR_df)

Top_preserv_WR_df$DN=as.numeric(Top_preserv_WR_df$DN)
quantile((Top_preserv_WR_df$DN))
# Top_preserv_WR_df=Top_preserv_WR_df[which(Top_preserv_WR_df$DN>=quantile(Top_preserv_WR_df$DN, 0.5)),]
nrow(Top_preserv_WR_df)

Top_preserv_WR_df$TOP=as.factor("Preservation")

### For both preservation and restoration
ncol(Top_resto_WR_df)==ncol(Top_preserv_WR_df)
colnames(Top_preserv_WR_df)=colnames(Top_resto_WR_df)
# rownames(Top_preserv_WR_df)=Top_preserv_WR_df$fid
# Top_preserv_WR_df=Top_preserv_WR_df[-which(is.na(Top_preserv_WR_df$A_3)),]

Top_df_WR=rbind(Top_resto_WR_df, Top_preserv_WR_df)
colnames(Top_df_WR)
Top_df_WR=Top_df_WR[,-c(1:4, 26:36)]
colnames(Top_df_WR)
# Top_df_WR=Top_df_WR[-is.na(Top_df_WR$A_3),]

# p=ggplot()
for (i in 1:(ncol(Top_df_WR)-1)){
  # p=p+geom_violin(aes(x=as.character(colnames(Top_df_WR)[i]),y=Top_df_WR[,i], fill=Top_df_WR$TOP))
  p=ggplot()+geom_violin(aes(x=as.character(colnames(Top_df_WR)[i]),y=Top_df_WR[,i], fill=Top_df_WR$TOP))
  fx(p)
}
# fx(p)

data_ncp_mean=Top_df_WR[1:2,-ncol(Top_df_WR)]
data_ncp_mean[1,]=apply(Top_df_WR[which(Top_df_WR$TOP=="Restoration"),-ncol(Top_df_WR)], 2, FUN="mean", na.rm=T)
data_ncp_mean[2,]=apply(Top_df_WR[which(Top_df_WR$TOP=="Preservation"),-ncol(Top_df_WR)], 2, FUN="mean", na.rm=T)
data_ncp_mean[3,]=apply(Top_df_WR[,-ncol(Top_df_WR)], 2, FUN="min", na.rm=T)
data_ncp_mean[4,]=apply(Top_df_WR[,-ncol(Top_df_WR)], 2, FUN="max", na.rm=T)

data_ncp_mean$TOP=c("Restoration","Preservation","Min","Max")



str(data_ncp_mean)

# x11()+par(mfrow=c(1,2))
radarchart(data_ncp_mean[c(4,3,1),-ncol(data_ncp_mean)], maxmin = T)
radarchart(data_ncp_mean[c(4,3,2),-ncol(data_ncp_mean)], maxmin = T)






```




### Clustering wetland NCP

```{r clustering_wetland}

for (i in 1:(ncol(Top_df_WR)-1)){
  print(nrow(Top_df_WR[is.na(Top_df_WR[,i]),]))
}
# Top_df_WR=Top_df_WR[-which(is.na(Top_df_WR$A_3)),]

Top_df_WR$A_2p1=Top_df_WR$A_2/(Top_df_WR$A_1+1)
Top_df_WR$B_2p1=Top_df_WR$B_2/(Top_df_WR$B_1+1)
Top_df_WR$C_2p1=Top_df_WR$C_2/(Top_df_WR$C_1+1)
# Top_df_WR$D_1_2
Top_df_WR$E_2p1=Top_df_WR$E_2/(Top_df_WR$E_1+1)
# Top_df_WR$F_1_2
Top_df_WR$G_2p1=Top_df_WR$G_2/(Top_df_WR$G_1+1)
Top_df_WR$H_2p1=Top_df_WR$H_2/(Top_df_WR$H_1+1)

str(Top_df_WR)
colnames(Top_df_WR)[22]
pca.agrof=PCA(Top_df_WR, graph=F, quali.sup = 22)

pca.var=pca.agrof$var
pca.ind=pca.agrof$ind

plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,3))
plot(pca.agrof,
     invisible = c("var", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(2,3))

plot(pca.agrof,
     invisible = c("var", "ind"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))

plot(pca.agrof,
     invisible = c("ind", "quali.sup"),
     cex = 0.8,                                    
     autoLab = "yes",
     axes=c(1,2))



# with cos2
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,2)
            # invisible=c("quali.sup"),
            )
fviz_pca_var(pca.agrof, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),  
            repel = TRUE, # Avoid text overlapping (slow)
            axes=c(1,3)
            # invisible=c("quali.sup"),
            )


eig.val <- pca.agrof$eig
barplot(eig.val[, 2], 
        names.arg = 1:nrow(eig.val), 
        main = "Variances Explained by Dimensions (%)",
        xlab = "Principal Dimensions",
        ylab = "Percentage of variances",
        col ="steelblue")
# Add connected line segments to the plot
lines(x = 1:nrow(eig.val), eig.val[, 2], 
      type = "b", pch = 19, col = "red")



##### Clustering

### All data
## with ratio:
# clust.agrof3=HCPC(PCA(Top_df_WR[,-c(23:ncol(Top_df_WR))], graph=F), metric="euclidean", nb.clust=3)
## without ratio
clust.agrof3=HCPC(PCA(Top_df_WR[,-c(22)], graph=F), metric="euclidean", nb.clust=3)


fviz_cluster(clust.agrof3,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = FALSE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
             )

plot(clust.agrof3, choice = "3D.map")

#test khi2
clust.agrof3$desc.var$test.chi2[which(as.integer(clust.agrof3$desc.var$test.chi2)<0.1),]

clust.agrof3$desc.var$category
######################
#######  C1  #########
######################
agrof.clust1=as.data.frame(clust.agrof3$desc.var$quanti$`1`)
agrof.clust1$Levers=rownames(agrof.clust1)
agrof.clust1$Signif=0
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test<0))]=-1
agrof.clust1$Signif[which((agrof.clust1$p.value<0.02) & (agrof.clust1$v.test>0))]=1
agrof.clust1$Signif=as.factor(agrof.clust1$Signif)
agrof.clust1$diff_mean=agrof.clust1$`Mean in category`-agrof.clust1$`Overall mean`

# A_2, A_3, A_2p1,C_3, D_1_2, D_3,G_3,  
# Water use, need and F/S, wood demand, water filtration and demand, outdoor demand 

######################
#######  C2  #########
######################
agrof.clust2=as.data.frame(clust.agrof3$desc.var$quanti$`2`)
agrof.clust2$Levers=rownames(agrof.clust2)
agrof.clust2$Signif=0
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test<0))]=-1
agrof.clust2$Signif[which((agrof.clust2$p.value<0.02) & (agrof.clust2$v.test>0))]=1
agrof.clust2$Signif=as.factor(agrof.clust2$Signif)
agrof.clust2$diff_mean=agrof.clust2$`Mean in category`-agrof.clust2$`Overall mean`

# E_2, E_1, E_2p1, E_3, H_2p1, H_2,  H_1
# Protective forest FSD-F/S, BD supply, use and F/S


######################
#######  C3  #########
######################
agrof.clust3=as.data.frame(clust.agrof3$desc.var$quanti$`3`)
agrof.clust3$Levers=rownames(agrof.clust3)
agrof.clust3$Signif=0
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test<0))]=-1
agrof.clust3$Signif[which((agrof.clust3$p.value<0.02) & (agrof.clust3$v.test>0))]=1
agrof.clust3$Signif=as.factor(agrof.clust3$Signif)
agrof.clust3$diff_mean=agrof.clust3$`Mean in category`-agrof.clust3$`Overall mean`

# A_1, B_2p1, B_2, B_1,B_3, C_1, C_2, C_2p1, E_2p1,E_1, F_1_2, H_1, G_1
# Water supply, grassland SFD and F/S, wood supply use (Cseq) and F/S, protective forest supply and F/S,  BD and outdoor recreation supply


### Summary:
# C1: Water use, need and F/S, wood demand, water filtration and demand, outdoor demand 

# C2: Protective forest FSD-F/S, BD supply, use and F/S

# C3: Water supply, grassland SFD and F/S, wood supply use (Cseq) and F/S, protective forest supply and F/S,  BD and outdoor recreation supply

### Export shp with clusters
## For restoration
# Top_resto_WR$DN=as.numeric(Top_resto_WR$DN)
# Top_resto_FM_50=Top_resto_FM[which(!is.na(Top_resto_FM$A_3) & Top_resto_FM$DN<=quantile(as.numeric(Top_resto_FM$DN), 0.5)),]


nrow(Top_resto_WR)+nrow(Top_preserv_WR)==nrow(clust.agrof3$data.clust)
Top_resto_WR$cluster=NA


# Top_df_FM=rbind(Top_resto_FM_df, Top_preserv_FM_df)
Top_resto_WR$cluster=clust.agrof3$data.clust$clust[1:nrow(Top_resto_WR@data)]


summary(as.factor(Top_resto_WR$cluster))
#  1  2  3 
# 78  0  5 
p=spplot(Top_resto_WR, zcol=c("cluster"))

# shapefile(Top_resto_WR, "Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_TOP_resto_NCP_clust_WGS84.shp")

## For preservation
# Top_preserv_FM_df=Top_preserv_FM_df[which(Top_preserv_FM_df$DN>=quantile(Top_preserv_FM_df$DN, 0.5)),]
# Top_preserv_WR=Top_preserv_FM[which(!is.na(Top_preserv_FM$A_3) & Top_preserv_FM$DN>=quantile(as.numeric(Top_preserv_FM$DN), 0.5)),]
Top_preserv_WR$cluster=NA
Top_preserv_WR$cluster=clust.agrof3$data.clust$clust[(nrow(Top_resto_WR@data)+1):nrow(clust.agrof3$data.clust)]


summary(as.factor(Top_preserv_WR$cluster))
# 1   2   3 
# 118   7 112
p=spplot(Top_preserv_FM, zcol=c("cluster"))


### Export in shp


shapefile(Top_preserv_WR, "Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_TOP_preserv_NCP_clust_WGS84.shp")


### Radarchart of NCP for each clusters ??

colnames(Top_preserv_WR@data)
colnames(Top_resto_WR@data)

data_ncp_mean=rbind(Top_preserv_WR@data[,-c(1:4,26:36)], Top_resto_WR@data[,-c(1:4,26:36)])
data_radar=data_ncp_mean[1:5,-ncol(data_ncp_mean)]
data_radar[1,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="max")
data_radar[2,]=apply(data_ncp_mean[,-ncol(data_ncp_mean)], 2, FUN="min")

data_radar[3,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==1),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[4,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==2),-ncol(data_ncp_mean)], 2, FUN="mean")
data_radar[5,]=apply(data_ncp_mean[which(data_ncp_mean$cluster==3),-ncol(data_ncp_mean)], 2, FUN="mean")


data_radar$TOP=c("Max", "Min", "C1","C2", "C3")

# color_border_hexadec=c("#b200f8", "#5dbdfc", "#71daa7")
colors_border=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255))
colors_in=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.4*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.4*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.4*255))

colnames(data_radar)[22]
# radarchart(data_radar[3:5,-c(22,ncol(data_radar))], maxmin = F,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

radarchart(data_radar[,-c(22,ncol(data_radar))], maxmin = T,  pcol=colors_border , pfcol=colors_in , plwd=4, plty=1) 

legend(x="right", y=1, legend = c("C1", "C2", "C3"),col=colors_border, bty = "n", pch=20 , text.col = "black", cex=0.9, pt.cex=1.6)

## Color clusters

color_clusters=palette.colors(palette="Set2")
color_clusters=palette.colors(palette="Set1")
Hillsides_out= rgb(102, 194, 165, maxColorValue = 255)
Hillsides_in= rgb(102, 194, 165, maxColorValue = 255, alpha=0.4*255)
Populated_out= rgb(252, 141, 98, maxColorValue = 255)
Populated_in= rgb(252, 141, 98, maxColorValue = 255, alpha=0.4*255)
Touristic_out= rgb(141, 160, 203, maxColorValue = 255)
Touristic_in= rgb(141, 160, 203, maxColorValue = 255, alpha=0.4*255)
Productive_out=rgb(231, 138, 195, maxColorValue = 255)
Productive_in=rgb(231, 138, 195, maxColorValue = 255, alpha=0.4*255)
Rural_out= rgb(166, 216, 84, maxColorValue = 255)
Rural_in= rgb(166, 216, 84, maxColorValue = 255, alpha=0.4*255)
Wetland_out=rgb(189, 97, 202, maxColorValue = 255)
Wetland_in=rgb(189, 97, 202, maxColorValue = 255, alpha=0.4*255)
# Rural_out=rgb(255, 217, 47, maxColorValue = 255)
# Rural_in=rgb(255, 217, 47, maxColorValue = 255, alpha=0.4*255)

color_wetlands_out=c(Populated_out, Wetland_out, Productive_out)
color_wetlands_in=c(Populated_in, Wetland_in, Productive_in)

radarchart(data_radar[,-c(22,23,ncol(data_radar))],seg=3,maxmin = T,  pcol=color_wetlands_out , pfcol=color_wetlands_in , plwd=4, plty=1, vlabels = " ", cglty=1, cglcol="black")



```

### Prop clusters


```{r prop_clusters_wetlands}
colnames(Top_preserv_WR@data)
colnames(Top_resto_WR@data)


data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Top_preserv_WR@data$Area[which(Top_preserv_WR@data$cluster==i)], na.rm=T), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Top_resto_WR@data$Area[which(Top_resto_WR@data$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)

data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))
 

### Test with new area calculated
Area_preserv=data.frame(i=Top_preserv_WR$fid, area=NA)
for (i in 1:nrow(Top_preserv_WR@data)){
  Area_preserv$area[i]=raster::area(Top_preserv_WR[i,])
  
}

Area_resto=data.frame(i=Top_resto_WR$fid, area=NA)
for (i in 1:nrow(Top_resto_WR@data)){
  Area_resto$area[i]=raster::area(Top_resto_WR[i,])
  
}



data_prop_preserv_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
data_prop_resto_clust=data.frame(TOP=NA, Area=NA, Cluster=NA)
for (i in 1:3){
  data_prop_preserv_clust[i,]=c("Preservation", sum(Area_preserv$area[which(Top_preserv_WR$cluster==i)]), i)
  data_prop_resto_clust[i,]=c("Restoration", sum(Area_resto$area[which(Top_resto_WR$cluster==i)]), i)
}

data_prop_preserv_clust$Area=as.numeric(data_prop_preserv_clust$Area)
data_prop_preserv_clust$Prop=100*data_prop_preserv_clust$Area/sum(data_prop_preserv_clust$Area)
data_prop_resto_clust$Area=as.numeric(data_prop_resto_clust$Area)
data_prop_resto_clust$Prop=100*data_prop_resto_clust$Area/sum(data_prop_resto_clust$Area)


data_prop_clust=rbind(data_prop_preserv_clust, data_prop_resto_clust)

# khi2
khi_prop_clust=cbind(data_prop_clust$Area[1:3], data_prop_clust$Area[4:6])
khi_prop_clust_test=chisq.test(khi_prop_clust) # p-value < 2.2e-16
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("1", "2", "3")
khi_prop_clust_res

# Label preserv
label_pres=c(data_prop_preserv_clust$Prop[3]/2,
             data_prop_preserv_clust$Prop[3]+(data_prop_preserv_clust$Prop[2]/2),
             data_prop_preserv_clust$Prop[3]+data_prop_preserv_clust$Prop[2]+(data_prop_preserv_clust$Prop[1]/2)
             )
label_resto=c(data_prop_resto_clust$Prop[3]/2,
             # 1+data_prop_resto_clust$Prop[3]+(data_prop_resto_clust$Prop[2]/2),
             data_prop_resto_clust$Prop[3]+data_prop_resto_clust$Prop[2]+(data_prop_resto_clust$Prop[1]/2)
             )


p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255))) +
   theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(data_prop_preserv_clust$Prop[c(3,2,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(data_prop_resto_clust$Prop[c(3,1)],0))), size=10)


fx(p)
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/Clusters" ,"/geom_bar_clusters_prop_wetlands_prop", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)




## ANOVA
data_prop_preserv_clust$TOP=as.factor(data_prop_preserv_clust$TOP)
data_prop_preserv_clust$Cluster=as.factor(data_prop_preserv_clust$Cluster)
data_prop_resto_clust$TOP=as.factor(data_prop_resto_clust$TOP)
data_prop_resto_clust$Cluster=as.factor(data_prop_resto_clust$Cluster)

# aov_clust_wr=aov(data=rbind(data_prop_preserv_clust, data_prop_resto_clust), Area~TOP:Cluster)
# anova(aov_clust_wr)
Top_preserv_WR$TOP=factor("Preservation")
Top_resto_WR$TOP=factor("Restoration")

aov_clust_wr=aov(data=rbind(Top_preserv_WR@data, Top_resto_WR@data), Area~TOP*cluster)
anova(aov_clust_wr)

#              Df     Sum Sq    Mean Sq F value    Pr(>F)    
# TOP           1 1.4945e+09 1494501906 21.2351 5.909e-06 ***
# cluster       2 5.7861e+08  289305690  4.1107   0.01728 *  
# TOP:cluster   1 7.0064e+07   70063726  0.9955   0.31916   

TukeyHSD(aov_clust_wr)
#                                 diff       lwr       upr      p adj
# Restoration > Preservation  4930.716 2825.47 7035.963 5.9e-06
# 2 = 1                       4134.100  -3464.871 11733.07097 0.4068840
# 3 <? 1                      -2227.179  -4535.175    80.81715 0.0612182
# 3 + 2                       -6361.279 -14048.205  1325.64748 0.1269132

HSD_WR=HSD.test(aov_clust_wr, trt="TOP", group=T, alpha=0.05)

# Area groups
# Restoration  8305.106      a
# Preservation 3374.389      b

label_preserv=c(data_prop_preserv_clust$Prop[3]/2,data_prop_preserv_clust$Prop[3] + data_prop_preserv_clust$Prop[2]/2,data_prop_preserv_clust$Prop[3] +data_prop_preserv_clust$Prop[2]+ data_prop_preserv_clust$Prop[1]/2 )

label_resto=c(data_prop_resto_clust$Prop[3]/2,data_prop_resto_clust$Prop[3] +data_prop_resto_clust$Prop[2]+ data_prop_resto_clust$Prop[1]/2 )


### With cluster colors
p=ggplot() +
  geom_bar(data=data_prop_preserv_clust, aes(x="Preservation",fill=Cluster,y=Prop), stat ='identity') +
  geom_bar(data=data_prop_resto_clust, aes(x="Restoration",fill=Cluster,y=Prop), stat ='identity') +
  scale_fill_manual(values=color_wetlands_out) +theme_bw() +
  geom_text(aes(x="Preservation", y=label_preserv, label=as.character(round(data_prop_preserv_clust$Prop[c(3,2,1)],0))), size=10)+
  geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(data_prop_resto_clust$Prop[c(3,1)],0))), size=10)+
  theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)  

# ggsave(plot=p, filename = paste(dossier_wr, "/Figure/Clusters" ,"/geom_bar_prop_NCP_clusters_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/Clusters" ,"/geom_bar_prop_NCP_clusters_groups_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)





```

### Distrib elevation

```{r elevation_wetlands}

### in function of elevation

Top_resto_WR$Elev=NA
for (i in 1:nrow(Top_resto_WR@data)){
  Top_resto_WR$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_resto_WR[i,], fun=mean, na.rm=T)
}

Top_preserv_WR$Elev=NA
for (i in 1:nrow(Top_preserv_WR@data)){
  Top_preserv_WR$Elev[i]=raster::extract(Elevation_cut_WGS84, Top_preserv_WR[i,], fun=mean, na.rm=T)
}
summary(Top_resto_WR$Elev)
summary(Top_preserv_WR$Elev)


# random data in AS
Elev_in_AS=mask(Elevation_cut_WGS84, AS_fusion_WGS84)
Elev_in_AS_rd=data.frame(Elev=sampleRandom(Elev_in_AS, 10000, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_AS_rd)=c("Elev", "TOP")  

# Elev in wetlands
Wetland_in_AS_cut=crop(Wetland_in_AS_pente_inf35_cut_resample, Elevation_cut_WGS84)
Wetland_in_AS_cut_resample=resample(Wetland_in_AS_cut, Elevation_cut_WGS84, method = 'ngb')
Elev_in_wetland=mask(Elevation_cut_WGS84, Wetland_in_AS_cut_resample)
summary(Elev_in_wetland)
length(Elev_in_wetland)
length(Elev_in_wetland@data@values[-which(is.na(Elev_in_wetland@data@values))])/length(Elev_in_wetland) # 982632 = 79%
Elev_in_wetland_rd=data.frame(Elev=sampleRandom(Elev_in_wetland, 10^5, na.rm=T, xy=F), TOP=factor("AS"))
colnames(Elev_in_wetland_rd)=c("Elev", "TOP")  
Elev_in_wetland_rd$TOP=as.factor(Elev_in_wetland_rd$TOP)  


## ANOVA
# AS: Elev_in_AS_rd / wetlands: Elev_in_wetland_rd
aov_elev_wr=aov(data=rbind(Top_preserv_WR@data[,c(38,39)], Top_resto_WR@data[,c(38,39)], Elev_in_wetland_rd), Elev~TOP)
anova(aov_elev_wr)

# AS             Df     Sum Sq    Mean Sq F value    Pr(>F)    
# TOP           2   53825804 26912902  57.815 < 2.2e-16 ***
# Wetlands
# TOP            2 1.7356e+07 8678197  26.337 3.672e-12 ***

TukeyHSD(aov_elev_wr)
# AS                            diff       lwr       upr      p adj
# Restoration < Preservation -341.9252 -545.9051 -137.9454 0.0002529
# AS > Preservation           299.1412  194.0328  404.2496 0.0000000
# AS > Restoration            641.0665  464.7953  817.3376 0.0000000
# Wetlands
# Restoration < Preservation -341.92525 -513.516074 -170.3344 0.0000090
# AS > Preservation            89.86708    2.374314  177.3598 0.0424772
# AS > Restoration            431.79233  284.060728  579.5239 0.0000000

HSD_WR=HSD.test(aov_elev_wr, trt="TOP", group=T, alpha=0.05)
HSD_WR
# AS                Elev groups
# AS           828.2557      a
# Preservation 529.1145      b
# Restoration  187.1892      c
# Wetlands       
# AS           618.9816      a
# Preservation 529.1145      b
# Restoration  187.1892      c


median_data <- rbind(Top_preserv_WR@data[,c(38,39)], Top_resto_WR@data[,c(38,39)], Elev_in_wetland_rd) %>%
  group_by(TOP) %>%
  summarize(median_elev = median(Elev, na.rm=T)) %>% as.data.frame()

## PLOT
# AS: Elev_in_AS_rd / Elev_in_wetland_rd
p=ggplot() + 
  geom_violin(data=rbind(Top_preserv_WR@data[,c(38,39)], Top_resto_WR@data[,c(38,39)], Elev_in_wetland_rd), aes(x=TOP, y=Elev, fill=TOP))+
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=4600 ,label = c("a", "b", "c")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  scale_x_discrete(labels = c("Surplus", "Deficit", "AS")) +
  geom_point(data =median_data , aes(y = median_elev, x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))+
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())


fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/Elev" ,"/geom_violin_wetlands_Elev_wetlands", ".png", sep=''), width=10*2, height=8*2, limitsize=F, dpi = 300)



```


### In protected area

```{r wetland_pa}
## done in QGIS: join protected area attribute (layer WDPA) to priority areas shapefile

Top_resto_WR_PA=shapefile("Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_AS_TOP_resto_vector_NCP_WDPA_WGS84.shp")

Top_resto_WR_PA_df=Top_resto_WR_PA@data
levels(as.factor(Top_resto_WR_PA_df$IUCN_CAT))
# "II"             "IV"             "Not Applicable" "Not Assigned"  
# [5] "Not Reported"
# Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="Ia")]=1
# Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="Ib")]=1
Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="II")]=2
# Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="III")]=3
Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="IV")]=4
# Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="V")]=5
# Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="VI")]=6
Top_resto_WR_PA_df$IUCN_CAT[which(is.na(Top_resto_WR_PA_df$IUCN_CAT))]=0
Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="Not Applicable")]=NA
Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="Not Assigned")]=NA
Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$IUCN_CAT=="Not Reported")]=NA

Top_resto_WR_PA_df$IUCN_CAT=as.integer(Top_resto_WR_PA_df$IUCN_CAT)

levels_fid=levels(as.factor(Top_resto_WR_PA_df$fid))
for (i in 1:nlevels(as.factor(Top_resto_WR_PA_df$fid))){
  if (nrow(Top_resto_WR_PA_df[which(Top_resto_WR_PA_df$fid==levels_fid[i]),])>1){
    data_sans_0=Top_resto_WR_PA_df$IUCN_CAT[which(Top_resto_WR_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    
    if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
    if (F %in% is.na(data_sans_0)){
    min_level=min(data_sans_0, na.rm=T)
   
    
     Top_resto_WR_PA_df=Top_resto_WR_PA_df[-which(Top_resto_WR_PA_df$fid==levels_fid[i] & (is.na(Top_resto_WR_PA_df$IUCN_CAT) | Top_resto_WR_PA_df$IUCN_CAT != min_level)),]
    }
    if ((T %in% !is.na(data_sans_0))==F){
      Top_resto_WR_PA_df=Top_resto_WR_PA_df[-grep(levels_fid[i], Top_resto_WR_PA_df$fid)[1],]
    }
    }
    
    if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
      Top_resto_WR_PA_df=Top_resto_WR_PA_df[-grep(levels_fid[i], Top_resto_WR_PA_df$fid)[-1],]
    }
     
  }
  
}


Top_resto_WR_PA_sum=as.data.frame(summary(as.factor(Top_resto_WR_PA_df$IUCN_CAT)))
colnames(Top_resto_WR_PA_sum)=c("nb")
# Top_resto_WR_PA_sum=t(Top_resto_WR_PA_sum)
p=ggplot(Top_resto_WR_PA_sum) + geom_bar(aes(x="Restoration", y=nb, fill=rownames(Top_resto_WR_PA_sum)), stat="identity")



### For preservation
Top_preserv_WR_PA=shapefile("Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_AS_TOP_preserv_vector_NCP_WDPA_WGS84.shp")

Top_preserv_WR_PA_df=Top_preserv_WR_PA@data

levels(as.factor(Top_preserv_WR_PA_df$IUCN_CAT))
 # "Ia"           "IV"           "Not Assigned" "Not Reported"
Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$IUCN_CAT=="Ia")]=1
# Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$IUCN_CAT=="Ib")]=1
# Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$IUCN_CAT=="II")]=2
Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$IUCN_CAT=="IV")]=4
# Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$IUCN_CAT=="V")]=5
Top_preserv_WR_PA_df$IUCN_CAT[which(is.na(Top_preserv_WR_PA_df$IUCN_CAT))]=0

Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$IUCN_CAT=="Not Assigned")]=NA
Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$IUCN_CAT=="Not Reported")]=NA

Top_preserv_WR_PA_df$IUCN_CAT=as.integer(Top_preserv_WR_PA_df$IUCN_CAT)


levels_fid=levels(as.factor(Top_preserv_WR_PA_df$fid))
for (i in 1:nlevels(as.factor(Top_preserv_WR_PA_df$fid))){
  print(i)
  print(nrow(Top_preserv_WR_PA_df))
  print(nrow(Top_preserv_WR_PA_df[which(Top_preserv_WR_PA_df$fid==levels_fid[i]),])>1)
  if (nrow(Top_preserv_WR_PA_df[which(Top_preserv_WR_PA_df$fid==levels_fid[i]),])>1){
    data_sans_0=Top_preserv_WR_PA_df$IUCN_CAT[which(Top_preserv_WR_PA_df$fid==levels_fid[i])]
    if (0 %in% data_sans_0){
      data_sans_0=data_sans_0[-which(data_sans_0==0)]
    }
    if (min(data_sans_0, na.rm=T)!=max(data_sans_0, na.rm=T)){
      if (F %in% is.na(data_sans_0)){
      min_level=min(data_sans_0, na.rm=T)
     
      
       Top_preserv_WR_PA_df=Top_preserv_WR_PA_df[-which(Top_preserv_WR_PA_df$fid==levels_fid[i] & (is.na(Top_preserv_WR_PA_df$IUCN_CAT) | Top_preserv_WR_PA_df$IUCN_CAT != min_level)),]
      }
      if ((T %in% !is.na(data_sans_0))==F){
        Top_preserv_WR_PA_df=Top_preserv_WR_PA_df[-grep(levels_fid[i], Top_preserv_WR_PA_df$fid)[-1],]
      }
      
    }
    
    if (min(data_sans_0, na.rm=T)==max(data_sans_0, na.rm=T)){
      Top_preserv_WR_PA_df=Top_preserv_WR_PA_df[-grep(levels_fid[i], Top_preserv_WR_PA_df$fid)[-1],]
    }
    }
  
  
}

nrow(Top_preserv_WR_PA_df)

Top_preserv_WR_PA_sum=as.data.frame(summary(as.factor(Top_preserv_WR_PA_df$IUCN_CAT)))


colnames(Top_preserv_WR_PA_sum)=c("nb")
# Top_preserv_WR_PA_sum=t(Top_preserv_WR_PA_sum)
p=ggplot(Top_preserv_WR_PA_sum) + geom_bar(aes(x="Preservation", y=nb, fill=rownames(Top_preserv_WR_PA_sum)), stat="identity")


### Both preserv and resto
p=ggplot() + geom_bar(data=Top_preserv_WR_PA_sum, aes(x="Preservation", y=nb, fill=rownames(Top_preserv_WR_PA_sum)), stat="identity") +
  geom_bar(data=Top_resto_WR_PA_sum, aes(x="Restoration", y=nb, fill=rownames(Top_resto_WR_PA_sum)), stat="identity")


Top_preserv_WR_PA_sum$TOP="Preservation"
Top_preserv_WR_PA_sum$TOP="Surplus"
Top_preserv_WR_PA_sum$PA=rownames(Top_preserv_WR_PA_sum)
Top_resto_WR_PA_sum$TOP="Restoration"
Top_resto_WR_PA_sum$TOP="Deficit"
Top_resto_WR_PA_sum$PA=rownames(Top_resto_WR_PA_sum)
Top_WR_PA_sum=rbind(Top_preserv_WR_PA_sum,Top_resto_WR_PA_sum)
## Geom_bar


# Label preserv
label_pres=c(Top_preserv_WR_PA_sum$nb[4]/2,
             Top_preserv_WR_PA_sum$nb[4]+(Top_preserv_WR_PA_sum$nb[3]/2),
             Top_preserv_WR_PA_sum$nb[4]+Top_preserv_WR_PA_sum$nb[3]+(Top_preserv_WR_PA_sum$nb[2]/2),
             Top_preserv_WR_PA_sum$nb[4]+Top_preserv_WR_PA_sum$nb[3]+Top_preserv_WR_PA_sum$nb[2]+(Top_preserv_WR_PA_sum$nb[1]/2)
             )
# Label resto
label_resto=c(Top_resto_WR_PA_sum$nb[4]/2,
             Top_resto_WR_PA_sum$nb[4]+(Top_resto_WR_PA_sum$nb[3]/2),
             Top_resto_WR_PA_sum$nb[4]+Top_resto_WR_PA_sum$nb[3]+(Top_resto_WR_PA_sum$nb[2]/2),
             Top_resto_WR_PA_sum$nb[4]+Top_resto_WR_PA_sum$nb[3]+Top_resto_WR_PA_sum$nb[2]+(Top_resto_WR_PA_sum$nb[1]/2)
            )

# # To have colour in good order => do not work
# Top_WR_PA_sum$PA=factor(Top_WR_PA_sum$PA, levels=c("0","1","2","3","4","5","6","NA's"))
# Top_WR_PA_sum=rbind(Top_WR_PA_sum, c(0, "Surplus", "3"))
# Top_WR_PA_sum=rbind(Top_WR_PA_sum, c(0, "Deficit", "3"))
# Top_WR_PA_sum=rbind(Top_WR_PA_sum, c(0, "Surplus", "5"))
# Top_WR_PA_sum=rbind(Top_WR_PA_sum, c(0, "Deficit", "5"))
# Top_WR_PA_sum=rbind(Top_WR_PA_sum, c(0, "Surplus", "6"))
# Top_WR_PA_sum=rbind(Top_WR_PA_sum, c(0, "Deficit", "6"))

# Color
color_values=c(rgb(128,128,128, maxColorValue=255))
color_values=c(color_values, palette.colors(palette="Dark2", n=length(unique(Top_WR_PA_sum$PA))-1))

# color_values=color_values[-c(4,6,7)] => do not work

Top_WR_PA_sum$TOP=as.factor(Top_WR_PA_sum$TOP)
Top_WR_PA_sum$PA=as.factor(Top_WR_PA_sum$PA)
Top_WR_PA_sum$nb=as.integer(Top_WR_PA_sum$nb)

p=ggplot() + geom_bar(data=Top_WR_PA_sum, aes(x=TOP, y=nb, fill=PA), stat="identity")+scale_fill_manual(values=color_values)+
  scale_x_discrete(limits = c("Surplus", "Deficit")) +
   theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) 
# +
  # geom_text(aes(x="Preservation", y=label_pres, label=as.character(round(Top_preserv_WR_PA_sum$nb[c(4,3,2,1)],0))), size=10)+
  # geom_text(aes(x="Restoration", y=label_resto, label=as.character(round(Top_resto_WR_PA_sum$nb[c(4,3,2,1)],0))), size=10)


ggsave(plot=p, filename = paste(dossier_wr, "/Figure/PA" ,"/geom_bar_PA_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


#### Test stats
TOP_PA=data.frame(IUCN_CAT=0:7, Pres=NA, Resto=NA)
for (i in (1:7)){
  if ((i-1) %in% Top_preserv_WR_PA_sum$PA){
  TOP_PA$Pres[i]=Top_preserv_WR_PA_sum$nb[which(Top_preserv_WR_PA_sum$PA==as.character(i-1))]
  } else {TOP_PA$Pres[i]=0}
  
    if ((i-1) %in% Top_resto_WR_PA_sum$PA){
  TOP_PA$Resto[i]=Top_resto_WR_PA_sum$nb[which(Top_resto_WR_PA_sum$PA==as.character(i-1))]
    } else {TOP_PA$Resto[i]=0}
}
TOP_PA$Pres[8]=Top_preserv_WR_PA_sum$nb[which(Top_preserv_WR_PA_sum$PA=="NA's")]
TOP_PA$Resto[8]=Top_resto_WR_PA_sum$nb[which(Top_resto_WR_PA_sum$PA=="NA's")]




khi_prop_clust=TOP_PA[,-1]
# khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust) # p-value < 2.2e-16
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c(0,1,2,4,"Not categorised")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#                   Preservation Restoration
# 0                         15          12
# 1                          1           1
# 2                         31          25
# 4                          9           7
# Not categorised            0           0

# >10 => significant



```


### BD

```{r bd_wetlands}

### BD in TOP RESTORATION 

Top_resto_WR_BD=shapefile("Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_AS_TOP_resto_vector_NCP_BD_art17_WGS84.shp")

Top_resto_WR_BD_df=Top_resto_WR_BD@data


table(Top_resto_WR_BD_df[,c(grep("cluster", colnames(Top_resto_WR_BD_df)),grep("conclusion", colnames(Top_resto_WR_BD_df)))])

# cluster U1 U2
#       1 50 28
#       3  0  5

Top_resto_WR_BD_sum=as.data.frame(table(Top_resto_WR_BD_df[,c(grep("cluster", colnames(Top_resto_WR_BD_df)),grep("conclusion", colnames(Top_resto_WR_BD_df)))]))
sum(Top_resto_WR_BD_sum$Freq) # 83 => ok

# ONly two clusters: 1 and 2
p=ggplot(Top_resto_WR_BD_sum) + geom_bar(aes(x=conclusion, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               # rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))

# No FV and no XX
Top_resto_WR_BD_summary=data.frame(conclusion=c("U1", "U2"), Freq=NA)
Top_resto_WR_BD_summary$conclusion=as.factor(Top_resto_WR_BD_summary$conclusion)
for (i in 1:nrow(Top_resto_WR_BD_summary)){
  Top_resto_WR_BD_summary$Freq[i]=sum(Top_resto_WR_BD_sum$Freq[which(Top_resto_WR_BD_sum$conclusion==Top_resto_WR_BD_summary$conclusion[i])])
}

p=ggplot(Top_resto_WR_BD_summary) + geom_bar(aes(x="Restoration", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(
  # rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))


## BD in TOP PRESERVATION


Top_preserv_WR_BD=shapefile("Path/to/working/directory/R/Export_data/Wetland/Anomalies_wetland_AS_TOP_preserv_vector_NCP_BD_art17_WGS84.shp")

Top_preserv_WR_BD_df=Top_preserv_WR_BD@data
str(Top_preserv_WR_BD_df)

table(Top_preserv_WR_BD_df[,c(grep("cluster", colnames(Top_preserv_WR_BD_df)),grep("conclusion", colnames(Top_preserv_WR_BD_df)))])
# cluster FV U1 U2
#       1  2 18 89
#       2  0  5  2
#       3  0 18 94

Top_preserv_WR_BD_sum=as.data.frame(table(Top_preserv_WR_BD_df[,c(grep("cluster", colnames(Top_preserv_WR_BD_df)),grep("conclusion", colnames(Top_preserv_WR_BD_df)))]))
sum(Top_preserv_WR_BD_sum$Freq) # 228 => ok


p=ggplot(Top_preserv_WR_BD_sum) + geom_bar(aes(x=conclusion, y=Freq, fill=cluster), stat="identity") + scale_fill_manual(values=c(rgb(178, 0, 248, maxColorValue = 255, alpha=0.9*255),
               rgb(93, 189, 252, maxColorValue = 255, alpha=0.9*255),
               rgb(113, 218, 167, maxColorValue = 255, alpha=0.9*255)))


# No XX
Top_preserv_WR_BD_summary=data.frame(conclusion=c("FV", "U1", "U2"), Freq=NA)
Top_preserv_WR_BD_summary$conclusion=as.factor(Top_preserv_WR_BD_summary$conclusion)
for (i in 1:nrow(Top_preserv_WR_BD_summary)){
  Top_preserv_WR_BD_summary$Freq[i]=sum(Top_preserv_WR_BD_sum$Freq[which(Top_preserv_WR_BD_sum$conclusion==Top_preserv_WR_BD_summary$conclusion[i])])
}

p=ggplot(Top_preserv_WR_BD_summary) + geom_bar(aes(x="Preservation", y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255)))

### GRAPH WITH RESTO and PRESERV

Top_preserv_WR_BD_summary$TOP="Preservation"
Top_preserv_WR_BD_summary$TOP="Surplus"
Top_resto_WR_BD_summary$TOP="Restoration"
Top_resto_WR_BD_summary$TOP="Deficit"
Top_WR_BD_summary=rbind(Top_preserv_WR_BD_summary, Top_resto_WR_BD_summary)

Top_preserv_WR_BD_summary$Prop=100*Top_preserv_WR_BD_summary$Freq/sum(Top_preserv_WR_BD_summary$Freq)
Top_resto_WR_BD_summary$Prop=100*Top_resto_WR_BD_summary$Freq/sum(Top_resto_WR_BD_summary$Freq)

# Label preserv
label_pres=c(Top_preserv_WR_BD_summary$Freq[3]/2,
             Top_preserv_WR_BD_summary$Freq[3]+(Top_preserv_WR_BD_summary$Freq[2]/2),
             Top_preserv_WR_BD_summary$Freq[3]+Top_preserv_WR_BD_summary$Freq[2]+(Top_preserv_WR_BD_summary$Freq[1]/2)
             )
# Label resto
label_resto=c(Top_resto_WR_BD_summary$Freq[2]/2,
             Top_resto_WR_BD_summary$Freq[2]+(Top_resto_WR_BD_summary$Freq[1]/2)
             )

p=ggplot() + geom_bar(data=Top_WR_BD_summary, aes(x=TOP, y=Freq, fill=conclusion), stat="identity") + scale_fill_manual(values=c(rgb(0, 128, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 165, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  scale_x_discrete(limits = c("Surplus", "Deficit")) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())
  # +geom_text(aes(x="Surplus", y=label_pres, label=as.character(round(Top_preserv_WR_BD_summary$Prop[c(3,2,1)],0))), size=10)
  # +geom_text(aes(x="Deficit", y=label_resto, label=as.character(round(Top_resto_WR_BD_summary$Prop[c(2,1)],0))), size=10)

fx(p)
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/BD" ,"/geom_bar_BD_prop_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


#### Test stats
TOP_BD=data.frame(IUCN_CAT=c("FV", "U1", "U2", "XX"), Pres=NA, Resto=NA)

for (i in (1:4)){
  if (TOP_BD$IUCN_CAT[i] %in% Top_preserv_WR_BD_summary$conclusion){
  TOP_BD$Pres[i]=Top_preserv_WR_BD_summary$Freq[which(Top_preserv_WR_BD_summary$conclusion==TOP_BD$IUCN_CAT[i])]
  } else {TOP_BD$Pres[i]=0}
  
    if (TOP_BD$IUCN_CAT[i] %in% Top_resto_WR_BD_summary$conclusion){
  TOP_BD$Resto[i]=Top_resto_WR_BD_summary$Freq[which(Top_resto_WR_BD_summary$conclusion==TOP_BD$IUCN_CAT[i])]
    } else {TOP_BD$Resto[i]=0}
}

# IUCN_CAT Pres Resto
# 1       FV    2     0
# 2       U1   41    50
# 3       U2  185    33
# 4       XX    0     0

## Sans XX
TOP_BD=TOP_BD[-4,]

khi_prop_clust=TOP_BD[,-1]
# khi_prop_clust=khi_prop_clust[-which(apply(khi_prop_clust, 1, "sum")==0),]
khi_prop_clust_test=chisq.test(khi_prop_clust)
khi_prop_clust_res=khi_prop_clust_test$residuals^2 
colnames(khi_prop_clust_res)=c("Preservation", "Restoration")
rownames(khi_prop_clust_res)=c("FV", "U1", "U2")
round(100*khi_prop_clust_res/sum(khi_prop_clust_res),0) 
#  Preservation Restoration
# FV            0           1
# U1           19          52
# U2            8          21
# >10 => significant

# Sans XX
#         Preservation Restoration
# FV           22          25
# U1           15          17
# U2           10          11



```


### BD-CCMa

```{r bd_ccm_wetland}

###### BD VS current carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_actual_masked_top_preserv_WR_FV=mask(SOC_actual_masked_wetland, Top_preserv_WR_BD[which(Top_preserv_WR_BD$conclusion=="FV"),])
# SOC_actual_masked_top_preserv_WR_FV=SOC_actual_masked_top_preserv_WR_FV[-which(is.na(SOC_actual_masked_top_preserv_WR_FV@data@values)),]
# SOC_actual_masked_top_preserv_WR_FV@data@values=as.numeric(SOC_actual_masked_top_preserv_WR_FV@data@values) # 7526 values
length(SOC_actual_masked_top_preserv_WR_FV)
# boxplot(SOC_actual_masked_top_preserv_WR_FV) 

# sampleRandom(SOC_actual_masked_top_preserv_WR_FV,2000, na.rm=TRUE, xy=TRUE)


data_soc_preserv_WR_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_WR_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")
colnames(data_soc_preserv_WR_FV)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_WR_FV, aes(y=SOC, x="Preservation FV"))
fx(p)

remove(SOC_actual_masked_top_preserv_WR_FV)

## In U1 state
SOC_actual_masked_top_preserv_WR_U1=mask(SOC_actual_masked_wetland, Top_preserv_WR_BD[which(Top_preserv_WR_BD$conclusion=="U1"),])
# SOC_actual_masked_top_preserv_WR_U1@data@values=as.numeric(SOC_actual_masked_top_preserv_WR_U1@data@values) # 7526 values
length(SOC_actual_masked_top_preserv_WR_U1@data@values) # 90492624
# boxplot(SOC_actual_masked_top_preserv_WR_U1) 

# sampleRandom(SOC_actual_masked_top_preserv_WR_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_WR_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_WR_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")
colnames(data_soc_preserv_WR_U1)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_WR_U1, aes(y=SOC, x="Preservation U1"))
fx(p)

remove(SOC_actual_masked_top_preserv_WR_U1)

## In U2 state
SOC_actual_masked_top_preserv_WR_U2=mask(SOC_actual_masked_wetland, Top_preserv_WR_BD[which(Top_preserv_WR_BD$conclusion=="U2"),])
# SOC_actual_masked_top_preserv_WR_U2@data@values=as.numeric(SOC_actual_masked_top_preserv_WR_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_preserv_WR_U2) 

# sampleRandom(SOC_actual_masked_top_preserv_WR_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_preserv_WR_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_preserv_WR_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")
colnames(data_soc_preserv_WR_U2)=c("SOC", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_preserv_WR_U2, aes(y=SOC, x="Preservation U2"))
fx(p)

remove(SOC_actual_masked_top_preserv_WR_U2)

# with all 3 state of BD
data_soc_preserv_WR_all=rbind(data_soc_preserv_WR_FV, data_soc_preserv_WR_U1, data_soc_preserv_WR_U2)
data_soc_preserv_WR_all$BD=as.factor(data_soc_preserv_WR_all$BD)

p=ggplot() + geom_violin(data=data_soc_preserv_WR_all, aes(y=SOC, x=BD)) 




### In Top restoration

## In BD favourable state => no 
# SOC_actual_masked_top_resto_WR_FV=mask(SOC_actual_masked_wetland, Top_resto_WR_BD[which(Top_resto_WR_BD$conclusion=="FV"),])
# SOC_actual_masked_top_resto_WR_FV@data@values=as.numeric(SOC_actual_masked_top_resto_WR_FV@data@values) # 7526 values
# length(SOC_actual_masked_top_resto_WR_FV)
# boxplot(SOC_actual_masked_top_resto_WR_FV)

# sampleRandom(SOC_actual_masked_top_resto_WR_FV,2000, na.rm=TRUE, xy=TRUE)

# data_soc_resto_WR_FV=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_WR_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")
# data_soc_resto_WR_FV=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="FV")
# colnames(data_soc_resto_WR_FV)=c("SOC", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_resto_WR_FV, aes(y=SOC, x="Restoration FV"))
# fx(p)
# remove(SOC_actual_masked_top_resto_WR_FV)

## In U1 state
SOC_actual_masked_top_resto_WR_U1=mask(SOC_actual_masked_wetland, Top_resto_WR_BD[which(Top_resto_WR_BD$conclusion=="U1"),])
# SOC_actual_masked_top_resto_WR_U1@data@values=as.numeric(SOC_actual_masked_top_resto_WR_U1@data@values) # 7526 values
length(SOC_actual_masked_top_resto_WR_U1@data@values) # 90492624
# boxplot(SOC_actual_masked_top_resto_WR_U1) 

# sampleRandom(SOC_actual_masked_top_resto_WR_U1,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_WR_U1=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_WR_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")
# data_soc_resto_WR_U1=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U1")
colnames(data_soc_resto_WR_U1)=c("SOC", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_resto_WR_U1, aes(y=SOC, x="Restoration U1"))
# fx(p)
remove(SOC_actual_masked_top_resto_WR_U1)

## In U2 state
SOC_actual_masked_top_resto_WR_U2=mask(SOC_actual_masked_wetland, Top_resto_WR_BD[which(Top_resto_WR_BD$conclusion=="U2"),])
# SOC_actual_masked_top_resto_WR_U2@data@values=as.numeric(SOC_actual_masked_top_resto_WR_U2@data@values) # 90492624 values
# boxplot(SOC_actual_masked_top_resto_WR_U2) 

# sampleRandom(SOC_actual_masked_top_resto_WR_U2,2000, na.rm=TRUE, xy=TRUE)

data_soc_resto_WR_U2=data.frame(SOC=sampleRandom(SOC_actual_masked_top_resto_WR_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")
# data_soc_resto_WR_U2=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U2")
colnames(data_soc_resto_WR_U2)=c("SOC", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_resto_WR_U2, aes(y=SOC, x="Restoration U2"))
# fx(p)
remove(SOC_actual_masked_top_resto_WR_U2)



# with all 3 state of BD
data_soc_resto_WR_all=rbind(data_soc_resto_WR_U1, data_soc_resto_WR_U2)
data_soc_resto_WR_all$BD=as.factor(data_soc_resto_WR_all$BD)

p=ggplot() + geom_violin(data=data_soc_resto_WR_all, aes(y=SOC, x=BD)) 




# BD VS potential carbon sequestration

data_soc_WR_FV=data_soc_preserv_WR_FV

data_soc_WR_U1=rbind(data_soc_preserv_WR_U1, data_soc_resto_WR_U1)
data_soc_WR_U2=rbind(data_soc_preserv_WR_U2, data_soc_resto_WR_U2)

# p=ggplot() +
#   geom_violin(data=data_soc_WR_FV, aes(y=SOC, x=TOP, fill=BD)) +
#   geom_violin(data=data_soc_WR_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_WR_U2, aes(y=SOC, x=TOP, fill=BD))


data_soc_all_WR_all=rbind(data_soc_preserv_WR_all, data_soc_resto_WR_all)

p=ggplot() + geom_violin(data=data_soc_all_WR_all, aes(y=SOC, x=BD:TOP, fill=TOP))
fx(p)

p=ggplot() + geom_violin(data=data_soc_all_WR_all, aes(y=SOC, x=TOP:BD, fill=BD))
fx(p)








### ANOVA

aov_WR=aov(data=data_soc_all_WR_all, SOC~TOP*BD)
anova(aov_WR) 

# Response: SOC
#              Df  Sum Sq Mean Sq F value    Pr(>F)    
# TOP          1  180688  180688 1372.15 < 2.2e-16 ***
# BD           2   65341   32670  248.10 < 2.2e-16 ***
# TOP:BD       1   62001   62001  470.84 < 2.2e-16 ***

TukeyHSD(aov_WR)
# Restoration-Preservation=9.65 (p=0) => signif: SOC Restoration>Preservation
# U1-FV =3.317080 (p=0.07) =>  U1 >? FV
# U2-FV=-2.505234 (p=0.22) => not signif: U2 = FV
# U2-U1=-5.822314 (p=0.00) => signif: U2 < U1

TukeyHSD(aov_WR)$`TOP:BD`[which(TukeyHSD(aov_WR)$`TOP:BD`[,4]<0.05),]
#                                      diff        lwr        upr        p adj
# Restoration:U1>Preservation:FV  15.586229  11.265472  19.906985 1.570111e-11
# Restoration:U1>Preservation:U1  15.335114  14.257450  16.412779 1.564393e-11
# Restoration:U2>Preservation:U1   4.051074   2.973409   5.128738 1.570100e-11
# Preservation:U2<Restoration:U1 -15.248071 -16.282433 -14.213708 1.564393e-11
# Restoration:U2<Restoration:U1  -11.284040 -12.318403 -10.249678 1.564393e-11
# Restoration:U2>Preservation:U2   3.964030   2.929668   4.998392 1.569500e-11

HSD_WR=HSD.test(aov_WR, trt="TOP", group=T, alpha=0.05)
# SOC groups
# Restoration  10.825225      a
# Preservation  1.174412      b

# Manual groups
# FV:Preservation    a
# U1:Preservation    a
# U1:Restoration     b
# U2:Preservation    a
# U2:Restoration     c

x_groups=c("FV:Preservation", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
groups=c("a", "a", "b", "a", "c")

### PLOT

data_soc_all_WR_all=rbind(data_soc_preserv_WR_all, data_soc_resto_WR_all)

p=ggplot() + geom_violin(data=data_soc_all_WR_all, aes(y=SOC, x=BD:TOP, fill=TOP))
fx(p)


Top_preserv_WR_BD_summary$Prop=100*Top_preserv_WR_BD_summary$Freq/sum(Top_preserv_WR_BD_summary$Freq)
Top_resto_WR_BD_summary$Prop=100*Top_resto_WR_BD_summary$Freq/sum(Top_resto_WR_BD_summary$Freq)

p=ggplot() + geom_violin(data=data_soc_all_WR_all, aes(y=SOC, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=41 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

  
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_SOC_groups_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

# WITH LOG

p=ggplot() + geom_violin(data=data_soc_all_WR_all, aes(y=log10(SOC), x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=1.7 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/BD_CCMa" ,"/geom_bar_BD_CCMa_log_SOC_groups_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)





```

### BD-CCMp

```{r bd_ccm_pot_wetlands}

###### BD VS potential carbon sequestration 

#### Top Preservation

## In BD favourable state
SOC_potent_masked_top_preserv_WR_FV=mask(SOC_potential_masked_wetland, Top_preserv_WR_BD[which(Top_preserv_WR_BD$conclusion=="FV"),])
# SOC_potent_masked_top_preserv_WR_FV=SOC_potent_masked_top_preserv_WR_FV[-which(is.na(SOC_potent_masked_top_preserv_WR_FV@data@values)),]
# SOC_potent_masked_top_preserv_WR_FV@data@values=as.numeric(SOC_potent_masked_top_preserv_WR_FV@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_WR_FV)
# boxplot(SOC_potent_masked_top_preserv_WR_FV) 

# sampleRandom(SOC_potent_masked_top_preserv_WR_FV,2000, na.rm=TRUE, xy=TRUE)


# data_soc_pot_preserv_WR_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_WR_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="FV")
data_soc_pot_preserv_WR_FV=data.frame(SOP=SOC_potent_masked_top_preserv_WR_FV@data@values[-which(is.na(SOC_potent_masked_top_preserv_WR_FV@data@values))], TOP=as.factor("Preservation"), BD="FV")

colnames(data_soc_pot_preserv_WR_FV)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_WR_FV, aes(y=SOP, x="Preservation FV"))
fx(p)
p=ggplot() + geom_point(data=data_soc_pot_preserv_WR_FV, aes(y=SOP, x="Preservation FV"))
fx(p)

remove(SOC_potent_masked_top_preserv_WR_FV)

## In U1 state
SOC_potent_masked_top_preserv_WR_U1=mask(SOC_potential_masked_wetland, Top_preserv_WR_BD[which(Top_preserv_WR_BD$conclusion=="U1"),])
# SOC_potent_masked_top_preserv_WR_U1@data@values=as.numeric(SOC_potent_masked_top_preserv_WR_U1@data@values) # 7526 values
length(SOC_potent_masked_top_preserv_WR_U1@data@values) # 90492624
# boxplot(SOC_potent_masked_top_preserv_WR_U1) 

# sampleRandom(SOC_potent_masked_top_preserv_WR_U1,2000, na.rm=TRUE, xy=TRUE)

# data_soc_pot_preserv_WR_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_WR_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U1")
data_soc_pot_preserv_WR_U1=data.frame(SOP=SOC_potent_masked_top_preserv_WR_U1@data@values[-which(is.na(SOC_potent_masked_top_preserv_WR_U1@data@values))], TOP=as.factor("Preservation"), BD="U1")
colnames(data_soc_pot_preserv_WR_U1)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_WR_U1, aes(y=SOP, x="Preservation U1"))
fx(p)

remove(SOC_potent_masked_top_preserv_WR_U1)

## In U2 state
SOC_potent_masked_top_preserv_WR_U2=mask(SOC_potential_masked_wetland, Top_preserv_WR_BD[which(Top_preserv_WR_BD$conclusion=="U2"),])
# SOC_potent_masked_top_preserv_WR_U2@data@values=as.numeric(SOC_potent_masked_top_preserv_WR_U2@data@values) # 90492624 values
length(SOC_potent_masked_top_preserv_WR_U2)
# boxplot(SOC_potent_masked_top_preserv_WR_U2) 

# sampleRandom(SOC_potent_masked_top_preserv_WR_U2,2000, na.rm=TRUE, xy=TRUE)

# data_soc_pot_preserv_WR_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_preserv_WR_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Preservation"), BD="U2")
data_soc_pot_preserv_WR_U2=data.frame(SOP=SOC_potent_masked_top_preserv_WR_U2@data@values[-which(is.na(SOC_potent_masked_top_preserv_WR_U2@data@values))], TOP=as.factor("Preservation"), BD="U2")

colnames(data_soc_pot_preserv_WR_U2)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_preserv_WR_U2, aes(y=SOP, x="Preservation U2"))
fx(p)

remove(SOC_potent_masked_top_preserv_WR_U2)

# with all 3 state of BD
data_soc_pot_preserv_WR_all=rbind(data_soc_pot_preserv_WR_FV, data_soc_pot_preserv_WR_U1, data_soc_pot_preserv_WR_U2)
data_soc_pot_preserv_WR_all$BD=as.factor(data_soc_pot_preserv_WR_all$BD)

p=ggplot() + geom_violin(data=data_soc_pot_preserv_WR_all, aes(y=SOP, x=BD)) 


### In Top restoration

## In BD favourable state
### NO FV in WR resto
# SOC_potent_masked_top_resto_WR_FV=mask(SOC_potential_masked_wetland, Top_resto_WR_BD[which(Top_resto_WR_BD$conclusion=="FV"),])
# SOC_potent_masked_top_resto_WR_FV@data@values=as.numeric(SOC_potent_masked_top_resto_WR_FV@data@values) # 7526 values
# length(SOC_potent_masked_top_resto_WR_FV)
# boxplot(SOC_potent_masked_top_resto_WR_FV) 

# sampleRandom(SOC_potent_masked_top_resto_WR_FV,2000, na.rm=TRUE, xy=TRUE)

# data_soc_pot_resto_WR_FV=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_WR_FV,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="FV")
# data_soc_pot_resto_WR_FV=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="FV")
# colnames(data_soc_pot_resto_WR_FV)=c("SOP", "TOP", "BD")

# p=ggplot() + geom_violin(data=data_soc_pot_resto_WR_FV, aes(y=SOP, x="Restoration FV"))
# fx(p)
# remove(SOC_potent_masked_top_resto_WR_FV)

## In U1 state
SOC_potent_masked_top_resto_WR_U1=mask(SOC_potential_masked_wetland, Top_resto_WR_BD[which(Top_resto_WR_BD$conclusion=="U1"),])
# SOC_potent_masked_top_resto_WR_U1@data@values=as.numeric(SOC_potent_masked_top_resto_WR_U1@data@values) # 7526 values
length(SOC_potent_masked_top_resto_WR_U1@data@values) # 90492624
# boxplot(SOC_potent_masked_top_resto_WR_U1) 

# sampleRandom(SOC_potent_masked_top_resto_WR_U1,2000, na.rm=TRUE, xy=TRUE)

# data_soc_pot_resto_WR_U1=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_WR_U1,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U1")
data_soc_pot_resto_WR_U1=data.frame(SOP=SOC_potent_masked_top_resto_WR_U1@data@values[-which(is.na(SOC_potent_masked_top_resto_WR_U1@data@values))], TOP=as.factor("Restoration"), BD="U1")
# data_soc_pot_resto_WR_U1=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U1")
colnames(data_soc_pot_resto_WR_U1)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_WR_U1, aes(y=SOP, x="Restoration U1"))
fx(p)

remove(SOC_potent_masked_top_resto_WR_U1)


## In U2 state
SOC_potent_masked_top_resto_WR_U2=mask(SOC_potential_masked_wetland, Top_resto_WR_BD[which(Top_resto_WR_BD$conclusion=="U2"),])
# SOC_potent_masked_top_resto_WR_U2@data@values=as.numeric(SOC_potent_masked_top_resto_WR_U2@data@values) # 90492624 values
# boxplot(SOC_potent_masked_top_resto_WR_U2) 
length(SOC_potent_masked_top_resto_WR_U2) # 90492624

# sampleRandom(SOC_potent_masked_top_resto_WR_U2,2000, na.rm=TRUE, xy=TRUE)

# data_soc_pot_resto_WR_U2=data.frame(SOP=sampleRandom(SOC_potent_masked_top_resto_WR_U2,2000, na.rm=TRUE, xy=F), TOP=as.factor("Restoration"), BD="U2")
data_soc_pot_resto_WR_U2=data.frame(SOP=SOC_potent_masked_top_resto_WR_U2@data@values[-which(is.na(SOC_potent_masked_top_resto_WR_U2@data@values))], TOP=as.factor("Restoration"), BD="U2")
# data_soc_pot_resto_WR_U2=data.frame(SOC=NA, TOP=as.factor("Restoration"), BD="U2")
colnames(data_soc_pot_resto_WR_U2)=c("SOP", "TOP", "BD")

p=ggplot() + geom_violin(data=data_soc_pot_resto_WR_U2, aes(y=SOP, x="Restoration U2"))
fx(p)
remove(SOC_potent_masked_top_resto_WR_U2)



# with all 3 state of BD
data_soc_pot_resto_WR_all=rbind(data_soc_pot_resto_WR_U1, data_soc_pot_resto_WR_U2)
data_soc_pot_resto_WR_all$BD=as.factor(data_soc_pot_resto_WR_all$BD)

p=ggplot() + geom_violin(data=data_soc_pot_resto_WR_all, aes(y=SOP, x=BD)) 



# data_soc_pot_WR_FV=rbind(data_soc_pot_preserv_WR_FV, data_soc_pot_resto_WR_FV)
# data_soc_pot_WR_U1=rbind(data_soc_pot_preserv_WR_U1, data_soc_pot_resto_WR_U1)
# data_soc_pot_WR_U2=rbind(data_soc_pot_preserv_WR_U2, data_soc_pot_resto_WR_U2)

# p=ggplot() +
#   geom_violin(data=data_soc_pot_WR_FV, aes(y=SOC, x=TOP, fill=BD)) +
#   geom_violin(data=data_soc_pot_WR_U1, aes(y=SOC, x=TOP, fill=BD)) + 
#   geom_violin(data=data_soc_pot_WR_U2, aes(y=SOC, x=TOP, fill=BD))


### ANOVA

aov_pot_WR=aov(data=data_soc_pot_all_WR_all, SOP~TOP*BD)
anova(aov_pot_WR) 

# Response: SOC
#              Df  Sum Sq Mean Sq F value    Pr(>F)  
# TOP          1  67.033  67.033 2224.15 < 2.2e-16 ***
# BD           2  12.666   6.333  210.13 < 2.2e-16 ***
# TOP:BD       1   8.681   8.681  288.03 < 2.2e-16 ***  

TukeyHSD(aov_pot_WR)
#                             diff          lwr            upr     p adj
# Restoration < Preservation -0.2216599 -0.2308735 -0.2124463     0
# U1 < FV                    -0.11457342 -0.19195850 -0.03718835 0.0015147
# U2 = FV                    -0.03538251 -0.11253057  0.04176555 0.5295699
# U2 > U1                     0.07919091  0.06870242  0.08967940 0.0000000


TukeyHSD(aov_pot_WR)$`TOP:BD`[which(TukeyHSD(aov_pot_WR)$`TOP:BD`[,4]<0.05),]
# Preservation:U1<Preservation:FV -0.09595848 -0.19089191 -0.0010250527
# Restoration:U1<Preservation:FV  -0.34902327 -0.44351698 -0.2545295639
# Restoration:U2<Preservation:FV  -0.12295215 -0.21882408 -0.0270802177
# Restoration:U1<Preservation:U1  -0.25306479 -0.27425629 -0.2318732811
# Preservation:U2>Preservation:U1  0.04197112  0.02386126  0.0600809739
# Restoration:U2<Preservation:U1  -0.02699367 -0.05366664 -0.0003207021
# Preservation:U2>Restoration:U1   0.29503590  0.27939393  0.3106778815
# Restoration:U2>Restoration:U1    0.22607112  0.20100816  0.2511340733
# Restoration:U2<Preservation:U2  -0.06896479 -0.09148231 -0.0464472677

# Manual groups
# FV:Preservation    a    
# U1:Preservation      b  
# U1:Restoration         c
# U2:Preservation  a   
# U2:Restoration      d

x_groups=c("FV:Preservation", "U1:Preservation", "U1:Restoration", "U2:Preservation", "U2:Restoration" )
groups=c("a", "b", "c", "a", "d")

### PLOT



data_soc_pot_all_WR_all=rbind(data_soc_pot_preserv_WR_all, data_soc_pot_resto_WR_all)

p=ggplot() + geom_violin(data=data_soc_pot_all_WR_all, aes(y=SOP, x=BD:TOP, fill=TOP))
fx(p)

p=ggplot() + geom_violin(data=data_soc_pot_all_WR_all, aes(y=SOP, x=BD:TOP, fill=TOP)) +
 scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  geom_text(aes(x=x_groups, y=1.05 ,label = groups),stat="identity", vjust = 1.5, colour = "black", size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

  
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/BD_CCMp" ,"/geom_bar_BD_CCMp_SOP_groups_wetlands", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)





```

### CCM absolute

```{r absolute_ccm_wetlands}

# SOC:
SOC_actual_masked_wetland
# SOP :
SOC_potential_wetland_cut_cut

Capacity_wetlands=SOC_actual_masked_wetland*(1-SOC_potential_masked_wetland)/SOC_potential_masked_wetland

# Top preserv
Capacity_CCM_wetlands_preserv=mask(Capacity_wetlands, Anomalies2100_in_WS_raster_wetland_masked_top_pres)

length(Capacity_CCM_wetlands_preserv@data@values[-which(is.na(Capacity_CCM_wetlands_preserv@data@values))])

data_capacity_preserv=data.frame(Capacity=sampleRandom(Capacity_CCM_wetlands_preserv$layer, 4912, na.rm=T, xy=F), TOP=as.factor("Preservation"))

str(data_capacity_preserv)


# Top resto
Capacity_CCM_wetlands_resto=mask(Capacity_wetlands, Anomalies2100_in_WS_raster_wetland_masked_top_resto)

length(Capacity_CCM_wetlands_resto@data@values[-which(is.na(Capacity_CCM_wetlands_resto@data@values))])

data_capacity_resto=data.frame(Capacity=sampleRandom(Capacity_CCM_wetlands_resto$layer, 1889, na.rm=T, xy=F), TOP=as.factor("Restoration"))

str(data_capacity_resto)


# in AS
SOC_present_WGS84=brick("Path/to/working/directory/CC_variable/CC_variable/CC_test/ESDAC/Derived_data_set_2013/SOC_top_soil_WGS84.tif")
crs(SOC_present_WGS84)@projargs==crs(AS_fusion_WGS84)@projargs
SOC_present_cut=crop(SOC_present_WGS84,AS_fusion_WGS84)
SOC_present_cut_resample=resample(SOC_present_cut, Carbon_saturation_cut_WGS84,method = 'ngb')

Capacity_CCM_in_AS=SOC_present_cut_resample*(1-Carbon_saturation_cut_WGS84)/Carbon_saturation_cut_WGS84
 
Capacity_CCM_in_AS=mask(Capacity_CCM_in_AS, AS_fusion_WGS84)

Capacity_CCM_in_AS_rd=data.frame(SOC=sampleRandom(Capacity_CCM_in_AS, 10000, na.rm=T, xy=F), TOP="AS")
colnames(Capacity_CCM_in_AS_rd)=c("Capacity", "TOP")





## ANOVA

aov_capacity_wr=aov(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), Capacity~TOP)
anova(aov_capacity_wr)
#              Df Sum Sq Mean Sq F value    Pr(>F) 
# TOP           2  60161 30080.7  2095.3 < 2.2e-16 ***
# Residuals 20656 16657.5   0.806                      

TukeyHSD(aov_capacity_wr)
# #                             diff         lwr       upr     p adj
# Restoration > Preservation  5.9077196  5.6672842  6.14815505 0.0000000
# AS < Preservation          -0.1195258 -0.2742634  0.03521187 0.1661139
# AS < Restoration           -6.0272454 -6.2500447 -5.80444607 0.0000000

HSD_WR=HSD.test(aov_capacity_wr, trt="TOP", group=T, alpha=0.05)
HSD_WR
# Capacity groups
# Restoration  6.4207684      a
# Preservation 0.5130488      b
# AS           0.3935230      b



### Capacity in pres & resto
median_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(median_cap = median(Capacity)) %>% as.data.frame()

mean_data <- rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd) %>%
  group_by(TOP) %>%
  summarize(mean_cap = mean(Capacity)) %>% as.data.frame()



p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "b", "a")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = (median_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/CCM_capacity" ,"/geom_violin_wetlands_CCM_capacity", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_wr, "/Figure/CCM_capacity" ,"/geom_violin_wetlands_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

### With log10

p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto,Capacity_CCM_in_AS_rd), aes(y=log10(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=2.5 ,label = c("a", "b", "a")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =median_data , aes(y = log10(median_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/CCM_capacity" ,"/geom_violin_wetlands_log_CCM_capacity", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/CCM_capacity" ,"/geom_violin_wetlands_log_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


### Without AS
p=ggplot() + geom_violin(data=rbind(data_capacity_preserv,data_capacity_resto), aes(y=log10(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration"), y=2.3 ,label = c("a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data[-3,] , aes(y = log10(mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/CCM_capacity" ,"/geom_violin_wetands_log_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
ggsave(plot=p, filename = paste(dossier_wr, "/Figure/CCM_capacity" ,"/geom_violin_wetlands_log_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)


##### AS only
dossier_as="Path/to/working/directory/R/Export_data/AS/"
  
p=ggplot() + geom_violin(data=Capacity_CCM_in_AS_rd, aes(y=(Capacity), x=TOP, fill=TOP)) + 
  scale_fill_manual(values=c(
    # rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),
               # rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(aes(x=c("Preservation", "Restoration", "AS"), y=65 ,label = c("a", "a", "b")),stat="identity", vjust = 1.5, colour = "black",  size=10) +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank()) +
  geom_point(data =mean_data[-c(1,2),] , aes(y = (mean_cap), x=TOP, fill=TOP), shape = 4, size = 6, color = "black", position = position_dodge(width = 0.75))
fx(p)

ggsave(plot=p, filename = paste(dossier_as, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_without_AS", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)
# ggsave(plot=p, filename = paste(dossier_fm, "/Figure/CCM_capacity" ,"/geom_violin_forest_CCM_capacity_groups", ".png", sep=''), width=8*2, height=10*2, limitsize=F, dpi = 300)

```


### Combined CCM index

```{r combined_ccm_index}

# SOC:
summary(SOC_actual_masked_wetland)
# Min.                          0.0
# 1st Qu.                       0.0
# Median                        0.0
# 3rd Qu.                       0.0
# Max.                         39.4
# NA's                   83042366.0

# SOP :
summary(SOC_potential_masked_wetland)
# Min.                    3.682248e-01
# 1st Qu.                 5.797518e-01
# Median                  8.272517e-01
# 3rd Qu.                 1.000000e+00
# Max.                    1.000000e+00
# NA's                    9.022205e+07


# list=1:ncell(SOC_potential_masked_wetland_slope_inf35)
# list=raster::extract(SOC_potential_masked_wetland_slope_inf35, na.rm=T, y=Bounding_box, cellnumbers=T)
list=1:ncell(SOC_potential_masked_wetland)
list=list[which(!is.na(SOC_potential_masked_wetland[]))]
length(list)/ncell(SOC_potential_masked_wetland) # 0.05%
list=as.vector(list)
# list_sp=list[sample(x=1:length(list), size=10^5)]
list_sp=list # size < 10^5
summary(SOC_potential_masked_wetland[list_sp]) # 0 NA
summary(SOC_actual_masked_wetland[list_sp]) # 0 NA
plot(SOC_actual_masked_wetland[list_sp], SOC_potential_masked_wetland[list_sp])
### complicated to create one index...

summary(Capacity_wetlands)
# Capacity_wetlands=SOC_actual_masked_wetland*(1-SOC_potential_masked_wetland_slope_inf35)/SOC_potential_masked_wetland_slope_inf35
# remove(Capacity_wetlands)
# Min.    0.000000e+00
# 1st Qu. 0.000000e+00
# Median  3.053871e-01
# 3rd Qu. 8.810750e-01
# Max.    7.729382e+01
# NA's    9.044686e+07


Cpot_add=SOC_actual_masked_wetland/SOC_potential_masked_wetland
summary(Cpot_add)
# Min.    0.000000e+00
# 1st Qu. 1.041842e+00
# Median  1.577425e+00
# 3rd Qu. 3.121579e+00
# Max.    1.166938e+02
# NA's    9.044686e+07

plot(SOC_actual_masked_wetland[list_sp], Cpot_add[list_sp])

### Preserv

Cpot_add_wetlands_preserv=mask(Cpot_add, Anomalies2100_in_WS_raster_wetland_masked_top_pres)

length(Cpot_add_wetlands_preserv[which(!is.na(Cpot_add_wetlands_preserv[]))]) # 4912

list=1:ncell(Cpot_add_wetlands_preserv)
list=list[which(!is.na(Cpot_add_wetlands_preserv[]))]
length(list) # 4912  /  < 10^5
# list_sp=list[sample(x=1:length(list), size=10^5)]
list_sp=list
data_cpot_add_preserv=data.frame(Cadd=Cpot_add_wetlands_preserv[list_sp], SOC=SOC_actual_masked_wetland[list_sp], TOP=as.factor("Surplus"))
colnames(data_cpot_add_preserv)=c("Cadd", "SOC", "TOP")

data_cpot_add_preserv_reshp=reshape(data_cpot_add_preserv,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_preserv_reshp$time=factor(data_cpot_add_preserv_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


# Resto

Cpot_add_wetlands_resto=mask(Cpot_add, Anomalies2100_in_WS_raster_wetland_masked_top_resto)

length(Cpot_add_wetlands_resto@data@values[which(!is.na(Cpot_add_wetlands_resto[]))]) # 1889

list=1:ncell(Cpot_add_wetlands_resto)
list=list[which(!is.na(Cpot_add_wetlands_resto[]))]
length(list) #1889 < 10^5
# list_sp=list[x=sample(1:length(list), size=10^5)]
list_sp=list

data_cpot_add_resto=data.frame(Cadd=Cpot_add_wetlands_resto[list_sp], SOC=SOC_actual_masked_wetland[list_sp], TOP=as.factor("Deficit"))
colnames(data_cpot_add_resto)=c("Cadd", "SOC", "TOP")

data_cpot_add_resto_reshp=reshape(data_cpot_add_resto,direction="long",varying=c("Cadd", "SOC"), v.names="Carbon", times=c("Cadd", "SOC"))

data_cpot_add_resto_reshp$time=factor(data_cpot_add_resto_reshp$time, ordered=T, levels=c("SOC", "Cadd"))


######## STATS
data_cpot_add_all_reshp=rbind(data_cpot_add_preserv_reshp, data_cpot_add_resto_reshp)

data_cpot_add_all_reshp$TOP=factor(data_cpot_add_all_reshp$TOP, ordered=T, levels = c("Surplus", "Deficit"))

aov_carbon=aov(data=data_cpot_add_all_reshp, Carbon~TOP*time)
anova(aov_carbon) 
# Response: Carbon
#              Df  Sum Sq Mean Sq  F value    Pr(>F)    
# TOP           1  272134  272134 2330.30 < 2.2e-16 ***
# time          1   15776   15776  135.09 < 2.2e-16 ***
# TOP:time      1   23808   23808  203.87 < 2.2e-16 ***

TukeyHSD(aov_carbon)
# $TOP
#                      diff       lwr       upr p adj
# Deficit > Surplus 9.986602 9.581095 10.39211     0

# $time
#              diff      lwr      upr p adj
# Cadd > SOC 2.153937 1.790691 2.517183     0

TukeyHSD(aov_carbon)$`TOP:time`[which(TukeyHSD(aov_carbon)$`TOP:time`[,4]<0.05),]
# $`TOP:time`
#                                diff       lwr       upr p adj
# Deficit:SOC  > Surplus:SOC    7.032742  6.281033  7.784451 1.551555e-09
# Deficit:Cadd > Surplus:SOC  13.453511 12.701801 14.205220 1.551555e-09
# Surplus:Cadd < Deficit:SOC  -6.519693 -7.271402 -5.767984 1.551555e-09
# Deficit:Cadd > Deficit:SOC   6.420768  5.517311  7.324226 1.551555e-09
# Deficit:Cadd > Surplus:Cadd 12.940462 12.188753 13.692171 1.551555e-09

# Manual grouping

# Surplus:SOC:   a
# Surplus:Cadd:  a   
# Deficit:SOC:      b
# Deficit:Cadd:       c








######## PLOT


median_log_data <- data_cpot_add_all_reshp %>%
  group_by(TOP:time) %>%
  summarize(median_carbon = median(log10(Carbon), na.rm=T)) %>% as.data.frame()


### Without AS
# x=seq(from=0.8, to=2.2, length.out=4)
p=ggplot() + geom_violin(data=data_cpot_add_all_reshp, aes(y=log10(Carbon), x=TOP, fill=TOP:time), position = position_dodge(0.8)) + 
  scale_fill_manual(values=c(rgb(1, 133, 113, maxColorValue = 255, alpha=0.9*255),rgb(1, 133, 113, maxColorValue = 255, alpha=0.6*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.9*255),
               rgb(166, 97, 26, maxColorValue = 255, alpha=0.6*255),
               # rgb(255, 0, 0, maxColorValue = 255, alpha=0.9*255),
               rgb(128, 128, 128, maxColorValue = 255, alpha=0.9*255))) +
  # geom_text(data=median_log_data, aes(x=c(0.8, 1.2, 1.8, 2.2), y=2.1 ,label = c("a", "a", "b", "c")), stat="identity", vjust = 1.5, colour = "black",  size=10) +
    geom_point(data =median_log_data , aes(y = (median_carbon), x=c(0.8, 1.2, 1.8, 2.2)), shape = 4, size = 6, color = "black") +
  theme_bw() + theme(axis.text.x=element_text(size=25),axis.text.y=element_text(size=25), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.title = element_blank())

fx(p)

ggsave(plot=p, filename = paste(dossier_wr, "/Figure/CCM_add" ,"/geom_bar_Carbon_SOC_add_wetlands", ".png", sep=''), width=7*2, height=10*2, limitsize=F, dpi = 300)







```


# Export watershed shapefile with data

```{r export_watersheds}
HydroBasin_l12_ALPS_int_sp_export=HydroBasin_l12_ALPS_int_sp
HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_Groundwater_JJA_RelDrought_2100=factor(HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_Groundwater_JJA_RelDrought_2100, ordered = F, levels=levels(HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_Groundwater_JJA_RelDrought_2100))

HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_anomalies_Groundwater_JJA_RelDrought_2100=factor(HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_anomalies_Groundwater_JJA_RelDrought_2100,ordered = F, levels=levels(HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_anomalies_Groundwater_JJA_RelDrought_2100))

HydroBasin_l12_ALPS_int_sp_export$Code_heatmap_RelDrought_dist_anom_grounwater_JJA_2100=factor(HydroBasin_l12_ALPS_int_sp_export$Code_heatmap_RelDrought_dist_anom_grounwater_JJA_2100, ordered = F, levels=levels(HydroBasin_l12_ALPS_int_sp_export$Code_heatmap_RelDrought_dist_anom_grounwater_JJA_2100))

HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_anomalies_Groundwater_mean_JJA_RelDrought_2100=factor(HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_anomalies_Groundwater_mean_JJA_RelDrought_2100, ordered = F, levels=levels(HydroBasin_l12_ALPS_int_sp_export$Sum_code_dist_anomalies_Groundwater_mean_JJA_RelDrought_2100))

HydroBasin_l12_ALPS_int_sp_export$Code_heatmap_RelDrought_dist_anom_groundwater_mean_JJA_2100=factor(HydroBasin_l12_ALPS_int_sp_export$Code_heatmap_RelDrought_dist_anom_groundwater_mean_JJA_2100, ordered = F, levels=levels(HydroBasin_l12_ALPS_int_sp_export$Code_heatmap_RelDrought_dist_anom_groundwater_mean_JJA_2100))

# shapefile(HydroBasin_l12_ALPS_int_sp_export, "Path/to/working/directory/R/Export_data/HydroBasin_l12_ALPS_int_sp_dist_models_WGS84.shp", overwrite=T)


```


